"use strict";function createSiteSectionsCategories(db){function _createTextsItemsFor(_category){function _save(payload){db.ctrl("Text","save",_.cloneDeep(payload)).then(cbCount.next)}var diags=["DPE","AMIANTE","PLOMB","CARREZ","ERNMT","GAZ","ELECTRICITE","PARASITAIRE"],cbCount=$U.cbHell(5*diags.length,function(){console.info("create-page-category-#",5*diags.length,"texts-created-or-updated-success")}),content="Page section: BOOKING_HOME, Code: ";diags.forEach(function(code){var name=code,payload={code:code,description:"Auto generated block for "+code+" when you click the card in the home page.",content:"",_category:_category,__match:["code"]};payload.code="PAGE_HOME_"+name+"_BLOCK_LEFT_TITLE",payload.content=content+payload.code,_save(payload),payload.code="PAGE_HOME_"+name+"_BLOCK_LEFT_CONTENT",payload.content=content+payload.code,_save(payload),payload.code="PAGE_HOME_"+name+"_BLOCK_RIGHT_TITLE",payload.content=content+payload.code,_save(payload),payload.code="PAGE_HOME_"+name+"_BLOCK_RIGHT_CONTENT",payload.content=content+payload.code,_save(payload),payload.code="PAGE_HOME_"+name+"_BLOCK_BOTTOM",payload.content=content+payload.code,_save(payload)})}function _createPageSections(res){if(res&&res.ok&&res.result){var root=res.result,cbCount=$U.cbHell(categories.length,function(){console.info("create-page-categories#",categories.length,"created-or-updated-success")});categories.forEach(function(cat){var payload={code:cat,description:"Diags Site Section",_parent:root._id,__match:["code"]};db.ctrl("Category","save",payload).then(function(r){r&&r.ok&&"BOOKING_HOME"==r.result.code&&_createTextsItemsFor(r.result._id),cbCount.next()})})}else console.warn("create-page-categories#create-page-sections=invalid-parameters,category-res-expected-and-got",res)}function _createRoot(cb){db.ctrl("Category","create",{code:"DIAGS",description:"Diags Root Category"}).then(cb)}db.ctrl("Category","get",{code:"DIAGS"}).then(function(res){res.ok&&res.result?_createPageSections(res):_createRoot(_createPageSections)});var categories=["ERNMT","BOOKING_HOME","GENERAL_CONDITIONS","FAQ","LEGAL_MENTIONS"]}function createDateTimePickerData(){var o={isOpen:!1,openCalendar:function(e){e.preventDefault(),e.stopPropagation(),o.isOpen=!0}};return o}function createSelect(opt){var o={label:opt.label,click:function(x){o.label=x.label||x,$U.setPropByGivenPath(opt.scope,opt.model,x),opt.change(x)},items:opt.items};return opt.scope.$watch(opt.model,function(v){void 0!==v?o.label=v.label||v.substring(0,1).toUpperCase()+v.slice(1):o.label=opt.label}),o}function rangeCollide(d1s,d1e,d2s,d2e){d1s=moment(d1s),d1e=moment(d1e),d2s=moment(d2s),d2e=moment(d2e);var collide=!1;return(collide=d2s.isAfter(d1s)&&d2s.isBefore(d1e))?collide:(collide=d2e.isAfter(d1s)&&d2e.isBefore(d1e),(collide=d1s.isAfter(d2s)&&d1s.isBefore(d2e))?collide:collide=d1e.isAfter(d2s)&&d1e.isBefore(d2e))}function openStripeModalPayOrder(order,cb,opt){opt=opt||{config:{companyName:"Unknown"}};var handler=StripeCheckout.configure({key:"pk_test_MDkxtBLcBpHwMCgkqX2dJHjO",image:"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",token:function(_token){cb(_token)}});handler.open({name:opt.config.companyName||"[r.config.companyName]",description:"Order payment",email:opt.email||order._client.email,currency:"eur",amount:100*order.price,zipCode:!1,allowRememberMe:!1})}function normalizeOrderStartTime(t,forwardOnly,backwardOnly){return t.minutes<30&&(forwardOnly?t.minutes=30:t.minutes=0),30==t.minutes&&(t.minutes=30),t.minutes>30&&(backwardOnly?t.minutes=30:(t.minutes=0,t.hours++)),t}function normalizeOrderTime(t,eachTreintaOnly){return t.minutes>0&&t.minutes<15&&(t.minutes=15,eachTreintaOnly&&(t.minutes=0)),t.minutes>15&&t.minutes<30&&(t.minutes=30),t.minutes>30&&t.minutes<45&&(t.minutes=45,eachTreintaOnly&&(t.minutes=30)),t.minutes>45&&t.minutes<59&&(t.hours+=1,t.minutes=0),t}function subTotal(model,diags,basePrice,opt){if(!model)return 0;opt=opt||{},opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo.basePrice=opt.s.priceInfo.basePrice);var total=0;model.diags=model.diags||{},Object.keys(model.diags).forEach(function(mkey){return model.diags[mkey]?void diags.forEach(function(dval,dkey){return dval.show&&dval.name==mkey?(opt.s&&(opt.s.priceInfo[mkey]=dval.price),total+=dval.price||0,!1):void 0}):void(opt.s&&opt.s.priceInfo[mkey]&&delete opt.s.priceInfo[mkey])});var rta=basePrice+total;return 0===total?(opt.s&&(opt.s.priceInfo.basePrice=0),rta=0):opt.s&&(opt.s.priceInfo.basePrice=basePrice),rta}function sizePrice(model,diags,squareMetersPrice,basePrice,opt){if(!model)return 0;var rta=0,squareMeters=model.info?model.info.squareMeters:model.squareMeters;if(squareMeters){var porcent=squareMetersPrice[squareMeters];if((_.isUndefined(porcent)||_.isNull(porcent))&&(console.warn("sizePrice: squareMeters missing in model."),porcent=0),0===parseInt(porcent))rta=0;else{var sub=subTotal(model,diags,basePrice,opt);rta=sub*parseInt(porcent),rta/=100}}return opt&&opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo.sizePrice=rta),rta}function totalPrice(showRounded,model,diags,squareMetersPrice,basePrice,opt){opt=opt||{},opt.basePrice&&(basePrice=opt.basePrice);var _sizePrice=sizePrice(model,diags,squareMetersPrice,basePrice,opt),tot=subTotal(model,diags,basePrice,opt)+_sizePrice;if(opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{}),opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers={sizePrice:_sizePrice}}),!model)return 0;if(opt.s){var date=model.diagStart;if(opt.dt&&(date=opt.dt),opt.s.settings&&opt.s.settings.pricePercentageIncrease&&date){var increase=opt.s.settings.pricePercentageIncrease,percentage=0;isSaturday(date)&&!isToday(date)&&(percentage=percentage>increase.saturday?percentage:increase.saturday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.saturday=percentage}),delete opt.s.priceInfo["increase-today"],delete opt.s.priceInfo["increase-tomorrow"],delete opt.s.priceInfo["increase-sunday"],opt.s.priceInfo["increase-saturday"]=tot*(percentage/100)+" ("+percentage+"%)"),isSunday(date)&&!isToday(date)&&(percentage=percentage>increase.saturday?percentage:increase.saturday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.sunday=percentage}),delete opt.s.priceInfo["increase-today"],delete opt.s.priceInfo["increase-tomorrow"],delete opt.s.priceInfo["increase-saturday"],opt.s.priceInfo["increase-sunday"]=tot*(percentage/100)+" ("+percentage+"%)"),isTomorrow(date)&&(percentage=percentage>increase.tomorrow?percentage:increase.tomorrow,isTomorrowSaturday(date)?(percentage=increase.tomorrowSaturday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.tomorrowSaturday=percentage})):isTomorrowSunday(date)?(percentage=increase.tomorrowSunday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.tomorrowSunday=percentage})):(percentage=increase.tomorrowMondayToFriday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.tomorrowMondayToFriday=percentage})),delete opt.s.priceInfo["increase-today"],delete opt.s.priceInfo["increase-saturday"],opt.s.priceInfo["increase-tomorrow"]=tot*(percentage/100)+" ("+percentage+"%)"),isToday(date)&&(percentage=percentage>increase.today?percentage:increase.today,isTodaySaturday(date)?(percentage=increase.todaySaturday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.todaySaturday=percentage})):isTodaySunday(date)?(percentage=increase.todaySunday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.todaySunday=percentage})):(percentage=increase.todayMondayToFriday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.todayMondayToFriday=percentage})),delete opt.s.priceInfo["increase-tomorrow"],delete opt.s.priceInfo["increase-saturday"],opt.s.priceInfo["increase-today"]=tot*(percentage/100)+" ("+percentage+"%)"),tot+=tot*(percentage/100)}if($U.val(model,"_client.discount")){var discount=$U.val(model,"_client.discount");discount>0&&(opt.s.priceInfo["client-discount"]=-tot*(discount/100)+" ("+discount+"%)",tot-=tot*(discount/100),opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.clientDiscount=discount}))}}else console.warn("$D totalPrice opt.s required");var realTot=10*parseInt(parseInt(tot)/10,10);return opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo["Round-to-near-10"]=-1*(tot-realTot)),opt.overwriteModel===!1||(model.price=realTot),showRounded?realTot:tot}function OrderTotalTime(selectedDiags,diags){var total=0;if(!selectedDiags)return 0;Object.keys(selectedDiags).forEach(function(mkey){selectedDiags[mkey]&&diags.forEach(function(dval,dkey){return dval.name==mkey?(dval.time=dval.price/4,total+=dval.time||0,!1):void 0})}),total=10*parseInt(parseInt(total)/10,10)+10;var hours=Math.floor(total/60),minutes=total%60,t={hours:hours,minutes:minutes};return t}function numberBetween(n,min,max){return n>=min&&max>=n}function expose(path,v){setVal(window,path,v)}function setVal(obj,propertyPath,_v){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||{},obj?void 0:!1)}),obj?(_v&&(obj[split[lastIndex]]=_v),obj[split[lastIndex]]):void 0}function has(v,arr){for(var x in arr)if(v==arr[x])return!0;return!1}function valid(obj,propertyPath,opt){var split=propertyPath.split("."),lastIndex=split.length-1;if(split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||{},obj?void 0:!1)}),!obj)return!1;var rta=obj[split[lastIndex]];return rta?!0:void 0}function val(obj,propertyPath,opt){var split=propertyPath.split("."),lastIndex=split.length-1;if(split.forEach(function(chunk,index){var isLast=lastIndex==index;isLast||(obj=obj[chunk]||{})}),obj){var rta=obj[split[lastIndex]];return"string"==typeof rta?rta:"function"==typeof rta?opt&&opt.args?rta.apply(this,opt.args):rta():rta}}function setPropByGivenPath(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj&&(obj[split[lastIndex]]=val)}function ifThenMessage(comparisons,messagesCallback,noMessagesCallback){var messages=[];comparisons.forEach(function(comparison){var v1=comparison[0];if("function"==typeof v1)v1()&&messages.push(comparison[1]);else{var operator=comparison[1],v2=comparison[2],m=comparison[3],cb=comparison[4]||void 0;"=="==operator&&v1==v2&&messages.push(m),"!="==operator&&v1!=v2&&messages.push(m),">"==operator&&v1>v2&&messages.push(m),"<"==operator&&v2>v1&&messages.push(m),">="==operator&&v1>=v2&&messages.push(m),"<="==operator&&v2>=v1&&messages.push(m)}messages.filter(function(_m){return _m==m}).length>0&&cb&&cb()}),messages.length>0?messagesCallback(messages):noMessagesCallback?noMessagesCallback():console.warn("ifThenMessage no-message-callback-undefined")}function getParameterByName(name,url){url||(url=window.location.href),name=name.replace(/[\[\]]/g,"\\$&");var regex=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)"),results=regex.exec(url);return results?results[2]?decodeURIComponent(results[2].replace(/\+/g," ")):"":null}function MyPromise(cb){var _scope={cb:null,errorCb:null,errorRes:null,res:null,evt:{}},resolve=function(res){_scope.cb&&_scope.cb(res),_scope.res=res||{}},error=function(errorRes){_scope.errorCb&&_scope.errorCb(errorRes),_scope.errorRes=errorRes||{}},emit=function(n,err,r){_scope.evt[n]=_scope.evt[n]||{},_scope.evt[n].res={err:err,r:r},void 0!==_scope.evt[n].cb&&_scope.evt[n].cb(_scope.evt[n].res.err,_scope.evt[n].res.r)};cb(resolve,error,emit);var rta={then:function(cb){return _scope.res?cb(_scope.res):_scope.cb=cb,rta},error:function(errorCb){return _scope.errorRes?errorCb(_scope.errorRes):_scope.errorCb=errorCb,rta},err:function(errorCb){return _scope.errorRes?errorCb(_scope.errorRes):_scope.errorCb=errorCb,rta},on:function(n,cb){return _scope.evt[n]=_scope.evt[n]||{},_scope.evt[n].cb=cb,void 0!==_scope.evt[n].res&&_scope.evt[n].cb(_scope.evt[n].res.err,_scope.evt[n].res.r),rta}};return rta}function onAnchorChange(handler){var storedHash=window.location.hash;window.setInterval(function(){window.location.hash!=storedHash&&(storedHash=window.location.hash,handler(storedHash))},100)}function cbHell(quantity,cb){return{call:function(){return cb()},next:function(){quantity--,0===quantity&&cb()}}}function hasUndefinedProps(obj,props){var has=!1;return props.forEach(function(v){void 0==obj[v]&&(has=!0)}),has}function indexOf(str,values){var rta=!1;return values.forEach(function(v){-1!==str.indexOf(v)&&(rta=!0)}),rta}function scrollToTop(time){$("html, body").animate({scrollTop:0},time||800)}function fetchCountry(address){return MyPromise(function(resolve,err,emit){var rta={name:"",code:""},geocoder=new google.maps.Geocoder;geocoder.geocode({address:address},function(results){for(var i=0;i<results[0].address_components.length;i++)for(var j=0;j<results[0].address_components[i].types.length;j++)if("country"==results[0].address_components[i].types[j]){var country=results[0].address_components[i];rta.name=country.long_name,rta.code=country.short_name,resolve(rta)}})})}function calendar(s,server,r){console.info("ctrl.calendar");var c=this;c.panel="CALENDAR",r.selectedDate="",c.range="",c.pickDate=function(rr){r.selectedDateRange=rr._id},c.init=function(main){c.main=main,c.main.state==c.main.states.CALENDAR&&c.initialized!==!0&&r.onCalendarInit()},r.$on("CALENDAR.CONTINUE",function(){r.selectedDateRange?console.log("gotoemail"):alert("Select a datetime")}),r.onCalendarInit=function(){console.log("onCalendarInit"),r.dom(function(){var $lastDate=null;$calendar=$("#calendar").fullCalendar({dayClick:function(date,jsEvent,view){var dateFormated=date.format();r.selectedDate=date.format("MMMM Do YYYY, dddd"),server.getAvailableRanges(dateFormated).then(function(data){c.availableRanges=data,console.log("availableRanges",c.availableRanges),r.dom(function(){})});var $curr=$(this);r.dom(function(){$lastDate&&$lastDate.css("background","transparent"),$curr.css("background","rgba(0,0,0,.2)"),$lastDate=$curr})}})}),c.initialized=!0},r.milliToHours=function(milli){return Math.floor(milli/1e3/60/60)},c.drawRange=function(rng){return moment(rng.from).format("HH:mm")+"h - "+moment(rng.to).format("HH:mm")+"h"}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol?"symbol":typeof obj},$D={openStripeModalPayOrder:openStripeModalPayOrder,rangeCollide:rangeCollide,normalizeOrderStartTime:normalizeOrderStartTime,OrderTotalTime:OrderTotalTime,subTotal:subTotal,sizePrice:sizePrice,totalPrice:totalPrice,createSelect:createSelect,createDateTimePickerData:createDateTimePickerData,ORDER_STATUS:{CREATED:"created",ORDERED:"ordered",PREPAID:"prepaid",DELIVERED:"delivered",COMPLETED:"completed"},ORDER_STATUS_PAID:["prepaid","completed"],createSiteSectionsCategories:createSiteSectionsCategories},isTomorrowSaturday=function(d){return 6===moment(d).add(1,"day").day()},isTomorrowSunday=function(d){return 0===moment(d).add(1,"day").day()},isTodaySaturday=function(d){return 6===moment(d).day()},isTodaySunday=function(d){return 0===moment(d).day()},isToday=function(d){return moment().isSame(moment(d),"day")},isTomorrow=function(d){return moment().add(1,"day").isSame(moment(d),"day")},isSaturday=function(d){return 6===moment(d).day()},isSunday=function(d){return 0===moment(d).day()},store=function(){return{set:function(id,raw){id="store#"+id;try{return raw=JSON.stringify(raw),localStorage.setItem(id,raw),!0}catch(e){return console.warn("store setData fails"),!1}},get:function(id){id="store#"+id;try{var localData=JSON.parse(localStorage.getItem(id));return localData}catch(e){return console.warn("store getData fails"),null}}}}();String.prototype.replaceAll=function(search,replacement){var target=this;return target.replace(new RegExp(search,"g"),replacement)};var $hasMouse=function(change){$("html").on("mousemove",function(e){change(!0),$("html").off("mousemove")}),change(!1)};$(function(){$.hrefAnchor=function(){var url=window.location.href,idx=url.indexOf("#"),hash=-1!=idx?url.substring(idx+1):"";return hash.replace("/","")},$.scrollToAnchor=function(){var elem=$("#"+$.hrefAnchor());$("html, body").animate({scrollTop:elem.offset().top},500)},$.onGlobalError=function(cb){$("html").on("error",function(){console.log("ERROR.DETECTED")})},$.downloadPNG=function(elem,name){html2canvas(elem,{onrendered:function(canvas){var imgData=canvas.toDataURL("image/jpeg",1),pdf=new jsPDF;pdf.addImage(imgData,"JPEG",25,20),pdf.save("download.pdf")}})}});var whenProperties=function(o,props,cbArray){var i=setInterval(function(){var rta=!0;props.forEach(function(v){_.isUndefined(o[v])&&(rta=!1)}),rta&&(clearInterval(i),cbArray.forEach(function(cb){cb()}))},200)};!function(exports){var BASE64URICHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split("");exports.newId=function(len,radix){var chars=BASE64URICHARS,newId=[],i=0;for(radix=radix||chars.length,len=len||22,i=0;len>i;i++)newId[i]=chars[0|Math.random()*radix];return newId.join("")}}("undefined"==typeof exports?window:exports);var downloadFile=function(filename,encodedData,mimeType){var link=document.createElement("a");mimeType=mimeType||"text/plain",link.setAttribute("download",filename),link.setAttribute("href","data:"+mimeType+";charset=utf-8,"+encodedData),link.click()},downloadJSON=function(filename,data){downloadFile(filename,JSON.stringify(data,null,"	"),"text/json")},ToStringParameters=function(obj){var rta="";for(var x in obj)""!=rta&&(rta+="&"),rta+=x+"="+decodeURIComponent(JSON.stringify(obj[x]));return rta},getHashParams=function(){for(var e,hashParams={},a=/\+/g,r=/([^&;=]+)=?([^&;]*)/g,d=function(s){return decodeURIComponent(s.replace(a," "))},q=window.location.hash.substring(1);e=r.exec(q);)hashParams[d(e[1])]=d(e[2]);return hashParams},Eventify=function(self){function firePreserve(n,handler){once[n]&&handler(once[n])}var once={},evts={};return self.off=function(evt){"string"==typeof evt?(delete evts[evt],delete once[evt]):delete evts[evt.type][evt.id]},self.emitPreserve=function(n,p){self.emit(n,p,{preserve:!0})},self.emit=function(n,p,opt){evts[n]=evts[n]||{},Object.keys(evts[n]).forEach(function(k){evts[n][k].handler(p)}),opt&&opt.preserve&&(once[n]=p||{});var pp=p;try{pp=JSON.stringify(pp)}catch(e){pp=p}},self.once=function(n,handler){if(once[n])return firePreserve(n,handler);var evt=self.on(n,function(p){handler(p),self.off(evt),once[n]=p})},self.on=function(n,handler){firePreserve(n,handler),evts[n]=evts[n]||{};var id="evt_"+n+"_"+(new Date).getTime()+"_"+Object.keys(evts).length;return evts[n][id]={id:id,type:n,handler:handler},evts[n][id]},self},queryString=function(){var queryString={};return queryString.parse=function(str){return"string"!=typeof str?{}:(str=str.trim().replace(/^\?/,""),str?str.trim().split("&").reduce(function(ret,param){var parts=param.replace(/\+/g," ").split("="),key=parts[0],val=parts[1];return key=decodeURIComponent(key),val=void 0===val?null:decodeURIComponent(val),ret.hasOwnProperty(key)?Array.isArray(ret[key])?ret[key].push(val):ret[key]=[ret[key],val]:ret[key]=val,ret},{}):{})},queryString.stringify=function(obj){return obj?Object.keys(obj).map(function(key){var val=obj[key];return Array.isArray(val)?val.map(function(val2){return encodeURIComponent(key)+"="+encodeURIComponent(val2)}).join("&"):encodeURIComponent(key)+"="+encodeURIComponent(val)}).join("&"):""},queryString.get=getParameterByName,queryString.hashName=function(){return(-1!==window.location.hash.indexOf("?")?window.location.hash.substring(0,window.location.hash.indexOf("?")):window.location.hash).replace("#/","")},queryString.hash=function(str){var hash=-1!==window.location.hash.indexOf("?")?window.location.hash.substring(0,window.location.hash.indexOf("?")):window.location.hash;if(void 0==str)return hash;var params=queryString.parse(window.location.hash.replace(hash,"")),new_params_string=queryString.stringify(params);window.history.pushState({},"",window.location.pathname+"#/"+str+"?"+new_params_string)},queryString.clear=function(){var hash=-1!==window.location.hash.indexOf("?")?window.location.hash.substring(0,window.location.hash.indexOf("?")):window.location.hash;window.history.pushState({},"",window.location.pathname+hash)},queryString.set=function(key,new_value){var hash=-1!==window.location.hash.indexOf("?")?window.location.hash.substring(0,window.location.hash.indexOf("?")):window.location.hash,params=queryString.parse(window.location.hash.replace(hash,""));params[key]=new_value;var new_params_string=queryString.stringify(params);window.history.pushState({},"",window.location.pathname+hash+"?"+new_params_string)},"undefined"!=typeof module&&module.exports?queryString:queryString}();"undefined"!=typeof exports?(exports.MyPromise=MyPromise,exports.getHashParams=getHashParams,exports.getParameterByName=getParameterByName,exports.ifThenMessage=ifThenMessage,exports.val=val,exports.numberBetween=numberBetween):(window.val=val,window.numberBetween=numberBetween,window.MyPromise=MyPromise,window.getHashParams=getHashParams,window.getParameterByName=getParameterByName,window.ifThenMessage=ifThenMessage,window.$U={store:store,whenProperties:whenProperties,expose:expose,fetchCountry:fetchCountry,scrollToTop:scrollToTop,indexOf:indexOf,url:queryString,hasUndefinedProps:hasUndefinedProps,cbHell:cbHell,onAnchorChange:onAnchorChange,valid:valid,val:val,setVal:setVal,numberBetween:numberBetween,MyPromise:MyPromise,getHashParams:getHashParams,getParameterByName:getParameterByName,ifThenMessage:ifThenMessage,has:has},window.$U=Eventify(window.$U)),function(global){function diagsGetAvailableRanges(order,ctrl){function diagsPriority(cb){ctrl("User","getAll",{userType:"diag",__rules:{disabled:{$ne:!0}},__select:"priority"}).then(function(data){cb(data.result.map(function(v){return{_id:v._id,priority:v.priority}}))})}function timeRangesDiagSayHeCantWorktype(cb){ctrl("TimeRange","getAll",{type:"work-exception",__select:"_user start end repeat"}).then(function(data){cb(data.result.map(function(v){return v}))})}function timeRangesDiagIsWorking(order,cb){ctrl("Order","getAll",{__select:"diagStart diagEnd _diag",__rules:{status:{$ne:"complete"}}}).then(function(data){data.result=data.result.filter(function(v){return moment(v.diagStart).isSame(moment(order.day),"day")}),cb(data.result.map(function(v){return{_user:v._diag,start:v.diagStart,end:v.diagEnd}}))})}function _data(cb){timeRangesDiagIsWorking(order,function(working){timeRangesDiagSayHeCantWorktype(function(exceptions){diagsPriority(function(diags){cb(working,exceptions,diags)})})})}function calc(order,working,exceptions,diags){return diagsCalculateAvailableSlots(order,working,exceptions,diags)}if(!isFinite(new Date(order.day)))throw Error("getAvailableRanges Invalid order day");return $U.MyPromise(function(resolve,error){_data(function(working,exceptions,diags){resolve(calc(order,working,exceptions,diags))})})}function diagsCalculateAvailableSlots(order,working,exceptions,diags){var slots={morning:[],afternoon:[]},diags=_.orderBy(diags,function(v){return v.priority});return diags.forEach(function(diag){if(isExceptionCollidingWholeDay(diag,order,exceptions))return void(DEBUG&&console.log(diag._id+" exception colliding whole day"));var _exceptions=orderDiagExceptions(order,diag,exceptions),_collisions=_.union(filterOrders(working,diag),_exceptions);if(_collisions=_.union(_collisions,slots.morning),_collisions=_.union(_collisions,slots.afternoon),slots.morning.length<2)if(freeMorning(order,_collisions))slots=allocateFixedMorning(slots,order,diag);else{var sumo=allocateMorning(diag,order,_collisions,slots);sumo&&slots.morning.length<2&&(_collisions.push(slots.morning[slots.morning.length-1]),allocateMorning(diag,order,_collisions,slots))}if(slots.afternoon.length<2)if(freeAfternoon(order,_collisions))slots=allocateFixedAfternoon(slots,order,diag);else{var sumo=allocateAfternoon(diag,order,_collisions,slots);sumo&&slots.afternoon.length<2&&(_collisions.push(slots.afternoon[slots.afternoon.length-1]),allocateAfternoon(diag,order,_collisions,slots))}}),_.union(slots.morning,slots.afternoon)}function allocateFixedMorning(_slots,order,diag){if(isToday(order))if(moment().isBefore(moment().hour(11).minutes(30)))if(moment().isBefore(moment().hour(8).minutes(0)))_slots.morning.push(slot(9,0,order,diag),slot(10,0,order,diag)),DEBUG&&console.log("allocate-fixed-morning-today-at-9h00-and-10h00-current-time-before-08h00: ");else{var fixed=moment().add(1,"hour");if(fixed.isBefore(moment().hour(11).minutes(30))){var minutes=10*parseInt(parseInt(fixed.minutes())/10,10);_slots.morning.push(slot(fixed.hours(),minutes,order,diag)),DEBUG&&console.log("allocate-fixed-morning-today-at: ",fixed),fixed=fixed.add(1,"hour"),fixed.isBefore(moment().hour(11).minutes(30))?(_slots.morning.push(slot(fixed.hours(),minutes,order,diag)),DEBUG&&console.log("allocate-fixed-morning-today-at: ",fixed)):DEBUG&&console.log("allocate-fixed-morning-today-skip: fixed beyond limit (11h30)",fixed)}else DEBUG&&console.log("allocate-fixed-morning-today-skip: fixed beyond limit (11h30)",fixed)}else DEBUG&&console.log("allocate-fixed-morning-skip-current-time-after-11h30: ",fixed);else _slots.morning.push(slot(9,0,order,diag),slot(10,0,order,diag));return _slots}function allocateFixedAfternoon(_slots,order,diag){if(isToday(order))if(moment().isAfter(moment().hour(13).minutes(0))){var fixed=moment().add(1,"hour"),limit=moment().hours(19).minutes(0).subtract(order.time.hours,"hours").subtract(order.time.minutes,"minutes");if(fixed.isBefore(limit)){var minutes=10*parseInt(parseInt(fixed.minutes())/10,10);_slots.afternoon.push(slot(fixed.hours(),minutes,order,diag)),DEBUG&&console.log("allocate-fixed-afternoon-today-at: ",fixed),fixed=fixed.add(1,"hour"),fixed.isBefore(limit)?(_slots.afternoon.push(slot(fixed.hours(),minutes,order,diag)),DEBUG&&console.log("allocate-fixed-afternoon-today-at: ",fixed)):DEBUG&&console.log("allocate-fixed-afternoon-today-skip: fixed beyond limit",limit,fixed)}else DEBUG&&console.log("allocate-fixed-afternoon-today-skip: fixed beyond limit",limit,fixed)}else _slots.afternoon.push(slot(14,0,order,diag),slot(15,0,order,diag)),DEBUG&&console.log("allocate-fixed-afternoon-today-at-14-and-15-current-time-before-13h00: ",fixed);else _slots.afternoon.push(slot(14,0,order,diag),slot(15,0,order,diag));return _slots}function isToday(order){return moment(order.day).isSame(moment(),"day")}function filterOrders(orders,diag){return orders.filter(function(v){return v._user==diag._id})}function allocateMorning(diag,order,collisions,arr){var startMinH=8,startMinM=0;if(isToday(order)){if(moment().isAfter(moment().hour(11).minutes(30)))return!1;startMinH=moment().add(1,"hour").hours(),startMinM=moment().minutes()}return allocate(startMinH,startMinM,11,30,diag,order,collisions,arr,"morning")}function allocateAfternoon(diag,order,collisions,arr){var startMinH=13,startMinM=0,startMax=moment(order.day).hours(19).minutes(0).subtract(order.time.hours,"hour").subtract(order.time.minutes,"minutes");if(isToday(order)){if(moment().isAfter(moment().hour(startMax.hours()).minutes(startMax.minutes())))return!1;startMinH=moment().add(1,"hour").hours(),startMinM=moment().minutes()}return allocate(startMinH,startMinM,startMax.hours(),startMax.minutes(),diag,order,collisions,arr,"afternoon")}function normalizeStart(start){start=moment(start);var h=start.hours(),m=start.minutes();return m>0&&30>m&&(m=30),m>30&&(m=0,h++),start.hours(h).minutes(m)}function allocate(startMinH,startMinM,startMaxH,startMaxM,diag,order,collisions,arr,propName){var startMin=moment(order.day).hour(startMinH).minutes(startMinM),startMax=moment(order.day).hour(startMaxH).minutes(startMaxM),cut=!1,start=moment(startMin),_cols=[],c=0;do{if(_cols=rangeCollisions4(start,order,collisions),0==_cols.length){if(_cols=rangeCollisions5(orderEnd(start,order),1,30,collisions),0==_cols.length){var _s=slot(start.hours(),start.minutes(),order,diag);return arr[propName].push(_s),!0}start=moment(_cols[_cols.length-1].end).add(1,"hours").add(30,"minutes"),start=normalizeStart(start)}else start=moment(_cols[_cols.length-1].end).add(1,"hours").add(30,"minutes"),start=normalizeStart(start);c++,c>20&&(cut=!0)}while(moment(start).isBefore(moment(startMax))||cut);return!1}function freeMorning(order,collisions){var lastAssignableMorningDate=moment(order.day).hours(11).minutes(30);return 0==collisions.filter(function(v){return moment(v.start).isBefore(lastAssignableMorningDate)}).length}function freeAfternoon(order,collisions){var minAssignableAfternoonDate=moment(order.day).hours(13).minutes(0);return 0==collisions.filter(function(v){return moment(v.start).isAfter(minAssignableAfternoonDate)}).length}function slot(h,m,order,diag){var start=moment(order.day).hour(h).minutes(m);return{_diag:diag._id,start:start,end:moment(start).add(order.time.hours,"hours").add(order.time.minutes,"minutes")}}function orderEnd(start,order){return moment(start).add(order.time.hours,"hours").add(order.time.minutes,"minutes")}function rangeCollisions5(date,hp,mp,collisions){return rangeCollisions2(date,moment(date).hours(),moment(date).minutes(),hp,mp,collisions)}function rangeCollisions4(start,order,collisions){return rangeCollisions(start,orderEnd(start,order),collisions)}function rangeCollisions2(date,h,m,hp,mp,collisions){var start=moment(date).hour(h).minutes(m),end=moment(start).add(hp,"hours").add(mp,"minutes");return rangeCollisions(start,end,collisions)}function rangeCollisions(start,end,collisions){var get=function(cb){return collisions.filter(function(v){return cb(v)})||[]},rta=get(function(r){return moment(r.start).isSameOrAfter(start)&&moment(r.start).isSameOrBefore(end)});return _.union(rta,get(function(r){return moment(r.end).isSameOrAfter(start)&&moment(r.end).isSameOrBefore(end)})),rta}function orderDiagExceptions(order,diag,exceptions){var repeatWeek,sameDOW,collide,sameDay=!1,repeatDay=!1;return exceptions.filter(function(range){return range._user!==diag._id?!1:(collide=!0,sameDay=moment(range.start).isSame(order.day,"day"),repeatDay="day"==range.repeat,repeatWeek="week"==range.repeat,sameDOW=moment(order.day).day()==moment(range.start).day(),collide=collide&&(sameDay||repeatDay||repeatWeek&&sameDOW))})}function isExceptionCollidingWholeDay(diag,order,exceptions){return exceptions.some(function(ex){var o=moment(order.day);return ex._user!=diag._id?!1:moment(ex.start).isBefore(o.hour(8).minutes(0))&&moment(ex.end).isAfter(o.hour(19).minutes(0))})}global.diagsCalculateAvailableSlots=diagsCalculateAvailableSlots,global.diagsGetAvailableRanges=diagsGetAvailableRanges;var DEBUG=!1}("undefined"!=typeof exports&&exports||window);var app=angular.module("app",["app.run","app.services","app.directives","app.static.calendar","ngRoute","ui.bootstrap"]),URL={HOME:"home",CONTACT_US:"contactez-nous",ERNT:"ernmt",FAQ:"faq",GENERAL_CONDITIONS:"conditions-generales-utilisation",LEGAL_MENTIONS:"mentions-legales",DIAGS:"choix-diagnostics",RDV:"rendez-vous",LOGIN:"connexion",NEW_ACCOUNT:"new-inscription",ACCOUNT_DETAILS:"account-details",ACCOUNT_DETAILS_BOOKING:"inscription-details",PAYMENT:"payment"};app.config(["$routeProvider",function($routeProvider){$routeProvider.when("/",{templateUrl:"views/booking/booking-1-home.html"}).when("/home",{templateUrl:"views/booking/booking-1-home.html"}).when("/mentions-legales",{templateUrl:"views/legal-mentions.html"}).when("/conditions-generales-utilisation",{templateUrl:"views/general-conditions.html"}).when("/ernmt",{templateUrl:"views/ernt.html"}).when("/faq",{templateUrl:"views/faq.html"}).when("/contactez-nous",{templateUrl:"views/contact-us.html"}).when("/choix-diagnostics",{templateUrl:"views/booking/booking-2-diags-selection.html"}).when("/rendez-vous",{templateUrl:"views/booking/booking-3-date-selection.html"}).when("/connexion",{templateUrl:"views/booking/booking-4-connection.html"}).when("/new-inscription",{templateUrl:"views/booking/booking-new-inscription.html"
}).when("/account-details",{templateUrl:"views/booking/booking-inscription-details.html"}).when("/inscription-details",{templateUrl:"views/booking/booking-5-inscription.html"}).when("/payment",{templateUrl:"views/booking/booking-6-payment.html"}).otherwise({redirectTo:"/"})}]),app.controller("ctrl.booking-contact-form",["server","$timeout","$scope","$rootScope","$uibModal",function(db,$timeout,s,r,$uibModal){s._email={},s.send=function(){db.ctrl("Email","contactFormSendToAllAdmins",s._email).then(function(d){d.ok?r.infoMessage("Message envoyé"):r.infoMessage("Problème de serveur , réessayer plus tard")})},s.validate=function(){ifThenMessage([[!s._email.fullname,"==",!0,"Prénom Nom requis"],[!s._email.email,"==",!0,"Email requis"],[!s._email.phone,"==",!0,"Phone requis"],[!s._email.message,"==",!0,"Message requis"]],function(m){s.warningMsg(m[0],1e4)},s.send)}}]),app.controller("ctrl.booking",["server","$timeout","$scope","$rootScope","$uibModal",function(db,$timeout,s,r,$uibModal){function resolvePaymentScreenAuth(){return $U.MyPromise(function(resolve,err,emit){return s._user&&s._user._id?($U.url.get("auth")||($U.url.set("auth",s._user._id),s.__manualUrlChange=(new Date).getTime()),void resolve()):$U.url.get("auth")?void db.ctrl("User","get",{_id:$U.url.get("auth")}).then(function(_user){return(_user=_user.ok&&_user.result||null)?(s._user=_user,$U.url.set("auth",s._user._id),s.__manualUrlChange=(new Date).getTime(),resolve(),void 0):r.route(URL.LOGIN)}):r.route(URL.LOGIN)})}function resolvePaymentScreenOrder(){if($U.url.get("order"))s._order._id||s.fetchOrder($U.url.get("order"));else if(s._order._id){if(!s._order._id)throw Error("ORDER-ID-NULL");s.__manualUrlChange=(new Date).getTime(),$U.url.set("order",s._order._id)}else s.saveAsync().on("success",function(){if(s.__manualUrlChange=(new Date).getTime(),!s._order._id)throw Error("ORDER-ID-NULL");$U.url.set("order",s._order._id)})}function atLeastOneDiagSelected(){for(var x in s.model.diags)if(1==s.model.diags[x])return!0;return!1}function setSelectedRangeIDUsingOrder(slots,rngId){return $U.val(s._order,"_diag._id")?rngId?null:void slots.forEach(function(v){var data=JSON.parse(window.atob(v.id));data._diag!=s._order._diag&&data._diag!=s._order._diag._id||data.start==s._order.diagStart&&data.end==s._order.diagEnd&&r.dom(function(){return s.model.range=v.id,v.id})}):void 0}function setSelectedRangeDateUsingOrder(){if($U.indexOf(r.__route,[URL.RDV])){var id=setSelectedRangeIDUsingOrder(s.slots1,null);id=setSelectedRangeIDUsingOrder(s.slots2,id),id=setSelectedRangeIDUsingOrder(s.slots3,id),id=setSelectedRangeIDUsingOrder(s.slots4,id)}}function stackCtrlPromise(id,db,arg1,arg2,arg3){window.___stackScope=window.___stackScope||{stacks:{}};var s=window.___stackScope;s.stacks[id]=s.stacks[id]||{flag:!1,promises:[],watcher:$U.on(id+"-stack-pop",function(){var stack=s.stacks[id];if(stack.promises.length>0){stack.flag=!0;var d=stack.promises.shift();db.ctrl(d.arg1,d.arg2,d.arg3).then(function(res){stack.flag=!1,console.log("stackCtrlPromise-watcher-resolve "+id+". left:"+stack.promises.length),$U.emit(id+"-stack-pop")})}})},s.stacks[id].promises.push({arg1:arg1,arg2:arg2,arg3:arg3}),0==s.stacks[id].flag&&setTimeout(function(){0==s.stacks[id].flag&&$U.emit(id+"-stack-pop")},50)}function orderPaid(){return _.includes($D.ORDER_STATUS_PAID,s._order.status)}function updateAutoSave(enabled){function cloneOrder(){s.__clonedOrder=_.cloneDeep(s._order)}enabled=enabled||!0;var saving=!1;return s.__autoSaveInterval&&window.clearInterval(s.__autoSaveInterval),enabled?s._order?(cloneOrder(),void(s.__autoSaveInterval=window.setInterval(function(){if(!saving&&s._order){var hasChanged=!_.isEqual(s.__clonedOrder,s._order);hasChanged&&(saving=!0,cloneOrder(),db.ctrl("Order","update",s._order).then(function(){saving=!1,console.info("auto-save: saved")}))}},5e3))):console.info("auto-save: call updateAutoSave _order exists"):console.info("auto-save: disabled")}function dtAfter(d1,d2,unit){return moment(d1).isAfter(moment(d2),unit)}function toggleMandatory(n,val){s.diags.forEach(function(diag){(n&&diag.name==n||!n)&&(diag.mandatory=val,r.dom())})}function updateChecksVisibilityOnDemand(){function updateChecks(){"Avant le 01/01/1949"===s.model.constructionPermissionDate?(toggle("crep",!0),s.model.diags.crep=!0,toggleMandatory("crep",!0)):(s.model.diags.crep=!1,toggle("crep",!0),toggleMandatory("crep",!1)),s.departmentHasTermites()?(toggle("termites",!0),s.model.diags.termites=!0,toggleMandatory("termites",!0)):(toggle("termites",!1),s.model.diags.termites=!1,toggleMandatory("termites",!1)),_.includes(["Avant le 01/01/1949","Entre 1949 et le 01/07/1997"],s.model.constructionPermissionDate)?(toggle("dta",!0),s.model.diags.dta=!0,toggleMandatory("dta",!0)):(toggle("dta",!0),s.model.diags.dta=!1,toggleMandatory("dta",!1)),_.includes(["Oui, Plus de 15 ans","Oui, Moins de 15 ans"],s.model.gasInstallation)?(toggle("gaz",!0),1==s.model.sell&&"Oui, Plus de 15 ans"===s.model.gasInstallation?(s.model.diags.gaz=!0,toggleMandatory("gaz",!0)):(s.model.diags.gaz=!1,toggleMandatory("gaz",!1))):(toggle("gaz",!1),toggleMandatory("gaz",!1)),_.includes(["Plus de 15 ans","Moins de 15 ans"],s.model.electricityInstallation)?(toggle("electricity",!0),1==s.model.sell&&"Plus de 15 ans"===s.model.electricityInstallation?(s.model.diags.electricity=!0,toggleMandatory("electricity",!0)):(s.model.diags.electricity=!1,toggleMandatory("electricity",!1))):(toggle("electricity",!1),toggleMandatory("electricity",!1))}var toggle=function(n,val){s.diags.forEach(function(diag){(n&&diag.name==n||!n)&&(diag.show=val,0==diag.show&&(s.model.diags[diag.name]=!1))})};s.diags.forEach(function(val,key){s.model.diags[val.name]=!!val.mandatory}),s.$watch("model.constructionPermissionDate",updateChecks),s.$watch("model.sell",updateChecks),s.$watch("model.gasInstallation",updateChecks),s.$watch("model.address",updateChecks),s.$watch("model.electricityInstallation",updateChecks),toggle(void 0,!0)}function loadDefaults(){s.model=Object.assign(s.model,{sell:paramBool("sell")||!0,house:paramBool("house")||!0,squareMeters:param("squareMeters",s.squareMeters)||"90 - 110m²",constructionPermissionDate:param("cpd",s.constructionPermissionDate)||void 0,address:param("address")||void 0,gasInstallation:param("gasInstallation",s.gasInstallation)||void 0,electricityInstallation:param("electricityInstallation",s.electricityInstallation)||void 0,date:paramDate("date"),time:param("time",["any"]),clientType:param("clientType",s.CLIENT_TYPES)}),r.dom(function(){try{var x=0;for(var pos in s.squareMeters){if(s.model.squareMeters==s.squareMeters[pos])break;x++}$("input[type=range]").val(x)}catch(e){}}),$U.emitPreserve("booking-defaults-change"),s.diags.forEach(function(diag){var val=paramBool(diag.name);_.isUndefined(val)||_.isNull(val)||(s.model.diags[diag.name]=val)})}function fetchOrder(_order_id){return $U.MyPromise(function(resolve,err,emit){var payload=Object.assign(s._order,{__populate:{_client:"_id email clientType address",_diag:"_id email clientType address firstName lastName"}});_order_id&&(payload._id=_order_id),db.ctrl("Order","getById",payload).then(function(d){d.ok?(console.info("fetch-order",payload._id,r.momentDateTime(d.result.diagStart)),r.dom(function(){setOrder(d.result)}),resolve(s._order)):err(d)})})}function setOrder(_order){s._order=_order,s._order.price=s.totalPrice(!0),commitOrderInfo(),updateAutoSave()}function commitOrderInfo(){s._order&&(void 0===s._order.info.house&&void 0!==s.model.house&&(s._order.info.house=s.model.house),void 0===s._order.info.sell&&void 0!==s.model.sell&&(s._order.info.sell=s.model.sell),!s._order.info.description&&s.model&&(s._order.info.description=s.bookingDescriptionTitle()+s.bookingDescriptionBody()),void 0==s._order.info.house&&console.warn("The order info.house is undefined."))}r.URL=URL,window.r=r,window.s=s,window.booking=s,r.dom(),moment.locale("fr");var MESSAGES={ANSWER_SELL_OR_RENT:"Répondre Vendez / Louer",ANSWER_APPARTAMENT_OR_MAISON:"Répondre Appartament / Maison",FRENCH_ADDRESS_REQUIRED:"Adresse besoin d&#39;appartenir à France"};s.STATIC={BOOKING_STRIPE_TEXT:"Paiement simplifié et sécurisé (PCI 1, le niveau le plus élevé) avec Stripe",BOOKING_HOME_BG_TEXT_1:"Accédez aux calendriers en live des diagnostiqueurs immobiliers certifiés, disponibles, au bon prix*",BOOKING_HOME_BG_TEXT_2:"Nous joindre au",BOOKING_HOME_BG_TEXT_PHONE:"0899 399 039"},s.isDevEnv=function(){return-1!==window.location.hostname.indexOf("diags-javoche.c9users.io")},$U.on("route-change",function(url){r.dom($U.scrollToTop),$U.indexOf(url,[URL.PAYMENT])?(s.__manualUrlChange||0)+5e3<(new Date).getTime()&&resolvePaymentScreenAuth().then(resolvePaymentScreenOrder):$U.url.clear(),$U.indexOf(url,[URL.HOME])||""==url?(s.__header=1,setTimeout(function(){$U.emit("render-ranges")},1e3)):s.__header=2,-1!==url.indexOf(URL.RDV)&&slotsDays.init(),$U.indexOf(url,[URL.ACCOUNT_DETAILS])&&(s._user&&s._user.__subscribeMode?delete s._user.__subscribeMode:(console.warn("current _user is not in _subscribeMode"),r.route(URL.HOME)))});var slotsDays=function(){function asyncRequest(_localCursor,cbHell,dataPosition){_localCursor=new Date(_localCursor),s.requestSlots(_localCursor).then(function(d){var d=_.orderBy(d,function(item){return item.start._d});if(d.length>4){try{db.ctrl("Log","create",{message:"booking-warning: date slot request retrieve "+d.length+" slots.",data:d})}catch(e){}for(;d.length>4;)d.pop()}_data[dataPosition]=new DaySlot(_localCursor,d),cbHell.next()})}var DaySlot=function(_date,_slots){var o={date:moment(_date),slots:_slots,label:function(){return o.isToday()?"Aujourd’hui":r.momentFormat(o.date,"dddd DD MMMM")},isToday:function(){return o.date.isSame(moment(),"day")}};return o},_data=[],_nextTimes=0,cursor=moment(),o={};return o.get=function(){return _data},o.init=function(){cursor=moment(),o.request()},o.nextIsDisabled=function(){return!1},o.next=function(){return _nextTimes>15?(_nextTimes=0,o.init()):(_nextTimes++,cursor=cursor.add(4,"days"),void o.request())},o.request=function(){var _localCursor=moment(cursor),cbHell=$U.cbHell(4,function(){setSelectedRangeDateUsingOrder()});asyncRequest(_localCursor._d,cbHell,0),_localCursor=_localCursor.add(1,"days"),asyncRequest(_localCursor._d,cbHell,1),_localCursor=_localCursor.add(1,"days"),asyncRequest(_localCursor._d,cbHell,2),_localCursor=_localCursor.add(1,"days"),asyncRequest(_localCursor._d,cbHell,3)},o}();s.slotsDays=slotsDays,s._user={address:null},s._order={},s.booking={order:{saved:!1,exists:!1,taken:!1},complete:!1,payment:{complete:!1}},s.checks={selectAll:!1},s.proceedToDiagsSelection=function(){s.validateQuestions(function(){r.route("choix-diagnostics")},function(){})},s.proceedToDateSelection=function(){s.validateQuestions(function(){return atLeastOneDiagSelected()?r.route("rendez-vous"):r.warningMessage("Sélectionnez au moins un choix")},function(){r.route("home")})},s.proceedToConnect=function(){setTimeout(function(){s.validateDate(function(){s._user&&s._user._id?r.route(URL.PAYMENT):r.route(URL.LOGIN)})},500)},s.dateSlot={proceedToConnect:s.proceedToConnect},s.validateBooking=function(cb){ifThenMessage([[s.isAgency()&&!s._order.landLordEmail,"==",!0,"E-mail du propriétaire requis"],[s.isAgency()&&!s._order.landLordFullName,"==",!0,"Nom du propriétaire requis"],[!s._order.keysAddress,"==",!0,"Clés Adresse requise"],[!s._order.keysTimeFrom,"==",!0,'Clés Temps "De" requis'],[!s._order.keysTimeTo,"==",!0,'Clés Temps "To" requis']],function(m){"string"!=typeof m[0]?s.warningMsg(m[0]()):s.warningMsg(m[0])},cb)},s.validateAuthInput=function(cb){ifThenMessage([[!s.auth.email,"==",!0,"Email required."],[!s.auth.pass,"==",!0,"Password required."]],function(m){"string"!=typeof m[0]?s.warningMsg(m[0]()):s.warningMsg(m[0])},cb)},s.validateClientDetails=function(cb){db.ctrl("User","exists",{email:s.auth.email,userType:"client"}).then(function(exists){exists=exists.ok&&1==exists.result,exists?s.warningMsg("This email address belongs to an existing member."):ifThenMessage([[!s._user.email,"==",!0,"Email c&#39;est obligatoire."],[!s._user.password,"==",!0,"Password c&#39;est obligatoire."],[!s._user.cellPhone,"==",!0,"Mobile c&#39;est obligatoire"]],function(m){"string"!=typeof m[0]?s.warningMsg(m[0]()):s.warningMsg(m[0])},cb)})},s.validateBeforePayment=function(cb,validateLoginAlso){return!validateLoginAlso||s._user&&s._user._id?void s.validateQuestions(function(){s.validateDate(cb,function(){return r.route(URL.RDV)})},function(){return r.route(URL.HOME)}):r.route(URL.LOGIN)},s.validateDate=function(cb,err){ifThenMessage([[s.model.diagStart,"==",void 0,""],[s.model.diagEnd,"==",void 0,""],[s.model._diag,"==",void 0,""]],function(m){s.warningMsg("Sélectionner une date"),err&&err()},cb)},s.validateQuestions=function(cb,err){ifThenMessage([[s.model.sell,"==",void 0,MESSAGES.ANSWER_SELL_OR_RENT],[s.model.house,"==",void 0,MESSAGES.ANSWER_APPARTAMENT_OR_MAISON],[s.model.squareMeters,"==",void 0,"Répondre Superficie"],[s.model.constructionPermissionDate,"==",void 0,"Répondre Permis de construire"],[s.model.gasInstallation,"==",void 0,"Répondre Gaz"],[s.model.electricityInstallation,"==",void 0,"Répondre Electricité"],[s.model.address,"==",void 0,"Répondre Address"],[_.includes(["France","Francia","Frankrig","Frankrijk","Frankreich","Frankrike","Francja"],s.model.country),"==",!1,MESSAGES.FRENCH_ADDRESS_REQUIRED]],function(m){s.warningMsg(m[0]),err&&err()},cb)},s.$watch("model.range",function(id){if(id){var data=JSON.parse(window.atob(id));s.model._diag=data._diag,s.model.diagStart=data.start,s.model.diagEnd=data.end}}),s.dateSlotSelected=function(rng){return s.model.range&&s.model.range==rng.id},s.orderDateFormatted=function(){s._order||console.warn("invalid-order");var _date=s._order&&s._order.diagStart,m=moment(_date).format("dddd D MMMM YYYY");return m+="à "+r.momentTime(_date),m.substring(0,1).toUpperCase()+m.slice(1)},s.orderDiagFormatted=function(){return"Avec "+(s._order&&s._order._diag&&s._order._diag.firstName&&s._order._diag.firstName+" "||"Pepe ")+(s._order&&s._order._diag&&s._order._diag.lastName&&s._order._diag.lastName.substring(0,1).toUpperCase()+" "||"G")},s.$watch("checks.selectAll",function(){s.diags&&s.diags.forEach(function(d){s.model.diags[d.name]=s.checks.selectAll})},!0),db.ctrl("Settings","getAll",{}).then(function(d){d.ok&&d.result.length>0&&(s.settings=d.result[0])}),db.ctrl("Text","getAll",{}).then(function(d){s.__texts=d.result,s.__texts.forEach(function(item){s.__text=s.__text||{},s.__text[item.code]=window.decodeURIComponent(item.content)})}),s.htmlReplaceDiagName=function(str){var code=str.replace("$NAME",s.diagSelected.label2).toUpperCase();return s.html(code)},s.html=function(code){var txt=s.STATIC[code]||"";if(s.__text&&s.__text[code]);else if(r.__textsNotFound=r.__textsNotFound||{},!r.__textsNotFound[code]&&(r.__textsNotFound[code]=code,s.isDevEnv())){var payload={code:code,categoryCode:$U.url.hashName()||"home",categoryRootCode:"DIAGS",content:txt};stackCtrlPromise("reportNotFound",db,"Text","reportNotFound",payload)}return s.__text&&s.__text[code]||txt||(s.isDevEnv()?code:"")},s.orderPaid=orderPaid,s.departmentHasTermites=function(){if(s.model.department){var code=s.model.postCode.substring(0,2);return _.includes(s.termitesDepartments.map(function(v){return v.toString()}),code)}},s.orderExistsNote=function(){if(s.booking.order.exists&&s.booking.order.saved){if("landlord"!==s._user.clientType){if(1!=s._order.landLordPaymentEmailSended)return"The payment of this order is pending.";s.booking.order.delegatedTo||(s.booking.order.delegatedTo=s._order.landLordEmail)}var delegated="The payment of this order was delegated to "+s.booking.order.delegatedTo;return orderPaid()?1==s._order.landLordPaymentEmailSended?"This order was delegated to "+s.booking.order.delegatedTo+" and is already paid.":"This order is already paid":delegated}},s.__keysWhereItems={},s.__keysWhereGetItems=function(){return s._user&&s._user.clientType?s.isLandLord()?{"Ou ?":function(){return""},"Diag Address":function(){return s._order.address},"Client Address":function(){return s._user.address},Other:function(){return"other"}}:{"Ou ?":function(){return""},"Diag Address":function(){return s._order.address},"Agency Address":function(){return s._user.address},"Landlord Address":function(){return s._order.landLordAddress},Other:function(){return"other"}}:{"Ou ?":function(){return""}}},s.$watch("_user",function(val){s.__keysWhereItems=s.__keysWhereGetItems()},!0),s.__keysWhereSelectFirstItem=function(){return s.__keysWhereItems&&Object.keys(s.__keysWhereItems)[0]||"Loading"},s.__keysWhereSelectLabel=function(){return s.__keysWhereSelectLabelVal||s.__keysWhereSelectFirstItem()},s.__keysWhereSelect=function(key,val){s._order.keysWhere=val&&val()||void 0},s.$watch("_order.keysWhere",function(val){return void 0==val?(r.dom(function(){s._order.keysAddress="non disponible"}),r.dom(function(){s._order.keysAddress=void 0},2e3),s.__keysWhereSelectLabelVal="Ou ?"):(Object.keys(s.__keysWhereItems).forEach(function(k){s.__keysWhereItems[k]()==val&&(s.__keysWhereSelectLabelVal=k)}),void(s._order.keysAddress="other"==val?"":val))}),s.__keysTimeFromItems={},s.__keysTimeFromGetItems=function(){var vals={};if(!s._order)return vals;for(var m=moment(s._order.diagStart).hours(8);m.isBefore(moment(s._order.diagStart));)vals[r.momentTime(m)]=new Date(m.toString()),m=m.add(5,"minutes");return vals[r.momentTime(s._order.diagStart)]=new Date(moment(s._order.diagStart).toString()),vals},s.__keysTimeFromSelectFirstItem=function(){return s.__keysTimeFromItems&&Object.keys(s.__keysTimeFromItems)[0]||"Loading"},s.__keysTimeFromSelectLabel="choisir",s.__keysTimeFromSelect=function(key,val){s._order.keysTimeFrom=val,dtAfter(s._order.keysTimeFrom,s._order.keysTimeTo)&&(s._order.keysTimeTo=void 0)},s.$watch("_order.keysTimeFrom",function(val){val?(s.__keysTimeFromSelectLabel="choisir",_.each(s.__keysTimeFromItems,function(v,k){v==val&&(s.__keysTimeFromSelectLabel=k)})):s.__keysTimeFromSelectLabel="choisir"}),s.$watch("_order.diagStart",function(val){s.__keysTimeFromItems=s.__keysTimeFromGetItems()}),s.__keysTimeToItems={},s.__keysTimeToGetItems=function(){var vals={};if(!s._order)return vals;var m=moment(s._order.diagStart).hours(8).minutes(0);for(moment(s._order.keysTimeFrom).isAfter(m)&&moment(s._order.keysTimeFrom).isBefore(moment(s._order.diagStart))&&(m=m.hours(moment(s._order.keysTimeFrom).hours()),m=m.minutes(moment(s._order.keysTimeFrom).minutes()));m.isBefore(moment(s._order.diagStart));)vals[r.momentTime(m)]=new Date(m.toString()),m=m.add(5,"minutes");return vals[r.momentTime(s._order.diagStart)]=new Date(moment(s._order.diagStart).toString()),vals},s.__keysTimeToSelectFirstItem=function(){return s.__keysTimeToItems&&Object.keys(s.__keysTimeToItems)[0]||"Loading"},s.__keysTimeToSelectLabel="choisir",s.__keysTimeToSelect=function(key,val){s._order.keysTimeTo=val},s.$watch("_order.keysTimeTo",function(val){val?(s.__keysTimeToSelectLabel="choisir",_.each(s.__keysTimeToItems,function(v,k){v==val&&(s.__keysTimeToSelectLabel=k)})):s.__keysTimeToSelectLabel="choisir"}),s.$watch("_order.keysTimeFrom",function(val){s.__keysTimeToItems=s.__keysTimeToGetItems()}),s.$watch("_order.diagStart",function(val){s.__keysTimeToItems=s.__keysTimeToGetItems()}),r.logger.addControlledErrors(["ORDER_EXISTS","ORDER_TAKEN"]),s.datepicker={minDate:moment(),maxDate:moment().add(60,"day"),initDate:new Date},s.CLIENT_TYPES=["agency","enterprise","landlord","other"],s.CLIENT_TYPES_COMPANY=["agency","enterprise","other"],s.isLandLord=function(){return!_.includes(s.CLIENT_TYPES_COMPANY,s._user.clientType)},s.isAgency=function(){return!s.isLandLord()},s.model={date:void 0,diags:{},clientType:"landlord"};var waitForProperties=function(cbArray,props){var i=setInterval(function(){var rta=!0;props.forEach(function(v){_.isUndefined(s[v])&&(rta=!1)}),rta&&(clearInterval(i),cbArray.forEach(function(cb){cb()}))},200)};s.__constructionPermissionDateSelectLabel="choisir",s.__constructionPermissionDateSelect=function(key,val){s.model.constructionPermissionDate=val},s.$watch("model.constructionPermissionDate",function(val){s.__constructionPermissionDateSelectLabel=val?val:"choisir",r.dom()}),s.__gazSelectLabel="choisir",s.__gazSelect=function(key,val){s.model.gasInstallation=val},s.$watch("model.gasInstallation",function(val){s.__gazSelectLabel=val?val:"choisir",r.dom()}),s.diagRightClass=function(){var cls={"diag-dialog-right":!0,"margin-top-three":!0,"padding-three":!0};return cls["bg-"+s.diagSelected.name]=!0,cls},s.diagSelected={},s.selectDiag=function(d){return s.diagSelected="string"==typeof d?s.diag[d]:d},s.homeOneTitle=function(){return decodeURI(val(s.diagSelected,"dialogs.one.title"))},s.homeOneContent=function(){return decodeURI(val(s.diagSelected,"dialogs.one.content"))},s.homeTwoTitle=function(){return decodeURI(val(s.diagSelected,"dialogs.two.title"))},s.homeTwoContent=function(){return decodeURI(val(s.diagSelected,"dialogs.one.content"))},s.homeThreeTitle=function(){return decodeURI(val(s.diagSelected,"dialogs.two.title"))},s.homeThreeContent=function(){return decodeURI(val(s.diagSelected,"dialogs.three.content"))},db.localData().then(function(data){Object.assign(s,data),s.diags=_.sortBy(s.diags,function(o){return o.sort}),s.diag=s.diag||{},s.diags.forEach(function(diag){s.diag[diag.name]=diag}),s.diagSelected=s.diag.dpe,updateChecksVisibilityOnDemand(),waitForProperties([loadDefaults,r.dom],["notify"])});var diagDescription=function(n){var rta=n;return s.diags.forEach(function(diag){n&&diag.name==n&&(rta=diag.label)}),"cpd"===n&&(rta="constructionPermissionDate"),rta},diag=function(n){var rta=null;return s.diags.forEach(function(diag){n&&diag.name==n&&(rta=diag)}),rta};s.diagLabel=function(n,v){return v?diag(n).label:void 0},s.diagPrice=function(n,v){return v?diag(n).price:void 0};var param=function(n,validate){var val=getParameterByName(n);if(val){if(validate){var vals=Object.keys(validate).map(function(v){return validate[v]});if(vals.length>0&&!_.includes(vals,val)){var msg="Parameter "+diagDescription(n)+" has the follow valid values:"+JSON.stringify(vals);return console.warn(msg),void s.notify(msg,"warning",0,!0,{duration:99999})}return val}return val}},paramDate=s.paramDate=function(n){var v=(getParameterByName(n)||"").toString(),d=new Date(v);if(isFinite(d)){var fail=!1;return moment(d).isBefore(s.datepicker.minDate,"day")&&(fail=!0),moment(d).isAfter(s.datepicker.maxDate,"day")&&(fail=!0),fail?void s.notify("Parameter "+n+" needs to be a valid date between "+s.datepicker.minDate.format("DD/MM/YY")+" and "+s.datepicker.maxDate.format("DD/MM/YY"),"warning",0,!0,{duration:99999}):d}null!==getParameterByName(n)&&s.notify("Parameter "+n+" needs to be a valid date","warning",0,!0,{duration:99999})},paramBool=function(n){var v=(getParameterByName(n)||"").toString();return _.includes(["1","0"],v)?"1"===v:void(null!==getParameterByName(n)&&s.notify("Parameter "+n+" needs to be a 1/0","warning",0,!0,{duration:99999}))};s.toggleMandatory=toggleMandatory,s.lineThrough=function(item){return 0==item.show},s.requestSlots=function(date){return $U.MyPromise(function(resolve,error,evt){if(isFinite(new Date(date))){var time=s.totalTime(),order={day:date,time:time};db.getAvailableRanges(order).then(function(data){if(data=data.length>0&&data||null,"any"==s.model.time&&data&&s.availableTimeRanges.length>0&&s.pickTimeRange(data[0]),data){var cbHell=$U.cbHell(data.length,function(){resolve(data)});data.forEach(function(r){if(r.id=window.btoa(JSON.stringify(r)),0===moment(date).day()){var basePriceIncr=100;r.price=s.totalPriceRange(date),r.price+=r.price*basePriceIncr/100}else r.price=s.totalPriceRange(date);db.ctrl("User","get",{_id:r._diag}).then(function(d){d.ok&&d.result&&(r.name=d.result.firstName+", "+d.result.lastName.substring(0,1),d.result.diagPriority&&(r.name+=" ("+d.result.diagPriority+")"),cbHell.next())})})}})}})},s.selectedDate=function(){return moment(s.model.date).format("DD MMMM YYYY")},s.drawRange=function(rng){var rta=moment(rng.start).format("HH[h]mm");return rta+=" - "+rng.price+" €"},s.infoMsg=function(msg){s.notify(msg,{type:"info",duration:5e3})},s.warningMsg=function(msg){s.notify(msg,{type:"warning",duration:5e3})},s.successMsg=function(msg){s.notify(msg,{type:"success",duration:2e3})},s.auth={email:void 0,pass:void 0},s.orderSaved=function(){return s._order&&s._order._id},s.paymentDelegated=function(){return 1==s._order.landLordPaymentEmailSended},s.login=function(){s.validateAuthInput(function(){db.ctrl("User","get",{email:s.auth.email,password:s.auth.pass,userType:"client"}).then(function(_user){_user=_user.ok&&_user.result||null,_user?(s.model.clientType=_user.clientType,s._user=_user,s.validateBeforePayment(function(){s.saveAsync().on("success",function(){s.route(URL.PAYMENT)})},!0)):s.warningMsg("Invalid credentials")})})},s.invoiceEndOfTheMonth=function(){s.validateBooking(function(){db.ctrl("Order","confirm",s._order).then(function(d){d.ok&&(s.booking.complete=!0,db.ctrl("Order","update",s._order))})})},s.bookingDescriptionTitle=function(){return s.model.sell?"Pack Vente:":"Pack Location:"},s.bookingDescriptionBody=function(){var rta="";return rta+=s.model.house?"Maison":"Appartement",s.model.city&&(rta+=" à "+s.model.city),s.model.constructionPermissionDate&&(rta+=" "+s.model.constructionPermissionDate),rta+=", "+s.model.squareMeters,_.includes(["Non","Oui, Moins de 15 ans"],s.model.gasInstallation)||(rta+=", Gaz"),"Moins de 15 ans"!=s.model.electricityInstallation&&(rta+=", Électricité"),rta+="."},s.bookingDescription=function(){return s.bookingDescriptionTitle()+s.bookingDescriptionBody()},s.sendPaymentLink=function(){function _sendPaymentLink(){db.ctrl("Order","update",s._order),s.openConfirm("Vous souhaitez envoyer un lien de paiement pour "+s._order.landLordEmail+" ?",function(){s.infoMsg("Sending email."),db.ctrl("Email","orderPaymentLink",s._order).then(function(data){s.infoMsg("Email envoyer avec succès. Suivi de votre commande dans le back office."),s._order.landLordPaymentEmailSended=!0,s._order.status="ordered",db.ctrl("Order","update",{_id:s._order._id,landLordPaymentEmailSended:!0}),s.booking.complete=!0})})}s.validateBooking(_sendPaymentLink)},s.subscribeClientStandAlone=function(){s.createClient(function(){s.infoMsg("Le compte a été créé . Vérifiez votre email ."),r.route(URL.HOME)})},s.subscribeClient=function(){s.createClient(function(){s.validateBeforePayment(function(){s.saveAsync().on("success",function(){s.route(URL.PAYMENT)})},!0)})},s.createClient=function(cb){s.validateClientDetails(function(){db.ctrl("User","createClient",s._user).then(function(data){data.ok?(s._user=data.result,cb()):s.warningMsg(data.err)})})},s.subscribeModeBooking=function(clientType){return s.subscribe(clientType,URL.ACCOUNT_DETAILS_BOOKING)},s.subscribeMode=function(clientType){return s.subscribe(clientType,URL.ACCOUNT_DETAILS)},s.subscribe=function(clientType,nextRoute){s.validateAuthInput(function(){db.ctrl("User","exists",{email:s.auth.email,userType:"client"}).then(function(exists){exists=exists.ok&&1==exists.result,exists?s.warningMsg("This email address belongs to an existing member."):(s._user.email=s.auth.email,s._user.password=s.auth.pass,s._user.clientType=clientType,s._user.__subscribeMode=!0,r.route(nextRoute))})})},s.fetchOrder=fetchOrder,s.saveAsync=function(){return $U.MyPromise(function(resolve,err,evt){return s._user&&(s.model._client=s._user,s.model.email=s._user.email,s.model.clientType=s._user.clientType),!s.model.keysTimeFrom&&s.model.diagStart&&(s.model.keysTimeFrom=moment(s.model.diagStart).subtract(2,"hour")),!s.model.keysTimeTo&&s.model.diagStart&&(s.model.keysTimeTo=moment(s.model.diagStart)),s.model.price=0,$U.hasUndefinedProps(s.model,["_diag","diagStart","diagEnd"])?(s.warningMsg("Select one available date"),r.route(URL.RDV)):void db.ctrl("Order","saveWithEmail",s.model).then(function(data){var saved=data.ok;console.info("save-order",data.err);var exists="ORDER_EXISTS"===data.err,taken="ORDER_TAKEN"===data.err;(exists||taken)&&(saved=!0),r.dom(function(){return setOrder(data.result),updateAutoSave(),saved&&evt("success"),saved?(db.ctrl("Order","getById",Object.assign(s._order,{__populate:{_client:"_id email clientType address discount",_diag:"_id email clientType address firstName lastName"}})).then(function(d){d.ok&&setOrder(d.result)}),saved&&s.successMsg("Order created"),exists&&s.successMsg("Order retaken"),s._orderSAVED=saved||exists,s.booking.order.saved=saved||exists||taken,s.booking.order.exists=exists,void(s.booking.order.taken=1==taken)):(console.warn("save-error",data),s.warningMsg("An error occured, please try again later"))})}).err(function(err){s.notify("There was a server issue during the order saving proccess. Retrying in 10 seconds. Wait.",{type:"warning",duration:1e5}),setTimeout(s.saveAsync,1e4)})})},s.payNOW=function(success){return orderPaid()?s.infoMsg("Son ordre de travail a déjà été payée"):void s.validateBooking(function(){db.ctrl("Order","update",s._order),db.ctrl("User","update",s._user);var order=s._order;openStripeModalPayOrder(order,function(token){order.stripeToken=token.id,db.ctrl("Order","pay",order).then(function(data){data.ok?(s._order.status="prepaid",s.booking.complete=!0,s.booking.payment.complete=!0,db.ctrl("Order","update",s._order),console.info("PAY-OK",data.result),s.notify("Order payment success. We send you an email.",{type:"success",duration:1e5}),r.dom(function(){return s._order={}}),updateAutoSave(!1),$U.url.clear(),r.route(URL.HOME)):(console.info("PAY-FAIL",data.err),s.notify("There was a server issue during the payment proccess. You pay later from the back-office.",{type:"warning",duration:1e5}))}).error(function(){s.notify("There was a server issue during the payment proccess. You pay later from the back-office.",{type:"warning",duration:1e5})})},{config:r.config})})},s.getDate=function(){return{date:moment(s.model.diagStart).format("DD-MM-YY"),start:moment(s.model.diagStart).format("HH[h]mm"),end:moment(s.model.diagEnd).format("HH[h]mm")}},s.subTotal=function(){return subTotal(s._order,s.diags,s.basePrice)},s.sizePrice=function(){return sizePrice(s._order,s.diags,s.squareMetersPrice,s.basePrice)},s.totalPrice=function(showRounded,opt){return totalPrice(showRounded,s._order,s.diags,s.squareMetersPrice,s.basePrice,Object.assign({s:s,r:r},opt||{}))},s.totalPriceRange=function(dt){return totalPrice(!0,s.model,s.diags,s.squareMetersPrice,s.basePrice,Object.assign({s:s,r:r,dt:dt},{}))},s.pickTimeRange=function(timeRange){s.model.diagStart=timeRange.start,s.model._diag=timeRange._diag,s.model.diagEnd=timeRange.end,s.model.price=timeRange.price,timeRange.price||console.warn("time-range invalid price attribute",timeRange)},s.totalTime=function(){var total=0;s.model.diags=s.model.diags||{},Object.keys(s.model.diags).forEach(function(mkey){s.model.diags[mkey]&&s.diags.forEach(function(dval,dkey){return dval.name==mkey?(dval.time=dval.price/4,total+=dval.time||0,!1):void 0})}),total=10*parseInt(parseInt(total)/10,10)+10;var hours=Math.floor(total/60),minutes=total%60,t={hours:hours,minutes:minutes};return t},s.totalTime.formatted=function(){var time=s.totalTime(),hours=time.hours,minutes=time.minutes;return minutes=10>minutes?"0"+minutes:minutes,hours>0?hours+":"+minutes+" hours":minutes+" minutes"}}]),app.directive("niceCheckBox",function($rootScope,$timeout,$compile){return{restrict:"E",scope:{model:"=model",data:"=data",name:"@name",template:"@template",click:"=click"},templateUrl:"views/directives/checkbox.html",link:function(scope,el,attrs){var url="views/directives/checkbox.html";scope.template&&(url=url.replace(".html","-")+scope.template+".html"),$.ajax({url:url,async:!1,success:function(r){var e=$compile(r)(scope),cls=attrs["class"];el.replaceWith(e),$timeout(function(){el.children(0).addClass("class",cls),el.find("input").name=scope.name,$rootScope.$apply()})},error:function(err){console.error("niceCheckBox invalid template ",url,err);
}})}}}),app.directive("checkBoxGroup",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){el.on("click",function(){var $box=$(this),group="input:checkbox[name='"+$box.attr("name")+"']";$(group).prop("checked",!1),$(group).prop("disabled",!1),$box.prop("checked",!0),$box.prop("disabled",!0)})}}}),app.directive("checkBoxModel",function($rootScope,$timeout,$compile){return{restrict:"A",scope:!1,link:function(scope,el,attrs){function set(_val){var ss=scope,split=attrs.checkBoxModel.split("."),last=split[split.length-1];split.forEach(function(word){return word!=last?(ss=$rootScope.lookUp(ss,word),void 0==ss?(console.warn("checkBoxModel ",attrs.checkBoxModel,word+" is undefined"),0):void 0):void 0}),void 0!=ss&&(ss[last]=_val,$timeout($rootScope.$apply()))}el.on("change",function(){if(el.prop("checked")){var v,p=attrs.value.toString();v="false"==p||"true"==p?"true"==p:p,set(v)}})}}}),app.directive("toggleClick",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){function val(value){var ss=scope,split=attrs.toggleValue.split("."),last=split[split.length-1];return split.forEach(function(word){return word!=last?(ss=ss[word],void 0==ss?(console.warn("toggleValue ",attrs.toggleValue,word+" is undefined"),0):void 0):void 0}),void 0!=ss?void 0===value?ss[last]:(ss[last]=value,void $timeout($rootScope.$apply())):void 0}el.on("click",function(){var v="string"==typeof attrs.ngValue&&"true"==attrs.ngValue.toLowerCase()||1==attrs.ngValue;val(v)}),$rootScope.$emit(attrs.toggleValue+"-changed",val())}}}),app.directive("toggleClass",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){function update(v){v==val?el.addClass(attrs.toggleClass):el.removeClass(attrs.toggleClass)}var val="string"==typeof attrs.ngValue&&"true"==attrs.ngValue.toLowerCase()||1==attrs.ngValue;return attrs.toggleValue?($rootScope.$on(attrs.toggleValue+"-changed",function(evt,v){}),void scope.$watch(attrs.toggleValue,function(v){"boolean"==typeof v&&update(v)})):console.warn("toggle-class: toggle-value attribute required.")}}}),app.directive("rangeModel",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){function update(){var index=el.val();set(get(index),scope),$timeout(function(){$rootScope.$apply()})}function get(index){return vals[Object.keys(vals)[index]]}function set(val,ss){var split=attrs.rangeModel.split(".");split.forEach(function(word){if(word!=split[split.length-1]&&(ss=ss[word],void 0==ss))throw Error(word," is undefined")}),ss[split[split.length-1]]=val,setDomVal(val,vals)}function setDomVal(val,valsObject){$rootScope.dom(function(){try{var x=0;for(var pos in valsObject){if(val==valsObject[pos])break;x++}$("input[type=range]").val(x)}catch(e){}})}if(!attrs.rangeValues)throw Error("rangeModel: rangeValues attribute requited.");var vals=scope[attrs.rangeValues];$timeout(function(){el.attr("min",0),el.attr("max",Object.keys(vals).length-1),el.attr("step",1),$rootScope.$apply()}),el.on("input",update),$U.on("render-ranges",function(){setDomVal($U.val(scope,attrs.rangeModel),vals)})}}}),app.directive("removeHidden",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){$rootScope.dom(function(){el.removeClass("hidden")},2e3)}}});var srv=angular.module("app.services",[]);srv.service("tpl",function($rootScope,$compile,$templateCache){var _this=this;this.compile=function(n,s){var raw=$templateCache.get(n+".html");return _this.compileRaw(raw,s)},this.compileRaw=function(raw,s){var el=$compile(angular.element(raw))(s);return el},expose("tpl",this)}),srv.service("$mongoosePaginate",["server",function(db){function handler(modelName){var self=this;self.working=!1,self.ctrl=function(data,model){return MyPromise(function(resolve,err,emit){return model.pagination?self.working?console.warn("$mongoosePaginate is working, wait."):(self.working=!0,void db.ctrl(modelName,"paginate",Object.assign({__limit:model.pagination.itemsPerPage,__lean:!0,__page:model.pagination.currentPage},data)).then(function(r){if(!r.ok)return void(self.working=!1);var numberOfPages=r.result.pages;self.working=!1,model.pagination&&model.pagination.update({itemsLength:r.result.docs.length,numPages:numberOfPages,total:r.result.total}),r.result=r.result.docs,resolve(r)})):(err("model.pagination required."),void console.warn("$mongoosePaginate model.pagination required."))})}}var handlers={};return{get:function(modelName){return handlers[modelName]||(handlers[modelName]=new handler(modelName)),handlers[modelName]}}}]),srv.service("localdb",["$http",function(http){return function(settings){return MyPromise(function(resolve){resolve({localdb:!0})})}}]),srv.directive("fileModel",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attrs){var model=$parse(attrs.fileModel),modelSetter=model.assign;element.bind("change",function(){scope.$apply(function(){modelSetter(scope,element[0].files[0])})})}}}]),srv.service("fileUpload",["$http",function($http){this.single=function(opt,success,err){var fd=new FormData;Object.keys(opt.data).forEach(function(key){fd.append(key,opt.data[key])}),fd.append("file",opt.file),$http.post(opt.url,fd,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(success).error(err)}}]),srv.service("server",["$http","localdb","$rootScope","fileUpload",function(_http,localdb,r,fileUpload){function getLocalData(){return MyPromise(function(resolve,error){localData?resolve(localData):$.getJSON("./data.json",function(data){localData=data,resolve(localData)}).fail(function(jqxhr,textStatus,error){var err=textStatus+", "+error;console.log("Request Failed: "+err)})})}function handleError(_log,err){_log(err)}function get(relativeUrl,data,callback){var _log=logger(relativeUrl,data);_http({method:"GET",data:data,url:_URL+"/"+relativeUrl}).then(function(res){_log(res),callback&&callback(res)},function(err){return handleError(_log,err)})}function _post(relativeUrl,data,callback,error){data=data||{};var _log=logger(relativeUrl,data);globalState.async&&(data=Object.assign(data,{___serviceOptions:{logAsAsync:!0}}),delete globalState.async),data.___serviceOptions&&1==data.___serviceOptions.logAsAsync&&_log.registerAsync(),$U.once("server-up",function(){_http({method:"POST",data:data,url:_URL+"/"+relativeUrl}).then(function(res){return _log(res),res.data&&0==res.data.ok&&console.warn("SERVER:REQUEST:WARNING = ",res.data.err||"Unkown error detected",relativeUrl),callback(res)},function(err){handleError(_log,err),error(err)})})}function login(data){return console.log("SEVICE LOGIN",data),MyPromise(function(resolve,error){_post("login",data,function(res){resolve(res)},error)})}function save(table,data){return MyPromise(function(resolve,error){_post("save/"+table,data,function(res){resolve(res)},error)})}function getSingle(table,data){return MyPromise(function(resolve,error){_post("get/"+table,data,function(res){resolve(res)},error)})}function getAll(table,data){return MyPromise(function(resolve,error){get("getAll/"+table,data,function(res){resolve(res)},error)})}function custom(controller,action,data,method){return MyPromise("get"===method?function(resolve,error){get(controller+"/"+action,data,function(res){resolve(res)},error)}:function(resolve,error){_post(controller+"/"+action,data,function(res){resolve(res)},error)})}function ctrl(ctrl,action,data){return MyPromise(function(resolve,error){_post("ctrl/"+ctrl+"/"+action,data,function(res){return resolve(res.data)},error)})}var _URL="http://localhost:5000";$.ajax("/serverURL").then(function(r){_URL=r.URL,$U.emitPreserve("server-up"),console.info("server:url(env serverURL):"+_URL)});var globalState={},localData=null,spinner=function(){return function(v){r.showSpinner=v,r.dom()}}(),logger=function(){var _controlledErrorsStrings=[],_controlledErrors={},_errors={},_logs={},fn=new function(){var self=this;return self.id=newId(20),function(url,req){var item={url:url,req:req};_logs[self.id]=item,setTimeout(function(){void 0!==_logs[self.id]&&(item.err="Logger: request timeout.",delete _logs[self.id])},3e4),r.$emit("logger.working");var rta=function(res){if(!_.isUndefined(_logs[self.id])){if(res.data||res.result){var data=res.data||res;data.ok!==!0&&(item.err=data.err||data,item.message=data.message||null,_.includes(_controlledErrorsStrings,item.err)?_controlledErrors[self.id]=item:item.err&&item.err.type&&_.includes(_controlledErrorsStrings,item.err.type)?(item.message=item.err.message,_controlledErrors[self.id]=item):_errors[self.id]=item)}else item.err="Server down, try later.",_.includes(_controlledErrorsStrings,item.err)?_controlledErrors[self.id]=item:_errors[self.id]=item;_.isUndefined(_logs[self.id])||delete _logs[self.id],0===Object.keys(_logs).length&&r.$emit("logger.clear")}};return rta.registerAsync=function(){delete _logs[self.id],r.$emit("logger.clear")},rta}};return fn.addControlledErrors=function(arr){_controlledErrorsStrings=_.union(arr,_controlledErrorsStrings)},fn.clearErrors=function(){return _errors={}},fn.hasErrors=function(){return Object.keys(_errors).length>0},fn.hasPending=function(){return Object.keys(_logs).length>0},fn.pending=function(){var msg="Pending<br>";return _.each(_logs,function(v,k){console.info(v.url),""!==msg&&(msg+="<br>"),msg+=v.url+": "+JSON.stringify(v.req)}),msg},fn.errors=function(){var msg="Errors<br>";return _.each(_errors,function(v,k){console.info(v),""!==msg&&(msg+="<br>");try{msg+=v.url+": "+JSON.stringify(v.err)}catch(e){msg+=v.url+": Unparseable error. See the console."}}),msg},r.state={working:function(){return fn.hasPending()},data:_logs},r.logger=fn,fn}();r.$on("logger.working",function(){spinner(!0)}),r.$on("logger.clear",function(){spinner(!1)}),r.get=get;var ws={URL:function(){return _URL},getAvailableRanges:function(order){return diagsGetAvailableRanges(order,ctrl)},login:login,save:save,get:getSingle,getAll:getAll,localData:getLocalData,custom:custom,http:function(ctrl,action,data){return _http.post(_URL+"/ctrl/"+ctrl+"/"+action,data)},form:function(relativeURL,data){if(!data.file)throw Error("form: file arg required");return MyPromise(function(r,err){var file=data.file;delete data.file;var _log=logger(relativeURL,data);fileUpload.single({url:_URL+"/"+relativeURL,file:file,data:data},function(res){_log(res),r(res)},function(res){_log(res),err(res)})})},setAsync:function(){return globalState.async=!0,ws},ctrl:ctrl,$get:function(url,config){return MyPromise(function(resolve,error){var _log=logger(url,data);_http.get(url,config).then(function(res){_log({ok:!0,result:res}),resolve(res)},function(err){_log({ok:!1,err:err}),error(err)})})},$post:function(url,data,config){return MyPromise(function(resolve,error){var _log=logger(url,data);_http.post(url,data,config).then(function(res){_log({ok:!0,result:res}),resolve(res)},function(err){_log({ok:!1,err:err}),error(err)})})},post:function(url,data){return MyPromise(function(resolve,error){_post(url,data,function(res){resolve(res)},error)})}};return r.ws=ws,ws}]);var app=angular.module("app.run",[]);app.config(["$httpProvider",function($httpProvider){$httpProvider.defaults.useXDomain=!0,delete $httpProvider.defaults.headers.common["X-Requested-With"]}]),app.run(["server","$timeout","$rootScope",function(db,$timeout,r){r.__debugDiags=!1;var keyword="";$(window).on("keyup",function(ev){ev=ev||window.event;var key=String.fromCharCode(ev.which);13==ev.which?("debug"==keyword.toLowerCase()?(r.__debugDiags=!0,console.info("debug-mode-on")):r.__debugDiags=!1,keyword="",r.dom()):keyword+=key})}]),app.run(["server","$timeout","$rootScope",function(db,$timeout,r){function getMessage(msg){return"function"==typeof msg?msg():"string"!=typeof msg&&msg.length?getMessage(msg[0]):msg}r.URL={LOGIN:"login",DIAG_SIGN_UP:"diag-inscription",HOME:"home",CONTACT_US:"contactez-nous",ERNT:"ernt",FAQ:"faq",GENERAL_CONDITIONS:"conditions-generales-utilisation",LEGAL_MENTIONS:"mentions-legales"},r.navShow=!0,r.toggleNavbar=function(val){r.navShow=val,r.dom()},r.secureSection=function(_s){_s.show=!1,r.logged()?(_s.show=!0,db.ctrl("User","getById",r.session()).then(function(d){d.ok&&d.result&&r.session(d.result)})):(console.warn("secureSection:redirecting to login"),r.route("login"))},r.handleSecurityRouteViolation=function(){r.route("dashboard"),console.warn("SECURITY: YOU-DONT-BELONG-HERE")},$("html").keydown(function(event){if("27"==event.keyCode&&r.params&&r.params.prevRoute&&r.__currentCtrlScope&&r.__currentCtrlScope.back){if(r.state.working())return void r.message("Loading...",{type:"warning",duration:2e3});var fn=r.__currentCtrlScope.back;r.__currentCtrlScope=null,fn()}}),r.setCurrentCtrl=function(_s){r.__currentCtrlScope=_s},r.errorMessage=function(msg,duration){msg=getMessage(msg),r.notify(msg,{type:"danger",duration:duration||3e3})},r.warningMessage=function(msg,duration){msg=getMessage(msg),r.notify(msg,{type:"warning",duration:duration||3e3})},r.infoMessage=function(msg,duration){msg=getMessage(msg),r.notify(msg,{type:"info",duration:duration||3e3})},r.successMessage=function(msg,duration){msg=getMessage(msg),r.notify(msg,{type:"success",duration:duration||3e3})}}]),app.run(["server","$timeout","$rootScope",function(db,$timeout,r){window.r=r,r.getHashParams=getHashParams,r.debug=!0,r.config={},db.localData().then(function(data){return Object.assign(r.config,data.config||{})}),r.__cache={},r.cache=function(n,o){return o?r.__cache[n]=o:(!_.isUndefined(r.__cache[n])&&!_.isNull(r.__cache[n]),r.__cache[n]||null)},r.momentFormat=function(d,f){return moment(d).format(f)},r.momentTime=function(d){return moment(d).format("HH[h]mm")},r.momentDateTime=function(d){return moment(d).format("DD-MM-YY HH[h]mm")},r.dom=function(cb,timeout){$timeout(function(){cb&&cb(),r.$apply()},timeout||0)},r.toggleBody=function(val){r.dom(function(){var el=document.body;el.className=el.className.replace("hidden","").trim(),val||(el.className=(el.className+" hidden").trim())})},r.db=function(){var lib=new localStorageDB("inspectors",localStorage),db={setUnique:function(tableName,data){lib.insertOrUpdate(tableName,{ID:1},data),lib.commit()},getUnique:function(tableName){return lib.queryAll(tableName)[0]},getAll:function(tableName){return lib.queryAll(tableName)}};return db.createSession=function(force){force&&lib.tableExists("session")&&lib.dropTable("session"),lib.createTable("session",["_id","email","expire","userType","password","rememberPass","clientType"]),db.setUnique("session",{_id:null,email:null,expire:null,password:null,userType:null,clientType:null,rememberPass:!0})},lib.tableExists("session")||db.createSession(),db}(),r.session=function(data){return data&&(r.db.setUnique("session",data),r._session=data),Object.assign(r.db.getUnique("session"),r._session||{})},r.logged=function(){var ss=r.session();return null!==ss.email&&null!==ss.password},r.viewAsClient=function(){r._session=r._session||{},r._session.userType="client",r.dom()},r.viewAsDiag=function(){r._session=r._session||{},r._session.userType="diag",r.dom()},r.viewAsAdmin=function(){r._session=r._session||{},r._session.userType="admin",r.dom()},r._login={email:"",password:""};var session=r.session();_.each(session,function(val,key){r._login[key]=val}),session.password&&(r._login.password=session.password),session.rememberPass||(r._login.password=null),r.logout=function(){r.session({email:null,password:null}),r.route("login")},r.admin=function(){r._login.email="arancibiajav@gmail.com",r._login.password="admin",r.dom()},r.route=function(url,delay){return setTimeout(function(){var path=window.location.origin+window.location.pathname;path+="#/"+url,$U.emit("route-exit:"+$U.url.hashName()),r.$emit("route-change",url),$U.url.hash(url),window.location.href=window.location.href},delay||0),r.__route=url,url},r.routeIs=function(n){return r.__route&&-1!==r.__route.toString().toLowerCase().indexOf(n&&n.toLowerCase()||"invalid")||!1},r.__route=window.location.href.replace(window.location.origin+window.location.pathname,""),r.__routeHashName=$U.url.hashName(),r.__routeHashNameBefore=$U.url.hashName(),setTimeout(function(){$U.emitPreserve("route-change",r.__route.slice(2))},500),$U.onAnchorChange(function(){r.__route=window.location.href.replace(window.location.origin+window.location.pathname,""),$U.emit("route-exit:"+r.__routeHashName),r.__routeHashName=$U.url.hashName(),$U.emitPreserve("route-change",r.__route.slice(2))}),r.userIs=function(arr){if(!r.logged())return!1;var type=r.session().userType;return"string"==typeof arr&&(arr=[arr]),_.includes(arr,type)},r.routeParams=function(obj){r.params=Object.assign(r.params||{},obj)},r.lookUp=function(scope,property){return scope[property]?scope[property]:scope.$parent?r.lookUp(scope.$parent,property):void 0},r.hasMouse=!1,$hasMouse(function(v){r.hasMouse=v,r.dom()})}]);var app=angular.module("app.directives",[]);app.directive("bindHtmlCompile",["$compile",function(compile){return{restrict:"A",link:function(s,el,attrs){s.$watch(function(){return s.$eval(attrs.bindHtmlCompile)},function(e){el.html(e&&e.toString());var f=s;attrs.bindHtmlScope&&(f=s.$eval(attrs.bindHtmlScope)),compile(el.contents())(f);var first=el.find(":first-child"),tag=first&&first.get(0)&&first.get(0).tagName.toUpperCase()||"NONE";"SPAN"!=tag&&"DIV"!=tag||el.html(first.html())})}}}]),app.directive("tableFilter",function($rootScope,$timeout,$compile,$templateRequest,$sce,tpl){return{restrict:"AE",replace:!0,scope:{model:"=model"},template:"<out></out>",link:function(s,elem,attrs){function storeSet(){s.model.filter.store&&$U.store.set("filter_"+s.model.filter.store+"_"+r.session()._id,s.model.filter.payload)}function storeGet(){s.model.filter.store&&(s.model.filter.payload=$U.store.get("filter_"+s.model.filter.store+"_"+r.session()._id))}function regexpFields(){var fields={};for(var x in s.model.filter.fields)"_"!=x.charAt(0)&&(fields[x]=s.model.filter.fields[x]);return fields}function collectionPointersFields(){var fields={};for(var x in s.model.filter.fields)"_"==x.charAt(0)&&s.model.filter.fields[x]&&(fields[x]=s.model.filter.fields[x]);return fields}var r=$rootScope;if(!s.model||s.model.filter){var filter=s.model.filter.template||"<h5>tableFilter requires filter.template</h5>";r.dom(function(){var el=tpl.compile(filter,s);elem.replaceWith(el),el.find("input").on("keyup",function(evt){"13"==evt.keyCode.toString()&&s.model.filter.filter()})}),s.model.filter.filter=function(){s.model.filter.payload={__regexp:regexpFields()},s.model.filter.payload=Object.assign(s.model.filter.payload,collectionPointersFields()),storeSet(),s.model.filter&&s.model.filter.update&&s.model.filter.update()},s.model.filter.clear=function(){s.model.filter.payload={};for(var x in s.model.filter.fields)s.model.filter.fields[x]="";storeSet(),s.model.filter.update()},s.model.filter.firstTime=function(){storeGet(),s.model.filter.update()},s.model.filter.fields={};var filtered=[];s.$watch("model.filter.fields",function(fields){if(s.model.itemsOriginalRef&&0!=s.model.itemsOriginalRef.length){filtered=s.model.itemsOriginalRef;var filterVal,rule="contains",val=null;for(var x in fields)filterVal=fields[x]||"",s.model.filter.rules[x]&&(rule=s.model.filter.rules[x]||rule,"contains"==rule&&(filtered=filtered.filter(function(v){return v[x]&&-1!==v[x].toLowerCase().indexOf(filterVal.toLowerCase())})),"match"==rule&&(filtered=filtered.filter(function(v){return val="_"==x.charAt(0)?v[x]&&v[x]._id:v[x],val&&val.toLowerCase()==filterVal.toLowerCase()})),"matchCaseSensiive"==rule&&(filtered=filtered.filter(function(v){return val="_"==x.charAt(0)?v[x]&&v[x]._id:v[x],val&&val==filterVal})));s.model.items=filtered,r.dom()}},!0)}}}}),app.directive("ctrlDtp",function($rootScope){return{restrict:"AE",scope:{opt:"=options"},replace:!0,templateUrl:"./views/directives/directive.ctrl.datetimepicker.html",link:function(s,el,attrs){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}var opt=s.opt;if($U.expose(opt.name||"dtp",s),!opt.modelPath)throw Error("ctrlDtp require opt.modelPath");if(!opt.scope)throw Error("ctrlDtp require opt.scope");if(!opt.cls)throw Error("ctrlDtp require opt.cls (function)");if(!opt.disabled)throw Error("ctrlDtp require opt.disabled (function)");s=Object.assign(s,{scope:opt.scope,opened:!1,disabled:function(){return opt.disabled()},cls:function(){return opt.cls()},model:opt.initDate||new Date}),opt.scope.$watch(function(){opt.digest&&opt.digest(opt)}),opt.scope.$watch(opt.modelPath,function(v){void 0!==v&&v!==s.model&&(s.model=v)}),s.$watch("model",function(v){setVal(opt.scope,opt.modelPath,v)})}}}),app.directive("ctrlSelect",function($rootScope){return{restrict:"AE",scope:{opt:"=options"},replace:!0,templateUrl:"./views/directives/directive.ctrl.select.html",link:function(s,el,attrs){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}s.choiceLabel=function(choice){return choice.label?"string"!=typeof choice.label?choice.label():choice.label:choice},s.choiceDisabled=function(choice){return choice.disabled?choice.disabled():!1};var r=$rootScope,opt=s.opt;if(!opt.modelPath)throw Error("ctrlSelect require opt.modelPath");if(!opt.scope)throw Error("ctrlSelect require opt.scope");if(!opt.items)throw Error("ctrlSelect require opt.items");if(!opt.cls)throw Error("ctrlSelect require opt.cls (function)");if(!opt.disabled)throw Error("ctrlSelect require opt.disabled (function)");s=Object.assign(s,{scope:opt.scope,label:opt.label||"(Select Item)",disabled:function(){return opt.disabled()},cls:function(){return opt.cls()},click:function(x){setVal(opt.scope,opt.modelPath,x.val||x)}}),opt.filterWatch?s.scope.$watch(opt.filterWatch,function(){opt.filter&&(s.opt.items=_.filter(s.opt.items,function(v){return opt.filter(v)}))},!0):s.scope.$watch(function(){opt.filter&&(s.opt.items=_.filter(s.opt.items,function(v){return opt.filter(v)}))}),opt.scope.$watch(opt.modelPath,function(v,oldV){var arr=s.opt.items.filter(function(item){return(item.val||item)==v});if(arr.length>1)throw Error("ctrlSelect items val need to be unique.");1==arr.length?(arr[0].label?"string"!=typeof arr[0].label?s.label=arr[0].label():s.label=arr[0].label:s.label=arr[0],opt.change&&opt.change(arr[0],opt,function(){v!==oldV&&setVal(opt.scope,opt.modelPath,oldV)}),r.dom()):(opt.label&&(s.label=opt.label||"(Select Item)"),console.warn("ctrlSelect model has an invalid value. Values expected: "+JSON.stringify(s.opt.items.map(function(item){return item.val||item}))))}),opt.init&&opt.init(opt)}}}),app.directive("includeReplace",function(){return{require:"ngInclude",restrict:"A",link:function(scope,el,attrs){el.replaceWith(el.children())}}}),app.directive("activeRoute",function($rootScope){return{restrict:"A",link:function(scope,el,attrs){function apply(){$rootScope.routeIs(attrs.activeRoute)?el.addClass("active"):el.removeClass("active")}$rootScope.dom(apply),$rootScope.$watch("__route",function(__route){$rootScope.dom(apply)})}}}),app.directive("focusOn",function(){return function(scope,elem,attr){scope.$on("focusOn",function(e,name){name===attr.focusOn&&elem[0].focus()})}}),app.directive("collapseNav",function($timeout,$rootScope){return{restrict:"AE",replace:!1,link:function(s,elem,attr){var r=$rootScope;r.dom(function(){elem.find("li").on("click",function(){r.dom(function(){var w=$(window).width();768>w&&elem.collapse("hide")})})})}}}),app.factory("focus",function($rootScope,$timeout){return function(name){$timeout(function(){$rootScope.$broadcast("focusOn",name)})}}),app.directive("crudModal",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open",close:"=close"},template:"<output></output>",link:function(s,elem,attrs){var fire=function(n,p,ctx){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){ctx?cb.call(ctx,p):cb(p)}))};s.open=function(opt){if(s.evts=opt.evts,!opt.templateUrl)throw Error("crudModal needs templateUrl");$uibModal.open({animation:!0,templateUrl:opt.templateUrl,controller:function($scope,$uibModalInstance){var s=$scope;s.fire=function(n,p){return fire(n,p,s)},Object.assign(s,opt),s.save=s.validate=function(){s.validate&&s.validate.when&&s.validate.fail?ifThenMessage(s.validate.when(s),s.validate.fail(s),function(){s.close()}):s.close()},s.close=function(){$uibModalInstance.close(),opt.callback(s.item)},s.closeSilent=function(){$uibModalInstance.close()},s.redirect=function(url){r.params={item:s.item},r.route(url),s.closeSilent()},s.cancel=function(){$uibModalInstance.dismiss("cancel")},fire("init",null,s)}})}}}}),app.directive("address",function($rootScope,$timeout){return{scope:{model:"=model",field:"@field",change:"=change",number:"@number",street:"@street",city:"@city",department:"@department",region:"@region",country:"@country",postCode:"@postCode"},restrict:"AE",link:function(scope,elem,attrs){if(!scope.model)throw Error("directive address require a valid model.");$timeout(function(){function onResult(event,result){scope.model[scope.field]=result.formatted_address,scope.change&&scope.change(result.formatted_address);var number,street,city,department,region,country,postCode,data=result.address_components.map(function(v){return v.long_name});4==data.length&&(number="",street=data[0],city=data[1],department=data[1],region="",country=data[2],postCode=data[3]),5==data.length&&(number="",street=data[0],city=data[0],department=data[1],region=data[2],country=data[3],postCode=data[4]),6===data.length&&(number="",street=data[0],city=data[1],department=data[2],region=data[3],country=data[4],postCode=data[5]),7===data.length&&(number=data[0],street=data[1],city=data[2],department=data[3],region=data[4],country=data[5],postCode=data[6]),scope.number&&setVal(scope.model,scope.number,number),scope.street&&setVal(scope.model,scope.street,street),scope.city&&setVal(scope.model,scope.city,city),scope.department&&setVal(scope.model,scope.department,department),scope.region&&setVal(scope.model,scope.region,region),scope.country&&$U.fetchCountry(result.formatted_address).then(function(d){setVal(scope.model,scope.country,d.name)}),scope.postCode&&setVal(scope.model,scope.postCode,postCode),expose("address",Object.assign(result,scope)),r.dom()}function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}function read(){$timeout(function(){""!==scope.model[scope.field]&&elem.geocomplete("find",scope.model[scope.field]),scope.$apply()})}try{elem.geocomplete().bind("geocode:result",onResult)}catch(e){var msg="Google library issue, address autocomplete feature is temporaly disabled.";return console.warn(msg)}read(),scope.$watch("model."+scope.field,read),scope.$apply()})}}}),app.directive("debug",function($rootScope,$timeout,server,$compile){return{scope:{show:"=show"},restrict:"AE",replace:!0,template:'<div><i ng-show="show" ng-click="click()" class="link fa fa-bug fa-lg fixed left-1 bottom-1 always-on-top"><input disabled type="checkbox" ng-click="stop()" ng-model="check"></i><span data-output></span></div>',link:function(s,elem,attrs){var r=$rootScope;s.check=!0,s.opt={onClose:function(){r.logger.clearErrors()}},s.stop=function(){return window.event.stopPropagation()},s.click=function(){var log=r.logger.pending();log&&s.create(log,"info");var err=r.logger.errors();err&&s.create(err,"danger")},s.$watch("check",function(v){v?(s.checking&&clearInterval(s.checking),s.checking=setInterval(function(){r.logger.hasErrors()&&r.dom(function(){0===elem.find("[data-output] .alert-danger").length&&(s.create(r.logger.errors(),"danger"),r.logger.clearErrors())})},1e3),window.onerror=function(err){s.create(err,"danger")}):(s.checking&&clearInterval(s.checking),window.onerror=function(err){})}),s.create=function(msg,type){return console.warn("[DEBUG]["+("danger"===type?"ERROR":"WARNING")+"] "+msg)},setTimeout(function(){-1!==server.URL().indexOf("localhost")&&(s.show=!0,r.dom())},5e3)}}}),app.directive("spinner",function($rootScope,$timeout){return{scope:{show:"=show"},restrict:"AE",replace:!0,templateUrl:"./views/directives/directive.spinner.html",link:function(scope,elem,attrs){}}}),app.directive("checkBox",function($rootScope,$timeout){return{scope:{val:"=val",arr:"=push"},restrict:"AE",replace:!0,template:"<input type='checkbox'/>",link:function(scope,elem,attrs){$timeout(function(){scope.$apply(function(){elem.value=scope.val,elem.on("change",function(){var checked=elem.get(0).checked;checked?(scope.arr=scope.arr||[],scope.arr.push(scope.val)):_.remove(scope.arr,function(e){return e===scope.val})})})})}}}),app.directive("notify",function($rootScope,$timeout){return{scope:{message:"@message",type:"@type",cls:"@cls",scroll:"=scroll",opt:"=opt",evts:"=evts",settings:"=settings"},restrict:"AE",replace:!0,templateUrl:"./views/common/popups/popup-notify.html",link:function(scope,elem,attrs){var r=$rootScope,s=scope;if(s.settings&&"string"==typeof s.settings){var fixedJSON=s.settings.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g,'"$2": ');s.settings=JSON.parse(fixedJSON)}var fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};$timeout(function(){scope.$apply(function(){elem.find(".alert").addClass(scope.type||"alert-danger"),scope.cls&&elem.find(".alert").addClass(scope.cls)})}),scope.clickDismiss=function(){s.settings&&s.settings.clickDismissable===!1&&s.opt&&!s.opt.clickDismissable||scope.dismiss()},scope.dismiss=function(){s.dismissed||(s.dismissed=!0,elem.find(".alert").alert("close"),elem.remove(),fireEvent("close"),scope.opt&&scope.opt.onClose&&scope.opt.onClose())},scope.$watch("message",function(v){elem.find("[data-message]").html(v)}),s.opt&&s.opt.duration?r.dom(s.dismiss,s.opt.duration):(_.includes(["alert-info","alert-success"],s.type)&&r.dom(scope.dismiss,2e3),_.includes(["alert-danger","alert-warning"],s.type)&&r.dom(scope.dismiss,1e4)),1==s.settings.scroll&&r.dom($U.scrollToTop)}}}),app.directive("myAlert",function($rootScope,$timeout){return{scope:{message:"@message",type:"@type",cls:"@cls",scroll:"=scroll",opt:"=opt",evts:"=evts"},restrict:"AE",replace:!0,templateUrl:"./views/directives/directive.alert.html",link:function(scope,elem,attrs){var s=scope,r=$rootScope,fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};$timeout(function(){scope.$apply(function(){elem.addClass(scope.type||"alert-danger"),scope.cls&&elem.addClass(scope.cls)})}),scope.dismiss=function(){elem.alert("close"),fireEvent("close"),scope.opt&&scope.opt.onClose&&scope.opt.onClose()},scope.$watch("message",function(v){elem.find("[data-message]").html(v),v&&scope.scroll&&r.dom(function(){$("html, body").animate({scrollTop:elem.offset().top},500)})})}}}),app.directive("myAlerts",function($rootScope,$timeout,$compile){return{restrict:"AE",replace:!0,scope:{add:"=add",directive:"@directive",stacked:"=stacked",settings:"@settings"},template:"<output></output>",link:function(s,elem,attrs){function onClose(){if(s.stacked){if(s.el=null,0===s._stacked.length)return;var p=s._stacked[0];s._stacked=s._stacked.slice(1),s.add(p.message,p.type,p.timeout,p.scroll,p.opt)}}var r=$rootScope;s.decodeMessage=function(msg){return"string"==typeof msg?msg:JSON.stringify(msg)},s._stacked=[],s.evts={close:[onClose]};var fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};s.add=function(message,type,timeout,scroll,opt){var msg=s.decodeMessage(message);type&&"string"!=typeof type&&(opt=type,
type=opt.type||void 0),timeout&&"object"===("undefined"==typeof timeout?"undefined":_typeof(timeout))&&(opt=timeout,timeout=void 0),opt&&opt.scroll===!0&&(scroll=!0),s.el&&s.el.alert("close");var directive=s.directive||"my-alert";s.opt=opt;var el=$compile("<"+directive+" settings='settings' evts='evts' opt='opt' scroll='"+scroll+"' message='"+msg+"' type='alert-"+(type||"danger")+"'/>")(s);s.el=el,elem.html("").append(el),timeout&&"my-alert"===directive&&r.dom(function(){elem.html(""),fireEvent("close")},timeout)},"notify"==s.directive&&(r.notify=s.add,r.message=s.add),window.ss=s}}}),app.directive("modalCustom",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){if(!attrs.templateUrl)throw Error("modalCustom attr templateUrl required.");s.open=function(opt,confirmCallback){opt=opt||{};var message="";message="string"==typeof opt?opt:opt.message||"";$uibModal.open({animation:!0,templateUrl:opt.templateUrl||attrs.templateUrl,controller:function($scope,$uibModalInstance){$scope.data=opt.data,$scope.message=message,$scope.messageEl=opt.messageEl||null,$scope.yes=function(){$uibModalInstance.close(),confirmCallback&&confirmCallback()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},expose("modalCustom",$scope)}})}}}}),app.directive("modalConfirm",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){s.open=function(opt,okCallback){opt=opt||{};var message="";message="string"==typeof opt?opt:opt.message||"";$uibModal.open({animation:!0,templateUrl:opt.templateUrl||"views/directives/directive.modal.sure.html",controller:function($scope,$uibModalInstance){$scope.data=opt.data,$scope.message=message,$scope.yes=function(){$uibModalInstance.close(),okCallback&&okCallback()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}})}}}}),app.directive("dynamicTable",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!0,scope:{model:"=model"},templateUrl:"views/partials/partials.table.html",link:function(s,elem,attrs){function objUpdate(obj1,obj2,preserveFields){var rta=obj1;return Object.keys(obj2).forEach(function(k){for(var x in preserveFields)if(preserveFields[x]==k&&"undefined"!=typeof obj1[k])return;rta[k]=obj2[k]}),rta}var r=$rootScope;$rootScope.$watch("hasMouse",function(v){s.hasMouse=v});attrs.name;if(!s.model)return void console.error("directive.table: no model present");s.click=function(item,index){s.model.click&&s.model.click(item,index)},s.buttons=s.model.buttons||null,s.columns=s.model.columns||[],s.model.items=s.model.items||[],s.paginationTotalItems=1;var paginationDefaults={currentPage:1,maxSize:5,itemsPerPage:10,total:1,changed:function(){s.model.paginate&&s.model.paginate(function(items){s.model.items=items,r.dom()})},update:function(p){s.model.pagination.total=p.total}};s.model.pagination=s.model.pagination&&objUpdate(s.model.pagination,paginationDefaults,["itemsPerPage"])||paginationDefaults,s.model.update=function(items,data){s.model.items=items,s.model.itemsOriginalRef=items,s.data||(s.data=data)},s.model.columnFilter=function(item){return void 0==item.disabled||1==!item.disabled},s.model.init&&s.model.init(),s.model.itemsOriginalRef=s.model.items,$U.expose("table",s)}}}),app.directive("appendChild",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!1,scope:{child:"=child"},link:function(s,elem,attrs){s.child&&elem.html("").append(s.child)}}}),app.directive("htmlContent",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!1,scope:{html:"&html"},link:function(s,elem,attrs){s.html&&r.dom(function(){elem.html(s.html)})}}}),app.directive("timeRange",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){s.open=function(opt){$uibModal.open({animation:!0,templateUrl:"views/directives/directive.modal.timeRange.html",controller:function($scope,$uibModalInstance){var s=$scope;s.title=opt.title,s.title||(s.title="Time Range",opt.action&&"edit"===opt.action?s.title+=" - Edition":s.title="New "+s.title),s._opt=opt,window.edit=s,s.days=function(){var o={label:"Day",selected:"",items:[],val:null,select:function(val){o.items.forEach(function(v){v.val.toString()==val.toString()&&o.click(v)})},click:function(v){o.selected=v.label||v,o.val=v.val,s.start.val&&(s.start.val=moment(s.start.val),s.start.val.day("-1"===o.val.toString()?1:o.val)),s.end.val&&(s.end.val=moment(s.end.val),s.end.val.day("-1"===o.val.toString()?1:o.val))}},m=moment();o.items.push({label:"(Choice a day)",val:""},{label:"Every day",val:"-1"});for(var x=1;7>=x;x++)m.day(x),o.items.push({label:m.format("dddd"),val:x});return o.selected=o.items[0].label,o}();var timePickerData=function(){return function(m){return{hstep:1,mstep:10,repeat:"",minDate:moment().date(1),val:m||moment().hour(9).minutes(0)}}}();if(s.start=timePickerData(opt.start),s.end=timePickerData(opt.end),s.repeat="none",s.daySelection=function(){return"none"!==s.repeat},s.datepicker={val:void 0,minDate:moment().add(1,"day"),maxDate:moment().add(2,"month"),initDate:new Date},s.$watch("repeat",function(v){"day"===v&&s.days.select(-1)}),s.validate=function(){if(!s.description,"week"==s.repeat&&"-1"===s.days.val.toString())return s.message("Choice a day","warning",2e3),!1;if("none"===s.repeat&&void 0==s.datepicker.val)return void s.message("Choice a day in the calendar","warning",2e3);if(!s.start.val)return void s.message("Choice a valid start time.");if(!s.end.val)return void s.message("Choice a valid end time.");if(moment(s.start.val).isAfter(moment(s.end.val)))return void s.message("Start time need  to be before end time.");try{var _d=moment(s.start.val);_d=moment(s.end.val),"none"===s.repeat&&(s.start.val=moment(s.datepicker.val).hour(moment(s.start.val).hour()).minutes(moment(s.start.val).minutes()).toDate(),s.end.val=moment(s.datepicker.val).hour(moment(s.end.val).hour()).minutes(moment(s.end.val).minutes()).toDate())}catch(e){return s.message("Invalid time","warning",2e3),!1}return!0},s.save=function(){if(s.validate()){$uibModalInstance.close();var rta={description:s.description||"",start:s.start.val,end:s.end.val,type:opt.type,repeat:s.repeat};"edit"==opt.action&&(rta._user=opt.item._user,rta._id=opt.item._id),opt.callback(rta)}},s.cancel=function(){$uibModalInstance.dismiss("cancel")},!opt.action)throw Error("directive timeRange open require arg.action");if("new"==opt.action,"edit"===opt.action){var start=moment(opt.item.start);s.repeat=opt.item.repeat,s.description=opt.item.description,s.start.val=opt.item.start,s.end.val=opt.item.end,opt.type=opt.item.type,s.days.val=start.day(),s.days.select(s.days.val),"day"==s.repeat&&(s.days.val=-1),"none"==s.repeat&&(s.datepicker.val=opt.item.start)}}})}}}}),angular.module("app.static.calendar",[]).controller("calendar",["$scope","server","$rootScope",calendar]);