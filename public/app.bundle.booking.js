"use strict";function numberBetween(n,min,max){return n>=min&&n<=max}function expose(path,v){setVal(window,path,v)}function setVal(obj,propertyPath,_v){var split=propertyPath.split("."),lastIndex=split.length-1;if(split.forEach(function(chunk,index){var isLast=lastIndex==index;return!isLast&&(obj=obj[chunk]||{},!!obj&&void 0)}),obj)return _v&&(obj[split[lastIndex]]=_v),obj[split[lastIndex]]}function has(v,arr){for(var x in arr)if(v==arr[x])return!0;return!1}function valid(obj,propertyPath,opt){var split=propertyPath.split("."),lastIndex=split.length-1;if(split.forEach(function(chunk,index){var isLast=lastIndex==index;return!isLast&&(obj=obj[chunk]||{},!!obj&&void 0)}),!obj)return!1;var rta=obj[split[lastIndex]];return!!rta||void 0}function val(obj,propertyPath,opt){var split=propertyPath.split("."),lastIndex=split.length-1;if(split.forEach(function(chunk,index){var isLast=lastIndex==index;isLast||(obj=obj[chunk]||{})}),obj){var rta=obj[split[lastIndex]];return"string"==typeof rta?rta:"function"==typeof rta?opt&&opt.args?rta.apply(this,opt.args):rta():rta}}function setPropByGivenPath(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;split.forEach(function(chunk,index){var isLast=lastIndex==index;return!isLast&&(obj=obj[chunk]||null,!!obj&&void 0)}),obj&&(obj[split[lastIndex]]=val)}function ifThenMessage(comparisons,messagesCallback,noMessagesCallback){var messages=[];comparisons.forEach(function(comparison){var v1=comparison[0];if("function"==typeof v1)v1()&&messages.push(comparison[1]);else{var operator=comparison[1],v2=comparison[2],m=comparison[3],cb=comparison[4]||void 0;"=="==operator&&v1==v2&&messages.push(m),"!="==operator&&v1!=v2&&messages.push(m),">"==operator&&v1>v2&&messages.push(m),"<"==operator&&v1<v2&&messages.push(m),">="==operator&&v1>=v2&&messages.push(m),"<="==operator&&v1<=v2&&messages.push(m)}messages.filter(function(_m){return _m==m}).length>0&&cb&&cb()}),messages.length>0?messagesCallback(messages):noMessagesCallback?noMessagesCallback():console.warn("ifThenMessage no-message-callback-undefined")}function getParameterByName(name,url){url||(url=window.location.href),name=name.replace(/[\[\]]/g,"\\$&");var regex=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)"),results=regex.exec(url);return results?results[2]?decodeURIComponent(results[2].replace(/\+/g," ")):"":null}function MyPromise(cb){var _scope={cb:null,errorCb:null,errorRes:null,res:null,evt:{}},resolve=function(res){_scope.cb&&_scope.cb(res),_scope.res=res||{}},error=function(errorRes){_scope.errorCb&&_scope.errorCb(errorRes),_scope.errorRes=errorRes||{}},emit=function(n,err,r){_scope.evt[n]=_scope.evt[n]||{},_scope.evt[n].res={err:err,r:r},void 0!==_scope.evt[n].cb&&_scope.evt[n].cb(_scope.evt[n].res.err,_scope.evt[n].res.r)};cb(resolve,error,emit);var rta={then:function(cb){return _scope.res?cb(_scope.res):_scope.cb=cb,rta},error:function(errorCb){return _scope.errorRes?errorCb(_scope.errorRes):_scope.errorCb=errorCb,rta},err:function(errorCb){return _scope.errorRes?errorCb(_scope.errorRes):_scope.errorCb=errorCb,rta},on:function(n,cb){return _scope.evt[n]=_scope.evt[n]||{},_scope.evt[n].cb=cb,void 0!==_scope.evt[n].res&&_scope.evt[n].cb(_scope.evt[n].res.err,_scope.evt[n].res.r),rta}};return rta}function onAnchorChange(handler){var storedHash=window.location.hash;window.setInterval(function(){window.location.hash!=storedHash&&(storedHash=window.location.hash,handler(storedHash))},100)}function cbHell(quantity,cb){return{call:function(){return cb()},next:function(){quantity--,0===quantity&&cb()}}}function hasUndefinedProps(obj,props){var has=!1;return props.forEach(function(v){void 0==obj[v]&&(has=!0)}),has}function indexOf(str,values){var rta=!1;return values.forEach(function(v){str.indexOf(v)!==-1&&(rta=!0)}),rta}function scrollToTop(time){$("html, body").animate({scrollTop:0},time||800)}function fetchCountry(address){return MyPromise(function(resolve,err,emit){var rta={name:"",code:""},geocoder=new google.maps.Geocoder;geocoder.geocode({address:address},function(results){if(results)for(var i=0;i<results[0].address_components.length;i++)for(var j=0;j<results[0].address_components[i].types.length;j++)if("country"==results[0].address_components[i].types[j]){var country=results[0].address_components[i];rta.name=country.long_name,rta.code=country.short_name,resolve(rta)}})})}function toCSV(args){var result,ctr,keys,columnDelimiter,lineDelimiter,data;return data=args.data||null,null!=data&&data.length?(columnDelimiter=args.columnDelimiter||",",lineDelimiter=args.lineDelimiter||"\n",keys=Object.keys(data[0]),result="",result+=keys.join(columnDelimiter),result+=lineDelimiter,data.forEach(function(item){ctr=0,keys.forEach(function(key){ctr>0&&(result+=columnDelimiter),result+='"'+item[key]+'"',ctr++}),result+=lineDelimiter}),result):null}function downloadContent(content,fileName,mimeType){mimeType=mimeType||"text/csv";var a=document.createElement("a");if(mimeType=mimeType||"application/octet-stream",window.navigator.msSaveBlob)return window.navigator.msSaveBlob(new window.Blob([content],{type:mimeType}),fileName);if("download"in a)return a.href="data:"+mimeType+","+encodeURIComponent(content),a.setAttribute("download",fileName),document.body.appendChild(a),setTimeout(function(){a.click(),document.body.removeChild(a)},66),!0;var f=document.createElement("iframe");return document.body.appendChild(f),f.src="data:"+mimeType+","+encodeURIComponent(content),setTimeout(function(){document.body.removeChild(f)},333),!0}function replaceHTML(html,obj){for(var x in obj)html=html.replaceAll("{{"+x.toUpperCase()+"}}",obj[x]);return html}function availableFranceDepartementsNumbers(){for(var rta=[],x=1;x<=95;x++)20!=x&&rta.push(x.toString());return rta.push("2a","2b","69M"),rta}function createSiteSectionsCategories(db){function _createTextsItemsFor(_category){function _save(payload){db.ctrl("Text","save",_.cloneDeep(payload)).then(cbCount.next)}var diags=["DPE","AMIANTE","PLOMB","CARREZ","ERNMT","GAZ","ELECTRICITE","PARASITAIRE"],cbCount=$U.cbHell(5*diags.length,function(){console.info("create-page-category-#",5*diags.length,"texts-created-or-updated-success")}),content="Page section: BOOKING_HOME, Code: ";diags.forEach(function(code){var name=code,payload={code:code,description:"Auto generated block for "+code+" when you click the card in the home page.",content:"",_category:_category,__match:["code"]};payload.code="PAGE_HOME_"+name+"_BLOCK_LEFT_TITLE",payload.content=content+payload.code,_save(payload),payload.code="PAGE_HOME_"+name+"_BLOCK_LEFT_CONTENT",payload.content=content+payload.code,_save(payload),payload.code="PAGE_HOME_"+name+"_BLOCK_RIGHT_TITLE",payload.content=content+payload.code,_save(payload),payload.code="PAGE_HOME_"+name+"_BLOCK_RIGHT_CONTENT",payload.content=content+payload.code,_save(payload),payload.code="PAGE_HOME_"+name+"_BLOCK_BOTTOM",payload.content=content+payload.code,_save(payload)})}function _createPageSections(res){if(res&&res.ok&&res.result){var root=res.result,cbCount=$U.cbHell(categories.length,function(){console.info("create-page-categories#",categories.length,"created-or-updated-success")});categories.forEach(function(cat){var payload={code:cat,description:"Diags Site Section",_parent:root._id,__match:["code"]};db.ctrl("Category","save",payload).then(function(r){r&&r.ok&&"BOOKING_HOME"==r.result.code&&_createTextsItemsFor(r.result._id),cbCount.next()})})}else console.warn("create-page-categories#create-page-sections=invalid-parameters,category-res-expected-and-got",res)}function _createRoot(cb){db.ctrl("Category","create",{code:"DIAGS",description:"Diags Root Category"}).then(cb)}db.ctrl("Category","get",{code:"DIAGS"}).then(function(res){res.ok&&res.result?_createPageSections(res):_createRoot(_createPageSections)});var categories=["ERNMT","BOOKING_HOME","GENERAL_CONDITIONS","FAQ","LEGAL_MENTIONS"]}function createDateTimePickerData(){var o={isOpen:!1,openCalendar:function(e){e.preventDefault(),e.stopPropagation(),o.isOpen=!0}};return o}function createSelect(opt){var o={label:opt.label,click:function(x){o.label=x.label||x,$U.setPropByGivenPath(opt.scope,opt.model,x),opt.change(x)},items:opt.items};return opt.scope.$watch(opt.model,function(v){void 0!==v?o.label=v.label||v.substring(0,1).toUpperCase()+v.slice(1):o.label=opt.label}),o}function rangeCollide(d1s,d1e,d2s,d2e){d1s=moment(d1s),d1e=moment(d1e),d2s=moment(d2s),d2e=moment(d2e);var collide=!1;return(collide=d2s.isAfter(d1s)&&d2s.isBefore(d1e))?collide:(collide=d2e.isAfter(d1s)&&d2e.isBefore(d1e),(collide=d1s.isAfter(d2s)&&d1s.isBefore(d2e))?collide:collide=d1e.isAfter(d2s)&&d1e.isBefore(d2e))}function diagNameConvertion(key){return"electricity"==key?"Electricité":"parasitaire"==key?"Parasitaire":"gaz"==key?"Gaz":"termites"==key?"Termites":"ernt"==key?"État des risques naturels, miniers et technologiques":"loiCarrez"==key?"Carrez":"crep"==key?"Plomb":"dta"==key?"Amiante":"dpe"==key?"DPE":key}function openStripeModalPayOrder(order,cb,opt){opt=opt||{config:{companyName:"Unknown"}};var handler=StripeCheckout.configure({key:r&&r.isDevEnv()?"pk_test_MDkxtBLcBpHwMCgkqX2dJHjO":window.atob("cGtfbGl2ZV9ScldVOUlDcFl1cWxpQ05RWDhOQmhEZjE="),image:"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",token:function(_token){cb(_token)}}),payload={name:opt.config.companyName||"[r.config.companyName]",description:"Order payment",currency:"eur",amount:100*order.price,zipCode:!1,allowRememberMe:!1};opt.email&&(payload.email=opt.email),handler.open(payload)}function getInvoiceHTMLContent(db,item,r,cb){db.ctrl("Category","createUpdate",{code:"DIAGS_SETTINGS",__match:["code"]}).then(function(_res){if(_res&&_res.ok&&_res.result){_res.result._id;db.ctrl("Text","get",{code:"INVOICE"}).then(function(res){if(res.ok&&res.result){var html=window.encodeURIComponent($D.OrderReplaceHTML(window.decodeURIComponent(res.result.content),_.cloneDeep(item),r));cb(html)}else r.warningMessage("Configure the Invoice template first.")})}})}function OrderReplaceHTML(html,_order,r){return _order.LOGO="<img src='"+(window.__raw_origin||window.location.origin)+"/img/logo.jpg'>",_order.ORDER_DESCRIPTION=_order.info.description,_order.CLIENT_FULLNAME=_order._client.firstName+" "+(_order._client.lastName||""),_order.CLIENT_FIRSTNAME=_order._client.firstName,_order.CLIENT_LASTNAME=_order._client.lastName||"",_order.CLIENT_EMAIL=_order._client.email,_order.CLIENT_ADDRESS=_order._client.address,_order.createdAt=r.momentDateTime(_order.createdAt),$U.replaceHTML(html,_order)}function createOrderDescription(_order){_order.info=_order.info||{};var rta="";return rta+=_order.info.sell?"Pack Vente: ":"Pack Location: ",rta+=_order.info.house?"Maison":"Appartement",_order.city&&(rta+=" à "+_order.city),_order.info.constructionPermissionDate&&(rta+=" "+_order.info.constructionPermissionDate),_order.info.squareMeters&&(rta+=", "+_order.info.squareMeters),_order.info.gasInstallation&&!_.includes(["Non","Oui, Moins de 15 ans"],_order.info.gasInstallation)&&(rta+=", Gaz"),_order.info.electricityInstallation&&"Moins de 15 ans"!=_order.info.electricityInstallation&&(rta+=", Électricité"),rta+="."}function normalizeOrderStartTime(t,forwardOnly,backwardOnly){return t.minutes<30&&(forwardOnly?t.minutes=30:t.minutes=0),30==t.minutes&&(t.minutes=30),t.minutes>30&&(backwardOnly?t.minutes=30:(t.minutes=0,t.hours++)),t}function normalizeOrderTime(t,eachTreintaOnly){return t.minutes>0&&t.minutes<15&&(t.minutes=15,eachTreintaOnly&&(t.minutes=0)),t.minutes>15&&t.minutes<30&&(t.minutes=30),t.minutes>30&&t.minutes<45&&(t.minutes=45,eachTreintaOnly&&(t.minutes=30)),t.minutes>45&&t.minutes<59&&(t.hours+=1,t.minutes=0),t}function subTotal(model,diags,basePrice,opt){if(!model)return 0;opt=opt||{},opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo.basePrice=opt.s.priceInfo.basePrice);var total=0;model.diags=model.diags||{},Object.keys(model.diags).forEach(function(mkey){return model.diags[mkey]?void diags.forEach(function(dval,dkey){if(dval.show)return dval.name==mkey?(opt.s&&(opt.s.priceInfo[mkey]=dval.price),total+=dval.price||0,!1):void 0}):void(opt.s&&opt.s.priceInfo[mkey]&&delete opt.s.priceInfo[mkey])});var rta=basePrice+total;return 0===total?(opt.s&&(opt.s.priceInfo.basePrice=0),rta=0):opt.s&&(opt.s.priceInfo.basePrice=basePrice),rta}function sizePrice(model,diags,squareMetersPrice,basePrice,opt){if(!model)return 0;var rta=0,squareMeters=model.info?model.info.squareMeters:model.squareMeters;if(squareMeters){var porcent=squareMetersPrice[squareMeters];if((_.isUndefined(porcent)||_.isNull(porcent))&&(console.warn("sizePrice: squareMeters missing in model."),porcent=0),0===parseInt(porcent))rta=0;else{var sub=subTotal(model,diags,basePrice,opt);rta=sub*parseInt(porcent),rta/=100}}return opt&&opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo.sizePrice=rta),rta}function totalPrice(showRounded,model,diags,squareMetersPrice,basePrice,opt){opt=opt||{},opt.basePrice&&(basePrice=opt.basePrice);var _sizePrice=sizePrice(model,diags,squareMetersPrice,basePrice,opt),tot=subTotal(model,diags,basePrice,opt)+_sizePrice;if(opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{}),opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers={sizePrice:_sizePrice}}),!model)return 0;if(opt.s){var date=model.start;if(opt.dt&&(date=opt.dt),opt.s.settings&&opt.s.settings.pricePercentageIncrease&&date){var increase=opt.s.settings.pricePercentageIncrease,percentage=0;isSaturday(date)&&!isToday(date)&&(percentage=percentage>increase.saturday?percentage:increase.saturday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.saturday=percentage}),delete opt.s.priceInfo["increase-today"],delete opt.s.priceInfo["increase-tomorrow"],delete opt.s.priceInfo["increase-sunday"],opt.s.priceInfo["increase-saturday"]=tot*(percentage/100)+" ("+percentage+"%)"),isSunday(date)&&!isToday(date)&&(percentage=percentage>increase.saturday?percentage:increase.saturday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.sunday=percentage}),delete opt.s.priceInfo["increase-today"],delete opt.s.priceInfo["increase-tomorrow"],delete opt.s.priceInfo["increase-saturday"],opt.s.priceInfo["increase-sunday"]=tot*(percentage/100)+" ("+percentage+"%)"),isTomorrow(date)&&(percentage=percentage>increase.tomorrow?percentage:increase.tomorrow,isTomorrowSaturday(date)?(percentage=increase.tomorrowSaturday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.tomorrowSaturday=percentage})):isTomorrowSunday(date)?(percentage=increase.tomorrowSunday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.tomorrowSunday=percentage})):(percentage=increase.tomorrowMondayToFriday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.tomorrowMondayToFriday=percentage})),delete opt.s.priceInfo["increase-today"],delete opt.s.priceInfo["increase-saturday"],opt.s.priceInfo["increase-tomorrow"]=tot*(percentage/100)+" ("+percentage+"%)"),isToday(date)&&(percentage=percentage>increase.today?percentage:increase.today,isTodaySaturday(date)?(percentage=increase.todaySaturday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.todaySaturday=percentage})):isTodaySunday(date)?(percentage=increase.todaySunday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.todaySunday=percentage})):(percentage=increase.todayMondayToFriday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.todayMondayToFriday=percentage})),delete opt.s.priceInfo["increase-tomorrow"],delete opt.s.priceInfo["increase-saturday"],opt.s.priceInfo["increase-today"]=tot*(percentage/100)+" ("+percentage+"%)"),tot+=tot*(percentage/100)}if($U.val(model,"_client.discount")){var discount=$U.val(model,"_client.discount");discount>0&&(opt.s.priceInfo["client-discount"]=-tot*(discount/100)+" ("+discount+"%)",tot-=tot*(discount/100),opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.clientDiscount=discount}))}}else console.warn("$D totalPrice opt.s required");var realTot=10*parseInt(parseInt(tot)/10,10);return opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo["Round-to-near-10"]=(tot-realTot)*-1),opt.overwriteModel===!1||(model.price=realTot),showRounded?realTot:tot}function OrderTotalTime(selectedDiags,diags){var total=0;if(!selectedDiags)return 0;Object.keys(selectedDiags).forEach(function(mkey){selectedDiags[mkey]&&diags.forEach(function(dval,dkey){if(dval.name==mkey)return dval.time=dval.price/4,total+=dval.time||0,!1})}),total=10*parseInt(parseInt(total)/10,10)+10;var hours=Math.floor(total/60),minutes=total%60,t={hours:hours,minutes:minutes};return t}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};!function(self){self.env={};var env=self.env;env.APP_NAME="FRONTSTUFF",env.CONFIG_JSON_PATH="./config.json",env.STORE_SESSION_PREFIX="_SESSION",env.$set=function(config){Object.keys(config).forEach(function(k){env[k]=config[k]})}}(window);var readJSONSync=function(url){return $.ajax({url:url,async:!1,dataType:"json"}).responseJSON},store=function(){return{set:function(id,raw){id="store#"+id;try{return raw=JSON.stringify(raw),localStorage.setItem(id,raw),!0}catch(e){return console.warn("store setData fails"),!1}},get:function(id){id="store#"+id;try{var localData=JSON.parse(localStorage.getItem(id));return localData}catch(e){return console.warn("store getData fails"),null}}}}();String.prototype.replaceAll=function(search,replacement){var target=this;return target.replace(new RegExp(search,"g"),replacement)};var $hasMouse=function(change){$("html").on("mousemove",function(e){change(!0),$("html").off("mousemove")}),change(!1)};$(function(){$.hrefAnchor=function(){var url=window.location.href,idx=url.indexOf("#"),hash=idx!=-1?url.substring(idx+1):"";return hash.replace("/","")},$.scrollToAnchor=function(){var elem=$("#"+$.hrefAnchor());$("html, body").animate({scrollTop:elem.offset().top},500)},$.onGlobalError=function(cb){$("html").on("error",function(){console.log("ERROR.DETECTED")})},$.downloadPNG=function(elem,name){html2canvas(elem,{onrendered:function(canvas){var imgData=canvas.toDataURL("image/jpeg",1),pdf=new jsPDF;pdf.addImage(imgData,"JPEG",25,20),pdf.save("download.pdf")}})}});var whenProperties=function(o,props,cbArray){var i=setInterval(function(){var rta=!0;props.forEach(function(v){_.isUndefined(o[v])&&(rta=!1)}),rta&&(clearInterval(i),cbArray.forEach(function(cb){cb()}))},200)};!function(exports){var BASE64URICHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split("");exports.newId=function(len,radix){var chars=BASE64URICHARS,newId=[],i=0;for(radix=radix||chars.length,len=len||22,i=0;i<len;i++)newId[i]=chars[0|Math.random()*radix];return newId.join("")}}("undefined"==typeof exports?window:exports);var downloadFile=function(filename,encodedData,mimeType){var link=document.createElement("a");mimeType=mimeType||"text/plain",link.setAttribute("download",filename),link.setAttribute("href","data:"+mimeType+";charset=utf-8,"+encodedData),link.click()},downloadJSON=function(filename,data){downloadFile(filename,JSON.stringify(data,null,"\t"),"text/json")},ToStringParameters=function(obj){var rta="";for(var x in obj)""!=rta&&(rta+="&"),rta+=x+"="+decodeURIComponent(JSON.stringify(obj[x]));return rta},getHashParams=function(){for(var e,hashParams={},a=/\+/g,r=/([^&;=]+)=?([^&;]*)/g,d=function(s){return decodeURIComponent(s.replace(a," "))},q=window.location.hash.substring(1);e=r.exec(q);)hashParams[d(e[1])]=d(e[2]);return hashParams},Eventify=function(self){function firePreserve(n,handler){once[n]&&handler(once[n])}var once={},evts={};return self.off=function(evt){"string"==typeof evt?(delete evts[evt],delete once[evt]):delete evts[evt.type][evt.id]},self.emitPreserve=function(n,p){self.emit(n,p,{preserve:!0})},self.emit=function(n,p,opt){evts[n]=evts[n]||{},Object.keys(evts[n]).forEach(function(k){evts[n][k].handler(p)}),opt&&opt.preserve&&(once[n]=p||{});var pp=p;try{pp=JSON.stringify(pp)}catch(e){pp=p}},self.once=function(n,handler){if(once[n])return firePreserve(n,handler);var evt=self.on(n,function(p){handler(p),self.off(evt),once[n]=p})},self.on=function(n,handler){firePreserve(n,handler),evts[n]=evts[n]||{};var id="evt_"+n+"_"+(new Date).getTime()+"_"+Object.keys(evts).length;return evts[n][id]={id:id,type:n,handler:handler},evts[n][id]},self},queryString=function(){var queryString={};return queryString.parse=function(str){return"string"!=typeof str?{}:(str=str.trim().replace(/^\?/,""),str?str.trim().split("&").reduce(function(ret,param){var parts=param.replace(/\+/g," ").split("="),key=parts[0],val=parts[1];return key=decodeURIComponent(key),val=void 0===val?null:decodeURIComponent(val),ret.hasOwnProperty(key)?Array.isArray(ret[key])?ret[key].push(val):ret[key]=[ret[key],val]:ret[key]=val,ret},{}):{})},queryString.stringify=function(obj){return obj?Object.keys(obj).map(function(key){var val=obj[key];return Array.isArray(val)?val.map(function(val2){return encodeURIComponent(key)+"="+encodeURIComponent(val2)}).join("&"):encodeURIComponent(key)+"="+encodeURIComponent(val)}).join("&"):""},queryString.get=getParameterByName,queryString.hashName=function(){return(window.location.hash.indexOf("?")!==-1?window.location.hash.substring(0,window.location.hash.indexOf("?")):window.location.hash).replace("#/","")},queryString.hash=function(str){var hash=window.location.hash.indexOf("?")!==-1?window.location.hash.substring(0,window.location.hash.indexOf("?")):window.location.hash;if(void 0==str)return hash;var params=queryString.parse(window.location.hash.replace(hash,"")),new_params_string=queryString.stringify(params);window.history.pushState({},"",window.location.pathname+"#/"+str+"?"+new_params_string)},queryString.clear=function(){var hash=window.location.hash.indexOf("?")!==-1?window.location.hash.substring(0,window.location.hash.indexOf("?")):window.location.hash;window.history.pushState({},"",window.location.pathname+hash)},queryString.set=function(key,new_value){var hash=window.location.hash.indexOf("?")!==-1?window.location.hash.substring(0,window.location.hash.indexOf("?")):window.location.hash,params=queryString.parse(window.location.hash.replace(hash,""));params[key]=new_value;var new_params_string=queryString.stringify(params);window.history.pushState({},"",window.location.pathname+hash+"?"+new_params_string)},"undefined"!=typeof module&&module.exports?queryString:queryString}();"undefined"!=typeof exports?(exports.MyPromise=MyPromise,exports.getHashParams=getHashParams,exports.getParameterByName=getParameterByName,exports.ifThenMessage=ifThenMessage,exports.val=val,exports.numberBetween=numberBetween):(window.val=val,window.numberBetween=numberBetween,window.MyPromise=MyPromise,window.getHashParams=getHashParams,window.getParameterByName=getParameterByName,window.ifThenMessage=ifThenMessage,window.$U={readJSONSync:readJSONSync,store:store,replaceHTML:replaceHTML,toCSV:toCSV,downloadContent:downloadContent,whenProperties:whenProperties,expose:expose,fetchCountry:fetchCountry,scrollToTop:scrollToTop,indexOf:indexOf,url:queryString,hasUndefinedProps:hasUndefinedProps,cbHell:cbHell,onAnchorChange:onAnchorChange,valid:valid,val:val,setVal:setVal,numberBetween:numberBetween,MyPromise:MyPromise,getHashParams:getHashParams,getParameterByName:getParameterByName,ifThenMessage:ifThenMessage,has:has},window.$U=Eventify(window.$U));var $D={openStripeModalPayOrder:openStripeModalPayOrder,rangeCollide:rangeCollide,diagNameConvertion:diagNameConvertion,getInvoiceHTMLContent:getInvoiceHTMLContent,createOrderDescription:createOrderDescription,normalizeOrderStartTime:normalizeOrderStartTime,OrderTotalTime:OrderTotalTime,OrderReplaceHTML:OrderReplaceHTML,subTotal:subTotal,sizePrice:sizePrice,totalPrice:totalPrice,createSelect:createSelect,availableFranceDepartementsNumbers:availableFranceDepartementsNumbers,createDateTimePickerData:createDateTimePickerData,ORDER_STATUS:{CREATED:"created",ORDERED:"ordered",PREPAID:"prepaid",DELIVERED:"delivered",COMPLETED:"completed"},ORDER_STATUS_PAID:["prepaid","completed"],createSiteSectionsCategories:createSiteSectionsCategories},isTomorrowSaturday=function(d){return 6===moment(d).add(1,"day").day()},isTomorrowSunday=function(d){return 0===moment(d).add(1,"day").day()},isTodaySaturday=function(d){return 6===moment(d).day()},isTodaySunday=function(d){return 0===moment(d).day()},isToday=function(d){return moment().isSame(moment(d),"day")},isTomorrow=function(d){return moment().add(1,"day").isSame(moment(d),"day")},isSaturday=function(d){return 6===moment(d).day()},isSunday=function(d){return 0===moment(d).day()};!function(global){function diagsGetAvailableRanges(order,ctrl,opt){function diagsPriority(cb){var payload={userType:"diag",__rules:{disabled:{$ne:!0}},__select:"priority"};opt._diag&&(payload._id=opt._diag._id||opt._diag),opt.department&&(payload.__rules.departments={$eq:opt.department.toString()},console.info("debug filtering diags who cover department ",opt.department)),ctrl("User","getAll",payload).then(function(data){cb(data.result.map(function(v){return{_id:v._id,priority:v.priority}}))})}function timeRangesDiagSayHeCantWorktype(cb){ctrl("TimeRange","getAll",{type:"work-exception",__select:"_user start end repeat"}).then(function(data){cb(data.result.map(function(v){return v}))})}function timeRangesDiagIsWorking(order,cb){ctrl("Order","getAll",{__select:"start end _diag",__rules:{status:{$ne:"complete"}}}).then(function(data){data.result=data.result.filter(function(v){return moment(v.start).isSame(moment(order.day),"day")}),cb(data.result.map(function(v){return{_user:v._diag,start:v.start,end:v.end}}))})}function _data(cb){timeRangesDiagIsWorking(order,function(working){timeRangesDiagSayHeCantWorktype(function(exceptions){diagsPriority(function(diags){cb(working,exceptions,diags)})})})}function calc(order,working,exceptions,diags){return diagsCalculateAvailableSlots(order,working,exceptions,diags)}if(opt=opt||{},!isFinite(new Date(order.day)))throw Error("getAvailableRanges Invalid order day");return $U.MyPromise(function(resolve,error){_data(function(working,exceptions,diags){resolve(calc(order,working,exceptions,diags))})})}function diagsCalculateAvailableSlots(order,working,exceptions,diags){var slots={morning:[],afternoon:[]},diags=_.orderBy(diags,function(v){return v.priority});return diags.forEach(function(diag){if(isExceptionCollidingWholeDay(diag,order,exceptions))return void(DEBUG&&console.log(diag._id+" exception colliding whole day"));var _exceptions=orderDiagExceptions(order,diag,exceptions),_collisions=_.union(filterOrders(working,diag),_exceptions);if(_collisions=_.union(_collisions,slots.morning),_collisions=_.union(_collisions,slots.afternoon),slots.morning.length<2)if(freeMorning(order,_collisions))slots=allocateFixedMorning(slots,order,diag);else{var sumo=allocateMorning(diag,order,_collisions,slots);sumo&&slots.morning.length<2&&(_collisions.push(slots.morning[slots.morning.length-1]),allocateMorning(diag,order,_collisions,slots))}if(slots.afternoon.length<2)if(freeAfternoon(order,_collisions))slots=allocateFixedAfternoon(slots,order,diag);else{var sumo=allocateAfternoon(diag,order,_collisions,slots);sumo&&slots.afternoon.length<2&&(_collisions.push(slots.afternoon[slots.afternoon.length-1]),allocateAfternoon(diag,order,_collisions,slots))}}),_.union(slots.morning,slots.afternoon)}function allocateFixedMorning(_slots,order,diag){if(isToday(order))if(moment().isBefore(moment().hour(11).minutes(30)))if(moment().isBefore(moment().hour(8).minutes(0)))_slots.morning.push(slot(9,0,order,diag),slot(10,0,order,diag)),DEBUG&&console.log("allocate-fixed-morning-today-at-9h00-and-10h00-current-time-before-08h00: ");else{var fixed=moment().add(1,"hour");if(fixed.isBefore(moment().hour(11).minutes(30))){var minutes=10*parseInt(parseInt(fixed.minutes())/10,10);_slots.morning.push(slot(fixed.hours(),minutes,order,diag)),DEBUG&&console.log("allocate-fixed-morning-today-at: ",fixed),fixed=fixed.add(1,"hour"),fixed.isBefore(moment().hour(11).minutes(30))?(_slots.morning.push(slot(fixed.hours(),minutes,order,diag)),DEBUG&&console.log("allocate-fixed-morning-today-at: ",fixed)):DEBUG&&console.log("allocate-fixed-morning-today-skip: fixed beyond limit (11h30)",fixed)}else DEBUG&&console.log("allocate-fixed-morning-today-skip: fixed beyond limit (11h30)",fixed)}else DEBUG&&console.log("allocate-fixed-morning-skip-current-time-after-11h30: ",fixed);else _slots.morning.push(slot(9,0,order,diag),slot(10,0,order,diag));return _slots}function allocateFixedAfternoon(_slots,order,diag){if(isToday(order))if(moment().isAfter(moment().hour(13).minutes(0))){var fixed=moment().add(1,"hour"),limit=moment().hours(19).minutes(0).subtract(order.time.hours,"hours").subtract(order.time.minutes,"minutes");if(fixed.isBefore(limit)){var minutes=10*parseInt(parseInt(fixed.minutes())/10,10);_slots.afternoon.push(slot(fixed.hours(),minutes,order,diag)),DEBUG&&console.log("allocate-fixed-afternoon-today-at: ",fixed),fixed=fixed.add(1,"hour"),fixed.isBefore(limit)?(_slots.afternoon.push(slot(fixed.hours(),minutes,order,diag)),DEBUG&&console.log("allocate-fixed-afternoon-today-at: ",fixed)):DEBUG&&console.log("allocate-fixed-afternoon-today-skip: fixed beyond limit",limit,fixed)}else DEBUG&&console.log("allocate-fixed-afternoon-today-skip: fixed beyond limit",limit,fixed)}else _slots.afternoon.push(slot(14,0,order,diag),slot(15,0,order,diag)),DEBUG&&console.log("allocate-fixed-afternoon-today-at-14-and-15-current-time-before-13h00: ",fixed);else _slots.afternoon.push(slot(14,0,order,diag),slot(15,0,order,diag));return _slots}function isToday(order){return moment(order.day).isSame(moment(),"day")}function filterOrders(orders,diag){return orders.filter(function(v){return v._user==diag._id})}function allocateMorning(diag,order,collisions,arr){var startMinH=8,startMinM=0;if(isToday(order)){if(moment().isAfter(moment().hour(11).minutes(30)))return!1;startMinH=moment().add(1,"hour").hours(),startMinM=moment().minutes()}return allocate(startMinH,startMinM,11,30,diag,order,collisions,arr,"morning")}function allocateAfternoon(diag,order,collisions,arr){var startMinH=13,startMinM=0,startMax=moment(order.day).hours(19).minutes(0).subtract(order.time.hours,"hour").subtract(order.time.minutes,"minutes");if(isToday(order)){if(moment().isAfter(moment().hour(startMax.hours()).minutes(startMax.minutes())))return!1;startMinH=moment().add(1,"hour").hours(),startMinM=moment().minutes()}return allocate(startMinH,startMinM,startMax.hours(),startMax.minutes(),diag,order,collisions,arr,"afternoon")}function normalizeStart(start){start=moment(start);var h=start.hours(),m=start.minutes();return m>0&&m<30&&(m=30),m>30&&(m=0,h++),start.hours(h).minutes(m)}function allocate(startMinH,startMinM,startMaxH,startMaxM,diag,order,collisions,arr,propName){var startMin=moment(order.day).hour(startMinH).minutes(startMinM),startMax=moment(order.day).hour(startMaxH).minutes(startMaxM),cut=!1,start=moment(startMin),_cols=[],c=0;do{if(_cols=rangeCollisions4(start,order,collisions),0==_cols.length){if(_cols=rangeCollisions5(orderEnd(start,order),1,30,collisions),0==_cols.length){var _s=slot(start.hours(),start.minutes(),order,diag);return arr[propName].push(_s),!0}start=moment(_cols[_cols.length-1].end).add(1,"hours").add(30,"minutes"),start=normalizeStart(start)}else start=moment(_cols[_cols.length-1].end).add(1,"hours").add(30,"minutes"),start=normalizeStart(start);c++,c>20&&(cut=!0)}while(moment(start).isBefore(moment(startMax))||cut);return!1}function freeMorning(order,collisions){var lastAssignableMorningDate=moment(order.day).hours(11).minutes(30);return 0==collisions.filter(function(v){return moment(v.start).isBefore(lastAssignableMorningDate)}).length}function freeAfternoon(order,collisions){var minAssignableAfternoonDate=moment(order.day).hours(13).minutes(0);return 0==collisions.filter(function(v){return moment(v.start).isAfter(minAssignableAfternoonDate)}).length}function slot(h,m,order,diag){
var start=moment(order.day).hour(h).minutes(m);return{_diag:diag._id,start:start,end:moment(start).add(order.time.hours,"hours").add(order.time.minutes,"minutes")}}function orderEnd(start,order){return moment(start).add(order.time.hours,"hours").add(order.time.minutes,"minutes")}function rangeCollisions5(date,hp,mp,collisions){return rangeCollisions2(date,moment(date).hours(),moment(date).minutes(),hp,mp,collisions)}function rangeCollisions4(start,order,collisions){return rangeCollisions(start,orderEnd(start,order),collisions)}function rangeCollisions2(date,h,m,hp,mp,collisions){var start=moment(date).hour(h).minutes(m),end=moment(start).add(hp,"hours").add(mp,"minutes");return rangeCollisions(start,end,collisions)}function rangeCollisions(start,end,collisions){var get=function(cb){return collisions.filter(function(v){return cb(v)})||[]},rta=get(function(r){return moment(r.start).isSameOrAfter(start)&&moment(r.start).isSameOrBefore(end)});return _.union(rta,get(function(r){return moment(r.end).isSameOrAfter(start)&&moment(r.end).isSameOrBefore(end)})),rta}function orderDiagExceptions(order,diag,exceptions){var repeatWeek,sameDOW,collide,sameDay=!1,repeatDay=!1;return exceptions.filter(function(range){return range._user===diag._id&&(collide=!0,sameDay=moment(range.start).isSame(order.day,"day"),repeatDay="day"==range.repeat,repeatWeek="week"==range.repeat,sameDOW=moment(order.day).day()==moment(range.start).day(),collide=collide&&(sameDay||repeatDay||repeatWeek&&sameDOW))})}function isExceptionCollidingWholeDay(diag,order,exceptions){return exceptions.some(function(ex){var o=moment(order.day);return ex._user==diag._id&&(moment(ex.start).isBefore(o.hour(8).minutes(0))&&moment(ex.end).isAfter(o.hour(19).minutes(0)))})}global.diagsCalculateAvailableSlots=diagsCalculateAvailableSlots,global.diagsGetAvailableRanges=diagsGetAvailableRanges;var DEBUG=!1}("undefined"!=typeof exports&&exports||window),function(){var app=angular.module("diags_ctrl_contact_form",[]);app.controller("diags_ctrl_contact_form",["server","$timeout","$scope","$rootScope","$uibModal",function(db,$timeout,s,r,$uibModal){s._email={},s.send=function(){db.ctrl("Notification","ADMIN_NEW_CONTACT_FORM_MESSAGE",s._email).then(function(d){d.ok?r.infoMessage("Message envoyé"):r.infoMessage("Problème de serveur , réessayer plus tard")})},s.validate=function(){$U.ifThenMessage([[!s._email.fullname,"==",!0,"Prénom Nom requis"],[!s._email.email,"==",!0,"Email requis"],[!s._email.phone,"==",!0,"Phone requis"],[!s._email.message,"==",!0,"Message requis"]],function(m){s.warningMsg(m[0],1e4)},s.send)}}])}();var app=angular.module("app",["app.run","ngSanitize","app.services","app.directives","app.login","ngRoute","diags_ctrl_contact_form","ui.bootstrap","srv.diagPrice","srv.diagSlots"]),URL={HOME:"home",CONTACT_US:"contactez-nous",ERNT:"ernmt",FAQ:"faq",GENERAL_CONDITIONS:"conditions-generales-utilisation",LEGAL_MENTIONS:"mentions-legales",DIAGS:"choix-diagnostics",RDV:"rendez-vous",LOGIN:"connexion",ESPACE_ENTERPRISE:"espace-enterprise",ESPACE_DIAG:"espace-diagnostiqueur",ACCOUNT_DETAILS:"account-details",ACCOUNT_DETAILS_BOOKING:"inscription-details",PAYMENT:"payment"};app.config(["$routeProvider",function($routeProvider){$routeProvider.when("/",{templateUrl:"views/diags/booking/booking-1-home.html"}).when("/home",{templateUrl:"views/diags/booking/booking-1-home.html"}).when("/mentions-legales",{templateUrl:"views/diags/legal-mentions.html"}).when("/conditions-generales-utilisation",{templateUrl:"views/diags/general-conditions.html"}).when("/ernmt",{templateUrl:"views/diags/ernmt.html"}).when("/faq",{templateUrl:"views/diags/faq.html"}).when("/contactez-nous",{templateUrl:"views/diags/contact-us.html"}).when("/choix-diagnostics",{templateUrl:"views/diags/booking/booking-2-diags-selection.html"}).when("/rendez-vous",{templateUrl:"views/diags/booking/booking-3-date-selection.html"}).when("/connexion",{templateUrl:"views/diags/booking/booking-4-connection.html"}).when("/new-inscription",{templateUrl:"views/diags/booking/booking-espace-enterprise.html"}).when("/espace-enterprise",{templateUrl:"views/diags/booking/booking-espace-enterprise.html"}).when("/espace-diagnostiqueur",{templateUrl:"views/diags/booking/booking-espace-diagnostiqueur.html"}).when("/account-details",{templateUrl:"views/diags/booking/booking-inscription-details.html"}).when("/inscription-details",{templateUrl:"views/diags/booking/booking-5-inscription.html"}).when("/payment",{templateUrl:"views/diags/booking/booking-6-payment.html"}).otherwise({redirectTo:"/"})}]),app.controller("ctrl.booking",["server","$timeout","$scope","$rootScope","$uibModal","diagPrice","diagSlots",function(db,$timeout,s,r,$uibModal,diagPrice,diagSlots){function creatediagSlots(){s.diagSlots=diagSlots(s,s.item)}function resolvePaymentScreenAuth(){return $U.MyPromise(function(resolve,err,emit){return s._user&&s._user._id?($U.url.get("auth")||($U.url.set("auth",s._user._id),s.__manualUrlChange=(new Date).getTime()),void resolve()):$U.url.get("auth")?void db.ctrl("User","get",{_id:$U.url.get("auth")}).then(function(_user){return(_user=_user.ok&&_user.result||null)?(s._user=_user,$U.url.set("auth",s._user._id),s.__manualUrlChange=(new Date).getTime(),resolve(),void 0):r.moveToLogin()}):r.moveToLogin()})}function resolvePaymentScreenOrder(){if($U.url.get("order"))s._order._id||s.fetchOrder($U.url.get("order"));else if(s._order._id){if(!s._order._id)throw Error("ORDER-ID-NULL");s.__manualUrlChange=(new Date).getTime(),$U.url.set("order",s._order._id)}else s.saveAsync().on("success",function(){if(s.__manualUrlChange=(new Date).getTime(),!s._order._id)throw Error("ORDER-ID-NULL");$U.url.set("order",s._order._id)})}function atLeastOneDiagSelected(){for(var x in s.item.diags)if(1==s.item.diags[x])return!0;return!1}function fetch_diag_info(){fetch_diag_info_called||(fetch_diag_info_called=!0,db.ctrl("User","get",{_id:s.item._diag}).then(function(res){s.__diag=res.result}).error(function(){fetch_diag_info_called=!1}))}function orderPaid(){return _.includes($D.ORDER_STATUS_PAID,s._order.status)}function updateAutoSave(enabled){function cloneOrder(){s.__clonedOrder=_.cloneDeep(s._order)}enabled=enabled||!0;var saving=!1;return s.__autoSaveInterval&&window.clearInterval(s.__autoSaveInterval),enabled?s._order?(cloneOrder(),void(s.__autoSaveInterval=window.setInterval(function(){if(!saving&&s._order){var hasChanged=!_.isEqual(s.__clonedOrder,s._order);hasChanged&&(saving=!0,cloneOrder(),db.ctrl("Order","update",s._order).then(function(){saving=!1,console.info("auto-save: saved")}))}},5e3))):console.info("auto-save: call updateAutoSave _order exists"):console.info("auto-save: disabled")}function dtAfter(d1,d2,unit){return moment(d1).isAfter(moment(d2),unit)}function toggleMandatory(n,val){s.diags.forEach(function(diag){(n&&diag.name==n||!n)&&(diag.mandatory=val,r.dom())})}function updateChecksVisibilityOnDemand(){function updateChecks(){"Avant le 01/01/1949"===s.item.constructionPermissionDate?(toggle("crep",!0),s.item.diags.crep=!0,toggleMandatory("crep",!0)):(s.item.diags.crep=!1,toggle("crep",!0),toggleMandatory("crep",!1)),s.departmentHasTermites()?(toggle("termites",!0),s.item.diags.termites=!0,toggleMandatory("termites",!0)):(toggle("termites",!1),s.item.diags.termites=!1,toggleMandatory("termites",!1)),_.includes(["Avant le 01/01/1949","Entre 1949 et le 01/07/1997"],s.item.constructionPermissionDate)?(toggle("dta",!0),s.item.diags.dta=!0,toggleMandatory("dta",!0)):(toggle("dta",!0),s.item.diags.dta=!1,toggleMandatory("dta",!1)),_.includes(["Oui, Plus de 15 ans","Oui, Moins de 15 ans"],s.item.gasInstallation)?(toggle("gaz",!0),1==s.item.sell&&"Oui, Plus de 15 ans"===s.item.gasInstallation?(s.item.diags.gaz=!0,toggleMandatory("gaz",!0)):(s.item.diags.gaz=!1,toggleMandatory("gaz",!1))):(toggle("gaz",!1),toggleMandatory("gaz",!1)),_.includes(["Plus de 15 ans","Moins de 15 ans"],s.item.electricityInstallation)?(toggle("electricity",!0),1==s.item.sell&&"Plus de 15 ans"===s.item.electricityInstallation?(s.item.diags.electricity=!0,toggleMandatory("electricity",!0)):(s.item.diags.electricity=!1,toggleMandatory("electricity",!1))):(toggle("electricity",!1),toggleMandatory("electricity",!1))}var toggle=function(n,val){s.diags.forEach(function(diag){(n&&diag.name==n||!n)&&(diag.show=val,0==diag.show&&(s.item.diags[diag.name]=!1))})};s.diags.forEach(function(val,key){s.item.diags[val.name]=!!val.mandatory}),s.$watch("item.constructionPermissionDate",updateChecks),s.$watch("item.sell",updateChecks),s.$watch("item.gasInstallation",updateChecks),s.$watch("item.address",updateChecks),s.$watch("item.electricityInstallation",updateChecks),toggle(void 0,!0)}function loadDefaults(){s.item=Object.assign(s.item,{sell:paramBool("sell")||!0,house:paramBool("house")||void 0,squareMeters:param("squareMeters",s.squareMeters)||"90 - 110m²",constructionPermissionDate:param("cpd",s.constructionPermissionDate)||void 0,address:param("address")||void 0,gasInstallation:param("gasInstallation",s.gasInstallation)||void 0,electricityInstallation:param("electricityInstallation",s.electricityInstallation)||s.item.electricityInstallation||void 0,date:paramDate("date"),time:param("time",["any"]),clientType:param("clientType",s.CLIENT_TYPES)}),creatediagSlots(),r.dom(function(){try{var x=0;for(var pos in s.squareMeters){if(s.item.squareMeters==s.squareMeters[pos])break;x++}$("input[type=range]").val(x)}catch(e){}}),$U.emitPreserve("booking-defaults-change"),s.diags.forEach(function(diag){var val=paramBool(diag.name);_.isUndefined(val)||_.isNull(val)||(s.item.diags[diag.name]=val)})}function getOrderPopupData(){var keysInfo=s._order.keysAddress+" / "+r.momentDateTimeWords(s._order.keysTimeFrom)+" - "+r.momentTime(s._order.keysTimeTo);return{diagNameConvertion:$D.diagNameConvertion,keysInfo:keysInfo,_order:s._order,_client:s._user}}function fetchOrder(_order_id){return $U.MyPromise(function(resolve,err,emit){var payload=Object.assign(s._order,{__populate:{_client:"_id email clientType address discount companyName",_diag:"_id email clientType address firstName lastName commission"}});_order_id&&(payload._id=_order_id),db.ctrl("Order","getById",payload).then(function(d){d.ok?(console.info("fetch-order",payload._id,r.momentDateTime(d.result.start)),r.dom(function(){setOrder(d.result)}),resolve(s._order)):err(d)})})}function setOrder(_order){s._order=_order,s._order.price=diagPrice.getPriceQuote(s),diagPrice.setPrices(s,s._order),commitOrderInfo(),updateAutoSave()}function commitOrderInfo(){s._order&&(void 0===s._order.info.addressBatiment&&(s._order.info.addressBatiment="Sur rue"),void 0===s._order.info.house&&void 0!==s.item.house&&(s._order.info.house=s.item.house),void 0===s._order.info.sell&&void 0!==s.item.sell&&(s._order.info.sell=s.item.sell),void 0===s._order.info.electricityInstallation&&void 0!==s.item.electricityInstallation&&(s._order.info.electricityInstallation=s.item.electricityInstallation),!s._order.info.description&&s.item&&(s._order.info.description=s.bookingDescriptionTitle()+s.bookingDescriptionBody()),void 0==s._order.info.house&&console.warn("The order info.house is undefined."))}function emailOfPersonWhoPaid(){var session=r.session();return session&&session._id==s._order._client._id?s._order._client.email:s._order.landLordEmail||""}r.URL=Object.assign(r.URL,URL),r.dom(),$U.expose("r",r),$U.expose("s",s),moment.locale("fr");var MESSAGES={ANSWER_SELL_OR_RENT:"Répondre Vendez / Louer",ANSWER_APPARTAMENT_OR_MAISON:"Répondre Appartament / Maison",FRENCH_ADDRESS_REQUIRED:"Adresse besoin d&#39;appartenir à France"};r.__textSTATIC={BOOKING_STRIPE_TEXT:"Paiement simplifié et sécurisé (PCI 1, le niveau le plus élevé) avec Stripe",BOOKING_HOME_BG_TEXT_1:"Accédez aux calendriers en live des diagnostiqueurs immobiliers certifiés, disponibles, au bon prix*",BOOKING_HOME_BG_TEXT_2:"Nous joindre au",BOOKING_HOME_BG_TEXT_PHONE:"0899 399 039"},$U.on("route-change",function(url){if(r.dom($U.scrollToTop),$U.indexOf(url,[URL.PAYMENT])?(s.__manualUrlChange||0)+5e3<(new Date).getTime()&&resolvePaymentScreenAuth().then(resolvePaymentScreenOrder):$U.url.clear(),$U.indexOf(url,[URL.HOME])||""==url?(s.__header=1,setTimeout(function(){$U.emit("render-ranges")},1e3)):s.__header=2,url.indexOf(URL.RDV)!==-1)var wait=setInterval(function(){s.diagSlots&&(clearInterval(wait),s.diagSlots.init(void 0,{department:s.item&&s.item.postCode&&s.item.postCode.substring(0,2)}))},100);$U.indexOf(url,[URL.ACCOUNT_DETAILS])&&(s._user&&s._user.__subscribeMode?delete s._user.__subscribeMode:(console.warn("current _user is not in _subscribeMode"),r.route(URL.HOME)))}),s._user={address:null},s._order={},s.booking={order:{saved:!1,exists:!1,taken:!1},complete:!1,payment:{complete:!1}},s.checks={selectAll:!1},s.proceedToDiagsSelection=function(){s.validateQuestions(function(){r.route("choix-diagnostics")},function(){if(!s.addressDepartmentCovered){var msg="Votre département n'est pas encore couvert par Diagnostical.<br>";msg+="Laissez-nous votre adresse e-mail pour être informé de l'ouverture du service dans votre département.",msg+="<div class='row margin-top-one' >",msg+="   <div class='col-sm-12'>",msg+="      <input class='diags-input' ng-model=\"data.email\" placeholder='adresse e-mail'>",msg+="   </div>",msg+="</div>",db.ctrl("Notification","ADMIN_BOOKING_MISSING_DEPARTMENT",{department:s.item.postCode.substring(0,2)});var modal=s.openConfirm({message:msg,data:{title:"Département en cours d'ouverture",hideYesButton:!0,email:r.session()&&r.session().email||"",customButton:!0,customButtonLabel:"Envoyer",customButtonClick:function(){return modal.scope.data.email?(db.ctrl("Notification","ADMIN_BOOKING_MISSING_DEPARTMENT_REQUEST",{department:s.item.postCode.substring(0,2),email:modal.scope.data.email,metadata:JSON.stringify(s.item)}),modal.close(),r.infoMessage("Nous avons été informés. Merci beaucoup.")):r.infoMessage("Email est nécessaire.")}}})}})},s.proceedToDateSelection=function(){s.validateQuestions(function(){return atLeastOneDiagSelected()?r.route("rendez-vous"):r.warningMessage("Sélectionnez au moins un choix")},function(){r.route("home")})},s.proceedToConnect=function(){setTimeout(function(){s.validateDate(function(){s._user&&s._user._id?r.route(URL.PAYMENT):s.moveToLogin()})},500)},s.moveToLogin=function(){r.logged()&&r.session().userType&&r.session().clientType&&"client"==r.session().userType?(s.auth.email=r.session().email,s.auth.pass=r.session().password,s.login()):r.route(URL.LOGIN)},s.dateSlot={proceedToConnect:s.proceedToConnect},s.validateBooking=function(cb){ifThenMessage([[s.isAgency()&&!s._order.landLordEmail,"==",!0,"E-mail du propriétaire requis"],[s.isAgency()&&!s._order.landLordFullName,"==",!0,"Nom du propriétaire requis"],[!s._order.keysAddress,"==",!0,"Clés Adresse requise"],[!s._order.keysTimeFrom,"==",!0,'Clés Temps "De" requis'],[!s._order.keysTimeTo,"==",!0,'Clés Temps "To" requis']],function(m){"string"!=typeof m[0]?s.warningMsg(m[0]()):s.warningMsg(m[0])},cb)},s.validateAuthInput=function(cb){ifThenMessage([[!s.auth.email,"==",!0,"Email required."],[!s.auth.pass,"==",!0,"Password required."]],function(m){"string"!=typeof m[0]?s.warningMsg(m[0]()):s.warningMsg(m[0])},cb)},s.validateClientDetails=function(cb){db.ctrl("User","exists",{email:s.auth.email,userType:"client"}).then(function(exists){exists=exists.ok&&1==exists.result,exists?s.warningMsg("This email address belongs to an existing member."):ifThenMessage([[!s._user.email,"==",!0,"Email c&#39;est obligatoire."],[!s._user.password,"==",!0,"Password c&#39;est obligatoire."],[!s._user.cellPhone,"==",!0,"Mobile c&#39;est obligatoire"]],function(m){"string"!=typeof m[0]?s.warningMsg(m[0]()):s.warningMsg(m[0])},cb)})},s.validateBeforePayment=function(cb,validateLoginAlso){return!validateLoginAlso||s._user&&s._user._id?void s.validateQuestions(function(){s.validateDate(cb,function(){return r.route(URL.RDV)})},function(){return r.route(URL.HOME)}):r.moveToLogin()},s.validateDate=function(cb,err){ifThenMessage([[s.item.start,"==",void 0,""],[s.item.end,"==",void 0,""],[s.item._diag,"==",void 0,""]],function(m){s.warningMsg("Sélectionner une date"),err&&err()},cb)},s.addressDepartmentCovered=!0,s.validateAddressDepartment=function(cb,err){var code=s.item.postCode.substring(0,2);console.info("debug validating address department",code),db.ctrl("User","departmentCoveredBy",{department:code.toString()}).then(function(res){return res.ok?(s.addressDepartmentCovered=res.result,void(1==res.result?cb&&cb():err&&err())):cb&&cb()})},s.validateQuestions=function(cb,err){ifThenMessage([[s.item.sell,"==",void 0,MESSAGES.ANSWER_SELL_OR_RENT],[s.item.house,"==",void 0,MESSAGES.ANSWER_APPARTAMENT_OR_MAISON],[s.item.squareMeters,"==",void 0,"Répondre Superficie"],[s.item.constructionPermissionDate,"==",void 0,"Répondre Permis de construire"],[s.item.gasInstallation,"==",void 0,"Répondre Gaz"],[s.item.electricityInstallation,"==",void 0,"Répondre Electricité"],[s.item.address,"==",void 0,"Répondre Address"],[_.includes(["France","Francia","Frankrig","Frankrijk","Frankreich","Frankrike","Francja"],s.item.country),"==",!1,MESSAGES.FRENCH_ADDRESS_REQUIRED]],function(m){s.warningMsg(m[0]),err&&err()},function(){s.validateAddressDepartment(cb,err)})},s.$watch("item.range",function(id){if(id){var data=JSON.parse(window.atob(id));s.item._diag=data._diag,s.item.start=data.start,s.item.end=data.end}}),s.dateSlotSelected=function(rng){return s.item.range&&s.item.range==rng.id},s.orderDateFormattedFromITEM=function(){s.item||console.warn("invalid-order");var _date=s.item&&s.item.start,m=moment(_date).format("dddd D MMMM YYYY");return m+=" à "+r.momentTime(_date),m.substring(0,1).toUpperCase()+m.slice(1)};var fetch_diag_info_called=!1;s.orderDiagFormattedFromITEM=function(){return s.__diag||fetch_diag_info(),"Avec "+(s.__diag&&s.__diag.firstName&&s.__diag.firstName+" "||"")+(s.__diag&&s.__diag.lastName&&s.__diag.lastName.substring(0,1).toUpperCase()+" "||"")},s.orderDateFormatted=function(){s._order||console.warn("invalid-order");var _date=s._order&&s._order.start,m=moment(_date).format("dddd D MMMM YYYY");return m+=" à "+r.momentTime(_date),m.substring(0,1).toUpperCase()+m.slice(1)},s.orderDiagFormatted=function(){return"Avec "+(s._order&&s._order._diag&&s._order._diag.firstName&&s._order._diag.firstName+" "||"Pepe ")+(s._order&&s._order._diag&&s._order._diag.lastName&&s._order._diag.lastName.substring(0,1).toUpperCase()+" "||"G")},s.$watch("checks.selectAll",function(){s.diags&&s.diags.forEach(function(d){s.item.diags[d.name]=s.checks.selectAll})},!0),db.ctrl("Settings","getAll",{}).then(function(d){d.ok&&d.result.length>0&&(s.settings=d.result[0])}),s.htmlReplaceDiagName=function(str){var code=str.replace("$NAME",s.diagSelected.label2).toUpperCase();return r.html(code)},s.orderPaid=orderPaid,s.departmentHasTermites=function(){if(s.item.department){var code=s.item.postCode.substring(0,2);return _.includes(s.termitesDepartments.map(function(v){return v.toString()}),code)}},s.orderExistsNote=function(){if(s.booking.order.exists&&s.booking.order.saved){if("landlord"!==s._user.clientType){if(1!=s._order.landLordPaymentEmailSended)return"The payment of this order is pending.";s.booking.order.delegatedTo||(s.booking.order.delegatedTo=s._order.landLordEmail)}var delegated="The payment of this order was delegated to "+s.booking.order.delegatedTo;return orderPaid()?1==s._order.landLordPaymentEmailSended?"This order was delegated to "+s.booking.order.delegatedTo+" and is already paid.":"This order is already paid":delegated}},s.__keysWhereItems={},s.__keysWhereGetItems=function(){return s._user&&s._user.clientType?s.isLandLord()?{"Ou ?":function(){return""},"Sur Place":function(){return s._order.address},"Votre adresse":function(){return s._user.address},Other:function(){return"other"}}:{"Ou ?":function(){return""},"Sur Place":function(){return s._order.address},"Votre adresse":function(){return s._user.address},"Résidence Principal":function(){return s._order.landLordAddress},Other:function(){return"other"}}:{"Ou ?":function(){return""}}},s.$watch("_user",function(val){s.__keysWhereItems=s.__keysWhereGetItems()},!0),s.__keysWhereSelectFirstItem=function(){return s.__keysWhereItems&&Object.keys(s.__keysWhereItems)[0]||"Loading"},s.__keysWhereSelectLabel=function(){return s.__keysWhereSelectLabelVal||s.__keysWhereSelectFirstItem()},s.__keysWhereSelect=function(key,val){s._order.keysWhere=val&&val()||void 0},s.$watch("_order.keysWhere",function(val){return void 0==val?(r.dom(function(){s._order.keysAddress="non disponible"}),r.dom(function(){s._order.keysAddress=void 0},2e3),s.__keysWhereSelectLabelVal="Ou ?"):(Object.keys(s.__keysWhereItems).forEach(function(k){s.__keysWhereItems[k]()==val&&(s.__keysWhereSelectLabelVal=k)}),s._order.keysAddress="other"==val?"":val,void r.dom(function(){if("Sur Place"==s.__keysWhereSelectLabel())s.__keysTimeFromSelect(r.momentTime(s._order.start),new Date(moment(s._order.start).toString()));else{var m=moment(s._order.start).hours(8);s.__keysTimeFromSelect(r.momentTime(m),new Date(m.toString()))}if("Sur Place"==s.__keysWhereSelectLabel())s.__keysTimeToSelect(r.momentTime(s._order.start),new Date(moment(s._order.start).toString()));else{var m=moment(s._order.start).subtract(30,"minutes");s.__keysTimeToSelect(r.momentTime(m),new Date(m.toString()))}},200))}),s.__keysTimeFromItems={},s.__keysTimeFromGetItems=function(){var vals={};if(!s._order)return vals;for(var m=moment(s._order.start).hours(8);m.isBefore(moment(s._order.start));)vals[r.momentTime(m)]=new Date(m.toString()),m=m.add(5,"minutes");return vals[r.momentTime(s._order.start)]=new Date(moment(s._order.start).toString()),vals},s.__keysTimeFromSelectFirstItem=function(){return s.__keysTimeFromItems&&Object.keys(s.__keysTimeFromItems)[0]||"Loading"},s.__keysTimeFromSelectLabel="choisir",s.__keysTimeFromSelect=function(key,val){s._order.keysTimeFrom=val,dtAfter(s._order.keysTimeFrom,s._order.keysTimeTo)&&(s._order.keysTimeTo=void 0),s.__keysTimeFromSelectKey=key},s.$watch("_order.keysTimeFrom",function(val){val?(s.__keysTimeFromSelectLabel="choisir",_.each(s.__keysTimeFromItems,function(v,k){v==val&&(s.__keysTimeFromSelectLabel=k)}),"choisir"==s.__keysTimeFromSelectLabel&&s.__keysTimeFromSelectKey&&(s.__keysTimeFromSelectLabel=s.__keysTimeFromSelectKey)):s.__keysTimeFromSelectLabel="choisir"}),s.$watch("_order.start",function(val){s.__keysTimeFromItems=s.__keysTimeFromGetItems()}),s.__keysTimeToItems={},s.__keysTimeToGetItems=function(){var vals={};if(!s._order)return vals;var m=moment(s._order.start).hours(8).minutes(0);for(moment(s._order.keysTimeFrom).isAfter(m)&&moment(s._order.keysTimeFrom).isBefore(moment(s._order.start))&&(m=m.hours(moment(s._order.keysTimeFrom).hours()),m=m.minutes(moment(s._order.keysTimeFrom).minutes()));m.isBefore(moment(s._order.start));)vals[r.momentTime(m)]=new Date(m.toString()),m=m.add(5,"minutes");return vals[r.momentTime(s._order.start)]=new Date(moment(s._order.start).toString()),vals},s.__keysTimeToSelectFirstItem=function(){return s.__keysTimeToItems&&Object.keys(s.__keysTimeToItems)[0]||"Loading"},s.__keysTimeToSelectLabel="choisir",s.__keysTimeToSelect=function(key,val){s._order.keysTimeTo=val,s.__keysTimeToSelectKey=key},s.$watch("_order.keysTimeTo",function(val){val?(s.__keysTimeToSelectLabel="choisir",_.each(s.__keysTimeToItems,function(v,k){v==val&&(s.__keysTimeToSelectLabel=k)}),"choisir"==s.__keysTimeToSelectLabel&&s.__keysTimeToSelectKey&&(s.__keysTimeToSelectLabel=s.__keysTimeToSelectKey)):s.__keysTimeToSelectLabel="choisir"}),s.$watch("_order.keysTimeFrom",function(val){s.__keysTimeToItems=s.__keysTimeToGetItems()}),s.$watch("_order.start",function(val){s.__keysTimeToItems=s.__keysTimeToGetItems()}),r.logger.addControlledErrors(["ORDER_EXISTS","ORDER_TAKEN"]),s.datepicker={minDate:moment(),maxDate:moment().add(60,"day"),initDate:new Date},s.CLIENT_TYPES=["agency","enterprise","landlord","other"],s.CLIENT_TYPES_COMPANY=["agency","enterprise","other"],s.isLandLord=function(){return!_.includes(s.CLIENT_TYPES_COMPANY,s._user.clientType)},s.isAgency=function(){return!s.isLandLord()},s.item={date:void 0,diags:{},clientType:"landlord"};var waitForProperties=function(cbArray,props){var i=setInterval(function(){var rta=!0;props.forEach(function(v){_.isUndefined(s[v])&&(rta=!1)}),rta&&(clearInterval(i),cbArray.forEach(function(cb){cb()}))},200)};s.__constructionPermissionDateSelectLabel="choisir",s.__constructionPermissionDateSelect=function(key,val){s.item.constructionPermissionDate=val},s.$watch("item.constructionPermissionDate",function(val){s.__constructionPermissionDateSelectLabel=val?val:"choisir",r.dom()}),s.__gazSelectLabel="choisir",s.__gazSelect=function(key,val){s.item.gasInstallation=val},s.$watch("item.gasInstallation",function(val){s.__gazSelectLabel=val?val:"choisir",r.dom()}),s.diagRightClass=function(){var cls={"diag-dialog-right":!0,"padding-two":!0};return cls["bg-"+s.diagSelected.name]=!0,cls},s.diagSelected={},s.selectDiag=function(d){return s.diagSelected="string"==typeof d?s.diag[d]:d},s.homeOneTitle=function(){return decodeURI(val(s.diagSelected,"dialogs.one.title"))},s.homeOneContent=function(){return decodeURI(val(s.diagSelected,"dialogs.one.content"))},s.homeTwoTitle=function(){return decodeURI(val(s.diagSelected,"dialogs.two.title"))},s.homeTwoContent=function(){return decodeURI(val(s.diagSelected,"dialogs.one.content"))},s.homeThreeTitle=function(){return decodeURI(val(s.diagSelected,"dialogs.two.title"))},s.homeThreeContent=function(){return decodeURI(val(s.diagSelected,"dialogs.three.content"))},db.localData().then(function(data){Object.assign(s,data),s.diags=_.sortBy(s.diags,function(o){return o.sort}),s.diag=s.diag||{},s.diags.forEach(function(diag){s.diag[diag.name]=diag}),s.diagSelected=s.diag.dpe,updateChecksVisibilityOnDemand(),waitForProperties([loadDefaults,r.dom],["notify"])});var diagDescription=function(n){var rta=n;return s.diags.forEach(function(diag){n&&diag.name==n&&(rta=diag.label)}),"cpd"===n&&(rta="constructionPermissionDate"),rta},diag=function(n){var rta=null;return s.diags.forEach(function(diag){n&&diag.name==n&&(rta=diag)}),rta};s.diagLabel=function(n,v){if(v)return diag(n).label};var param=function(n,validate){var val=getParameterByName(n);if(val){if(validate){var vals=Object.keys(validate).map(function(v){return validate[v]});if(vals.length>0&&!_.includes(vals,val)){var msg="Parameter "+diagDescription(n)+" has the follow valid values:"+JSON.stringify(vals);return console.warn(msg),void s.notify(msg,"warning",0,!0,{duration:99999})}return val}return val}},paramDate=s.paramDate=function(n){var v=(getParameterByName(n)||"").toString(),d=new Date(v);if(isFinite(d)){var fail=!1;return moment(d).isBefore(s.datepicker.minDate,"day")&&(fail=!0),moment(d).isAfter(s.datepicker.maxDate,"day")&&(fail=!0),fail?void s.notify("Parameter "+n+" needs to be a valid date between "+s.datepicker.minDate.format("DD/MM/YY")+" and "+s.datepicker.maxDate.format("DD/MM/YY"),"warning",0,!0,{duration:99999}):d}null!==getParameterByName(n)&&s.notify("Parameter "+n+" needs to be a valid date","warning",0,!0,{duration:99999})},paramBool=function(n){var v=(getParameterByName(n)||"").toString();return _.includes(["1","0"],v)?"1"===v:void(null!==getParameterByName(n)&&s.notify("Parameter "+n+" needs to be a 1/0","warning",0,!0,{duration:99999}))};s.toggleMandatory=toggleMandatory,s.lineThrough=function(item){return 0==item.show},s.openOrderConfirmationPrepaid=function(cb){cb=cb||function(){},s.openConfirm({backdrop:"static",data:getOrderPopupData(),templateUrl:"views/diags/booking/partials/booking-popup-order-prepaid.html"},cb)},s.openOrderConfirmationDelegated=function(cb){cb=cb||function(){},s.openConfirm({backdrop:"static",data:getOrderPopupData(),templateUrl:"views/diags/booking/partials/booking-popup-order-delegated.html"},cb)},s.selectedDate=function(){return moment(s.item.date).format("DD MMMM YYYY")},s.drawRange=function(rng){var rta=moment(rng.start).format("HH[h]mm");return rta+=" - "+rng.price+" €"},s.infoMsg=function(msg){s.notify(msg,{type:"info",duration:5e3})},s.warningMsg=function(msg){s.notify(msg,{type:"warning",duration:5e3})},s.successMsg=function(msg){s.notify(msg,{type:"success",duration:2e3})},s.auth={email:void 0,pass:void 0},s.orderSaved=function(){return s._order&&s._order._id},s.paymentDelegated=function(){return 1==s._order.landLordPaymentEmailSended},s.login=function(){s.validateAuthInput(function(){db.ctrl("User","get",{email:s.auth.email,password:s.auth.pass,userType:"client"}).then(function(_user){_user=_user.ok&&_user.result||null,_user?(s.item.clientType=_user.clientType,s._user=_user,s.validateBeforePayment(function(){s.saveAsync().on("success",function(){s.route(URL.PAYMENT)})},!0)):s.warningMsg("Invalid credentials")})})},s.invoiceEndOfTheMonth=function(){s.validateBooking(function(){db.ctrl("Order","confirm",s._order).then(function(d){d.ok&&(s.booking.complete=!0,db.ctrl("Order","update",s._order))})})},s.bookingDescriptionTitle=function(){return s.item.sell?"Pack Vente: ":"Pack Location: "},s.bookingDescriptionBody=function(){var rta="";return rta+=s.item.house?"Maison":"Appartement",s.item.city&&(rta+=" à "+s.item.city),s.item.constructionPermissionDate&&(rta+=" "+s.item.constructionPermissionDate),rta+=", "+s.item.squareMeters,_.includes(["Non","Oui, Moins de 15 ans"],s.item.gasInstallation)||(rta+=", Gaz"),"Moins de 15 ans"!=s.item.electricityInstallation&&(rta+=", Électricité"),rta+="."},s.bookingDescription=function(){return s.bookingDescriptionTitle()+s.bookingDescriptionBody()},s.sendPaymentLink=function(){function _sendPaymentLink(){db.ctrl("Order","update",s._order),s.openConfirm({templateUrl:"views/diags/booking/partials/booking-delegate-popup.html",data:{email:s._order.landLordEmail,title:"Confirmer la délégation"}},function(){$D.getInvoiceHTMLContent(db,s._order,r,function(html){db.ctrl("Notification","LANDLORD_ORDER_PAYMENT_DELEGATED",{_user:s._user,_order:s._order,attachmentPDFHTML:html}).then(function(data){return data.ok?(s.infoMsg("Commande Créée",1e4),s._order.notifications=s._order.notifications||{},s._order.notifications.LANDLORD_ORDER_PAYMENT_DELEGATED=!0,s._order.status="ordered",db.ctrl("Order","update",{_id:s._order._id,notifications:s._order.notifications,status:s._order.status}),s.booking.complete=!0,void s.openOrderConfirmationDelegated(function(){s._order={},r.route("home")})):r.warningMessage("Le courriel ne peut être envoyé à ce moment , d'essayer de nouveau de backoffice",1e4)})})})}s.validateBooking(_sendPaymentLink)},s.subscribeClientStandAlone=function(){s.createClient(function(){s.infoMsg("Le compte a été créé . Vérifiez votre email ."),r.route(URL.HOME)})},s.subscribeClient=function(){s.createClient(function(){s.validateBeforePayment(function(){s.saveAsync().on("success",function(){s.route(URL.PAYMENT)})},!0)})},s.createClient=function(cb){s.validateClientDetails(function(){db.ctrl("User","createClient",s._user).then(function(data){data.ok?(s._user=data.result,cb()):s.warningMsg(data.err)})})},s.subscribeModeBooking=function(clientType){return s.subscribe(clientType,URL.ACCOUNT_DETAILS_BOOKING)},s.subscribeMode=function(clientType){return s.subscribe(clientType,URL.ACCOUNT_DETAILS)},s.subscribe=function(clientType,nextRoute){s.validateAuthInput(function(){db.ctrl("User","exists",{email:s.auth.email,userType:"client"}).then(function(exists){exists=exists.ok&&1==exists.result,exists?s.warningMsg("This email address belongs to an existing member."):(s._user.email=s.auth.email,s._user.password=s.auth.pass,s._user.clientType=clientType,s._user.__subscribeMode=!0,r.route(nextRoute))})})},s.fetchOrder=fetchOrder,s.saveAsync=function(){return $U.MyPromise(function(resolve,err,evt){return s._user&&(s.item._client=s._user,s.item.email=s._user.email,s.item.clientType=s._user.clientType),!s.item.keysTimeFrom&&s.item.start&&(s.item.keysTimeFrom=moment(s.item.start).subtract(2,"hour")),!s.item.keysTimeTo&&s.item.start&&(s.item.keysTimeTo=moment(s.item.start)),
s.item.price=0,$U.hasUndefinedProps(s.item,["_diag","start","end"])?(s.warningMsg("Select one available date"),r.route(URL.RDV)):void db.ctrl("Order","saveWithEmail",s.item).then(function(data){var saved=data.ok;console.info("save-order",data.err);var exists="ORDER_EXISTS"===data.err,taken="ORDER_TAKEN"===data.err;(exists||taken)&&(saved=!0),r.dom(function(){return s._order=data.result,updateAutoSave(),saved&&evt("success"),saved?(db.ctrl("Order","getById",Object.assign(s._order,{__populate:{_client:"_id email clientType address discount companyName",_diag:"_id email clientType address firstName lastName commission"}})).then(function(d){d.ok&&setOrder(d.result)}),s._orderSAVED=saved||exists,s.booking.order.saved=saved||exists||taken,s.booking.order.exists=exists,void(s.booking.order.taken=1==taken)):(console.warn("save-error",data),s.warningMsg("An error occured, please try again later"))})}).err(function(err){s.notify("There was a server issue during the order saving proccess. Retrying in 10 seconds. Wait.",{type:"warning",duration:1e5}),setTimeout(s.saveAsync,1e4)})})},s.payNOW=function(success){return orderPaid()?s.infoMsg("Son ordre de travail a déjà été payée"):void s.validateBooking(function(){db.ctrl("Order","update",s._order),db.ctrl("User","update",s._user);var order=s._order;$D.openStripeModalPayOrder(order,function(token){order.stripeToken=token.id,order.stripeTokenEmail=token.email,db.ctrl("Order","pay",order).then(function(data){data.ok?(s._order.status="prepaid",s.booking.complete=!0,s.booking.payment.complete=!0,db.ctrl("Order","update",s._order),console.info("PAY-OK",data.result),s.infoMsg("Commande Créée",1e4),r.dom(function(){updateAutoSave(!1),$U.url.clear(),s.openOrderConfirmationPrepaid(function(){s._order={},r.route("home")})})):(console.info("PAY-FAIL",data.err),s.notify("Le paiement ne peut être traitée en ce moment.",{type:"warning",duration:1e5}))}).error(function(){s.notify("Le paiement ne peut être traitée en ce moment.",{type:"warning",duration:1e5})})},{config:r.config,email:emailOfPersonWhoPaid()})})},s.getDate=function(){return{date:moment(s.item.start).format("DD-MM-YY"),start:moment(s.item.start).format("HH[h]mm"),end:moment(s.item.end).format("HH[h]mm")}},s.subTotal=function(){return subTotal(s._order,s.diags,s.basePrice)},s.sizePrice=function(){return sizePrice(s._order,s.diags,s.squareMetersPrice,s.basePrice)},s.totalPrice=function(showRounded,opt){return totalPrice(showRounded,s._order,s.diags,s.squareMetersPrice,s.basePrice,Object.assign({s:s,r:r},opt||{}))},s.totalPriceRange=function(dt){return totalPrice(!0,s.item,s.diags,s.squareMetersPrice,s.basePrice,Object.assign({s:s,r:r,dt:dt},{}))},s.pickTimeRange=function(timeRange){s.item.start=timeRange.start,s.item._diag=timeRange._diag,s.item.end=timeRange.end,s.item.price=timeRange.price,timeRange.price||console.warn("time-range invalid price attribute",timeRange)},s.totalTime=function(){var total=0;s.item.diags=s.item.diags||{},Object.keys(s.item.diags).forEach(function(mkey){s.item.diags[mkey]&&s.diags.forEach(function(dval,dkey){if(dval.name==mkey)return dval.time=dval.price/4,total+=dval.time||0,!1})}),total=10*parseInt(parseInt(total)/10,10)+10;var hours=Math.floor(total/60),minutes=total%60,t={hours:hours,minutes:minutes};return t},s.totalTime.formatted=function(){var time=s.totalTime(),hours=time.hours,minutes=time.minutes;return minutes=minutes<10?"0"+minutes:minutes,hours>0?hours+":"+minutes+" hours":minutes+" minutes"}}]),app.directive("removeHidden",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){$rootScope.dom(function(){el.removeClass("hidden")},2e3)}}}),function(){function updateCategorySelectData(s,db,cb){s.categories=[],db.ctrl("Category","get",{code:"DIAGS"}).then(function(r){r&&r.ok&&r.result&&db.ctrl("Category","getAll",{_parent:r.result._id}).then(function(r){r&&r.ok&&r.result&&(s.categories=r.result,cb&&cb())})})}app.directive("ckEditor",["$compile",function(compile){return{restrict:"A",link:function(s,el,attrs){function init(){"undefined"!=typeof window.CKEDITOR?CKEDITOR.replace(attrs.name):setTimeout(init,1e3)}init()}}}]),app.controller("ctrl-text-edit",["server","$scope","$rootScope","$routeParams","focus",function(db,s,r,params){function check(){"undefined"!=typeof window.tinymce?r.dom(init):setTimeout(check,100)}function setData(decodedData){if(isCKEditor()){if(!CKEDITOR)return setTimeout(function(){return setData(decodedData)},500);CKEDITOR.instances.editor.setData(decodedData)}else tinymce.activeEditor.setContent(decodedData)}function initTinyMCE(){if("undefined"!=typeof window.tinyMCE)for(var length=window.tinyMCE.editors.length,i=length;i>0;i--)window.tinyMCE.editors[i-1].remove();tinymce.init({selector:"#editor",theme:"modern",height:300,plugins:["advlist autolink link image lists charmap print preview hr anchor pagebreak spellchecker","searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking","save table contextmenu directionality emoticons template paste textcolor"],content_css:"css/diags.design.css",toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media fullpage | forecolor backcolor emoticons"})}function init(){isCKEditor()||initTinyMCE(),params&&params.id&&"-1"!==params.id.toString()?(s.item._id=params.id,r.dom(s.read,0)):r.params.code&&db.ctrl("Text","get",{code:r.params.code}).then(function(res){res.ok&&res.result&&(s.item._id=res.result._id,r.dom(s.read,0))})}$U.expose("s",s),s.item={code:"",description:"",content:"",updatedByHuman:!0};var isCKEditor=function(){return r.params.code||r.params.ckeditor};s.isCKEditor=isCKEditor,updateCategorySelectData(s,db),isCKEditor()?init():check(),s.read=function(){db.ctrl("Text","get",{_id:s.item._id}).then(function(res){res.ok?(s.item=res.result,setData(window.decodeURIComponent(s.item.content))):r.warningMessage("Server issue while reading item. Try later.")})},s.save=function(){return s.item.code?s.item.description?s.item._category?(s.item.updatedByHuman=!0,isCKEditor()?s.item.content=window.encodeURIComponent(CKEDITOR.instances.editor.getData()):s.item.content=window.encodeURIComponent(tinymce.activeEditor.getContent()),void db.ctrl("Text","save",s.item).then(function(){r.route("texts"),r.params.code&&r.routeParams({_text:s.item})})):r.warningMessage("Page Section required"):r.warningMessage("Description required"):r.warningMessage("Code required")},s["delete"]=function(){s.confirm("Delete "+s.item.code+" ?",function(){db.ctrl("Text","remove",{_d:s.item._id})})}}]),app.directive("textsList",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server,$mongoosePaginate){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){},controller:function($scope,$element,$attrs,$transclude){function update(items,cb){var data={__populate:{_category:"code"},__sort:"-createdAt"};data=Object.assign(data,s.model.filter.payload),dbPaginate.ctrl(data,s.model).then(function(res){cb?cb(res.result):s.model.update(res.result,null)})}var r=$rootScope,db=server,s=$scope,dbPaginate=$mongoosePaginate.get("Text");$U.expose("s",s),r.routeParams({prevRoute:"texts"}),s.model={init:function(){updateCategorySelectData(s.model,db,function(){s.model.filter.firstTime()})},filter:{store:"TEXTS_LIST",template:"textsFilter",update:update,rules:{code:"contains",_category:"match"}},pagination:{itemsPerPage:10},paginate:function(cb){update(null,cb)},click:function(item,index){r.routeParams({item:item}),r.route("texts/edit/"+item._id)},buttons:[{label:"Rafraîchir",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return s.model.filter.filter()}},{label:"Clear Filters",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return s.model.filter.clear&&s.model.filter.clear()}},{label:"Créer",type:function(){return"btn diags-btn bg-azure-radiance margin-right-1"},click:function(){return r.route("texts/edit/-1")}}],columns:[{label:"Page Section",name:"_category",format:function(v,item){return item._category&&item._category.code||""}},{label:"Code",name:"code"},{label:"Description",name:"description"},{label:"UpdatedAt",name:"updatedAt",format:function(v,item){return r.momentFormat(item.updatedAt,"DD-MM-YY HH:mm")}},{label:"Edit",disabled:!0,name:"updatedAt",format:function(v,item){return'<i class="fa fa-pencil-square-o link" ng-click="model.editItem(item)" aria-hidden="true"></i>'}}],editItem:function(item){window.open(window.location.origin+"/admin#/texts/edit/"+item._id,"_blank")},items:[],records:{label:"Records",show:!0}}}}})}(),function(){var app=angular.module("srv.diagPrice",[]);app.service("diagPrice",function($rootScope,server){function diagsPrice(_order,diagsArr){var _diags={};debug("diags",_diags);var diag=null,rta=0;return Object.keys(_order.diags).forEach(function(diagName){_order.diags[diagName]&&(diag=diagsArr.filter(function(d){return d.name==diagName})[0],_diags[diagName]=diag.price,rta+=diag.price)}),rta}function getExtraDatePrice(price,date,scope){debug("extraDatePrice",0),debug("extraDatePriceType","");var porcentages=scope.settings.pricePercentageIncrease;return isTodaySaturday(date)?(debug("extraDatePrice",price*porcentages.todaySaturday/100),debug("extraDatePriceType","todaySaturday"),debug("extraDatePricePorc",porcentages.todaySaturday),price*porcentages.todaySaturday/100):isTodaySunday(date)?(debug("extraDatePrice",price*porcentages.todayMondayToFriday/100),debug("extraDatePriceType","todayMondayToFriday"),debug("extraDatePricePorc",porcentages.todayMondayToFriday),price*porcentages.todayMondayToFriday/100):isToday(date)?(debug("extraDatePrice",price*porcentages.todayMondayToFriday/100),debug("extraDatePriceType","todayMondayToFriday"),price*porcentages.todayMondayToFriday/100):isTomorrowSaturday(date)?(debug("extraDatePrice",price*porcentages.tomorrowSaturday/100),debug("extraDatePriceType","tomorrowSaturday"),debug("extraDatePricePorc",porcentages.tomorrowSaturday),price*porcentages.tomorrowSaturday/100):isTomorrowSunday(date)?(debug("extraDatePrice",price*porcentages.tomorrowSunday/100),debug("extraDatePriceType","tomorrowSunday"),debug("extraDatePricePorc",porcentages.tomorrowSunday),price*porcentages.tomorrowSunday/100):isTomorrow(date)?(debug("extraDatePrice",price*porcentages.tomorrowMondayToFriday/100),debug("extraDatePriceType","tomorrowMondayToFriday"),debug("extraDatePricePorc",porcentages.tomorrowMondayToFriday),price*porcentages.tomorrowMondayToFriday/100):isSaturday(date)?(debug("extraDatePrice",price*porcentages.saturday/100),debug("extraDatePriceType","saturday"),debug("extraDatePricePorc",porcentages.saturday),price*porcentages.saturday/100):isSunday(date)?(debug("extraDatePrice",price*porcentages.sunday/100),debug("extraDatePriceType","sunday"),debug("extraDatePricePorc",porcentages.sunday),price*porcentages.sunday/100):(debug("extraDatePrice",price*porcentages.mondayToFriday/100),debug("extraDatePriceType","mondayToFriday"),debug("extraDatePricePorc",porcentages.mondayToFriday),price*porcentages.mondayToFriday/100)}function warn(str){return console.warn("getPriceQuote: "+str),0}function debug(prop,val){void 0==prop&&(r.__priceQuote={}),r.__priceQuote[prop]=val}var r=$rootScope,isSaturday=function(d){return 6===moment(d).day()},isSunday=function(d){return 0===moment(d).day()},isTomorrowSaturday=function(d){return 6===moment().add(1,"day").day()&&moment(d).isSame(moment().add(1,"day"),"day")},isTomorrowSunday=function(d){return 0===moment().add(1,"day").day()&&moment(d).isSame(moment().add(1,"day"),"day")},isTomorrow=function(d){return moment(d).isSame(moment().add(1,"day"),"day")},isTodaySaturday=function(d){return 6===moment().day()&&moment().isSame(moment(d),"day")},isTodaySunday=function(d){return 0===moment().day()&&moment().isSame(moment(d),"day")},isToday=function(d){return moment().isSame(moment(d),"day")};return r.__priceQuote={},{setPrices:function(scope,_order){var diagCommissionRate=_order._diag.commission;if(void 0==diagCommissionRate)return console.warn("setPrices _order._diag.commission required");var vatRate=scope.settings.pricePercentageIncrease.VATRate||20,priceHT=_order.price/(vatRate/100+1);_order.vatPrice=_order.price-priceHT,_order.priceHT=priceHT,_order.diagRemunerationHT=_order.priceHT*diagCommissionRate/100,debug("diagRemunerationHT",_order.diagRemunerationHT),debug("diagCommissionRate",diagCommissionRate),debug("revenueRate",100-diagCommissionRate),_order.revenueHT=_order.priceHT-_order.diagRemunerationHT,debug("revenueHT",_order.revenueHT),_order.vatRate=vatRate},getPriceQuote:function(scope,date){debug(void 0);var _order=scope.item;if(scope._order&&scope._order._id&&(_order=scope._order),_order=_.cloneDeep(_order),_order.info||(_order.info=_order),debug("_order",_order),!_order)return warn("_order required.");if(date=date||_order.start,!date)return warn("date (or _order.start) required.");var basePrice=scope.basePrice;if(!basePrice)return warn("basePrice required.");debug("basePrice",basePrice);var squareMeters=_order.info.squareMeters;if(!squareMeters)return warn("squareMeters required.");var squareMetersPrice=scope.squareMetersPrice;if(!squareMetersPrice)return warn("squareMetersPrice required.");var squareMetersPorcentage=squareMetersPrice[squareMeters];if(!squareMetersPorcentage)return warn("squareMetersPorcentage required.");if(!scope.diags)return warn("diags required.");var selectedDiagsTotalPrice=diagsPrice(_order,scope.diags);debug("selectedDiagsTotalPrice",selectedDiagsTotalPrice);var subTotal=basePrice+selectedDiagsTotalPrice;debug("subTotal",subTotal);var extraBuildingSizePrice=subTotal*squareMetersPorcentage/100;debug("extraBuildingSizePrice",extraBuildingSizePrice),debug("extraBuildingSizePorc",squareMetersPorcentage);var extraDatePrice=getExtraDatePrice(subTotal,date,scope);debug("extraDatePrice",extraDatePrice),_order._client&&void 0!=_order._client.discount&&!isNaN(_order._client.discount)||(_order._client=_order._client||{},_order._client.discount=0,warn("_order._client.discount 0 .. 100 required (warning)"));var discountClientPorc=_order._client.discount,discountClientPrice=subTotal*_order._client.discount/100;debug("discountClientPrice",discountClientPrice),debug("discountClientPorc",discountClientPorc);var rta=subTotal+extraBuildingSizePrice+extraDatePrice-discountClientPrice,rtaRounded=10*parseInt(parseInt(rta)/10,10);debug("total",rta),debug("totalRoundedValue",Math.abs(rta-rtaRounded)),debug("totalRoundedHT",rtaRounded);var vatPrice=scope.settings.pricePercentageIncrease.VATRate||20;return debug("vatRate",vatPrice),vatPrice=rtaRounded*vatPrice/100,debug("vatPrice",vatPrice),rtaRounded+=vatPrice,debug("totalRoundedTTC",rtaRounded),rtaRounded}}})}(),function(){var app=angular.module("srv.diagSlots",[]);app.service("diagSlots",function($rootScope,server,diagPrice){var r=$rootScope,db=server;return function(scope,item){function requestSlots(date){return $U.MyPromise(function(resolve,error,evt){if(isFinite(new Date(date))){var time=$D.OrderTotalTime(item.diags,scope.diags),order={day:date,time:time};db.getAvailableRanges(order,_settings).then(function(data){var cbHell=$U.cbHell(data.length,function(){resolve(data)});data.forEach(function(r){r.id=window.btoa(JSON.stringify(r)),r.price=diagPrice.getPriceQuote(scope,date),db.ctrl("User","get",{_id:r._diag}).then(function(d){d.ok&&d.result&&(r.name=d.result.firstName+", "+d.result.lastName.substring(0,1),d.result.diagPriority&&(r.name+=" ("+d.result.diagPriority+")"),cbHell.next())})}),0==data.length&&cbHell.call()})}})}var _settings={};return function(){function asyncRequest(_date,cbHell,dataPosition){var _newDate=new Date(_date);requestSlots(_newDate).then(function(d){var d=_.orderBy(d,function(item){return item.start._d});if(d.length>4){try{db.ctrl("Log","create",{message:"booking-warning: date slot request retrieve "+d.length+" slots.",data:d})}catch(e){}for(;d.length>4;)d.pop()}_data[dataPosition]=new DaySlot(_newDate,d),cbHell.next()})}var DaySlot=function(_date,_slots){var o={date:moment(_date),slots:_slots,label:function(){return o.isToday()?"Aujourd’hui":r.momentFormat(o.date,"dddd DD MMMM")},isToday:function(){return o.date.isSame(moment(),"day")}};return o},_data=[],_nextTimes=0,cursor=moment(),o={};return o.setDiag=function(_diag){_settings._diag=_diag},o.get=function(){return _data},o.init=function(d,opt){cursor=moment(d),opt=opt||{},_settings.department=opt.department,o.request()},o.backIsDisabled=function(){return cursor.isSame(moment(),"days")},o.nextIsDisabled=function(){return!1},o.next=function(){return _nextTimes>15?(_nextTimes=0,o.init()):(_nextTimes++,cursor=cursor.add(4,"days"),void o.request())},o.back=function(){cursor.isSame(moment(),"days")||(cursor=cursor.subtract(4,"days"),cursor.isBefore(moment(),"days")?cursor=moment():_nextTimes--,o.request())},o.request=function(){var _localCursor=moment(cursor),cbHell=$U.cbHell(4,function(){o.get()[0].date.isSame(moment(),"day")&&0==o.get()[0].slots.length&&o.init(moment().add(1,"days").toDate())});asyncRequest(_localCursor._d,cbHell,0),_localCursor=_localCursor.add(1,"days"),asyncRequest(_localCursor._d,cbHell,1),_localCursor=_localCursor.add(1,"days"),asyncRequest(_localCursor._d,cbHell,2),_localCursor=_localCursor.add(1,"days"),asyncRequest(_localCursor._d,cbHell,3)},o}()}})}(),app.directive("niceCheckBox",function($rootScope,$timeout,$compile){return{restrict:"E",scope:{model:"=model",data:"=data",name:"@name",template:"@template",click:"=click"},templateUrl:"views/directives/checkbox.html",link:function(scope,el,attrs){var url="views/directives/checkbox.html";scope.template&&(url=url.replace(".html","-")+scope.template+".html"),$.ajax({url:url,async:!1,success:function(r){var e=$compile(r)(scope),cls=attrs["class"];el.replaceWith(e),$timeout(function(){el.children(0).addClass("class",cls),el.find("input").name=scope.name,$rootScope.$apply()})},error:function(err){console.error("niceCheckBox invalid template ",url,err)}})}}}),app.directive("checkBoxGroup",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){el.on("click",function(){var $box=$(this),group="input:checkbox[name='"+$box.attr("name")+"']";$(group).prop("checked",!1),$(group).prop("disabled",!1),$box.prop("checked",!0),$box.prop("disabled",!0)})}}}),app.directive("checkBoxModel",function($rootScope,$timeout,$compile){return{restrict:"A",scope:!1,link:function(scope,el,attrs){function set(_val){var ss=scope,split=attrs.checkBoxModel.split("."),last=split[split.length-1];split.forEach(function(word){if(word!=last)return ss=$rootScope.lookUp(ss,word),void 0==ss?(console.warn("checkBoxModel ",attrs.checkBoxModel,word+" is undefined"),0):void 0}),void 0!=ss&&(ss[last]=_val,$timeout($rootScope.$apply()))}el.on("click",function(){if(el.prop("checked")){var v,p=attrs.value.toString();v="false"==p||"true"==p?"true"==p:p,set(v)}}),$rootScope.dom(function(){var elValue=attrs.value.toString(),scopeValue=$U.val(scope,attrs.checkBoxModel);el.removeAttr("checked"),elValue==scopeValue&&el.attr("checked","")},500)}}}),app.directive("toggleClick",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){function val(value){var ss=scope,split=attrs.toggleValue.split("."),last=split[split.length-1];if(split.forEach(function(word){if(word!=last)return ss=ss[word],void 0==ss?(console.warn("toggleValue ",attrs.toggleValue,word+" is undefined"),0):void 0}),void 0!=ss)return void 0===value?ss[last]:(ss[last]=value,void $timeout($rootScope.$apply()))}el.on("click",function(){var v="string"==typeof attrs.ngValue&&"true"==attrs.ngValue.toLowerCase()||1==attrs.ngValue;val(v)}),$rootScope.$emit(attrs.toggleValue+"-changed",val())}}}),app.directive("toggleClass",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){function update(v){v==val?el.addClass(attrs.toggleClass):el.removeClass(attrs.toggleClass)}var val="string"==typeof attrs.ngValue&&"true"==attrs.ngValue.toLowerCase()||1==attrs.ngValue;return attrs.toggleValue?($rootScope.$on(attrs.toggleValue+"-changed",function(evt,v){}),void scope.$watch(attrs.toggleValue,function(v){"boolean"==typeof v&&update(v)})):console.warn("toggle-class: toggle-value attribute required.")}}}),app.directive("keyBind",function(){return{restrict:"A",link:function($scope,$element,$attrs){$element.bind($attrs.eventType||"keypress",function(event){var keyCode=event.which||event.keyCode;keyCode==$attrs.code&&$scope.$apply(function(){$scope.$eval($attrs.keyBind,{$event:event})})})}}}),app.directive("rangeModel",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){function update(){var index=Math.round(parseInt(handler.noUiSlider.get())),val=get(index);set(val,scope),$timeout(function(){$rootScope.$apply()})}function get(index){return vals[Object.keys(vals)[index]]}function set(val,ss){var split=attrs.rangeModel.split(".");split.forEach(function(word){if(word!=split[split.length-1]&&(ss=ss[word],void 0==ss))throw Error(word," is undefined")}),ss[split[split.length-1]]=val,setDomVal(val,vals)}function setDomVal(val,valsObject){$rootScope.dom(function(){try{var x=0;for(var pos in valsObject){if(val==valsObject[pos])break;x++}handler.noUiSlider.set(x)}catch(e){}})}if(!attrs.rangeValues)throw Error("rangeModel: rangeValues attribute requited.");var vals=scope[attrs.rangeValues],handler=el.get(0);$timeout(function(){el.attr("min",0),el.attr("max",Object.keys(vals).length-1),el.attr("step",1),noUiSlider.create(handler,{start:[0],step:1,range:{min:[0],max:[Object.keys(vals).length-1]}}),handler.noUiSlider.on("change",function(){update()}),handler.noUiSlider.on("slide",function(){update()}),$rootScope.$apply()}),$U.on("render-ranges",function(){setDomVal($U.val(scope,attrs.rangeModel),vals)})}}});var srv=angular.module("app.services",[]);srv.service("dbText",["$rootScope","server",function(r,db){r.__texts=[],r.__text=r.__text||{},r.__textSTATIC=r.__textSTATIC||{},this.update=function(){db.ctrl("Text","getAll",{}).then(function(d){r.__texts=d.result,r.__texts.forEach(function(item){r.__text[item.code]=window.decodeURIComponent(item.content)})})},r.htmlEditCancel=function(){r.htmlEditItem=void 0,r.dom()},r.htmlEditSave=function(){r.htmlEditItem.content=window.encodeURIComponent(window.CKEDITOR.instances.editor.getData()),console.log("save",window.decodeURIComponent(r.htmlEditItem.content).substring(0,10)+" ..."),r.__text[r.htmlEditItem.code]=window.decodeURIComponent(r.htmlEditItem.content),db.ctrl("Text","save",r.htmlEditItem).then(function(){}),r.htmlEditItem=void 0,r.dom()},r.htmlEdit=function(code){function setData(decodedData){return!window.CKEDITOR||window.CKEDITOR&&!window.CKEDITOR.instances||window.CKEDITOR&&window.CKEDITOR.instances&&!window.CKEDITOR.instances.editor?setTimeout(function(){return setData(decodedData)},500):void window.CKEDITOR.instances.editor.setData(decodedData)}r.routeParams({code:code}),window.CKEDITOR||$.getScript("https://cdn.ckeditor.com/4.5.9/full/ckeditor.js"),db.ctrl("Text","get",{code:r.params.code}).then(function(res){res.ok&&res.result&&(r.htmlEditItem=res.result,setData(window.decodeURIComponent(r.htmlEditItem.content)),$U.scrollToTop())})},r.html=function(code){function buildBlock(){var html="";if(r.userIs("admin")&&(html+="<i  onclick=\"r.htmlEdit('"+code+"')\" style='opacity:0.4; margin-left:-1em' class='link absolute fa fa-pencil-square-o ' aria-hidden='true'></i>&nbsp;"),r.__text&&r.__text[code]&&r.__text[code].length>1){var content=r.__text[code],tag=document.createElement("tag");tag.innerHTML=r.__text[code],tag.childNodes&&1==tag.childNodes.length&&"P"==tag.childNodes[0].tagName&&(content=tag.childNodes[0].innerHTML),html+=content}else txt?html+=txt:(r.isDevEnv()||r.userIs("admin"))&&(html+=code);return html}var txt=r.__textSTATIC[code]||"";if(r.__text&&r.__text[code]);else if(r.__textsNotFound=r.__textsNotFound||{},!r.__textsNotFound[code]&&(r.__textsNotFound[code]=code,r.isDevEnv())){var payload={code:code,categoryCode:$U.url.hashName()||"home",categoryRootCode:"DIAGS",content:txt};db.stackCtrl("reportNotFound","Text","reportNotFound",payload)}return buildBlock()}}]),srv.service("tpl",function($rootScope,$compile,$templateCache){var _this=this;this.compile=function(n,s){var raw=$templateCache.get(n+".html");return _this.compileRaw(raw,s)},this.compileRaw=function(raw,s){var el=$compile(angular.element(raw))(s);return el},expose("tpl",this)}),srv.service("$mongoosePaginate",["server",function(db){function handler(modelName){var self=this;self.id=Date.now(),self.working=!1,self.ctrl=function(data,model,opt){function autoResolve(res){opt.callback?opt.callback(res.result):model.update(res.result,null)}var promise=MyPromise(function(resolve,err,emit){if(!model.pagination)return err("model.pagination required."),void console.warn("$mongoosePaginate model.pagination required.");if(!self.working){self.working=!0,self.workingTS=Date.now(),function(ts){setTimeout(function(){self.workingTS==ts&&1==self.working&&(self.working=!1)},1e4)}(self.workingTS);var action=opt&&opt.action||"paginate";db.ctrl(modelName,action,Object.assign({__limit:model.pagination.itemsPerPage,__lean:!0,__page:model.pagination.currentPage},data)).then(function(r){if(self.working=!1,!r.ok)return void(self.working=!1);var numberOfPages=r.result.pages;model.pagination&&model.pagination.update({itemsLength:r.result.docs.length,numPages:numberOfPages,total:r.result.total}),r.result=r.result.docs,opt&&opt.autoResolve?(autoResolve(r),resolve(r)):resolve(r)})}});return promise}}return{get:function(modelName){return new handler(modelName)}}}]),srv.service("localdb",["$http",function(http){return function(settings){return MyPromise(function(resolve){resolve({localdb:!0})})}}]),srv.directive("fileModel",["$parse","$rootScope",function($parse,$rootScope){return{restrict:"A",scope:{model:"=fileModel",overwrite:"=fileModelOverwrite",field:"@field"},link:function(scope,element,attrs){var model=$parse(attrs.fileModel),modelSetter=model.assign;$U.expose("fileModel",scope),element.bind("change",function(){scope.$apply(function(){try{scope.model=scope.model||{},"undefined"!=typeof scope.overwrite&&(scope.overwrite=void 0!=scope.overwrite&&scope.overwrite,scope.overwrite="boolean"==typeof scope.overwrite&&scope.overwrite),scope.overwrite?scope.model=element[0].files[0]:scope.model[scope.field||"file"]=element[0].files[0],attrs.fileModelChange&&scope.$parent.$eval(attrs.fileModelChange)}catch(e){modelSetter(element[0].files[0])}})})}}}]),srv.service("fileUpload",["$http",function($http){this.single=function(opt,success,err){var fd=new FormData;Object.keys(opt.data).forEach(function(key){fd.append(key,opt.data[key])}),fd.append("file",opt.file),$http.post(opt.url,fd,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(success).error(err)}}]),srv.service("server",["$http","localdb","$rootScope","fileUpload",function(_http,localdb,r,fileUpload){function getLocalData(){return MyPromise(function(resolve,error){localData?resolve(localData):$.getJSON("./data.json",function(data){localData=data,resolve(localData)}).fail(function(jqxhr,textStatus,error){var err=textStatus+", "+error;console.log("Request Failed: "+err)})})}function handleError(_log,err){_log(err)}function get(relativeUrl,data,callback){var _log=logger(relativeUrl,data);_http({method:"GET",data:data,url:_URL+"/"+relativeUrl}).then(function(res){_log(res),callback&&callback(res)},function(err){return handleError(_log,err)})}function _post(relativeUrl,data,callback,error){data=data||{};var _log=logger(relativeUrl,data);globalState.async&&(data=Object.assign(data,{___serviceOptions:{logAsAsync:!0}}),delete globalState.async),data.___serviceOptions&&1==data.___serviceOptions.logAsAsync&&_log.registerAsync(),$U.once("server-up",function(){_http({method:"POST",data:data,url:_URL+"/"+relativeUrl}).then(function(res){return _log(res),res.data&&0==res.data.ok&&console.warn("SERVER:REQUEST:WARNING = ",res.data.err||"Unkown error detected",relativeUrl),callback(res)},function(err){handleError(_log,err),error(err)})})}function ctrl(ctrl,action,data){return MyPromise(function(resolve,error){_post("ctrl/"+ctrl+"/"+action,data,function(res){return resolve(res.data)},error)})}function stackCtrl(id,arg1,arg2,arg3){window.___stackScope=window.___stackScope||{stacks:{}};var s=window.___stackScope;s.stacks[id]=s.stacks[id]||{flag:!1,promises:[],watcher:$U.on(id+"-stack-pop",function(){var stack=s.stacks[id];if(stack.promises.length>0){stack.flag=!0;var d=stack.promises.shift();ctrl(d.arg1,d.arg2,d.arg3).then(function(res){stack.flag=!1,console.log("stackCtrlPromise-watcher-resolve "+id+". left:"+stack.promises.length),$U.emit(id+"-stack-pop")})}})},s.stacks[id].promises.push({arg1:arg1,arg2:arg2,arg3:arg3}),0==s.stacks[id].flag&&setTimeout(function(){0==s.stacks[id].flag&&$U.emit(id+"-stack-pop")},50)}var _URL="http://localhost:5000";$.ajax("/serverURL").then(function(r){_URL=r.URL,$U.emitPreserve("server-up"),console.info("server:url(env serverURL):"+_URL)}),$.ajax("/serverRawURL").then(function(r){window.__raw_origin=r.URL});var globalState={},localData=null,spinner=function(){return function(v){r.showSpinner=v,r.dom()}}(),logger=function(){var _controlledErrorsStrings=[],_controlledErrors={},_errors={},_logs={},fn=new function(){var self=this;return self.id=newId(20),function(url,req){var item={url:url,req:req};_logs[self.id]=item,setTimeout(function(){void 0!==_logs[self.id]&&(item.err="Logger: request timeout.",delete _logs[self.id])},3e4),r.$emit("logger.working");var rta=function(res){if(!_.isUndefined(_logs[self.id])){if(res.data||res.result){var data=res.data||res;data.ok!==!0&&(item.err=data.err||data,item.message=data.message||null,_.includes(_controlledErrorsStrings,item.err)?_controlledErrors[self.id]=item:item.err&&item.err.type&&_.includes(_controlledErrorsStrings,item.err.type)?(item.message=item.err.message,_controlledErrors[self.id]=item):_errors[self.id]=item)}else item.err="Server down, try later.",_.includes(_controlledErrorsStrings,item.err)?_controlledErrors[self.id]=item:_errors[self.id]=item;_.isUndefined(_logs[self.id])||delete _logs[self.id],0===Object.keys(_logs).length&&r.$emit("logger.clear")}};return rta.registerAsync=function(){delete _logs[self.id],r.$emit("logger.clear")},rta}};return fn.addControlledErrors=function(arr){_controlledErrorsStrings=_.union(arr,_controlledErrorsStrings)},fn.clearErrors=function(){return _errors={}},fn.hasErrors=function(){return Object.keys(_errors).length>0},fn.hasPending=function(){return Object.keys(_logs).length>0},fn.pending=function(){var msg="Pending<br>";return _.each(_logs,function(v,k){console.info(v.url),""!==msg&&(msg+="<br>"),msg+=v.url+": "+JSON.stringify(v.req)}),msg},fn.errors=function(){var msg="Errors<br>";return _.each(_errors,function(v,k){console.info(v),""!==msg&&(msg+="<br>");try{msg+=v.url+": "+JSON.stringify(v.err)}catch(e){msg+=v.url+": Unparseable error. See the console."}}),msg},r.state={working:function(){return fn.hasPending()},data:_logs},r.logger=fn,fn}();r.$on("logger.working",function(){spinner(!0)}),r.$on("logger.clear",function(){spinner(!1)}),r.get=get;var ws={URL:function(){return _URL},getAvailableRanges:function(order,opt){return diagsGetAvailableRanges(order,ctrl,opt)},localData:getLocalData,http:function(ctrl,action,data){return _http.post(_URL+"/ctrl/"+ctrl+"/"+action,data)},form:function(relativeURL,data){if(!data.file)throw Error("form: file arg required");return MyPromise(function(r,err){var file=data.file;delete data.file;var _log=logger(relativeURL,data);fileUpload.single({url:_URL+"/"+relativeURL,file:file,data:data},function(res){_log(res),r(res)},function(res){_log(res),err(res)})})},setAsync:function(){return globalState.async=!0,
ws},stackCtrl:stackCtrl,ctrl:ctrl,$get:function(url,config){return MyPromise(function(resolve,error){var _log=logger(url,{});_http.get(url,config).then(function(res){_log({ok:!0,result:res}),resolve(res)},function(err){_log({ok:!1,err:err}),error(err)})})},$post:function(url,data,config){return MyPromise(function(resolve,error){var _log=logger(url,data);_http.post(url,data,config).then(function(res){_log({ok:!0,result:res}),resolve(res)},function(err){_log({ok:!1,err:err}),error(err)})})},post:function(url,data){return MyPromise(function(resolve,error){_post(url,data,function(res){resolve(res)},error)})}};return r.ws=ws,ws}]);var app=angular.module("app.run",[]);app.config(["$httpProvider",function($httpProvider){$httpProvider.defaults.useXDomain=!0,delete $httpProvider.defaults.headers.common["X-Requested-With"]}]),app.run(["server","$timeout","$rootScope",function(db,$timeout,r){r.__debugDiags=!1;var keyword="";$(window).on("keyup",function(ev){ev=ev||window.event;var key=String.fromCharCode(ev.which);13==ev.which?("debug"==keyword.toLowerCase()?(r.__debugDiags=!0,console.info("debug-mode-on")):r.__debugDiags=!1,keyword="",r.dom()):keyword+=key})}]),app.run(["server","$timeout","$rootScope",function(db,$timeout,r){function getMessage(msg){return"function"==typeof msg?msg():"string"!=typeof msg&&msg.length?getMessage(msg[0]):msg}r.isDevEnv=function(){return window.location.hostname.indexOf("diags-javoche.c9users.io")!==-1},r.URL={LOGIN:"login",DIAG_SIGN_UP:"diag-inscription",HOME:"home",CONTACT_US:"contactez-nous",ERNT:"ernt",FAQ:"faq",GENERAL_CONDITIONS:"conditions-generales-utilisation",LEGAL_MENTIONS:"mentions-legales"},r.navShow=!0,r.toggleNavbar=function(val){r.navShow=val,r.dom()},r.secureSection=function(_s){_s.show=!1,r.logged()?(_s.show=!0,db.ctrl("User","getById",r.session()).then(function(d){d.ok&&d.result&&r.session(d.result)})):(console.warn("secureSection:redirecting to login"),r.route("login"))},r.handleSecurityRouteViolation=function(){r.route("dashboard"),console.warn("SECURITY: YOU-DONT-BELONG-HERE")},$("html").keydown(function(event){if("27"==event.keyCode&&r.params&&r.params.prevRoute&&r.__currentCtrlScope&&r.__currentCtrlScope.back){if(r.state.working())return void r.message("Loading...",{type:"warning",duration:2e3});var fn=r.__currentCtrlScope.back;r.__currentCtrlScope=null,fn()}}),r.setCurrentCtrl=function(_s){r.__currentCtrlScope=_s,$U.expose("s",_s)},r.errorMessage=function(msg,duration){msg=getMessage(msg),r.notify(msg,{type:"danger",duration:duration||3e3})},r.warningMessage=function(msg,duration){msg=getMessage(msg),r.notify(msg,{type:"warning",duration:duration||3e3})},r.infoMessage=function(msg,duration){msg=getMessage(msg),r.notify(msg,{type:"info",duration:duration||3e3})},r.successMessage=function(msg,duration){msg=getMessage(msg),r.notify(msg,{type:"success",duration:duration||3e3})}}]),app.run(["$rootScope","$location","$window",function($rootScope,$location,$window){$rootScope.$on("$routeChangeSuccess",function(event){$window.ga&&(console.log("ga tracking to "+$location.path()),$window.ga("set","page",$location.path()),$window.ga("send","pageview"))})}]),app.run(["server","$timeout","$rootScope",function(db,$timeout,r){window.r=r,r.getHashParams=getHashParams,r.debug=!0,r.config={};var env=window.env;r.config=$U.readJSONSync(window.env.CONFIG_JSON_PATH),env.$set(r.config),db.localData().then(function(data){return Object.assign(r.config,data.config||{})}),r.__cache={},r.cache=function(n,o){return o?r.__cache[n]=o:(!_.isUndefined(r.__cache[n])&&!_.isNull(r.__cache[n]),r.__cache[n]||null)},r.momentFormat=function(d,f){return moment(d).format(f)},r.momentTime=function(d){return moment(d).format("HH[h]mm")},r.momentDateTime=function(d){return moment(d).format("DD-MM-YY HH[h]mm")},r.momentDateTimeWords=function(d){return moment(d).format("[Le] dddd DD MMMM YY [à] HH[h]mm")},r.momentDateTimeWords2=function(d){return moment(d).format("dddd DD MMMM YY [à] HH[h]mm")},r.dom=function(cb,timeout){$timeout(function(){cb&&cb(),r.$apply()},timeout||0)},r.toggleBody=function(val){r.dom(function(){var el=document.body;el.className=el.className.replace("hidden","").trim(),val||(el.className=(el.className+" hidden").trim())})},r.session=function(data){var id=r.config.APP_NAME+"_"+window.location.hostname+env.STORE_SESSION_PREFIX;return data&&($U.store.set(id,data),r._session=data),r._session=$U.store.get(id),r._session||($U.store.set(id,{}),r._session={}),r._session},r.logged=function(){var ss=r.session();return null!==ss._id&&null!==ss.email&&null!==ss.password},r.viewAsClient=function(){r._session=r._session||{},r._session.userType="client",r.dom()},r.viewAsDiag=function(){r._session=r._session||{},r._session.userType="diag",r.dom()},r.viewAsAdmin=function(){r._session=r._session||{},r._session.userType="admin",r.dom()},r._login={email:"",password:""};var session=r.session();_.each(session,function(val,key){r._login[key]=val}),session.password&&(r._login.password=session.password),session.rememberPass||(r._login.password=null),r.logout=function(){r.session({email:null,password:null}),$U.url.clear(),r.route("login")},r.admin=function(){r._login.email="arancibiajav@gmail.com",r._login.password="admin",r.dom()},r.routeRelative=function(url,delay){return setTimeout(function(){var path=window.location.origin;path+=(window.location.pathname+"/"+url).replaceAll("//","/"),$U.emit("route-exit:"+$U.url.hashName()),window.location.href=path},delay||0),r.__route=url,url},r.route=function(url,delay){return setTimeout(function(){var path=window.location.origin+window.location.pathname;if(path+="#/"+url,$U.emit("route-exit:"+$U.url.hashName()),r.$emit("route-change",url),$U.url.hash(url),window.location.href=window.location.href,window.ga){("/"+url+".html").replaceAll("//","/")}},delay||0),r.__route=url,url},r.routeIs=function(n){return r.__route&&r.__route.toString().toLowerCase().indexOf(n&&n.toLowerCase()||"invalid")!==-1||!1},r.__route=window.location.href.replace(window.location.origin+window.location.pathname,""),r.__routeHashName=$U.url.hashName(),r.__routeHashNameBefore=$U.url.hashName(),setTimeout(function(){$U.emitPreserve("route-change",r.__route.slice(2))},500),$U.onAnchorChange(function(){r.__route=window.location.href.replace(window.location.origin+window.location.pathname,""),$U.emit("route-exit:"+r.__routeHashName),r.__routeHashName=$U.url.hashName(),$U.emitPreserve("route-change",r.__route.slice(2))}),r.userIs=function(arr){if(!r.logged())return!1;var type=r.session().userType;return"string"==typeof arr&&(arr=[arr]),_.includes(arr,type)},r.routeParams=function(obj){r.params=Object.assign(r.params||{},obj)},r.lookUp=function(scope,property){return scope[property]?scope[property]:scope.$parent?r.lookUp(scope.$parent,property):void 0},r.hasMouse=!1,$hasMouse(function(v){r.hasMouse=v,r.dom()})}]),app.run(["server","$timeout","$rootScope","dbText",function(db,$timeout,r,dbText){dbText.update()}]);var app=angular.module("app.directives",[]);app.directive("compileHtml",["$compile",function($compile){return{restrict:"A",link:function(scope,element,attrs){scope.$watch(function(){return scope.$eval(attrs.compileHtml)},function(value){element.html(value),$compile(element.contents())(scope)}),console.log("compile-html running")}}}]),app.directive("bindHtmlCompile",["$compile",function(compile){return{restrict:"A",link:function(s,el,attrs){s.$watch(function(){return s.$eval(attrs.bindHtmlCompile)},function(e){el.html(e&&e.toString());var f=s;attrs.bindHtmlScope&&(f=s.$eval(attrs.bindHtmlScope));var compiled=compile(el.contents())(f);el.html("").append(compiled);var first=el.find(":first-child"),tag=first&&first.get(0)&&first.get(0).tagName.toUpperCase()||"NONE";if("SPAN"==tag){var other=$(el).find("*").not(":first");first.append(other),el.html(first.html())}var text="";el.children().each(function(){"SPAN"==$(this).get(0).tagName&&(text+=$(this).text())}),text.length>0&&el.text(text)})}}}]),app.directive("tableFilter",function($rootScope,$timeout,$compile,$templateRequest,$sce,tpl){return{restrict:"AE",replace:!0,scope:{model:"=model"},template:"<out></out>",link:function(s,elem,attrs){function assignPayloadRules(data){var rule,val,_data,rules=s.model.filter.payloadRules;if(!rules)return data;for(var x in rules)rule=rules[x],void 0!=rule&&(val=s.model.filter.fields[x],void 0!=val&&(data.__rules=data.__rules||{},_data=rule(data,val),_data?data=_data:console.warn("app filter payload rules undefined output for ",x)));return data}function assignRuleByType(payload,type,handler){var fieldValue=null;for(var fieldName in s.model.filter.fields)fieldValue=s.model.filter.fields[fieldName],void 0!=fieldValue&&void 0!==s.model.filter.rules[fieldName]&&s.model.filter.rules[fieldName].toLowerCase()==type.toLowerCase()&&(payload.__rules=payload.__rules||{},payload=handler(payload,fieldName,fieldValue));return payload}function storeSet(){s.model.filter.store&&$U.store.set("filter_"+s.model.filter.store+"_"+r.session()._id,s.model.filter.payload)}function storeGet(){s.model.filter.store&&(s.model.filter.payload=$U.store.get("filter_"+s.model.filter.store+"_"+r.session()._id))}function regexpFields(){var fields={};for(var x in s.model.filter.fields)"_"!=x.charAt(0)&&s.model.filter.rules[x]&&"contains"==s.model.filter.rules[x]&&(fields[x]=s.model.filter.fields[x]);return fields}function collectionPointersFields(){var fields={};for(var x in s.model.filter.fields)"_"==x.charAt(0)&&s.model.filter.fields[x]&&(fields[x]=s.model.filter.fields[x]);return fields}var r=$rootScope;if(!s.model||s.model.filter){var filter=s.model.filter.template||"<h5>tableFilter requires filter.template</h5>";r.dom(function(){var el=tpl.compile(filter,s);elem.replaceWith(el),el.find("input").on("keyup",function(evt){"13"==evt.keyCode.toString()&&s.model.filter.filter()})}),s.model.filter.filter=function(){s.model.filter.payload={__regexp:regexpFields()},s.model.filter.payload=assignRuleByType(s.model.filter.payload,"awesome-in",function(data,name,val){val=val.replaceAll(" ",""),","==val.charAt(val.length-1)&&(val=val.substring(0,val.length-1));var arr=val.split(",");return data.__rules=data.__rules||{},data.__rules[name]={$in:arr},data}),s.model.filter.payload=assignRuleByType(s.model.filter.payload,"in",function(data,name,val){return data.__rules[name]={$in:[val]},data}),s.model.filter.payload=assignRuleByType(s.model.filter.payload,"month-range",function(data,name,val){var date=moment().month(parseInt(val));return data.__rules[name]={$gte:date.startOf("month").toDate().toString(),$lt:date.endOf("month").toDate().toString()},data}),s.model.filter.payload=assignPayloadRules(s.model.filter.payload),s.model.filter.payload=Object.assign(s.model.filter.payload,collectionPointersFields()),storeSet(),s.model.filter&&s.model.filter.update&&s.model.filter.update()},s.model.filter.clear=function(){s.model.filter.payload={};for(var x in s.model.filter.fields)s.model.filter.fields[x]="";storeSet(),s.model.filter.fields={},s.model.filter.update()},s.model.filter.firstTime=function(){storeGet(),s.model.filter.update()},s.model.filter.fields={};var filtered=[];s.$watch("model.filter.fields",function(fields){if(s.model.itemsOriginalRef&&0!=s.model.itemsOriginalRef.length){filtered=s.model.itemsOriginalRef;var filterVal,rule="contains",val=null;for(var x in fields)filterVal=fields[x]||"",s.model.filter.rules[x]&&(rule=s.model.filter.rules[x]||rule,"contains"==rule&&(filtered=filtered.filter(function(v){return v[x]&&v[x].toLowerCase().indexOf(filterVal.toLowerCase())!==-1})),"match"==rule&&(filtered=filtered.filter(function(v){return val="_"==x.charAt(0)?v[x]&&v[x]._id:v[x],val&&val.toLowerCase()==filterVal.toLowerCase()})),"matchCaseSensiive"==rule&&(filtered=filtered.filter(function(v){return val="_"==x.charAt(0)?v[x]&&v[x]._id:v[x],val&&val==filterVal})));s.model.items=filtered,r.dom()}},!0)}}}}),app.directive("ctrlDtp",function($rootScope){return{restrict:"AE",scope:{opt:"=options"},replace:!0,templateUrl:"./views/directives/directive.ctrl.datetimepicker.html",link:function(s,el,attrs){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;if(split.forEach(function(chunk,index){var isLast=lastIndex==index;return!isLast&&(obj=obj[chunk]||null,!!obj&&void 0)}),obj)return val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]}var opt=s.opt;if($U.expose(opt.name||"dtp",s),!opt.modelPath)throw Error("ctrlDtp require opt.modelPath");if(!opt.scope)throw Error("ctrlDtp require opt.scope");if(!opt.cls)throw Error("ctrlDtp require opt.cls (function)");if(!opt.disabled)throw Error("ctrlDtp require opt.disabled (function)");s=Object.assign(s,{scope:opt.scope,opened:!1,disabled:function(){return opt.disabled()},cls:function(){return opt.cls()},model:opt.initDate||new Date}),opt.scope.$watch(function(){opt.digest&&opt.digest(opt)}),opt.scope.$watch(opt.modelPath,function(v){void 0!==v&&v!==s.model&&(s.model=v)}),s.$watch("model",function(v){setVal(opt.scope,opt.modelPath,v)})}}}),app.directive("ctrlSelect",function($rootScope){return{restrict:"AE",scope:{opt:"=options"},replace:!0,templateUrl:"./views/directives/directive.ctrl.select.html",link:function(s,el,attrs){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;if(split.forEach(function(chunk,index){var isLast=lastIndex==index;return!isLast&&(obj=obj[chunk]||null,!!obj&&void 0)}),obj)return val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]}s.choiceLabel=function(choice){return choice.label?"string"!=typeof choice.label?choice.label():choice.label:choice},s.choiceDisabled=function(choice){return!!choice.disabled&&choice.disabled()};var r=$rootScope,opt=s.opt;if(!opt.modelPath)throw Error("ctrlSelect require opt.modelPath");if(!opt.scope)throw Error("ctrlSelect require opt.scope");if(!opt.items)throw Error("ctrlSelect require opt.items");if(!opt.cls)throw Error("ctrlSelect require opt.cls (function)");if(!opt.disabled)throw Error("ctrlSelect require opt.disabled (function)");s=Object.assign(s,{scope:opt.scope,label:opt.label||"(Select Item)",disabled:function(){return opt.disabled()},cls:function(){return opt.cls()},click:function(x){setVal(opt.scope,opt.modelPath,x.val||x)}}),opt.filterWatch?s.scope.$watch(opt.filterWatch,function(){opt.filter&&(s.opt.items=_.filter(s.opt.items,function(v){return opt.filter(v)}))},!0):s.scope.$watch(function(){opt.filter&&(s.opt.items=_.filter(s.opt.items,function(v){return opt.filter(v)}))}),opt.scope.$watch(opt.modelPath,function(v,oldV){var arr=s.opt.items.filter(function(item){return(item.val||item)==v});if(arr.length>1)throw Error("ctrlSelect items val need to be unique.");1==arr.length?(arr[0].label?"string"!=typeof arr[0].label?s.label=arr[0].label():s.label=arr[0].label:s.label=arr[0],opt.change&&opt.change(arr[0],opt,function(){v!==oldV&&setVal(opt.scope,opt.modelPath,oldV)}),r.dom()):(opt.label&&(s.label=opt.label||"(Select Item)"),console.warn("ctrlSelect model has an invalid value. Values expected: "+JSON.stringify(s.opt.items.map(function(item){return item.val||item}))))}),opt.init&&opt.init(opt)}}}),app.directive("includeReplace",function(){return{require:"ngInclude",restrict:"A",link:function(scope,el,attrs){el.replaceWith(el.children())}}}),app.directive("activeRoute",function($rootScope){return{restrict:"A",link:function(scope,el,attrs){function apply(){$rootScope.routeIs(attrs.activeRoute)?el.addClass("active"):el.removeClass("active")}$rootScope.dom(apply),$rootScope.$watch("__route",function(__route){$rootScope.dom(apply)})}}}),app.directive("focusOn",function(){return function(scope,elem,attr){scope.$on("focusOn",function(e,name){name===attr.focusOn&&elem[0].focus()})}}),app.directive("collapseNav",function($timeout,$rootScope){return{restrict:"AE",replace:!1,link:function(s,elem,attr){var r=$rootScope;r.dom(function(){elem.find("li").on("click",function(){r.dom(function(){var w=$(window).width();w<768&&elem.collapse("hide")})})})}}}),app.factory("focus",function($rootScope,$timeout){return function(name){$timeout(function(){$rootScope.$broadcast("focusOn",name)})}}),app.directive("crudModal",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open",close:"=close"},template:"<output></output>",link:function(s,elem,attrs){var r=$rootScope,fire=function(n,p,ctx){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){ctx?cb.call(ctx,p):cb(p)}))};s.open=function(opt){if(s.evts=opt.evts,!opt.templateUrl)throw Error("crudModal needs templateUrl");$uibModal.open({animation:!0,templateUrl:opt.templateUrl,controller:function($scope,$uibModalInstance){var s=$scope;s.fire=function(n,p){return fire(n,p,s)},Object.assign(s,opt),s.save=s.validate=function(){s.validate&&s.validate.when&&s.validate.fail?$U.ifThenMessage(s.validate.when(s),s.validate.fail(s),function(){s.close()}):s.close()},s.close=function(){$uibModalInstance.close(),opt.callback(s.item)},s.closeSilent=function(){$uibModalInstance.close()},s.redirect=function(url){r.params={item:s.item},r.route(url),s.closeSilent()},s.cancel=function(){$uibModalInstance.dismiss("cancel")},fire("init",null,s)}})}}}}),app.directive("address",function($rootScope,$timeout){return{scope:{model:"=model",field:"@field",change:"=change",number:"@number",street:"@street",city:"@city",department:"@department",region:"@region",country:"@country",postCode:"@postCode"},restrict:"AE",link:function(scope,elem,attrs){if(!scope.model)throw Error("directive address require a valid model.");$timeout(function(){function onResult(event,result){scope.model[scope.field]=result.formatted_address,scope.change&&scope.change(result.formatted_address);var number,street,city,department,region,country,postCode,data=result.address_components.map(function(v){return v.long_name});4==data.length&&(number="",street=data[0],city=data[1],department=data[1],region="",country=data[2],postCode=data[3]),5==data.length&&(number="",street=data[0],city=data[0],department=data[1],region=data[2],country=data[3],postCode=data[4]),6===data.length&&(number="",street=data[0],city=data[1],department=data[2],region=data[3],country=data[4],postCode=data[5]),7===data.length&&(number=data[0],street=data[1],city=data[2],department=data[3],region=data[4],country=data[5],postCode=data[6]),scope.number&&setVal(scope.model,scope.number,number),scope.street&&setVal(scope.model,scope.street,street),scope.city&&setVal(scope.model,scope.city,city),scope.department&&setVal(scope.model,scope.department,department),scope.region&&setVal(scope.model,scope.region,region),scope.country&&$U.fetchCountry(result.formatted_address).then(function(d){setVal(scope.model,scope.country,d.name)}),scope.postCode&&setVal(scope.model,scope.postCode,postCode),$U.expose("address",Object.assign(result,scope)),$rootScope.dom()}function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;if(split.forEach(function(chunk,index){var isLast=lastIndex==index;return!isLast&&(obj=obj[chunk]||null,!!obj&&void 0)}),obj)return val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]}function read(){$timeout(function(){""!==scope.model[scope.field]&&elem.geocomplete("find",scope.model[scope.field]),scope.$apply()})}try{elem.geocomplete({country:"FR"}).bind("geocode:result",onResult)}catch(e){var msg="Google library issue, address autocomplete feature is temporaly disabled.";return console.warn(msg)}read(),scope.$watch("model."+scope.field,read),scope.$apply()})}}}),app.directive("debug",function($rootScope,$timeout,server,$compile){return{scope:{show:"=show"},restrict:"AE",replace:!0,template:'<div><i ng-show="show" ng-click="click()" class="link fa fa-bug fa-lg fixed left-1 bottom-1 always-on-top"><input disabled type="checkbox" ng-click="stop()" ng-model="check"></i><span data-output></span></div>',link:function(s,elem,attrs){var r=$rootScope;s.check=!0,s.opt={onClose:function(){r.logger.clearErrors()}},s.stop=function(){return window.event.stopPropagation()},s.click=function(){var log=r.logger.pending();log&&s.create(log,"info");var err=r.logger.errors();err&&s.create(err,"danger")},s.$watch("check",function(v){v?(s.checking&&clearInterval(s.checking),s.checking=setInterval(function(){r.logger.hasErrors()&&r.dom(function(){0===elem.find("[data-output] .alert-danger").length&&(s.create(r.logger.errors(),"danger"),r.logger.clearErrors())})},1e3),window.onerror=function(err){s.create(err,"danger")}):(s.checking&&clearInterval(s.checking),window.onerror=function(err){})}),s.create=function(msg,type){return console.warn("[DEBUG]["+("danger"===type?"ERROR":"WARNING")+"] "+msg)},setTimeout(function(){server.URL().indexOf("localhost")!==-1&&(s.show=!0,r.dom())},5e3)}}}),app.directive("spinner",function($rootScope,$timeout){return{scope:{show:"=show"},restrict:"AE",replace:!0,templateUrl:"./views/directives/directive.spinner.html",link:function(scope,elem,attrs){}}}),app.directive("checkBox",function($rootScope,$timeout){return{scope:{val:"=val",arr:"=push"},restrict:"AE",replace:!0,template:"<input type='checkbox'/>",link:function(scope,elem,attrs){$timeout(function(){scope.$apply(function(){elem.value=scope.val,elem.on("change",function(){var checked=elem.get(0).checked;checked?(scope.arr=scope.arr||[],scope.arr.push(scope.val)):_.remove(scope.arr,function(e){return e===scope.val})})})})}}}),app.directive("notify",function($rootScope,$timeout){return{scope:{message:"@message",type:"@type",cls:"@cls",scroll:"=scroll",opt:"=opt",evts:"=evts",settings:"=settings"},restrict:"AE",replace:!0,templateUrl:"./views/common/popups/popup-notify.html",link:function(scope,elem,attrs){var r=$rootScope,s=scope;if(s.settings&&"string"==typeof s.settings){var fixedJSON=s.settings.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g,'"$2": ');s.settings=JSON.parse(fixedJSON)}var fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};$timeout(function(){scope.$apply(function(){elem.find(".alert").addClass(scope.type||"alert-danger"),scope.cls&&elem.find(".alert").addClass(scope.cls)})}),scope.clickDismiss=function(){s.settings&&s.settings.clickDismissable===!1&&s.opt&&!s.opt.clickDismissable||scope.dismiss()},scope.dismiss=function(){s.dismissed||(s.dismissed=!0,elem.find(".alert").alert("close"),elem.remove(),fireEvent("close"),scope.opt&&scope.opt.onClose&&scope.opt.onClose())},scope.$watch("message",function(v){elem.find("[data-message]").html(v)}),s.opt&&s.opt.duration?r.dom(s.dismiss,s.opt.duration):(_.includes(["alert-info","alert-success"],s.type)&&r.dom(scope.dismiss,2e3),_.includes(["alert-danger","alert-warning"],s.type)&&r.dom(scope.dismiss,1e4)),1==s.settings.scroll&&r.dom($U.scrollToTop)}}}),app.directive("myAlert",function($rootScope,$timeout){return{scope:{message:"@message",type:"@type",cls:"@cls",scroll:"=scroll",opt:"=opt",evts:"=evts"},restrict:"AE",replace:!0,templateUrl:"./views/directives/directive.alert.html",link:function(scope,elem,attrs){var s=scope,r=$rootScope,fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};$timeout(function(){scope.$apply(function(){elem.addClass(scope.type||"alert-danger"),scope.cls&&elem.addClass(scope.cls)})}),scope.dismiss=function(){elem.alert("close"),fireEvent("close"),scope.opt&&scope.opt.onClose&&scope.opt.onClose()},scope.$watch("message",function(v){elem.find("[data-message]").html(v),v&&scope.scroll&&r.dom(function(){$("html, body").animate({scrollTop:elem.offset().top},500)})})}}}),app.directive("myAlerts",function($rootScope,$timeout,$compile){return{restrict:"AE",replace:!0,scope:{add:"=add",directive:"@directive",stacked:"=stacked",settings:"@settings"},template:"<output></output>",link:function(s,elem,attrs){function onClose(){if(s.stacked){if(s.el=null,0===s._stacked.length)return;var p=s._stacked[0];s._stacked=s._stacked.slice(1),s.add(p.message,p.type,p.timeout,p.scroll,p.opt)}}var r=$rootScope;s.decodeMessage=function(msg){return"string"==typeof msg?msg:JSON.stringify(msg)},s._stacked=[],s.evts={close:[onClose]};var fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};s.add=function(message,type,timeout,scroll,opt){var msg=s.decodeMessage(message);type&&"string"!=typeof type&&(opt=type,type=opt.type||void 0),timeout&&"object"===("undefined"==typeof timeout?"undefined":_typeof(timeout))&&(opt=timeout,timeout=void 0),opt&&opt.scroll===!0&&(scroll=!0),s.el&&s.el.alert("close");var directive=s.directive||"my-alert";s.opt=opt;var el=$compile("<"+directive+" settings='settings' evts='evts' opt='opt' scroll='"+scroll+"' message='"+msg+"' type='alert-"+(type||"danger")+"'/>")(s);s.el=el,elem.html("").append(el),timeout&&"my-alert"===directive&&r.dom(function(){elem.html(""),fireEvent("close")},timeout)},"notify"==s.directive&&(r.notify=s.add,r.message=s.add),window.ss=s}}}),app.directive("modalCustom",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){if(!attrs.templateUrl)throw Error("modalCustom attr templateUrl required.");s.open=function(opt,confirmCallback){opt=opt||{};var message="";message="string"==typeof opt?opt:opt.message||"";$uibModal.open({animation:!0,templateUrl:opt.templateUrl||attrs.templateUrl,controller:function($scope,$uibModalInstance){$scope.data=opt.data,$scope.message=message,$scope.messageEl=opt.messageEl||null,$scope.yes=function(){$uibModalInstance.close(),confirmCallback&&confirmCallback()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$U.expose("modalCustom",$scope)}})}}}}),app.directive("modalConfirm",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){s.open=function(opt,okCallback){opt=opt||{};var message="";message="string"==typeof opt?opt:opt.message||"";var rta={};$uibModal.open({backdrop:opt.backdrop||!0,animation:!0,templateUrl:opt.templateUrl||"views/directives/directive.modal.sure.html",controller:function($scope,$uibModalInstance){$scope.data=opt.data,$scope.message=message,$scope.yes=function(){$uibModalInstance.close(),okCallback&&okCallback()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.close=function(good){$uibModalInstance.dismiss("cancel"),good&&okCallback&&okCallback()},rta.scope=$scope,rta.close=function(){$uibModalInstance.dismiss("cancel")},r._modal=$scope}});return rta};var r=$rootScope;r.modalConfirm=r.modalConfirm||{},r.modalConfirm[attrs.open]=s.open,r.modalConfirm.first=s.open}}}),app.directive("dynamicTable",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!0,scope:{model:"=model"},templateUrl:"views/common/partials/dynamic-table.html",link:function(s,elem,attrs){function objUpdate(obj1,obj2,preserveFields){var rta=obj1;return Object.keys(obj2).forEach(function(k){for(var x in preserveFields)if(preserveFields[x]==k&&"undefined"!=typeof obj1[k])return;rta[k]=obj2[k]}),rta}var r=$rootScope;$rootScope.$watch("hasMouse",function(v){s.hasMouse=v});attrs.name;if(!s.model)return void console.error("directive.table: no model present");s.click=function(item,index){s.model.click&&s.model.click(item,index)},s.buttons=s.model.buttons||null,s.columns=s.model.columns||[],s.model.items=s.model.items||[],s.paginationTotalItems=1;var paginationDefaults={currentPage:1,maxSize:5,itemsPerPage:10,total:1,changed:function(){s.model.paginate&&s.model.paginate(function(items){s.model.items=items,r.dom()})},update:function(p){s.model.pagination.total=p.total}};s.model.pagination=s.model.pagination&&objUpdate(s.model.pagination,paginationDefaults,["itemsPerPage"])||paginationDefaults,s.model.update=function(items,data){s.model.items=items,s.model.itemsOriginalRef=items,s.data||(s.data=data)},s.model.columnFilter=function(item){return void 0==item.disabled||1==!item.disabled},s.model.init&&s.model.init(),s.model.itemsOriginalRef=s.model.items,$U.expose("table",s)}}}),app.directive("appendChild",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!1,scope:{child:"=child"},link:function(s,elem,attrs){s.child&&elem.html("").append(s.child)}}}),app.directive("htmlContent",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!1,scope:{html:"&html"},link:function(s,elem,attrs){s.html&&$rootScope.dom(function(){elem.html(s.html)})}}}),app.directive("timeRange",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){s.open=function(opt){$uibModal.open({animation:!0,templateUrl:"views/directives/directive.modal.timeRange.html",controller:function($scope,$uibModalInstance){var s=$scope;s.title=opt.title,s.title||(s.title="Time Range",opt.action&&"edit"===opt.action?s.title+=" - Edition":s.title="New "+s.title),s._opt=opt,window.edit=s,s.days=function(){var o={label:"Day",selected:"",items:[],val:null,select:function(val){o.items.forEach(function(v){v.val.toString()==val.toString()&&o.click(v)})},click:function(v){o.selected=v.label||v,o.val=v.val,s.start.val&&(s.start.val=moment(s.start.val),s.start.val.day("-1"===o.val.toString()?1:o.val)),s.end.val&&(s.end.val=moment(s.end.val),s.end.val.day("-1"===o.val.toString()?1:o.val))}},m=moment();o.items.push({label:"(Choice a day)",val:""},{label:"Every day",val:"-1"});for(var x=1;x<=7;x++)m.day(x),o.items.push({label:m.format("dddd"),val:x});return o.selected=o.items[0].label,o}();var timePickerData=function(){return function(m){return{hstep:1,mstep:10,repeat:"",minDate:moment().date(1),val:m||moment().hour(9).minutes(0)}}}();if(s.start=timePickerData(opt.start),s.end=timePickerData(opt.end),s.repeat="none",s.daySelection=function(){return"none"!==s.repeat},s.datepicker={val:void 0,minDate:moment().add(1,"day"),maxDate:moment().add(2,"month"),initDate:new Date},s.$watch("repeat",function(v){"day"===v&&s.days.select(-1)}),s.validate=function(){if(!s.description,"week"==s.repeat&&"-1"===s.days.val.toString())return s.message("Choice a day","warning",2e3),!1;if("none"===s.repeat&&void 0==s.datepicker.val)return void s.message("Choice a day in the calendar","warning",2e3);if(!s.start.val)return void s.message("Choice a valid start time.");if(!s.end.val)return void s.message("Choice a valid end time.");if(moment(s.start.val).isAfter(moment(s.end.val)))return void s.message("Start time need  to be before end time.");try{var _d=moment(s.start.val);_d=moment(s.end.val),"none"===s.repeat&&(s.start.val=moment(s.datepicker.val).hour(moment(s.start.val).hour()).minutes(moment(s.start.val).minutes()).toDate(),s.end.val=moment(s.datepicker.val).hour(moment(s.end.val).hour()).minutes(moment(s.end.val).minutes()).toDate())}catch(e){return s.message("Invalid time","warning",2e3),!1}return!0},s.save=function(){if(s.validate()){$uibModalInstance.close();var rta={description:s.description||"",start:s.start.val,end:s.end.val,type:opt.type,repeat:s.repeat};"edit"==opt.action&&(rta._user=opt.item._user,rta._id=opt.item._id),opt.callback(rta)}},s.cancel=function(){$uibModalInstance.dismiss("cancel")},!opt.action)throw Error("directive timeRange open require arg.action");if("new"==opt.action,"edit"===opt.action){var start=moment(opt.item.start);s.repeat=opt.item.repeat,s.description=opt.item.description,s.start.val=opt.item.start,s.end.val=opt.item.end,opt.type=opt.item.type,s.days.val=start.day(),s.days.select(s.days.val),"day"==s.repeat&&(s.days.val=-1),"none"==s.repeat&&(s.datepicker.val=opt.item.start)}}})}}}});var app=angular.module("app.login",[]);app.controller("adminLogin",["server","$scope","$rootScope",function(db,s,r){r.__hideNavMenu=!0,r.navShow=!0,s.show=!1,$U.once("route-exit:login",function(url){r.__hideNavMenu=!1}),s.login=function(){var session=r.session();session.email&&session.expire<(new Date).getTime(),db.ctrl("User","login",r._login).then(function(res){
res.ok&&null!=res.result?(r.session(res.result),r.route("dashboard")):(s.loginFailedTimes++,r.warningMessage("Incorrect login"))}).error(function(res){s.sendingRequest=!1,r.errorMessage("Server down, try later.")})},s.resetPassword=function(){return r._login.email?void db.ctrl("User","passwordReset",{email:r._login.email}).then(function(res){res.ok&&(r.message("Un nouveau mot de passe a été envoyé par e-mail","info",void 0,void 0,{duration:1e4}),s.loginFailedTimes=0,r.dom())}):r.warningMessage("Email required")};var params={email:$U.getParameterByName("email"),password:$U.getParameterByName("k")?window.atob($U.getParameterByName("k")):""};params.email&&(r._login.email=params.email),params.password&&(r._login.password=params.password),params.email&&params.password&&(console.log("adminLogin: lets try to sign-in from queryparameters"),s.login()),r.logged()?(db.ctrl("User","get",{_id:r.session()._id}).then(function(err,data){!err&&data.ok&&data.result&&r.session(data.result)}),r.route("dashboard")):s.show=!0}]),app.controller("adminLoginExternal",["server","$scope","$rootScope",function(db,s,r){s.login=function(){var session=r.session();session.email&&session.expire<(new Date).getTime(),db.ctrl("User","login",r._login).then(function(res){res.ok&&null!=res.result?(r.session(res.result),s.redirect()):r.warningMessage("Login incorrect")}).error(function(res){s.sendingRequest=!1,r.errorMessage("Server down, try later.")})},s.redirect=function(){var path="admin#/login?email="+r._login.email+"&k="+window.btoa(r._login.password||"dummy");r.routeRelative(path)},s.resetPassword=function(){return r._login.email?void db.ctrl("User","passwordReset",{email:r._login.email}).then(function(res){res.ok&&(r.message("Un nouveau mot de passe a été envoyé par e-mail","info",void 0,void 0,{duration:1e4}),r.dom())}):r.warningMessage("Email est requis")},s.userType=s.userType||"client",r.dom(function(){r.logged()&&r.session().userType==s.userType&&(r._login.email=r.session().email,r._login.password=r.session().password,s.redirect())},500),$U.expose("s",s)}]);