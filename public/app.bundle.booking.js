"use strict";function openStripeModalPayOrder(order,cb,opt){opt=opt||{};var handler=StripeCheckout.configure({key:"pk_test_MDkxtBLcBpHwMCgkqX2dJHjO",image:"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",token:function(_token){cb(_token)}});handler.open({name:r.config.companyName||"[r.config.companyName]",description:"Order payment",email:opt.email||order._client.email,currency:"eur",amount:100*order.price,zipCode:!1,allowRememberMe:!1})}function normalizeOrderStartTime(t,forwardOnly,backwardOnly){return t.minutes<30&&(forwardOnly?t.minutes=30:t.minutes=0),30==t.minutes&&(t.minutes=30),t.minutes>30&&(backwardOnly?t.minutes=30:(t.minutes=0,t.hours++)),t}function normalizeOrderTime(t,eachTreintaOnly){return t.minutes>0&&t.minutes<15&&(t.minutes=15,eachTreintaOnly&&(t.minutes=0)),t.minutes>15&&t.minutes<30&&(t.minutes=30),t.minutes>30&&t.minutes<45&&(t.minutes=45,eachTreintaOnly&&(t.minutes=30)),t.minutes>45&&t.minutes<59&&(t.hours+=1,t.minutes=0),t}function OrderTotalTime(selectedDiags,diags){var total=0;if(!selectedDiags)return 0;Object.keys(selectedDiags).forEach(function(mkey){selectedDiags[mkey]&&diags.forEach(function(dval,dkey){return dval.name==mkey?(dval.time=dval.price/4,total+=dval.time||0,!1):void 0})}),total=10*parseInt(parseInt(total)/10,10)+10;var hours=Math.floor(total/60),minutes=total%60,t={hours:hours,minutes:minutes};return t}function expose(path,val){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||{},obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}setVal(window,path,val)}function createDateTimePickerData(){var o={isOpen:!1,openCalendar:function(e){e.preventDefault(),e.stopPropagation(),o.isOpen=!0}};return o}function createSelect(opt){var o={label:opt.label,click:function(x){o.label=x.label||x,setPropByGivenPath(opt.scope,opt.model,x),opt.change(x)},items:opt.items};return opt.scope.$watch(opt.model,function(v){void 0!==v?o.label=v.label||v.substring(0,1).toUpperCase()+v.slice(1):o.label=opt.label}),o}function setPropByGivenPath(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj&&(obj[split[lastIndex]]=val)}function ifThenMessage(comparisons,messagesCallback,noMessagesCallback){var messages=[];comparisons.forEach(function(comparison){var v1=comparison[0];if("function"==typeof v1)v1()&&messages.push(comparison[1]);else{var operator=comparison[1],v2=comparison[2],m=comparison[3],cb=comparison[4]||void 0;"=="==operator&&v1==v2&&messages.push(m),"!="==operator&&v1!=v2&&messages.push(m),">"==operator&&v1>v2&&messages.push(m),"<"==operator&&v2>v1&&messages.push(m),">="==operator&&v1>=v2&&messages.push(m),"<="==operator&&v2>=v1&&messages.push(m)}messages.filter(function(_m){return _m==m}).length>0&&cb&&cb()}),messages.length>0?messagesCallback(messages):noMessagesCallback()}function getParameterByName(name,url){url||(url=window.location.href),name=name.replace(/[\[\]]/g,"\\$&");var regex=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)"),results=regex.exec(url);return results?results[2]?decodeURIComponent(results[2].replace(/\+/g," ")):"":null}function MyPromise(cb){var _scope={cb:null,errorCb:null,errorRes:null,res:null,evt:{}},resolve=function(res){_scope.cb&&_scope.cb(res),_scope.res=res||{}},error=function(errorRes){_scope.errorCb&&_scope.errorCb(errorRes),_scope.errorRes=errorRes||{}},emit=function(n,err,r){_scope.evt[n]=_scope.evt[n]||{},_scope.evt[n].res={err:err,r:r},void 0!==_scope.evt[n].cb&&_scope.evt[n].cb(_scope.evt[n].res.err,_scope.evt[n].res.r)};cb(resolve,error,emit);var rta={then:function(cb){return _scope.res?cb(_scope.res):_scope.cb=cb,rta},error:function(errorCb){return _scope.errorRes?errorCb(_scope.errorRes):_scope.errorCb=errorCb,rta},on:function(n,cb){return _scope.evt[n]=_scope.evt[n]||{},_scope.evt[n].cb=cb,void 0!==_scope.evt[n].res&&_scope.evt[n].cb(_scope.evt[n].res.err,_scope.evt[n].res.r),rta}};return rta}function calendar(s,server,r){console.info("ctrl.calendar");var c=this;c.panel="CALENDAR",r.selectedDate="",c.range="",c.pickDate=function(rr){r.selectedDateRange=rr._id},c.init=function(main){c.main=main,c.main.state==c.main.states.CALENDAR&&c.initialized!==!0&&r.onCalendarInit()},r.$on("CALENDAR.CONTINUE",function(){r.selectedDateRange?console.log("gotoemail"):alert("Select a datetime")}),r.onCalendarInit=function(){console.log("onCalendarInit"),r.dom(function(){var $lastDate=null;$calendar=$("#calendar").fullCalendar({dayClick:function(date,jsEvent,view){var dateFormated=date.format();r.selectedDate=date.format("MMMM Do YYYY, dddd"),server.getAvailableRanges(dateFormated).then(function(data){c.availableRanges=data,console.log("availableRanges",c.availableRanges),r.dom(function(){})});var $curr=$(this);r.dom(function(){$lastDate&&$lastDate.css("background","transparent"),$curr.css("background","rgba(0,0,0,.2)"),$lastDate=$curr})}})}),c.initialized=!0},r.milliToHours=function(milli){return Math.floor(milli/1e3/60/60)},c.drawRange=function(rng){return moment(rng.from).format("HH:mm")+"h - "+moment(rng.to).format("HH:mm")+"h"}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol?"symbol":typeof obj},subTotal=function(model,diags,basePrice,opt){opt=opt||{},opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo.basePrice=opt.s.priceInfo.basePrice);var total=0;model.diags=model.diags||{},Object.keys(model.diags).forEach(function(mkey){return model.diags[mkey]?void diags.forEach(function(dval,dkey){return dval.show&&dval.name==mkey?(opt.s&&(opt.s.priceInfo[mkey]=dval.price),total+=dval.price||0,!1):void 0}):void(opt.s&&opt.s.priceInfo[mkey]&&delete opt.s.priceInfo[mkey])});var rta=basePrice+total;return 0===total?(opt.s&&(opt.s.priceInfo.basePrice=0),rta=0):opt.s&&(opt.s.priceInfo.basePrice=basePrice),rta},sizePrice=function(model,diags,squareMetersPrice,basePrice,opt){var rta=0,isHouse=model.info?model.info.house:model.house,squareMeters=model.info?model.info.squareMeters:model.squareMeters;if(isHouse&&squareMeters){var porcent=squareMetersPrice[squareMeters];if((_.isUndefined(porcent)||_.isNull(porcent))&&(console.warn("sizePrice: squareMeters missing in model."),porcent=0),0===parseInt(porcent))rta=0;else{var sub=subTotal(model,diags,basePrice,opt);rta=sub*parseInt(porcent),rta/=100}}return opt&&opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo.sizePrice=rta),rta},totalPrice=function(showRounded,model,diags,squareMetersPrice,basePrice,opt){var tot=subTotal(model,diags,basePrice,opt)+sizePrice(model,diags,squareMetersPrice,basePrice,opt),realTot=10*parseInt(parseInt(tot)/10,10);return opt=opt||{},opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo["Round-to-near-10"]=-1*(tot-realTot)),opt.overwriteModel===!1||(model.price=realTot),showRounded?realTot:tot};!function(global){function diagsCalculateAvailableSlots(order,working,exceptions,diags){var slots={morning:[],afternoon:[]},diags=_.orderBy(diags,function(v){return v.priority});return diags.forEach(function(diag){var _exceptions=orderDiagExceptions(order,diag,exceptions),_collisions=_.union(filterOrders(working,diag),_exceptions);if(_collisions=_.union(_collisions,slots.morning),_collisions=_.union(_collisions,slots.afternoon),slots.morning.length<2)if(freeMorning(order,_collisions))slots.morning.push(slot(9,0,order,diag),slot(10,0,order,diag));else{var sumo=allocateMorning(diag,order,_collisions,slots);sumo&&slots.morning.length<2&&(_collisions.push(slots.morning[slots.morning.length-1]),allocateMorning(diag,order,_collisions,slots))}if(slots.afternoon.length<2)if(freeAfternoon(order,_collisions))slots.afternoon.push(slot(14,0,order,diag),slot(15,0,order,diag));else{var sumo=allocateAfternoon(diag,order,_collisions,slots);sumo&&slots.afternoon.length<2&&(_collisions.push(slots.afternoon[slots.afternoon.length-1]),allocateAfternoon(diag,order,_collisions,slots))}}),_.union(slots.morning,slots.afternoon)}function filterOrders(orders,diag){return orders.filter(function(v){return v._user==diag._id})}function allocateMorning(diag,order,collisions,arr){return allocate(8,0,11,30,diag,order,collisions,arr,"morning")}function allocateAfternoon(diag,order,collisions,arr){var startMax=moment(order.day).hours(19).minutes(0).subtract(order.time.hours,"hour").subtract(order.time.minutes,"minutes");return allocate(13,0,startMax.hours(),startMax.minutes(),diag,order,collisions,arr,"afternoon")}function normalizeStart(start){start=moment(start);var h=start.hours(),m=start.minutes();return m>0&&30>m&&(m=30),m>30&&(m=0,h++),start.hours(h).minutes(m)}function allocate(startMinH,startMinM,startMaxH,startMaxM,diag,order,collisions,arr,propName){var startMin=moment(order.day).hour(startMinH).minutes(startMinM),startMax=moment(order.day).hour(startMaxH).minutes(startMaxM),cut=!1,start=moment(startMin),_cols=[],c=0;do{if(_cols=rangeCollisions4(start,order,collisions),0==_cols.length){if(_cols=rangeCollisions5(orderEnd(start,order),1,30,collisions),0==_cols.length){var _s=slot(start.hours(),start.minutes(),order,diag);return arr[propName].push(_s),!0}start=moment(_cols[_cols.length-1].end).add(1,"hours").add(30,"minutes"),start=normalizeStart(start)}else start=moment(_cols[_cols.length-1].end).add(1,"hours").add(30,"minutes"),start=normalizeStart(start);c++,c>20&&(cut=!0)}while(moment(start).isBefore(moment(startMax))||cut);return!1}function freeMorning(order,collisions){var lastAssignableMorningDate=moment(order.day).hours(11).minutes(30);return 0==collisions.filter(function(v){return moment(v.start).isBefore(lastAssignableMorningDate)}).length}function freeAfternoon(order,collisions){var minAssignableAfternoonDate=moment(order.day).hours(13).minutes(0);return 0==collisions.filter(function(v){return moment(v.start).isAfter(minAssignableAfternoonDate)}).length}function slot(h,m,order,diag){var start=moment(order.day).hour(h).minutes(m);return{_diag:diag._id,start:start,end:moment(start).add(order.time.hours,"hours").add(order.time.minutes,"minutes")}}function orderEnd(start,order){return moment(start).add(order.time.hours,"hours").add(order.time.minutes,"minutes")}function rangeCollisions5(date,hp,mp,collisions){return rangeCollisions2(date,moment(date).hours(),moment(date).minutes(),hp,mp,collisions)}function rangeCollisions4(start,order,collisions){return rangeCollisions(start,orderEnd(start,order),collisions)}function rangeCollisions2(date,h,m,hp,mp,collisions){var start=moment(date).hour(h).minutes(m),end=moment(start).add(hp,"hours").add(mp,"minutes");return rangeCollisions(start,end,collisions)}function rangeCollisions(start,end,collisions){var get=function(cb){return collisions.filter(function(v){return cb(v)})||[]},rta=get(function(r){return moment(r.start).isSameOrAfter(start)&&moment(r.start).isSameOrBefore(end)});return _.union(rta,get(function(r){return moment(r.end).isSameOrAfter(start)&&moment(r.end).isSameOrBefore(end)})),rta}function orderDiagExceptions(order,diag,exceptions){var repeatWeek,sameDOW,collide,sameDay=!1,repeatDay=!1;return exceptions.filter(function(range){return range._user!==diag._id?!1:(collide=!0,sameDay=moment(range.start).isSame(order.day,"day"),repeatDay="day"==range.repeat,repeatWeek="week"==range.repeat,sameDOW=moment(order.day).day()==moment(range.start).day(),collide=collide&&(sameDay||repeatDay||repeatWeek&&sameDOW))})}global.diagsCalculateAvailableSlots=diagsCalculateAvailableSlots}("undefined"!=typeof exports&&exports||window);var $hasMouse=function(change){$("html").on("mousemove",function(e){change(!0),$("html").off("mousemove")}),change(!1)};$(function(){$.hrefAnchor=function(){var url=window.location.href,idx=url.indexOf("#"),hash=-1!=idx?url.substring(idx+1):"";return hash.replace("/","")},$.scrollToAnchor=function(){var elem=$("#"+$.hrefAnchor());$("html, body").animate({scrollTop:elem.offset().top},500)},$.onGlobalError=function(cb){$("html").on("error",function(){console.log("ERROR.DETECTED")})},$.downloadPNG=function(elem,name){html2canvas(elem,{onrendered:function(canvas){var imgData=canvas.toDataURL("image/jpeg",1),pdf=new jsPDF;pdf.addImage(imgData,"JPEG",25,20),pdf.save("download.pdf")}})}});var whenProperties=function(o,props,cbArray){var i=setInterval(function(){var rta=!0;props.forEach(function(v){_.isUndefined(o[v])&&(rta=!1)}),rta&&(clearInterval(i),cbArray.forEach(function(cb){cb()}))},200)};!function(exports){var BASE64URICHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split("");exports.newId=function(len,radix){var chars=BASE64URICHARS,newId=[],i=0;for(radix=radix||chars.length,len=len||22,i=0;len>i;i++)newId[i]=chars[0|Math.random()*radix];return newId.join("")}}("undefined"==typeof exports?window:exports);var downloadFile=function(filename,encodedData,mimeType){var link=document.createElement("a");mimeType=mimeType||"text/plain",link.setAttribute("download",filename),link.setAttribute("href","data:"+mimeType+";charset=utf-8,"+encodedData),link.click()},downloadJSON=function(filename,data){downloadFile(filename,JSON.stringify(data,null,"	"),"text/json")},ToStringParameters=function(obj){var rta="";for(var x in obj)""!=rta&&(rta+="&"),rta+=x+"="+decodeURIComponent(JSON.stringify(obj[x]));return rta},getHashParams=function(){for(var e,hashParams={},a=/\+/g,r=/([^&;=]+)=?([^&;]*)/g,d=function(s){return decodeURIComponent(s.replace(a," "))},q=window.location.hash.substring(1);e=r.exec(q);)hashParams[d(e[1])]=d(e[2]);return hashParams};"undefined"!=typeof exports?(exports.MyPromise=MyPromise,exports.getHashParams=getHashParams,exports.getParameterByName=getParameterByName,exports.ifThenMessage=ifThenMessage):(window.MyPromise=MyPromise,window.getHashParams=getHashParams,window.getParameterByName=getParameterByName,window.ifThenMessage=ifThenMessage);var srv=angular.module("app.common.service",[]);srv.service("localdb",["$http",function(http){return function(settings){return MyPromise(function(resolve){resolve({localdb:!0})})}}]),srv.directive("fileModel",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attrs){var model=$parse(attrs.fileModel),modelSetter=model.assign;element.bind("change",function(){scope.$apply(function(){modelSetter(scope,element[0].files[0])})})}}}]),srv.service("fileUpload",["$http",function($http){this.single=function(opt,success,err){var fd=new FormData;Object.keys(opt.data).forEach(function(key){fd.append(key,opt.data[key])}),fd.append("file",opt.file),$http.post(opt.url,fd,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(success).error(err)}}]),srv.service("server",["$http","localdb","$rootScope","fileUpload",function(_http,localdb,r,fileUpload){function getLocalData(){return MyPromise(function(resolve,error){localData?resolve(localData):$.getJSON("./data.json",function(data){localData=data,resolve(localData)}).fail(function(jqxhr,textStatus,error){var err=textStatus+", "+error;console.log("Request Failed: "+err)})})}function handleError(_log,err){_log(err)}function get(relativeUrl,data,callback){var _log=logger(relativeUrl,data);_http({method:"GET",data:data,url:_URL+"/"+relativeUrl}).then(function(res){_log(res),callback&&callback(res)},function(err){return handleError(_log,err)})}function _post(relativeUrl,data,callback,error){var _log=logger(relativeUrl,data);_http({method:"POST",data:data,url:_URL+"/"+relativeUrl}).then(function(res){return _log(res),res.data&&0==res.data.ok&&console.warn("SERVER:REQUEST:WARNING = ",res.data.err||"Unkown error detected"),callback(res)},function(err){handleError(_log,err),error(err)})}function login(data){return console.log("SEVICE LOGIN",data),MyPromise(function(resolve,error){_post("login",data,function(res){resolve(res)},error)})}function save(table,data){return MyPromise(function(resolve,error){_post("save/"+table,data,function(res){resolve(res)},error)})}function getSingle(table,data){return MyPromise(function(resolve,error){_post("get/"+table,data,function(res){resolve(res)},error)})}function getAll(table,data){return MyPromise(function(resolve,error){get("getAll/"+table,data,function(res){resolve(res)},error)})}function custom(controller,action,data,method){return MyPromise("get"===method?function(resolve,error){get(controller+"/"+action,data,function(res){resolve(res)},error)}:function(resolve,error){_post(controller+"/"+action,data,function(res){resolve(res)},error)})}function diagsPriority(cb){ctrl("User","getAll",{userType:"diag",__rules:{disabled:{$ne:!0}},__select:"diagPriority"}).then(function(data){cb(data.result.map(function(v){return{_id:v._id,priority:v.diagPriority}}))})}function timeRangesDiagSayHeCantWorktype(cb){ctrl("TimeRange","getAll",{type:"work-exception",__select:"_user start end repeat"}).then(function(data){cb(data.result.map(function(v){return v}))})}function timeRangesDiagIsWorking(order,cb){ctrl("Order","getAll",{__select:"diagStart diagEnd _diag",__rules:{status:{$ne:"complete"}}}).then(function(data){data.result=data.result.filter(function(v){return moment(v.diagStart).isSame(moment(order.day),"day")}),cb(data.result.map(function(v){return{_user:v._diag,start:v.diagStart,end:v.diagEnd}}))})}function getAvailableRanges(order){function _data(cb){timeRangesDiagIsWorking(order,function(working){timeRangesDiagSayHeCantWorktype(function(exceptions){diagsPriority(function(diags){cb(working,exceptions,diags)})})})}function calc(order,working,exceptions,diags){return diagsCalculateAvailableSlots(order,working,exceptions,diags)}if(!isFinite(new Date(order.day)))throw Error("getAvailableRanges Invalid order day");return MyPromise(function(resolve,error){_data(function(working,exceptions,diags){resolve(calc(order,working,exceptions,diags))})})}function ctrl(ctrl,action,data){return MyPromise(function(resolve,error){_post("ctrl/"+ctrl+"/"+action,data,function(res){return resolve(res.data)},error)})}var _URL="http://localhost:5000";$.ajax("/serverURL").then(function(r){_URL=r.URL,console.info("server:url:"+_URL)});var localData=null,spinner=function(){return function(v){r.showSpinner=v,r.dom()}}(),logger=function(){var _controlledErrorsStrings=[],_controlledErrors={},_errors={},_logs={},fn=new function(){var self=this;return self.id=newId(20),function(url,req){var item={url:url,req:req};return _logs[self.id]=item,setTimeout(function(){void 0!==_logs[self.id]&&(item.err="Logger: request timeout.",delete _logs[self.id])},3e4),r.$emit("logger.working"),function(res){if(res.data||res.result){var data=res.data||res;data.ok!==!0&&(item.err=data.err||data,item.message=data.message||null,_.includes(_controlledErrorsStrings,item.err)?_controlledErrors[self.id]=item:_errors[self.id]=item)}else item.err="Server down, try later.",_.includes(_controlledErrorsStrings,item.err)?_controlledErrors[self.id]=item:_errors[self.id]=item;_.isUndefined(_logs[self.id])||delete _logs[self.id],0===Object.keys(_logs).length&&r.$emit("logger.clear")}}};return fn.addControlledErrors=function(arr){_controlledErrorsStrings=_.union(arr,_controlledErrorsStrings)},fn.clearErrors=function(){return _errors={}},fn.hasErrors=function(){return Object.keys(_errors).length>0},fn.hasPending=function(){return Object.keys(_logs).length>0},fn.pending=function(){var msg="Pending<br>";return _.each(_logs,function(v,k){console.info(v.url),""!==msg&&(msg+="<br>"),msg+=v.url+": "+JSON.stringify(v.req)}),msg},fn.errors=function(){var msg="Errors<br>";return _.each(_errors,function(v,k){console.info(v),""!==msg&&(msg+="<br>");try{msg+=v.url+": "+JSON.stringify(v.err)}catch(e){msg+=v.url+": Unparseable error. See the console."}}),msg},r.state={working:function(){return fn.hasPending()},data:_logs},r.logger=fn,fn}();r.$on("logger.working",function(){spinner(!0)}),r.$on("logger.clear",function(){spinner(!1)}),r.get=get;var ws=([{price:60,diagStart:(new Date).getTime()-18e5,diagEnd:(new Date).getTime()+18e5,_diag:1},{price:55,diagStart:(new Date).getTime()-72e5,diagEnd:(new Date).getTime()-36e5,_diag:1}],{URL:function(){return _URL},getAvailableRanges:getAvailableRanges,login:login,save:save,get:getSingle,getAll:getAll,localData:getLocalData,custom:custom,http:function(ctrl,action,data){return _http.post(_URL+"/ctrl/"+ctrl+"/"+action,data)},form:function(relativeURL,data){if(!data.file)throw Error("form: file arg required");return MyPromise(function(r,err){var file=data.file;delete data.file;var _log=logger(relativeURL,data);fileUpload.single({url:_URL+"/"+relativeURL,file:file,data:data},function(res){_log(res),r(res)},function(res){_log(res),err(res)})})},ctrl:ctrl,$get:function(url,config){return MyPromise(function(resolve,error){var _log=logger(url,data);_http.get(url,config).then(function(res){_log({ok:!0,result:res}),resolve(res)},function(err){_log({ok:!1,err:err}),error(err)})})},$post:function(url,data,config){return MyPromise(function(resolve,error){var _log=logger(url,data);_http.post(url,data,config).then(function(res){_log({ok:!0,result:res}),resolve(res)},function(err){_log({ok:!1,err:err}),error(err)})})},post:function(url,data){return MyPromise(function(resolve,error){_post(url,data,function(res){resolve(res)},error)})}});return r.ws=ws,ws}]);var app=angular.module("app.common.root",[]);app.run(["server","$timeout","$rootScope",function(db,$timeout,r){window.r=r,r.getHashParams=getHashParams,r.debug=!0,r.config={},db.localData().then(function(data){return Object.assign(r.config,data.config||{})}),r.__cache={},r.cache=function(n,o){return o?r.__cache[n]=o:(!_.isUndefined(r.__cache[n])&&!_.isNull(r.__cache[n]),r.__cache[n]||null)},r.momentFormat=function(d,f){return moment(d).format(f)},r.momentTime=function(d){return moment(d).format("HH:mm")},r.dom=function(cb,timeout){$timeout(function(){cb&&cb(),r.$apply()},timeout||0)},r.toggleBody=function(val){r.dom(function(){var el=document.body;el.className=el.className.replace("hidden","").trim(),val||(el.className=(el.className+" hidden").trim())})},r.db=function(){var lib=new localStorageDB("inspectors",localStorage),db={setUnique:function(tableName,data){lib.insertOrUpdate(tableName,{ID:1},data),lib.commit()},getUnique:function(tableName){return lib.queryAll(tableName)[0]},getAll:function(tableName){return lib.queryAll(tableName)}};return db.createSession=function(force){force&&lib.tableExists("session")&&lib.dropTable("session"),lib.createTable("session",["_id","email","expire","userType","password","rememberPass","clientType"]),db.setUnique("session",{_id:null,email:null,expire:null,password:null,userType:null,clientType:null,rememberPass:!0})},lib.tableExists("session")||db.createSession(),db}(),r.session=function(data){return data&&(r.db.setUnique("session",data),r._session=data),Object.assign(r.db.getUnique("session"),r._session||{})},r.logged=function(){var ss=r.session();return null!==ss.email&&null!==ss.password},r.viewAsClient=function(){r._session=r._session||{},r._session.userType="client",r.dom()},r.viewAsDiag=function(){r._session=r._session||{},r._session.userType="diag",r.dom()},r.viewAsAdmin=function(){r._session=r._session||{},r._session.userType="admin",r.dom()},r._login={email:"",password:""};var session=r.session();_.each(session,function(val,key){r._login[key]=val}),session.password&&(r._login.password=session.password),session.rememberPass||(r._login.password=null),r.logout=function(){r.session({email:null,password:null}),r.route("login")},r.route=function(url,delay){return setTimeout(function(){var path=window.location.origin+window.location.pathname;path+="#/"+url,window.location.href=path},delay||0),r.__route=url,url},r.routeIs=function(n){return r.__route&&-1!==r.__route.toString().toLowerCase().indexOf(n&&n.toLowerCase()||"invalid")||!1},r.__route=window.location.href.replace(window.location.origin+window.location.pathname,""),r.userIs=function(arr){var type=r.session().userType;return _.includes(arr,type)},r.routeParams=function(obj){r.params=Object.assign(r.params||{},obj)},r.hasMouse=!1,$hasMouse(function(v){r.hasMouse=v,r.dom()})}]);var app=angular.module("app.common.directives",[]);app.directive("ctrlDtp",function($rootScope){return{restrict:"AE",scope:{opt:"=options"},replace:!0,templateUrl:"./views/directives/directive.ctrl.datetimepicker.html",link:function(s,el,attrs){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}var opt=s.opt;if(expose&&expose(opt.name||"dtp",s),!opt.modelPath)throw Error("ctrlDtp require opt.modelPath");if(!opt.scope)throw Error("ctrlDtp require opt.scope");if(!opt.cls)throw Error("ctrlDtp require opt.cls (function)");if(!opt.disabled)throw Error("ctrlDtp require opt.disabled (function)");s=Object.assign(s,{scope:opt.scope,opened:!1,disabled:function(){return opt.disabled()},cls:function(){return opt.cls()},model:opt.initDate||new Date}),opt.scope.$watch(function(){opt.digest&&opt.digest(opt)}),opt.scope.$watch(opt.modelPath,function(v){void 0!==v&&v!==s.model&&(s.model=v)}),s.$watch("model",function(v){setVal(opt.scope,opt.modelPath,v)})}}}),app.directive("ctrlSelect",function($rootScope){return{restrict:"AE",scope:{opt:"=options"},replace:!0,templateUrl:"./views/directives/directive.ctrl.select.html",link:function(s,el,attrs){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}s.choiceLabel=function(choice){return choice.label?"string"!=typeof choice.label?choice.label():choice.label:choice},s.choiceDisabled=function(choice){return choice.disabled?choice.disabled():!1};var r=$rootScope,opt=s.opt;if(!opt.modelPath)throw Error("ctrlSelect require opt.modelPath");if(!opt.scope)throw Error("ctrlSelect require opt.scope");if(!opt.items)throw Error("ctrlSelect require opt.items");if(!opt.cls)throw Error("ctrlSelect require opt.cls (function)");if(!opt.disabled)throw Error("ctrlSelect require opt.disabled (function)");s=Object.assign(s,{scope:opt.scope,label:opt.label||"(Select Item)",disabled:function(){return opt.disabled()},cls:function(){return opt.cls()},click:function(x){setVal(opt.scope,opt.modelPath,x.val||x)}}),opt.filterWatch?s.scope.$watch(opt.filterWatch,function(){opt.filter&&(s.opt.items=_.filter(s.opt.items,function(v){return opt.filter(v)}))},!0):s.scope.$watch(function(){opt.filter&&(s.opt.items=_.filter(s.opt.items,function(v){return opt.filter(v)}))}),opt.scope.$watch(opt.modelPath,function(v,oldV){var arr=s.opt.items.filter(function(item){return(item.val||item)==v});if(arr.length>1)throw Error("ctrlSelect items val need to be unique.");1==arr.length?(arr[0].label?"string"!=typeof arr[0].label?s.label=arr[0].label():s.label=arr[0].label:s.label=arr[0],opt.change&&opt.change(arr[0],opt,function(){v!==oldV&&setVal(opt.scope,opt.modelPath,oldV)}),r.dom()):(opt.label&&(s.label=opt.label||"(Select Item)"),console.warn("ctrlSelect model has an invalid value. Values expected: "+JSON.stringify(s.opt.items.map(function(item){return item.val||item}))))}),opt.init&&opt.init(opt)}}}),app.directive("includeReplace",function(){return{require:"ngInclude",restrict:"A",link:function(scope,el,attrs){el.replaceWith(el.children())}}}),app.directive("activeRoute",function($rootScope){return{restrict:"A",link:function(scope,el,attrs){function apply(){$rootScope.routeIs(attrs.activeRoute)?el.addClass("active"):el.removeClass("active")}$rootScope.dom(apply),$rootScope.$watch("__route",function(__route){$rootScope.dom(apply)})}}}),app.directive("focusOn",function(){return function(scope,elem,attr){scope.$on("focusOn",function(e,name){name===attr.focusOn&&elem[0].focus()})}}),app.directive("collapseNav",function($timeout,$rootScope){return{restrict:"AE",replace:!1,link:function(s,elem,attr){var r=$rootScope;r.dom(function(){elem.find("li").on("click",function(){r.dom(function(){var w=$(window).width();768>w&&elem.collapse("hide")})})})}}}),app.factory("focus",function($rootScope,$timeout){return function(name){$timeout(function(){$rootScope.$broadcast("focusOn",name)})}}),app.directive("crudModal",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open",close:"=close"},template:"<output></output>",link:function(s,elem,attrs){var fire=function(n,p,ctx){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){ctx?cb.call(ctx,p):cb(p)}))};s.open=function(opt){if(s.evts=opt.evts,!opt.templateUrl)throw Error("crudModal needs templateUrl");$uibModal.open({animation:!0,templateUrl:opt.templateUrl,controller:function($scope,$uibModalInstance){var s=$scope;s.fire=function(n,p){return fire(n,p,s)},Object.assign(s,opt),s.save=s.validate=function(){s.validate&&s.validate.when&&s.validate.fail?ifThenMessage(s.validate.when(s),s.validate.fail(s),function(){s.close()}):s.close()},s.close=function(){$uibModalInstance.close(),opt.callback(s.item)},s.closeSilent=function(){$uibModalInstance.close()},s.redirect=function(url){r.params={item:s.item},r.route(url),s.closeSilent()},s.cancel=function(){$uibModalInstance.dismiss("cancel")},fire("init",null,s)}})}}}}),app.directive("address",function($rootScope,$timeout){return{scope:{model:"=model",field:"@field",change:"=change",number:"@number",street:"@street",city:"@city",department:"@department",region:"@region",country:"@country",postCode:"@postCode"},restrict:"AE",link:function(scope,elem,attrs){if(!scope.model)throw Error("directive address require a valid model.");$timeout(function(){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}function read(){$timeout(function(){""!==scope.model[scope.field]&&elem.geocomplete("find",scope.model[scope.field]),scope.$apply()})}elem.geocomplete().bind("geocode:result",function(event,result){scope.model[scope.field]=result.formatted_address,scope.change&&scope.change(result.formatted_address);var number,street,city,department,region,country,postCode,data=result.address_components.map(function(v){return v.long_name});4==data.length&&(number="",street=data[0],city=data[1],department=data[1],region="",country=data[2],postCode=data[3]),5==data.length&&(number="",street=data[0],city=data[0],department=data[1],region=data[2],country=data[3],postCode=data[4]),6===data.length&&(number="",street=data[0],city=data[1],department=data[2],region=data[3],country=data[4],postCode=data[5]),7===data.length&&(number=data[0],street=data[1],city=data[2],department=data[3],region=data[4],country=data[5],postCode=data[6]),scope.number&&setVal(scope.model,scope.number,number),scope.street&&setVal(scope.model,scope.street,street),scope.city&&setVal(scope.model,scope.city,city),scope.department&&setVal(scope.model,scope.department,department),scope.region&&setVal(scope.model,scope.region,region),scope.country&&setVal(scope.model,scope.country,country),scope.postCode&&setVal(scope.model,scope.postCode,postCode),expose("address",Object.assign(result,scope)),r.dom()}),read(),scope.$watch("model."+scope.field,read),scope.$apply()})}}}),app.directive("debug",function($rootScope,$timeout,server,$compile){return{scope:{show:"=show"},restrict:"AE",replace:!0,template:'<div><i ng-show="show" ng-click="click()" class="link fa fa-bug fa-lg fixed left-1 bottom-1 always-on-top"><input type="checkbox" ng-click="stop()" ng-model="check"></i><span data-output></span></div>',
link:function(s,elem,attrs){var r=$rootScope;s.check=!0,s.opt={onClose:function(){r.logger.clearErrors()}},s.stop=function(){return window.event.stopPropagation()},s.click=function(){var log=r.logger.pending();log&&s.create(log,"info");var err=r.logger.errors();err&&s.create(err,"danger")},s.$watch("check",function(v){v?(s.checking&&clearInterval(s.checking),s.checking=setInterval(function(){r.logger.hasErrors()&&r.dom(function(){0===elem.find("[data-output] .alert-danger").length&&s.create(r.logger.errors(),"danger")})},1e3),window.onerror=function(err){s.create(err,"danger")}):(s.checking&&clearInterval(s.checking),window.onerror=function(err){})}),s.create=function(msg,type){s.msgs=s.msgs||{};var cls="always-on-top fixed overlay limit-h-200 fullwidth "+("danger"===type?"bottom-1":"top-1"),el=$compile("<my-alert opt='opt' message='"+msg+"' type='alert-"+(type||"danger")+"' cls='"+cls+"' />")(s);void 0!==s.msgs[type]&&s.msgs[type].alert("close"),s.msgs[type]=el,r.dom(function(){elem.find("[data-output]").append(el)})},setTimeout(function(){-1!==server.URL().indexOf("localhost")&&(s.show=!0,r.dom())},5e3)}}}),app.directive("spinner",function($rootScope,$timeout){return{scope:{show:"=show"},restrict:"AE",replace:!0,templateUrl:"./views/directives/directive.spinner.html",link:function(scope,elem,attrs){}}}),app.directive("checkBox",function($rootScope,$timeout){return{scope:{val:"=val",arr:"=push"},restrict:"AE",replace:!0,template:"<input type='checkbox'/>",link:function(scope,elem,attrs){$timeout(function(){scope.$apply(function(){elem.value=scope.val,elem.on("change",function(){var checked=elem.get(0).checked;checked?(scope.arr=scope.arr||[],scope.arr.push(scope.val)):_.remove(scope.arr,function(e){return e===scope.val})})})})}}}),app.directive("notify",function($rootScope,$timeout){return{scope:{message:"@message",type:"@type",cls:"@cls",scroll:"=scroll",opt:"=opt",evts:"=evts",settings:"=settings"},restrict:"AE",replace:!0,templateUrl:"./views/directives/directive.alert.notify.html",link:function(scope,elem,attrs){var r=$rootScope,s=scope;if(s.settings&&"string"==typeof s.settings){var fixedJSON=s.settings.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g,'"$2": ');s.settings=JSON.parse(fixedJSON)}var fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};$timeout(function(){scope.$apply(function(){elem.find(".alert").addClass(scope.type||"alert-danger"),scope.cls&&elem.find(".alert").addClass(scope.cls)})}),scope.clickDismiss=function(){s.settings&&s.settings.clickDismissable===!1&&s.opt&&!s.opt.clickDismissable||scope.dismiss()},scope.dismiss=function(){s.dismissed||(s.dismissed=!0,elem.find(".alert").alert("close"),elem.remove(),fireEvent("close"),scope.opt&&scope.opt.onClose&&scope.opt.onClose())},scope.$watch("message",function(v){elem.find("[data-message]").html(v)}),s.opt&&s.opt.duration?r.dom(s.dismiss,s.opt.duration):(_.includes(["alert-info","alert-success"],s.type)&&r.dom(scope.dismiss,2e3),_.includes(["alert-danger","alert-warning"],s.type)&&r.dom(scope.dismiss,1e4))}}}),app.directive("myAlert",function($rootScope,$timeout){return{scope:{message:"@message",type:"@type",cls:"@cls",scroll:"=scroll",opt:"=opt",evts:"=evts"},restrict:"AE",replace:!0,templateUrl:"./views/directives/directive.alert.html",link:function(scope,elem,attrs){var s=scope,fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};$timeout(function(){scope.$apply(function(){elem.addClass(scope.type||"alert-danger"),scope.cls&&elem.addClass(scope.cls)})}),scope.dismiss=function(){elem.alert("close"),fireEvent("close"),scope.opt&&scope.opt.onClose&&scope.opt.onClose()},scope.$watch("message",function(v){elem.find("[data-message]").html(v),v&&scope.scroll&&r.dom(function(){$("html, body").animate({scrollTop:elem.offset().top},500)})})}}}),app.directive("myAlerts",function($rootScope,$timeout,$compile){return{restrict:"AE",replace:!0,scope:{add:"=add",directive:"@directive",stacked:"@stacked",settings:"@settings"},template:"<output></output>",link:function(s,elem,attrs){function onClose(){if(s.stacked){if(s.el=null,0===s._stacked.length)return;var p=s._stacked[0];s._stacked=s._stacked.slice(1),s.add(p.message,p.type,p.timeout,p.scroll,p.opt)}}s.stacked="true"===s.stacked,s.decodeMessage=function(msg){return"string"==typeof msg?msg:JSON.stringify(msg)},s._stacked=[],s.evts={close:[onClose]};var fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};s.add=function(message,type,timeout,scroll,opt){var msg=s.decodeMessage(message);if(type&&"string"!=typeof type&&(opt=type,type=opt.type||void 0),timeout&&"object"===("undefined"==typeof timeout?"undefined":_typeof(timeout))&&(opt=timeout,timeout=void 0),opt&&opt.scroll===!0&&(scroll=!0),s.stacked){if(s.el)return s._stacked.push({message:message,type:type,timeout:timeout,scroll:scroll,opt:opt})}else s.el&&s.el.alert("close");var directive=s.directive||"my-alert";s.opt=opt;var el=$compile("<"+directive+" settings='settings' evts='evts' opt='opt' scroll='"+scroll+"' message='"+msg+"' type='alert-"+(type||"danger")+"'/>")(s);s.el=el,elem.html("").append(el),timeout&&"my-alert"===directive&&r.dom(function(){elem.html(""),fireEvent("close")},timeout)},window.ss=s}}}),app.directive("modalCustom",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){if(!attrs.templateUrl)throw Error("modalCustom attr templateUrl required.");s.open=function(opt,confirmCallback){opt=opt||{};var message="";message="string"==typeof opt?opt:opt.message||"";$uibModal.open({animation:!0,templateUrl:opt.templateUrl||attrs.templateUrl,controller:function($scope,$uibModalInstance){$scope.data=opt.data,$scope.message=message,$scope.messageEl=opt.messageEl||null,$scope.yes=function(){$uibModalInstance.close(),confirmCallback&&confirmCallback()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},expose("modalCustom",$scope)}})}}}}),app.directive("modalConfirm",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){s.open=function(opt,okCallback){opt=opt||{};var message="";message="string"==typeof opt?opt:opt.message||"";$uibModal.open({animation:!0,templateUrl:opt.templateUrl||"views/directives/directive.modal.sure.html",controller:function($scope,$uibModalInstance){$scope.data=opt.data,$scope.message=message,$scope.yes=function(){$uibModalInstance.close(),okCallback&&okCallback()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}})}}}}),app.directive("dynamicTable",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!0,scope:{model:"=model"},templateUrl:"views/partials/partials.table.html",link:function(s,elem,attrs){var r=$rootScope;$rootScope.$watch("hasMouse",function(v){s.hasMouse=v});attrs.name;return s.model?(s.click=function(item,index){s.model.click&&s.model.click(item,index)},s.buttons=s.model.buttons||null,s.columns=s.model.columns||[],s.items=s.model.items||[],void(s.model.update=function(items,data){s.items=items,s.data=data,r.dom()})):void console.error("directive.table: no model present")}}}),app.directive("appendChild",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!1,scope:{child:"=child"},link:function(s,elem,attrs){s.child&&elem.html("").append(s.child)}}}),app.directive("htmlContent",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!1,scope:{html:"&html"},link:function(s,elem,attrs){s.html&&r.dom(function(){elem.html(s.html)})}}}),app.directive("timeRange",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){s.open=function(opt){$uibModal.open({animation:!0,templateUrl:"views/directives/directive.modal.timeRange.html",controller:function($scope,$uibModalInstance){var s=$scope;s.title=opt.title,s.title||(s.title="Time Range",opt.action&&"edit"===opt.action?s.title+=" - Edition":s.title="New "+s.title),s._opt=opt,window.edit=s,s.days=function(){var o={label:"Day",selected:"",items:[],val:null,select:function(val){o.items.forEach(function(v){v.val.toString()==val.toString()&&o.click(v)})},click:function(v){o.selected=v.label||v,o.val=v.val,s.start.val&&(s.start.val=moment(s.start.val),s.start.val.day("-1"===o.val.toString()?1:o.val)),s.end.val&&(s.end.val=moment(s.end.val),s.end.val.day("-1"===o.val.toString()?1:o.val))}},m=moment();o.items.push({label:"(Choice a day)",val:""},{label:"Every day",val:"-1"});for(var x=1;7>=x;x++)m.day(x),o.items.push({label:m.format("dddd"),val:x});return o.selected=o.items[0].label,o}();var timePickerData=function(){return function(m){return{hstep:1,mstep:10,repeat:"",minDate:moment().date(1),val:m||moment().hour(9).minutes(0)}}}();if(s.start=timePickerData(opt.start),s.end=timePickerData(opt.end),s.repeat="none",s.daySelection=function(){return"none"!==s.repeat},s.datepicker={val:void 0,minDate:moment().add(1,"day"),maxDate:moment().add(2,"month"),initDate:new Date},s.$watch("repeat",function(v){"day"===v&&s.days.select(-1)}),s.validate=function(){if(!s.description,!s.days.val)return s.message("Choice a day","warning",2e3),!1;if("day"!==s.repeat&&"-1"===s.days.val.toString())return s.message("Choice a day","warning",2e3),!1;if("none"===s.repeat&&void 0==s.datepicker.val)return void s.message("Choice a day in the calendar","warning",2e3);try{var _d=moment(s.start.val);_d=moment(s.end.val),"none"===s.repeat&&(s.start.val=moment(s.datepicker.val).hour(moment(s.start.val).hour()).minutes(moment(s.start.val).minutes()).toDate(),s.end.val=moment(s.datepicker.val).hour(moment(s.end.val).hour()).minutes(moment(s.end.val).minutes()).toDate())}catch(e){return s.message("Invalid time","warning",2e3),!1}return!0},s.save=function(){if(s.validate()){$uibModalInstance.close();var rta={description:s.description||"",start:s.start.val,end:s.end.val,type:opt.type,repeat:s.repeat};"edit"==opt.action&&(rta._user=opt.item._user,rta._id=opt.item._id),opt.callback(rta)}},s.cancel=function(){$uibModalInstance.dismiss("cancel")},!opt.action)throw Error("directive timeRange open require arg.action");if("new"==opt.action,"edit"===opt.action){var start=moment(opt.item.start);s.repeat=opt.item.repeat,s.description=opt.item.description,s.start.val=opt.item.start,s.end.val=opt.item.end,opt.type=opt.item.type,s.days.val=start.day(),s.days.select(s.days.val),"day"==s.repeat&&(s.days.val=-1)}}})}}}}),angular.module("app.static.calendar",[]).controller("calendar",["$scope","server","$rootScope",calendar]);var app=angular.module("app",["app.common.service","app.common.root","app.common.directives","app.static.calendar","ui.bootstrap"]);app.controller("fullpage",["server","$timeout","$scope","$rootScope","$uibModal",function(db,$timeout,s,r,$uibModal){function scrollToAnchor(){try{$.hrefAnchor()&&$.fn.fullpage.moveTo($.hrefAnchor())}catch(e){}}function updateChecksVisibilityOnDemand(){function updateChecks(){"Before le 01/01/1949"===s.model.constructionPermissionDate?(toggle("crep",!0),s.model.diags.crep=!0):(s.model.diags.crep=!1,toggle("crep",!0)),s.departmentHasTermites()?(toggle("termites",!0),s.model.diags.termites=!0):(toggle("termites",!1),s.model.diags.termites=!1),_.includes(["Before le 01/01/1949","entre 1949 et le 01/07/1997"],s.model.constructionPermissionDate)?(toggle("dta",!0),s.model.diags.dta=!0):(toggle("dta",!0),s.model.diags.dta=!1),_.includes(["Oui, Plus de 15 ans","Oui, Moins de 15 ans"],s.model.gasInstallation)?(toggle("gaz",!0),1==s.model.sell&&"Oui, Plus de 15 ans"===s.model.gasInstallation?s.model.diags.gaz=!0:s.model.diags.gaz=!1):toggle("gaz",!1),_.includes(["Oui, Plus de 15 ans","Oui, Moins de 15 ans"],s.model.electricityInstallation)?(toggle("electricity",!0),1==s.model.sell&&"Oui, Plus de 15 ans"===s.model.electricityInstallation?s.model.diags.electricity=!0:s.model.diags.electricity=!1):toggle("electricity",!1)}var toggle=function(n,val){s.diags.forEach(function(diag){(n&&diag.name==n||!n)&&(diag.show=val,0==diag.show&&(s.model.diags[diag.name]=!1))})};s.diags.forEach(function(val,key){s.model.diags[val.name]=!!val.mandatory}),s.$watch("model.constructionPermissionDate",updateChecks),s.$watch("model.sell",updateChecks),s.$watch("model.gasInstallation",updateChecks),s.$watch("model.address",updateChecks),s.$watch("model.electricityInstallation",updateChecks),toggle(void 0,!0)}function loadDefaults(){s.model=Object.assign(s.model,{sell:paramBool("sell"),house:paramBool("house"),squareMeters:param("squareMeters",s.squareMeters)||void 0,apartamentType:param("apartamentType",s.apartamentType)||void 0,constructionPermissionDate:param("cpd",s.constructionPermissionDate)||void 0,address:param("address")||void 0,gasInstallation:param("gasInstallation",s.gasInstallation)||void 0,electricityInstallation:param("gasInstallation",s.gasInstallation)||void 0,date:paramDate("date"),time:param("time",["any"]),clientType:param("clientType",["agency","landlord"])}),s.diags.forEach(function(diag){var val=paramBool(diag.name);_.isUndefined(val)||_.isNull(val)||(s.model.diags[diag.name]=val)})}function _payOrder(order){openStripeModalPayOrder(order,function(token){order.stripeToken=token.id,db.ctrl("Order","pay",order).then(function(data){data.ok?(_modalSuccess(),console.info("PAY-OK",data.result),s.notify("Order created and paid. We send you an email.",{type:"success",duration:1e5})):(console.info("PAY-FAIL",data.err),s.notify("There was a server issue during the payment proccess, but your Order has been created. Check your email for more information.",{type:"warning",duration:1e5}))}).error(function(){s.notify("There was a server issue during the payment proccess, but your Order has been created. Check your email for more information.",{type:"warning",duration:1e5})})})}window.r=r,window.s=s,r.dom(),s._user={address:null},s._order={},s.booking={order:{saved:!1,exists:!1,taken:!1},complete:!1,payment:{complete:!1}},s.orderPaid=function(){return _.includes(["prepaid","completed"],s._order.status)},s.departmentHasTermites=function(){if(s.model.department){var code=s.model.postCode.substring(0,2);return _.includes(s.termitesDepartments.map(function(v){return v.toString()}),code)}},s.orderExistsNote=function(){if(s.booking.order.exists&&s.booking.order.saved){if("landlord"!==s._user.clientType){if(1!=s._order.landLordPaymentEmailSended)return"The payment of this order is pending.";s.booking.order.delegatedTo||(s.booking.order.delegatedTo=s._order.landLordEmail)}var delegated="The payment of this order was delegated to "+s.booking.order.delegatedTo;return _.includes(["prepaid","completed"],s._order.status)?1==s._order.landLordPaymentEmailSended?"This order was delegated to "+s.booking.order.delegatedTo+" and is already paid.":"This order is already paid":delegated}},s.keysWhereTime={invalidKeysTimeMessage:function(){var startTime=function(){return moment(s._order.diagStart).format("HH:mm")};return"Keys time should be between 8:00 and "+startTime()},invalidKeysTime:function(){var before=function(d1,h){return moment(d1).isBefore(moment(d1).hours(8))},diag={hours:moment(s._order.diagStart).hours(),minutes:moment(s._order.diagStart).minutes()},after=function(d1){return moment(d1).isAfter(moment(d1).hours(diag.hours).minutes(diag.minutes))},tfrom=s._order.keysTimeFrom,tto=s._order.keysTimeTo;return!tfrom||before(tfrom)||after(tfrom)?(console.warn("invalidKeysTime from",!tfrom,before(tfrom),after(tfrom)),!0):!tto||before(tto)||after(tto)?(console.warn("invalidKeysTime to",!tto,before(tto),after(tto)),!0):tto&&tfrom&&moment(tto).isBefore(moment(tfrom))?(console.warn("invalidKeysTime from <- to required."),!0):!1},emit:function(n){var self=this,arr=self.evts[n]||[];arr.forEach(function(evt){return evt(self)})},evts:{onItem:[function(self){s.keysWhereTime.updateItems(self)}]},mstep:15,hstep:1,address:"",scope:s,val:void 0,disabled:function(){return r.state.working()},cls:function(){return{btn:!0,"btn-default":!0}},filterWatch:"_order",filter:function(v){return!(s._order&&s._order._client&&s._order._client.clientType&&"agency"!==s._order._client.clientType&&"agency"==v.val)},label:"(Select where)",modelPath:"_order.keysWhere",items:[],updateItems:function(self){var o=[{label:function(){return s._order&&s._order.address||"Diag Address"},val:1,get:function(){return s._order&&s._order.address}}];s._order._client&&"agency"==s._order._client.clientType?o.push({label:function(){return s._user.address||"Agency address"},val:3,get:function(){return s._user.address||""}},{label:function(){return s._order.landLordAddress||"Landlord address"},val:4,disabled:function(){return!s._order.landLordAddress},get:function(){return s._order.landLordAddress||""}}):o.push({label:function(){return s._user.address||"Client address"},val:3,get:function(){return s._user.address||""}}),self.items=o},change:function(v,self,setOldValue){if(v){var address=v.get();return address?s._order.keysAddress&&s._order.keysAddress==address?void(s._order.keysTime||(s._order.keysTime=moment(s._order.diagStart).hours(8).minutes(0)._d)):void(s._order.keysAddress=address):(s.notify("Address not found",{type:"warning",duration:5e3,clickDismissable:!0}),self.val=void 0,void setOldValue())}}},r.logger.addControlledErrors(["ORDER_EXISTS","ORDER_TAKEN"]),s.datepicker={minDate:moment().add(1,"day"),maxDate:moment().add(60,"day"),initDate:new Date},s.model={date:void 0,diags:{},clientType:"agency"},s.isAgency=function(){return"agency"==s.model.clientType||!1},s.validModel=function(){var isValid=void 0!==s.model.sell&&!0&&void 0!==s.model.house&&(s.model.squareMeters||!1)&&(s.model.constructionPermissionDate||!1)&&(s.model.gasInstallation||!1)&&(s.model.electricityInstallation||!1)&&(s.model.address||!1)&&(s.model.diagStart||!1)&&(s.model.diagEnd||!1)&&!0;return isValid};var waitForProperties=function(cbArray,props){var i=setInterval(function(){var rta=!0;props.forEach(function(v){_.isUndefined(s[v])&&(rta=!1)}),rta&&(clearInterval(i),cbArray.forEach(function(cb){cb()}))},200)};db.localData().then(function(data){Object.assign(s,data),updateChecksVisibilityOnDemand(),waitForProperties([loadDefaults,scrollToAnchor,r.dom],["notify"])});var diagDescription=function(n){var rta=n;return s.diags.forEach(function(diag){n&&diag.name==n&&(rta=diag.label)}),"cpd"===n&&(rta="constructionPermissionDate"),rta},diag=function(n){var rta=null;return s.diags.forEach(function(diag){n&&diag.name==n&&(rta=diag)}),rta};s.diagLabel=function(n,v){return v?diag(n).label:void 0},s.diagPrice=function(n,v){return v?diag(n).price:void 0};var param=function(n,validate){var val=getParameterByName(n);if(val){if(validate){var vals=Object.keys(validate).map(function(v){return validate[v]});if(vals.length>0&&!_.includes(vals,val)){var msg="Parameter "+diagDescription(n)+" has the follow valid values:"+JSON.stringify(vals);return console.warn(msg),void s.notify(msg,"warning",0,!0,{duration:99999})}return val}return val}},paramDate=s.paramDate=function(n){var v=(getParameterByName(n)||"").toString(),d=new Date(v);if(isFinite(d)){var fail=!1;return moment(d).isBefore(s.datepicker.minDate,"day")&&(fail=!0),moment(d).isAfter(s.datepicker.maxDate,"day")&&(fail=!0),fail?void s.notify("Parameter "+n+" needs to be a valid date between "+s.datepicker.minDate.format("DD/MM/YY")+" and "+s.datepicker.maxDate.format("DD/MM/YY"),"warning",0,!0,{duration:99999}):d}null!==getParameterByName(n)&&s.notify("Parameter "+n+" needs to be a valid date","warning",0,!0,{duration:99999})},paramBool=function(n){var v=(getParameterByName(n)||"").toString();return _.includes(["1","0"],v)?"1"===v:void(null!==getParameterByName(n)&&s.notify("Parameter "+n+" needs to be a 1/0","warning",0,!0,{duration:99999}))};s.lineThrough=function(item){return 0==item.show},s.$watch("model.date",function(date){if(isFinite(new Date(date))){var time=s.totalTime(),order={day:date,time:time};db.getAvailableRanges(order).then(function(data){s.availableTimeRanges=data.length>0&&data||null,"any"==s.model.time&&s.availableTimeRanges&&s.availableTimeRanges.length>0&&s.pickTimeRange(s.availableTimeRanges[0]),s.availableTimeRanges&&s.availableTimeRanges.forEach(function(r){db.ctrl("User","get",{_id:r._diag}).then(function(d){d.ok&&d.result&&(r.name=d.result.firstName,d.result.diagPriority&&(r.name+=" ("+d.result.diagPriority+")"))})})})}}),s.moveTo=function(n){$.fn.fullpage.moveTo(n)},s.left=function(){return $.fn.fullpage.moveSlideLeft()},s.right=function(){return $.fn.fullpage.moveSlideRight()},s.down=function(force){var curr=$.hrefAnchor(),anchors=["question1","question2","question3","question4","question5","question6","question7","diags","calendar-timepicker","confirm-order"],req={question1:function(){return void 0!==s.model.sell},question2:function(){return void 0!==s.model.house},question3:function(){return s.model.squareMeters},question4:function(){return s.model.constructionPermissionDate},question5:function(){return s.model.address},question6:function(){return s.model.gasInstallation},question7:function(){return s.model.electricityInstallation},diags:function(){return!1},"calendar-timepicker":function(){return s.model.diagStart&&!0&&s.model.diagEnd},"confirm-order":function(){return!1}},nextInvalidAnchor=function(curr){var index=_.indexOf(anchors,curr);if(index+1==anchors.length)return curr;index++;for(var section in req){if(!req[anchors[index]]())return anchors[index];index++}};1==force?$.fn.fullpage.moveSectionDown():s.moveTo(nextInvalidAnchor(curr))},s.up=function(){$.fn.fullpage.moveSectionUp()},s.selectedDate=function(){return moment(s.model.date).format("MMMM Do YYYY, dddd")},s.drawRange=function(rng){var rta=moment(rng.start).format("HH:mm")+"h - "+moment(rng.end).format("HH:mm")+"h";return rng.name&&(rta+=" by "+rng.name),rta},s.onModelChange=function(a,b,c){},s.$watch("model",s.onModelChange,!0),s.infoMsg=function(msg){s.notify(msg,{type:"info",duration:5e3})},s.warningMsg=function(msg){s.notify(msg,{type:"warning",duration:5e3})},s.successMsg=function(msg){s.notify(msg,{type:"success",duration:2e3})},s.auto=function(){console.log("auto"),r.dom(function(){return s.moveTo("confirm-and-save")},0),r.dom(function(){return s.right()},2e3),r.dom(function(){return s.login()},4e3),s.hideNav(),s.auth={email:"javiermosch@gmail.com",pass:"client"}},s.auth={email:void 0,pass:void 0},s.validateAuthInput=function(cb){ifThenMessage([[!s.auth.email,"==",!0,"Email required."],[!s.auth.pass,"==",!0,"Password required."]],function(m){"string"!=typeof m[0]?s.warningMsg(m[0]()):s.warningMsg(m[0])},cb)},s.orderSaved=function(){return s.booking.order.saved},s.paymentDelegated=function(){return 1==s._order.landLordPaymentEmailSended},s.login=function(){s.validateAuthInput(function(){db.ctrl("User","get",{email:s.auth.email,password:s.auth.pass,userType:"client"}).then(function(_user){_user=_user.ok&&_user.result||null,_user?(s.model.clientType=_user.clientType,s._user=_user,s.saveAsync(),s.subscribeMode=!0):s.warningMsg("Invalid credentials")})})},s.backToBookingQuestions=function(){s.moveTo("question5"),$("#fp-nav").toggle(!0),s.left()},s.slideToAuth=function(){s.subscribeMode&&s.saveAsync(),s.hideNav(),s.right()},s.validateBooking=function(cb){ifThenMessage([[s.isAgency()&&!s._order.landLordEmail,"==",!0,"Landlord Email required."],[s.isAgency()&&!s._order.landLordFullName,"==",!0,"Landlord Name required."],[!s._order.keysAddress,"==",!0,"Keys Address required."],[!s._order.keysTimeFrom,"==",!0,"Keys Time From  required."],[!s._order.keysTimeTo,"==",!0,"Keys Time To required."],[s.keysWhereTime.invalidKeysTime(),"==",!0,s.keysWhereTime.invalidKeysTimeMessage]],function(m){"string"!=typeof m[0]?s.warningMsg(m[0]()):s.warningMsg(m[0])},cb)},s.invoiceEndOfTheMonth=function(){s.validateBooking(function(){db.ctrl("Order","confirm",s._order).then(function(d){d.ok&&(s.booking.complete=!0,db.ctrl("Order","update",s._order))})})},s.sendPaymentLink=function(){function _sendPaymentLink(){db.ctrl("Order","update",s._order),s.openConfirm("You want to send a payment link to "+s._order.landLordEmail+" ?",function(){s.infoMsg("Sending email."),db.ctrl("Email","orderPaymentLink",s._order).then(function(data){s.infoMsg("Email sended to the landlord. Check the back-office to track your order status."),s._order.landLordPaymentEmailSended=!0,db.ctrl("Order","update",{_id:s._order._id,landLordPaymentEmailSended:!0}),s.booking.complete=!0})})}s.validateBooking(_sendPaymentLink)},s.subscribeMode=!1,s.subscribeConfirm=function(){var addressMessage=function(){return"landlord"==s._user.clientType?"Address required.":"agency"==s._user.clientType?"Agency address required.":"other"==s._user.clientType?"Company address required.":void 0};ifThenMessage([[!s._user.address,"==",!0,addressMessage],[!s._user.email,"==",!0,"Email required."],[!s._user.password,"==",!0,"Password required."],[!s._user.fixedTel&&!s._user.cellPhone,"==",!0,"at least one fixed phone or cell phone is required."]],function(m){"string"!=typeof m[0]?s.warningMsg(m[0]()):s.warningMsg(m[0])},function(){db.ctrl("User","update",s._user).then(function(){return s.right()})})},s.subscribe=function(clientType){s.validateAuthInput(function(){db.ctrl("User","exists",{email:s.auth.email,userType:"client"}).then(function(exists){exists=exists.ok&&1==exists.result,exists?s.warningMsg("This email address belongs to an existing member."):db.ctrl("User","createClient",{email:s.auth.email,clientType:clientType}).then(function(data){data.ok&&(s._user=data.result,s.saveAsync(),s.subscribeMode=!0)})})})},s.goRightAndHideNav=function(){s.openConfirm("You are sure to continue?. You cannot modified Order time and selected inspections after this point",function(){s.hideNav(),s.right()})},s.hideNav=function(){r.dom(function(){$("#fp-nav").toggle(!1)})},s.showNav=function(){r.dom(function(){$("#fp-nav").toggle(!0)})},s.saveAsync=function(){s._user&&(s.model._client=s._user._id,s.model.email=s._user.email,s.model.clientType=s._user.clientType),!s.model.keysTimeFrom&&s.model.diagStart&&(s.model.keysTimeFrom=moment(s.model.diagStart).subtract(2,"hour")),!s.model.keysTimeTo&&s.model.diagStart&&(s.model.keysTimeTo=moment(s.model.diagStart)),db.ctrl("Order","saveWithEmail",s.model).then(function(data){var saved=data.ok,exists="ORDER_EXISTS"===data.err,taken="ORDER_TAKEN"===data.err;s._order=data.result,db.ctrl("Order","getById",Object.assign(s._order,{__populate:{_client:"_id email clientType address",_diag:"_id email clientType address"}})).then(function(d){d.ok&&(s._order=d.result),s.keysWhereTime.emit("onItem")}),saved&&s.successMsg("Order created"),exists&&s.successMsg("Order retaken"),s._orderSAVED=saved||exists,s.booking.order.saved=saved||exists,s.booking.order.exists=exists,s.booking.order.taken=1==taken}).error(function(err){s.notify("There was a server issue during the order saving proccess. Retrying in 10 seconds. Wait.",{type:"warning",duration:1e5}),setTimeout(saveAsync,1e4)})};var isLandlord=function(){return"landlord"===s.model.clientType};s.payNOW=function(success){s.validateBooking(function(){db.ctrl("Order","update",s._order),db.ctrl("User","update",s._user);var order=s._order;openStripeModalPayOrder(order,function(token){order.stripeToken=token.id,db.ctrl("Order","pay",order).then(function(data){data.ok?(success&&success(),s.booking.complete=!0,s.booking.payment.complete=!0,db.ctrl("Order","update",s._order),console.info("PAY-OK",data.result),s.notify("Order payment success. We send you an email.",{type:"success",duration:1e5})):(console.info("PAY-FAIL",data.err),s.notify("There was a server issue during the payment proccess. You pay later from the back-office.",{type:"warning",duration:1e5}))}).error(function(){s.notify("There was a server issue during the payment proccess. You pay later from the back-office.",{type:"warning",duration:1e5})})})})},s.confirm=function(){function _modal(_userResponse){var _user=_userResponse.ok&&_userResponse.result||null;_user&&(s._user=_user,s.model.clientType=_user.clientType);var url="views/directives/directive.modal.confirm.order.as.agency.html";_user||"landlord"!==s.model.clientType?"landlord"===_user.clientType&&(url=url.replace("agency","landlord")):url=url.replace("agency","landlord"),s.openConfirm({templateUrl:url,data:{total:s.totalPrice(!0),clientType:s.clientType[s.model.clientType],hasUser:_userResponse.ok&&null!==_userResponse.result,_user:_userResponse.result}},function(){_saveOrder(isLandlord())})}function _modalInfo(msg,cb){s.openConfirm({templateUrl:"views/directives/directive.modal.ok.html",message:msg})}function _saveOrder(payAfterSave){db.custom("order","saveWithEmail",s.model).then(function(res){if(res.data.ok)payAfterSave?_payOrder(res.data.result):s.notify("Order created. We send you an email.",{type:"success",duration:1e5}),s._orderSAVED=!0,console.info("ORDER:SAVE:SUCCESS",res.data);else if("ORDER_EXISTS"===res.data.err){var _order=res.data.result;if(isLandlord()&&!_.includes(["prepaid","completed"],_order.status))return _payOrder(_order);var backOffice='<a target="_blank" href="'+location.origin+"/admin#/orders/edit/"+_order._id+'">View Order</a>';_modalInfo("A similar order is alredy associated to the email you enter: "+s.model.email+".<br>"+backOffice+" in our back-office.")}else console.info("ORDER:SAVE:ISSUES",res.data),s.notify("There was a server issue. Try again later.",{type:"warning",duration:1e4})}).error(function(res){console.warn("ORDER:SAVE:ERROR",res),s.notify("There was a server issue. Try again later.",{type:"warning",duration:1e4})})}db.ctrl("User","get",{email:s.model.email,userType:"client"}).then(_modal)},s.getDate=function(){return{date:moment(s.model.diagStart).format("DD-MM-YY"),start:moment(s.model.diagStart).format("HH:mm"),end:moment(s.model.diagEnd).format("HH:mm")}},s.subTotal=function(){return subTotal(s.model,s.diags,s.basePrice)},s.sizePrice=function(){return sizePrice(s.model,s.diags,s.squareMetersPrice,s.basePrice)},s.totalPrice=function(showRounded){return totalPrice(showRounded,s.model,s.diags,s.squareMetersPrice,s.basePrice,{s:s})},s.pickTimeRange=function(timeRange){s.model.diagStart=timeRange.start,s.model._diag=timeRange._diag,s.model.diagEnd=timeRange.end},s.totalTime=function(){var total=0;s.model.diags=s.model.diags||{},Object.keys(s.model.diags).forEach(function(mkey){s.model.diags[mkey]&&s.diags.forEach(function(dval,dkey){return dval.name==mkey?(dval.time=dval.price/4,total+=dval.time||0,!1):void 0})}),total=10*parseInt(parseInt(total)/10,10)+10;var hours=Math.floor(total/60),minutes=total%60,t={hours:hours,minutes:minutes};return t},s.totalTime.formatted=function(){var time=s.totalTime(),hours=time.hours,minutes=time.minutes;return minutes=10>minutes?"0"+minutes:minutes,hours>0?hours+":"+minutes+" hours":minutes+" minutes"}}]);