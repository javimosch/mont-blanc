"use strict";function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function numberBetween(n,min,max){return n>=min&&max>=n}function expose(path,v){setVal(window,path,v)}function setVal(obj,propertyPath,_v){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||{},obj?void 0:!1)}),obj?(_v&&(obj[split[lastIndex]]=_v),obj[split[lastIndex]]):void 0}function has(v,arr){for(var x in arr)if(v==arr[x])return!0;return!1}function valid(obj,propertyPath,opt){var split=propertyPath.split("."),lastIndex=split.length-1;if(split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||{},obj?void 0:!1)}),!obj)return!1;var rta=obj[split[lastIndex]];return rta?!0:void 0}function val(obj,propertyPath,opt){var split=propertyPath.split("."),lastIndex=split.length-1;if(split.forEach(function(chunk,index){var isLast=lastIndex==index;isLast||(obj=obj[chunk]||{})}),obj){var rta=obj[split[lastIndex]];return"string"==typeof rta?rta:"function"==typeof rta?opt&&opt.args?rta.apply(this,opt.args):rta():rta}}function setPropByGivenPath(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj&&(obj[split[lastIndex]]=val)}function ifThenMessage(comparisons,messagesCallback,noMessagesCallback){var messages=[];comparisons.forEach(function(comparison){var v1=comparison[0];if("function"==typeof v1)v1()&&messages.push(comparison[1]);else{var operator=comparison[1],v2=comparison[2],m=comparison[3],cb=comparison[4]||void 0;"=="==operator&&v1==v2&&messages.push(m),"!="==operator&&v1!=v2&&messages.push(m),">"==operator&&v1>v2&&messages.push(m),"<"==operator&&v2>v1&&messages.push(m),">="==operator&&v1>=v2&&messages.push(m),"<="==operator&&v2>=v1&&messages.push(m)}messages.filter(function(_m){return _m==m}).length>0&&cb&&cb()}),messages.length>0?messagesCallback(messages):noMessagesCallback?noMessagesCallback():console.warn("ifThenMessage no-message-callback-undefined")}function getParameterByName(name,url){url||(url=window.location.href),name=name.replace(/[\[\]]/g,"\\$&");var regex=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)"),results=regex.exec(url);return results?results[2]?decodeURIComponent(results[2].replace(/\+/g," ")):"":null}function MyPromise(cb){var _scope={cb:null,errorCb:null,errorRes:null,res:null,evt:{}},resolve=function(res){_scope.cb&&_scope.cb(res),_scope.res=res||{}},error=function(errorRes){_scope.errorCb&&_scope.errorCb(errorRes),_scope.errorRes=errorRes||{}},emit=function(n,err,r){_scope.evt[n]=_scope.evt[n]||{},_scope.evt[n].res={err:err,r:r},void 0!==_scope.evt[n].cb&&_scope.evt[n].cb(_scope.evt[n].res.err,_scope.evt[n].res.r)};cb(resolve,error,emit);var rta={then:function(cb){return _scope.res?cb(_scope.res):_scope.cb=cb,rta},error:function(errorCb){return _scope.errorRes?errorCb(_scope.errorRes):_scope.errorCb=errorCb,rta},err:function(errorCb){return _scope.errorRes?errorCb(_scope.errorRes):_scope.errorCb=errorCb,rta},on:function(n,cb){return _scope.evt[n]=_scope.evt[n]||{},_scope.evt[n].cb=cb,void 0!==_scope.evt[n].res&&_scope.evt[n].cb(_scope.evt[n].res.err,_scope.evt[n].res.r),rta}};return rta}function onAnchorChange(handler){var storedHash=window.location.hash;window.setInterval(function(){window.location.hash!=storedHash&&(storedHash=window.location.hash,handler(storedHash))},100)}function cbHell(quantity,cb){return{call:function(){return cb()},next:function(){quantity--,0===quantity&&cb()}}}function hasUndefinedProps(obj,props){var has=!1;return props.forEach(function(v){void 0==obj[v]&&(has=!0)}),has}function indexOf(str,values){var rta=!1;return values.forEach(function(v){-1!==str.indexOf(v)&&(rta=!0)}),rta}function scrollToTop(time){$("html, body").animate({scrollTop:0},time||800)}function fetchCountry(address){return MyPromise(function(resolve,err,emit){var rta={name:"",code:""},geocoder=new google.maps.Geocoder;geocoder.geocode({address:address},function(results){if(results)for(var i=0;i<results[0].address_components.length;i++)for(var j=0;j<results[0].address_components[i].types.length;j++)if("country"==results[0].address_components[i].types[j]){var country=results[0].address_components[i];rta.name=country.long_name,rta.code=country.short_name,resolve(rta)}})})}function toCSV(args){var result,ctr,keys,columnDelimiter,lineDelimiter,data;return data=args.data||null,null!=data&&data.length?(columnDelimiter=args.columnDelimiter||",",lineDelimiter=args.lineDelimiter||"\n",keys=Object.keys(data[0]),result="",result+=keys.join(columnDelimiter),result+=lineDelimiter,data.forEach(function(item){ctr=0,keys.forEach(function(key){ctr>0&&(result+=columnDelimiter),result+='"'+item[key]+'"',ctr++}),result+=lineDelimiter}),result):null}function downloadContent(content,fileName,mimeType){mimeType=mimeType||"text/csv";var a=document.createElement("a");if(mimeType=mimeType||"application/octet-stream",window.navigator.msSaveBlob)return window.navigator.msSaveBlob(new window.Blob([content],{type:mimeType}),fileName);if("download"in a)return a.href="data:"+mimeType+","+encodeURIComponent(content),a.setAttribute("download",fileName),document.body.appendChild(a),setTimeout(function(){a.click(),document.body.removeChild(a)},66),!0;var f=document.createElement("iframe");return document.body.appendChild(f),f.src="data:"+mimeType+","+encodeURIComponent(content),setTimeout(function(){document.body.removeChild(f)},333),!0}function replaceHTML(html,obj){for(var x in obj)html=html.replaceAll("{{"+x.toUpperCase()+"}}",obj[x]);return html}function availableFranceDepartementsNumbers(){for(var rta=[],x=1;95>=x;x++)20!=x&&rta.push(x.toString());return rta.push("2a","2b","69M"),rta}function createSiteSectionsCategories(db){function _createTextsItemsFor(_category){function _save(payload){db.ctrl("Text","save",_.cloneDeep(payload)).then(cbCount.next)}var diags=["DPE","AMIANTE","PLOMB","CARREZ","ERNMT","GAZ","ELECTRICITE","PARASITAIRE"],cbCount=$U.cbHell(5*diags.length,function(){console.info("create-page-category-#",5*diags.length,"texts-created-or-updated-success")}),content="Page section: BOOKING_HOME, Code: ";diags.forEach(function(code){var name=code,payload={code:code,description:"Auto generated block for "+code+" when you click the card in the home page.",content:"",_category:_category,__match:["code"]};payload.code="PAGE_HOME_"+name+"_BLOCK_LEFT_TITLE",payload.content=content+payload.code,_save(payload),payload.code="PAGE_HOME_"+name+"_BLOCK_LEFT_CONTENT",payload.content=content+payload.code,_save(payload),payload.code="PAGE_HOME_"+name+"_BLOCK_RIGHT_TITLE",payload.content=content+payload.code,_save(payload),payload.code="PAGE_HOME_"+name+"_BLOCK_RIGHT_CONTENT",payload.content=content+payload.code,_save(payload),payload.code="PAGE_HOME_"+name+"_BLOCK_BOTTOM",payload.content=content+payload.code,_save(payload)})}function _createPageSections(res){if(res&&res.ok&&res.result){var root=res.result,cbCount=$U.cbHell(categories.length,function(){console.info("create-page-categories#",categories.length,"created-or-updated-success")});categories.forEach(function(cat){var payload={code:cat,description:"Diags Site Section",_parent:root._id,__match:["code"]};db.ctrl("Category","save",payload).then(function(r){r&&r.ok&&"BOOKING_HOME"==r.result.code&&_createTextsItemsFor(r.result._id),cbCount.next()})})}else console.warn("create-page-categories#create-page-sections=invalid-parameters,category-res-expected-and-got",res)}function _createRoot(cb){db.ctrl("Category","create",{code:"DIAGS",description:"Diags Root Category"}).then(cb)}db.ctrl("Category","get",{code:"DIAGS"}).then(function(res){res.ok&&res.result?_createPageSections(res):_createRoot(_createPageSections)});var categories=["ERNMT","BOOKING_HOME","GENERAL_CONDITIONS","FAQ","LEGAL_MENTIONS"]}function createDateTimePickerData(){var o={isOpen:!1,openCalendar:function(e){e.preventDefault(),e.stopPropagation(),o.isOpen=!0}};return o}function createSelect(opt){var o={label:opt.label,click:function(x){o.label=x.label||x,$U.setPropByGivenPath(opt.scope,opt.model,x),opt.change(x)},items:opt.items};return opt.scope.$watch(opt.model,function(v){void 0!==v?o.label=v.label||v.substring(0,1).toUpperCase()+v.slice(1):o.label=opt.label}),o}function rangeCollide(d1s,d1e,d2s,d2e){d1s=moment(d1s),d1e=moment(d1e),d2s=moment(d2s),d2e=moment(d2e);var collide=!1;return(collide=d2s.isAfter(d1s)&&d2s.isBefore(d1e))?collide:(collide=d2e.isAfter(d1s)&&d2e.isBefore(d1e),(collide=d1s.isAfter(d2s)&&d1s.isBefore(d2e))?collide:collide=d1e.isAfter(d2s)&&d1e.isBefore(d2e))}function diagNameConvertion(key){return"electricity"==key?"Electricité":"parasitaire"==key?"Parasitaire":"gaz"==key?"Gaz":"termites"==key?"Termites":"ernt"==key?"État des risques naturels, miniers et technologiques":"loiCarrez"==key?"Carrez":"crep"==key?"Plomb":"dta"==key?"Amiante":"dpe"==key?"DPE":key}function openStripeModalPayOrder(order,cb,opt){opt=opt||{config:{companyName:"Unknown"}};var handler=StripeCheckout.configure({key:r&&r.isDevEnv()?"pk_test_MDkxtBLcBpHwMCgkqX2dJHjO":window.atob("cGtfbGl2ZV9ScldVOUlDcFl1cWxpQ05RWDhOQmhEZjE="),image:"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",token:function(_token){cb(_token)}}),payload={name:opt.config.companyName||"[r.config.companyName]",description:"Order payment",currency:"eur",amount:100*order.price,zipCode:!1,allowRememberMe:!1};opt.email&&(payload.email=opt.email),handler.open(payload)}function getInvoiceHTMLContent(db,item,r,cb){db.ctrl("Category","createUpdate",{code:"DIAGS_SETTINGS",__match:["code"]}).then(function(_res){if(_res&&_res.ok&&_res.result){_res.result._id;db.ctrl("Text","get",{code:"INVOICE"}).then(function(res){if(res.ok&&res.result){var html=window.encodeURIComponent($D.OrderReplaceHTML(window.decodeURIComponent(res.result.content),_.cloneDeep(item),r));cb(html)}else r.warningMessage("Configure the Invoice template first.")})}})}function OrderReplaceHTML(html,_order,r){return _order.LOGO="<img src='"+(window.__raw_origin||window.location.origin)+"/img/logo.jpg'>",_order.ORDER_DESCRIPTION=_order.info.description,_order.CLIENT_FULLNAME=_order._client.firstName+" "+(_order._client.lastName||""),_order.CLIENT_FIRSTNAME=_order._client.firstName,_order.CLIENT_LASTNAME=_order._client.lastName||"",_order.CLIENT_EMAIL=_order._client.email,_order.CLIENT_ADDRESS=_order._client.address,_order.createdAt=r.momentDateTime(_order.createdAt),$U.replaceHTML(html,_order)}function createOrderDescription(_order){_order.info=_order.info||{};var rta="";return rta+=_order.info.sell?"Pack Vente: ":"Pack Location: ",rta+=_order.info.house?"Maison":"Appartement",_order.city&&(rta+=" à "+_order.city),_order.info.constructionPermissionDate&&(rta+=" "+_order.info.constructionPermissionDate),_order.info.squareMeters&&(rta+=", "+_order.info.squareMeters),_order.info.gasInstallation&&!_.includes(["Non","Oui, Moins de 15 ans"],_order.info.gasInstallation)&&(rta+=", Gaz"),_order.info.electricityInstallation&&"Moins de 15 ans"!=_order.info.electricityInstallation&&(rta+=", Électricité"),rta+="."}function normalizeOrderStartTime(t,forwardOnly,backwardOnly){return t.minutes<30&&(forwardOnly?t.minutes=30:t.minutes=0),30==t.minutes&&(t.minutes=30),t.minutes>30&&(backwardOnly?t.minutes=30:(t.minutes=0,t.hours++)),t}function normalizeOrderTime(t,eachTreintaOnly){return t.minutes>0&&t.minutes<15&&(t.minutes=15,eachTreintaOnly&&(t.minutes=0)),t.minutes>15&&t.minutes<30&&(t.minutes=30),t.minutes>30&&t.minutes<45&&(t.minutes=45,eachTreintaOnly&&(t.minutes=30)),t.minutes>45&&t.minutes<59&&(t.hours+=1,t.minutes=0),t}function subTotal(model,diags,basePrice,opt){if(!model)return 0;opt=opt||{},opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo.basePrice=opt.s.priceInfo.basePrice);var total=0;model.diags=model.diags||{},Object.keys(model.diags).forEach(function(mkey){return model.diags[mkey]?void diags.forEach(function(dval,dkey){return dval.show&&dval.name==mkey?(opt.s&&(opt.s.priceInfo[mkey]=dval.price),total+=dval.price||0,!1):void 0}):void(opt.s&&opt.s.priceInfo[mkey]&&delete opt.s.priceInfo[mkey])});var rta=basePrice+total;return 0===total?(opt.s&&(opt.s.priceInfo.basePrice=0),rta=0):opt.s&&(opt.s.priceInfo.basePrice=basePrice),rta}function sizePrice(model,diags,squareMetersPrice,basePrice,opt){if(!model)return 0;var rta=0,squareMeters=model.info?model.info.squareMeters:model.squareMeters;if(squareMeters){var porcent=squareMetersPrice[squareMeters];if((_.isUndefined(porcent)||_.isNull(porcent))&&(console.warn("sizePrice: squareMeters missing in model."),porcent=0),0===parseInt(porcent))rta=0;else{var sub=subTotal(model,diags,basePrice,opt);rta=sub*parseInt(porcent),rta/=100}}return opt&&opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo.sizePrice=rta),rta}function totalPrice(showRounded,model,diags,squareMetersPrice,basePrice,opt){opt=opt||{},opt.basePrice&&(basePrice=opt.basePrice);var _sizePrice=sizePrice(model,diags,squareMetersPrice,basePrice,opt),tot=subTotal(model,diags,basePrice,opt)+_sizePrice;if(opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{}),opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers={sizePrice:_sizePrice}}),!model)return 0;if(opt.s){var date=model.start;if(opt.dt&&(date=opt.dt),opt.s.settings&&opt.s.settings.pricePercentageIncrease&&date){var increase=opt.s.settings.pricePercentageIncrease,percentage=0;isSaturday(date)&&!isToday(date)&&(percentage=percentage>increase.saturday?percentage:increase.saturday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.saturday=percentage}),delete opt.s.priceInfo["increase-today"],delete opt.s.priceInfo["increase-tomorrow"],delete opt.s.priceInfo["increase-sunday"],opt.s.priceInfo["increase-saturday"]=tot*(percentage/100)+" ("+percentage+"%)"),isSunday(date)&&!isToday(date)&&(percentage=percentage>increase.saturday?percentage:increase.saturday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.sunday=percentage}),delete opt.s.priceInfo["increase-today"],delete opt.s.priceInfo["increase-tomorrow"],delete opt.s.priceInfo["increase-saturday"],opt.s.priceInfo["increase-sunday"]=tot*(percentage/100)+" ("+percentage+"%)"),isTomorrow(date)&&(percentage=percentage>increase.tomorrow?percentage:increase.tomorrow,isTomorrowSaturday(date)?(percentage=increase.tomorrowSaturday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.tomorrowSaturday=percentage})):isTomorrowSunday(date)?(percentage=increase.tomorrowSunday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.tomorrowSunday=percentage})):(percentage=increase.tomorrowMondayToFriday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.tomorrowMondayToFriday=percentage})),delete opt.s.priceInfo["increase-today"],delete opt.s.priceInfo["increase-saturday"],opt.s.priceInfo["increase-tomorrow"]=tot*(percentage/100)+" ("+percentage+"%)"),isToday(date)&&(percentage=percentage>increase.today?percentage:increase.today,isTodaySaturday(date)?(percentage=increase.todaySaturday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.todaySaturday=percentage})):isTodaySunday(date)?(percentage=increase.todaySunday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.todaySunday=percentage})):(percentage=increase.todayMondayToFriday,opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.todayMondayToFriday=percentage})),delete opt.s.priceInfo["increase-tomorrow"],delete opt.s.priceInfo["increase-saturday"],opt.s.priceInfo["increase-today"]=tot*(percentage/100)+" ("+percentage+"%)"),tot+=tot*(percentage/100)}if($U.val(model,"_client.discount")){var discount=$U.val(model,"_client.discount");discount>0&&(opt.s.priceInfo["client-discount"]=-tot*(discount/100)+" ("+discount+"%)",tot-=tot*(discount/100),opt.r&&opt.r.dom(function(){opt.r.__debugPriceModifiers.clientDiscount=discount}))}}else console.warn("$D totalPrice opt.s required");var realTot=10*parseInt(parseInt(tot)/10,10);return opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo["Round-to-near-10"]=-1*(tot-realTot)),opt.overwriteModel===!1||(model.price=realTot),showRounded?realTot:tot}function OrderTotalTime(selectedDiags,diags){var total=0;if(!selectedDiags)return 0;Object.keys(selectedDiags).forEach(function(mkey){selectedDiags[mkey]&&diags.forEach(function(dval,dkey){return dval.name==mkey?(dval.time=dval.price/4,total+=dval.time||0,!1):void 0})}),total=10*parseInt(parseInt(total)/10,10)+10;var hours=Math.floor(total/60),minutes=total%60,t={hours:hours,minutes:minutes};return t}function TABLE_COLUMNS(r){return[{label:"Début",name:"start",format:function(x,item){return r.momentDateTimeWords2(item.start)}},{label:"Fin",name:"end",format:function(x,item){return r.momentDateTimeWords2(item.end)}},{label:"Adresse",name:"address"}]}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol?"symbol":typeof obj};!function(self){self.env={};var env=self.env;env.APP_NAME="FRONTSTUFF",env.CONFIG_JSON_PATH="./config.json",env.STORE_SESSION_PREFIX="_SESSION",env.$set=function(config){Object.keys(config).forEach(function(k){env[k]=config[k]})}}(window);var readJSONSync=function(url){return $.ajax({url:url,async:!1,dataType:"json"}).responseJSON},store=function(){return{set:function(id,raw){id="store#"+id;try{return raw=JSON.stringify(raw),localStorage.setItem(id,raw),!0}catch(e){return console.warn("store setData fails"),!1}},get:function(id){id="store#"+id;try{var localData=JSON.parse(localStorage.getItem(id));return localData}catch(e){return console.warn("store getData fails"),null}}}}();String.prototype.replaceAll=function(search,replacement){var target=this;return target.replace(new RegExp(search,"g"),replacement)};var $hasMouse=function(change){$("html").on("mousemove",function(e){change(!0),$("html").off("mousemove")}),change(!1)};$(function(){$.hrefAnchor=function(){var url=window.location.href,idx=url.indexOf("#"),hash=-1!=idx?url.substring(idx+1):"";return hash.replace("/","")},$.scrollToAnchor=function(){var elem=$("#"+$.hrefAnchor());$("html, body").animate({scrollTop:elem.offset().top},500)},$.onGlobalError=function(cb){$("html").on("error",function(){console.log("ERROR.DETECTED")})},$.downloadPNG=function(elem,name){html2canvas(elem,{onrendered:function(canvas){var imgData=canvas.toDataURL("image/jpeg",1),pdf=new jsPDF;pdf.addImage(imgData,"JPEG",25,20),pdf.save("download.pdf")}})}});var whenProperties=function(o,props,cbArray){var i=setInterval(function(){var rta=!0;props.forEach(function(v){_.isUndefined(o[v])&&(rta=!1)}),rta&&(clearInterval(i),cbArray.forEach(function(cb){cb()}))},200)};!function(exports){var BASE64URICHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split("");exports.newId=function(len,radix){var chars=BASE64URICHARS,newId=[],i=0;for(radix=radix||chars.length,len=len||22,i=0;len>i;i++)newId[i]=chars[0|Math.random()*radix];return newId.join("")}}("undefined"==typeof exports?window:exports);var downloadFile=function(filename,encodedData,mimeType){var link=document.createElement("a");mimeType=mimeType||"text/plain",link.setAttribute("download",filename),link.setAttribute("href","data:"+mimeType+";charset=utf-8,"+encodedData),link.click()},downloadJSON=function(filename,data){downloadFile(filename,JSON.stringify(data,null,"	"),"text/json")},ToStringParameters=function(obj){var rta="";for(var x in obj)""!=rta&&(rta+="&"),rta+=x+"="+decodeURIComponent(JSON.stringify(obj[x]));return rta},getHashParams=function(){for(var e,hashParams={},a=/\+/g,r=/([^&;=]+)=?([^&;]*)/g,d=function(s){return decodeURIComponent(s.replace(a," "))},q=window.location.hash.substring(1);e=r.exec(q);)hashParams[d(e[1])]=d(e[2]);return hashParams},Eventify=function(self){function firePreserve(n,handler){once[n]&&handler(once[n])}var once={},evts={};return self.off=function(evt){"string"==typeof evt?(delete evts[evt],delete once[evt]):delete evts[evt.type][evt.id]},self.emitPreserve=function(n,p){self.emit(n,p,{preserve:!0})},self.emit=function(n,p,opt){evts[n]=evts[n]||{},Object.keys(evts[n]).forEach(function(k){evts[n][k].handler(p)}),opt&&opt.preserve&&(once[n]=p||{});var pp=p;try{pp=JSON.stringify(pp)}catch(e){pp=p}},self.once=function(n,handler){if(once[n])return firePreserve(n,handler);var evt=self.on(n,function(p){handler(p),self.off(evt),once[n]=p})},self.on=function(n,handler){firePreserve(n,handler),evts[n]=evts[n]||{};var id="evt_"+n+"_"+(new Date).getTime()+"_"+Object.keys(evts).length;return evts[n][id]={id:id,type:n,handler:handler},evts[n][id]},self},queryString=function(){var queryString={};return queryString.parse=function(str){return"string"!=typeof str?{}:(str=str.trim().replace(/^\?/,""),str?str.trim().split("&").reduce(function(ret,param){var parts=param.replace(/\+/g," ").split("="),key=parts[0],val=parts[1];return key=decodeURIComponent(key),val=void 0===val?null:decodeURIComponent(val),ret.hasOwnProperty(key)?Array.isArray(ret[key])?ret[key].push(val):ret[key]=[ret[key],val]:ret[key]=val,ret},{}):{})},queryString.stringify=function(obj){return obj?Object.keys(obj).map(function(key){var val=obj[key];return Array.isArray(val)?val.map(function(val2){return encodeURIComponent(key)+"="+encodeURIComponent(val2)}).join("&"):encodeURIComponent(key)+"="+encodeURIComponent(val)}).join("&"):""},queryString.get=getParameterByName,queryString.hashName=function(){return(-1!==window.location.hash.indexOf("?")?window.location.hash.substring(0,window.location.hash.indexOf("?")):window.location.hash).replace("#/","")},queryString.hash=function(str){var hash=-1!==window.location.hash.indexOf("?")?window.location.hash.substring(0,window.location.hash.indexOf("?")):window.location.hash;if(void 0==str)return hash;var params=queryString.parse(window.location.hash.replace(hash,"")),new_params_string=queryString.stringify(params);window.history.pushState({},"",window.location.pathname+"#/"+str+"?"+new_params_string)},queryString.clear=function(){var hash=-1!==window.location.hash.indexOf("?")?window.location.hash.substring(0,window.location.hash.indexOf("?")):window.location.hash;window.history.pushState({},"",window.location.pathname+hash)},queryString.set=function(key,new_value){var hash=-1!==window.location.hash.indexOf("?")?window.location.hash.substring(0,window.location.hash.indexOf("?")):window.location.hash,params=queryString.parse(window.location.hash.replace(hash,""));params[key]=new_value;var new_params_string=queryString.stringify(params);window.history.pushState({},"",window.location.pathname+hash+"?"+new_params_string)},"undefined"!=typeof module&&module.exports?queryString:queryString}();"undefined"!=typeof exports?(exports.MyPromise=MyPromise,exports.getHashParams=getHashParams,exports.getParameterByName=getParameterByName,exports.ifThenMessage=ifThenMessage,exports.val=val,exports.numberBetween=numberBetween):(window.val=val,window.numberBetween=numberBetween,window.MyPromise=MyPromise,window.getHashParams=getHashParams,window.getParameterByName=getParameterByName,window.ifThenMessage=ifThenMessage,window.$U={readJSONSync:readJSONSync,store:store,replaceHTML:replaceHTML,toCSV:toCSV,downloadContent:downloadContent,whenProperties:whenProperties,expose:expose,fetchCountry:fetchCountry,scrollToTop:scrollToTop,indexOf:indexOf,url:queryString,hasUndefinedProps:hasUndefinedProps,cbHell:cbHell,onAnchorChange:onAnchorChange,valid:valid,val:val,setVal:setVal,numberBetween:numberBetween,MyPromise:MyPromise,getHashParams:getHashParams,getParameterByName:getParameterByName,ifThenMessage:ifThenMessage,has:has},window.$U=Eventify(window.$U));var $D={openStripeModalPayOrder:openStripeModalPayOrder,rangeCollide:rangeCollide,diagNameConvertion:diagNameConvertion,getInvoiceHTMLContent:getInvoiceHTMLContent,createOrderDescription:createOrderDescription,normalizeOrderStartTime:normalizeOrderStartTime,OrderTotalTime:OrderTotalTime,OrderReplaceHTML:OrderReplaceHTML,subTotal:subTotal,sizePrice:sizePrice,totalPrice:totalPrice,createSelect:createSelect,availableFranceDepartementsNumbers:availableFranceDepartementsNumbers,createDateTimePickerData:createDateTimePickerData,ORDER_STATUS:{CREATED:"created",ORDERED:"ordered",PREPAID:"prepaid",DELIVERED:"delivered",COMPLETED:"completed"},ORDER_STATUS_PAID:["prepaid","completed"],createSiteSectionsCategories:createSiteSectionsCategories},isTomorrowSaturday=function(d){return 6===moment(d).add(1,"day").day()},isTomorrowSunday=function(d){return 0===moment(d).add(1,"day").day()},isTodaySaturday=function(d){return 6===moment(d).day()},isTodaySunday=function(d){return 0===moment(d).day()},isToday=function(d){return moment().isSame(moment(d),"day")},isTomorrow=function(d){return moment().add(1,"day").isSame(moment(d),"day")},isSaturday=function(d){return 6===moment(d).day()},isSunday=function(d){return 0===moment(d).day()};!function(){var app=angular.module("app",["app.run","ngRoute","ngSanitize","app.run-calendar","mwl.calendar","ui.bootstrap","ui.bootstrap.datetimepicker","srv.crud","srv.diagPrice","srv.diagSlots","diags_ctrl_settings","diags_ctrl_contact_form","diags_ctrl_tools","app.admin","app.routes","app.login","app.user","app.diag","app.log","app.diag.complete","app.diag.balance","app.order","app.client","app.diag","app.calendar","app.notifications","app.client.payments","app.directives","app.services","app.tools"]);app.run(function(uibPaginationConfig){uibPaginationConfig.firstText="Premier",uibPaginationConfig.nextText="Suivant",uibPaginationConfig.previousText="Précédent",uibPaginationConfig.lastText="Dernier"}),moment.locale("fr"),expose("app",app)}(),app.directive("niceCheckBox",function($rootScope,$timeout,$compile){return{restrict:"E",scope:{model:"=model",data:"=data",name:"@name",template:"@template",click:"=click"},templateUrl:"views/directives/checkbox.html",link:function(scope,el,attrs){var url="views/directives/checkbox.html";scope.template&&(url=url.replace(".html","-")+scope.template+".html"),$.ajax({url:url,async:!1,success:function(r){var e=$compile(r)(scope),cls=attrs["class"];el.replaceWith(e),$timeout(function(){el.children(0).addClass("class",cls),el.find("input").name=scope.name,$rootScope.$apply()})},error:function(err){console.error("niceCheckBox invalid template ",url,err)}})}}}),app.directive("checkBoxGroup",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){el.on("click",function(){var $box=$(this),group="input:checkbox[name='"+$box.attr("name")+"']";$(group).prop("checked",!1),$(group).prop("disabled",!1),$box.prop("checked",!0),$box.prop("disabled",!0)})}}}),app.directive("checkBoxModel",function($rootScope,$timeout,$compile){return{restrict:"A",scope:!1,link:function(scope,el,attrs){function set(_val){var ss=scope,split=attrs.checkBoxModel.split("."),last=split[split.length-1];split.forEach(function(word){return word!=last?(ss=$rootScope.lookUp(ss,word),void 0==ss?(console.warn("checkBoxModel ",attrs.checkBoxModel,word+" is undefined"),0):void 0):void 0}),void 0!=ss&&(ss[last]=_val,$timeout($rootScope.$apply()))}el.on("change",function(){if(el.prop("checked")){var v,p=attrs.value.toString();v="false"==p||"true"==p?"true"==p:p,set(v)}}),$rootScope.dom(function(){var elValue=attrs.value.toString(),scopeValue=$U.val(scope,attrs.checkBoxModel);el.removeAttr("checked"),elValue==scopeValue&&el.attr("checked","")},500)}}}),app.directive("awesomeComplete",function($rootScope,$timeout,$compile){return{restrict:"A",scope:{list:"@target",model:"=model",field:"@field"},link:function(scope,el,attrs){var r=$rootScope;r.dom(function(){var list=el.parent().get(0).querySelector(scope.list);new Awesomplete(el.get(0),{list:list,filter:function(text,input){return Awesomplete.FILTER_CONTAINS(text,input.match(/[^,]*$/)[0])},replace:function(text){var before=this.input.value.match(/^.+,\s*|/)[0];this.input.value=before+text+", ",r.dom()}});el.on("awesomplete-selectcomplete",function(){r.dom(function(){$U.setVal(scope.model,scope.field,el.val())})}),$(".awesomplete").attr("id","awesome-ctrl-"+Date.now());var _id=$(".awesomplete").attr("id"),_iv=setInterval(function(){var _el=$("#"+_id);_el.length>0?void 0==$U.val(scope.model,scope.field)&&r.dom(function(){_el.find("input").val("")}):clearInterval(_iv)},2e3)})}}}),app.directive("toggleClick",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){function val(value){var ss=scope,split=attrs.toggleValue.split("."),last=split[split.length-1];return split.forEach(function(word){return word!=last?(ss=ss[word],void 0==ss?(console.warn("toggleValue ",attrs.toggleValue,word+" is undefined"),0):void 0):void 0}),void 0!=ss?void 0===value?ss[last]:(ss[last]=value,void $timeout($rootScope.$apply())):void 0}el.on("click",function(){var v="string"==typeof attrs.ngValue&&"true"==attrs.ngValue.toLowerCase()||1==attrs.ngValue;val(v)}),$rootScope.$emit(attrs.toggleValue+"-changed",val())}}}),app.directive("toggleClass",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){function update(v){v==val?el.addClass(attrs.toggleClass):el.removeClass(attrs.toggleClass)}var val="string"==typeof attrs.ngValue&&"true"==attrs.ngValue.toLowerCase()||1==attrs.ngValue;return attrs.toggleValue?($rootScope.$on(attrs.toggleValue+"-changed",function(evt,v){}),void scope.$watch(attrs.toggleValue,function(v){"boolean"==typeof v&&update(v)})):console.warn("toggle-class: toggle-value attribute required.")}}}),app.directive("keyBind",function(){return{restrict:"A",link:function($scope,$element,$attrs){$element.bind($attrs.eventType||"keypress",function(event){var keyCode=event.which||event.keyCode;keyCode==$attrs.code&&$scope.$apply(function(){$scope.$eval($attrs.keyBind,{$event:event})})})}}}),app.directive("pikaday",function($rootScope,$timeout,$compile,$parse){return{restrict:"A",scope:!1,link:function(scope,el,attrs){function set(){var v=$U.val(scope,attrs.pikaday);v&&(v.toDate&&v.format?timepicker.setMoment(v,!0):isFinite(new Date(v))&&timepicker.setDate(v,!0),$rootScope.dom&&$rootScope.dom())}var model=$parse(attrs.pikaday),modelSetter=model.assign;el.addClass("pika-wrapper"),el.addClass(attrs.pikaday);var config={field:el.get(0),format:"DD-MM-YY HH[h]mm",onSelect:function(){modelSetter(scope,this.getMoment()),console.log(this.getMoment().format("DD-MM-YY HH[h]mm")),$rootScope.dom&&$rootScope.dom()},firstDay:1,minDate:new Date(2e3,0,1),maxDate:new Date(2020,12,31),yearRange:[2e3,2020],showTime:!0,autoClose:!1,use24hour:!0};attrs.theme&&(config.theme=attrs.theme,el.addClass(attrs.theme)),attrs.min&&(config.minDate=new Date(attrs.min)),attrs.max&&(config.maxDate=new Date(attrs.max)),config.onDraw=function(){var minuteEl=$(timepicker.el).find(".pika-select-minute");minuteEl.off("change").on("change",function(){timepicker.hide()})};var timepicker=new Pikaday(config);scope.$watch(attrs.pikaday,function(){set()});var id=attrs.pikaday.replace(".","_");$U.expose("dtp_"+id,timepicker),$U.expose("dtp_"+id+".model",model)}}});var app=angular.module("app.run",[]);app.config(["$httpProvider",function($httpProvider){$httpProvider.defaults.useXDomain=!0,delete $httpProvider.defaults.headers.common["X-Requested-With"]}]),app.run(["server","$timeout","$rootScope",function(db,$timeout,r){r.__debugDiags=!1;var keyword="";$(window).on("keyup",function(ev){ev=ev||window.event;var key=String.fromCharCode(ev.which);13==ev.which?("debug"==keyword.toLowerCase()?(r.__debugDiags=!0,console.info("debug-mode-on")):r.__debugDiags=!1,keyword="",r.dom()):keyword+=key})}]),app.run(["server","$timeout","$rootScope",function(db,$timeout,r){function getMessage(msg){return"function"==typeof msg?msg():"string"!=typeof msg&&msg.length?getMessage(msg[0]):msg}r.isDevEnv=function(){return-1!==window.location.hostname.indexOf("diags-javoche.c9users.io");
},r.URL={LOGIN:"login",DIAG_SIGN_UP:"diag-inscription",HOME:"home",CONTACT_US:"contactez-nous",ERNT:"ernt",FAQ:"faq",GENERAL_CONDITIONS:"conditions-generales-utilisation",LEGAL_MENTIONS:"mentions-legales"},r.navShow=!0,r.toggleNavbar=function(val){r.navShow=val,r.dom()},r.secureSection=function(_s){_s.show=!1,r.logged()?(_s.show=!0,db.ctrl("User","getById",r.session()).then(function(d){d.ok&&d.result&&r.session(d.result)})):(console.warn("secureSection:redirecting to login"),r.route("login"))},r.handleSecurityRouteViolation=function(){r.route("dashboard"),console.warn("SECURITY: YOU-DONT-BELONG-HERE")},$("html").keydown(function(event){if("27"==event.keyCode&&r.params&&r.params.prevRoute&&r.__currentCtrlScope&&r.__currentCtrlScope.back){if(r.state.working())return void r.message("Loading...",{type:"warning",duration:2e3});var fn=r.__currentCtrlScope.back;r.__currentCtrlScope=null,fn()}}),r.setCurrentCtrl=function(_s){r.__currentCtrlScope=_s,$U.expose("s",_s)},r.errorMessage=function(msg,duration){msg=getMessage(msg),r.notify(msg,{type:"danger",duration:duration||3e3})},r.warningMessage=function(msg,duration){msg=getMessage(msg),r.notify(msg,{type:"warning",duration:duration||3e3})},r.infoMessage=function(msg,duration){msg=getMessage(msg),r.notify(msg,{type:"info",duration:duration||3e3})},r.successMessage=function(msg,duration){msg=getMessage(msg),r.notify(msg,{type:"success",duration:duration||3e3})}}]),app.run(["server","$timeout","$rootScope",function(db,$timeout,r){window.r=r,r.getHashParams=getHashParams,r.debug=!0,r.config={};var env=window.env;r.config=$U.readJSONSync(window.env.CONFIG_JSON_PATH),env.$set(r.config),db.localData().then(function(data){return Object.assign(r.config,data.config||{})}),r.__cache={},r.cache=function(n,o){return o?r.__cache[n]=o:(!_.isUndefined(r.__cache[n])&&!_.isNull(r.__cache[n]),r.__cache[n]||null)},r.momentFormat=function(d,f){return moment(d).format(f)},r.momentTime=function(d){return moment(d).format("HH[h]mm")},r.momentDateTime=function(d){return moment(d).format("DD-MM-YY HH[h]mm")},r.momentDateTimeWords=function(d){return moment(d).format("[Le] dddd DD MMMM YY [à] HH[h]mm")},r.momentDateTimeWords2=function(d){return moment(d).format("dddd DD MMMM YY [à] HH[h]mm")},r.dom=function(cb,timeout){$timeout(function(){cb&&cb(),r.$apply()},timeout||0)},r.toggleBody=function(val){r.dom(function(){var el=document.body;el.className=el.className.replace("hidden","").trim(),val||(el.className=(el.className+" hidden").trim())})},r.session=function(data){var id=r.config.APP_NAME+"_"+window.location.hostname+env.STORE_SESSION_PREFIX;return data&&($U.store.set(id,data),r._session=data),r._session=$U.store.get(id),r._session||($U.store.set(id,{}),r._session={}),r._session},r.logged=function(){var ss=r.session();return null!==ss._id&&null!==ss.email&&null!==ss.password},r.viewAsClient=function(){r._session=r._session||{},r._session.userType="client",r.dom()},r.viewAsDiag=function(){r._session=r._session||{},r._session.userType="diag",r.dom()},r.viewAsAdmin=function(){r._session=r._session||{},r._session.userType="admin",r.dom()},r._login={email:"",password:""};var session=r.session();_.each(session,function(val,key){r._login[key]=val}),session.password&&(r._login.password=session.password),session.rememberPass||(r._login.password=null),r.logout=function(){r.session({email:null,password:null}),$U.url.clear(),r.route("login")},r.admin=function(){r._login.email="arancibiajav@gmail.com",r._login.password="admin",r.dom()},r.routeRelative=function(url,delay){return setTimeout(function(){var path=window.location.origin;path+=(window.location.pathname+"/"+url).replaceAll("//","/"),$U.emit("route-exit:"+$U.url.hashName()),window.location.href=path},delay||0),r.__route=url,url},r.route=function(url,delay){return setTimeout(function(){var path=window.location.origin+window.location.pathname;if(path+="#/"+url,$U.emit("route-exit:"+$U.url.hashName()),r.$emit("route-change",url),$U.url.hash(url),window.location.href=window.location.href,window.ga){var pageval=("/"+url+".html").replaceAll("//","/");ga("set","page",pageval),ga("send","pageview")}},delay||0),r.__route=url,url},r.routeIs=function(n){return r.__route&&-1!==r.__route.toString().toLowerCase().indexOf(n&&n.toLowerCase()||"invalid")||!1},r.__route=window.location.href.replace(window.location.origin+window.location.pathname,""),r.__routeHashName=$U.url.hashName(),r.__routeHashNameBefore=$U.url.hashName(),setTimeout(function(){$U.emitPreserve("route-change",r.__route.slice(2))},500),$U.onAnchorChange(function(){r.__route=window.location.href.replace(window.location.origin+window.location.pathname,""),$U.emit("route-exit:"+r.__routeHashName),r.__routeHashName=$U.url.hashName(),$U.emitPreserve("route-change",r.__route.slice(2))}),r.userIs=function(arr){if(!r.logged())return!1;var type=r.session().userType;return"string"==typeof arr&&(arr=[arr]),_.includes(arr,type)},r.routeParams=function(obj){r.params=Object.assign(r.params||{},obj)},r.lookUp=function(scope,property){return scope[property]?scope[property]:scope.$parent?r.lookUp(scope.$parent,property):void 0},r.hasMouse=!1,$hasMouse(function(v){r.hasMouse=v,r.dom()})}]),app.run(["server","$timeout","$rootScope","dbText",function(db,$timeout,r,dbText){dbText.update()}]);var srv=angular.module("app.services",[]);srv.service("dbText",["$rootScope","server",function(r,db){r.__texts=[],r.__text=r.__text||{},r.__textSTATIC=r.__textSTATIC||{},this.update=function(){db.ctrl("Text","getAll",{}).then(function(d){r.__texts=d.result,r.__texts.forEach(function(item){r.__text[item.code]=window.decodeURIComponent(item.content)})})},r.htmlEditCancel=function(){r.htmlEditItem=void 0,r.dom()},r.htmlEditSave=function(){r.htmlEditItem.content=window.encodeURIComponent(window.CKEDITOR.instances.editor.getData()),console.log("save",window.decodeURIComponent(r.htmlEditItem.content).substring(0,10)+" ..."),r.__text[r.htmlEditItem.code]=window.decodeURIComponent(r.htmlEditItem.content),db.ctrl("Text","save",r.htmlEditItem).then(function(){}),r.htmlEditItem=void 0,r.dom()},r.htmlEdit=function(code){function setData(decodedData){return!window.CKEDITOR||window.CKEDITOR&&!window.CKEDITOR.instances||window.CKEDITOR&&window.CKEDITOR.instances&&!window.CKEDITOR.instances.editor?setTimeout(function(){return setData(decodedData)},500):void window.CKEDITOR.instances.editor.setData(decodedData)}r.routeParams({code:code}),window.CKEDITOR||$.getScript("https://cdn.ckeditor.com/4.5.9/full/ckeditor.js"),db.ctrl("Text","get",{code:r.params.code}).then(function(res){res.ok&&res.result&&(r.htmlEditItem=res.result,setData(window.decodeURIComponent(r.htmlEditItem.content)),$U.scrollToTop())})},r.html=function(code){function buildBlock(){var html="";if(r.userIs("admin")&&(html+="<i  onclick=\"r.htmlEdit('"+code+"')\" style='opacity:0.4; margin-left:-1em' class='link absolute fa fa-pencil-square-o ' aria-hidden='true'></i>&nbsp;"),r.__text&&r.__text[code]&&r.__text[code].length>1){var content=r.__text[code],tag=document.createElement("tag");tag.innerHTML=r.__text[code],tag.childNodes&&1==tag.childNodes.length&&"P"==tag.childNodes[0].tagName&&(content=tag.childNodes[0].innerHTML),html+=content}else txt?html+=txt:(r.isDevEnv()||r.userIs("admin"))&&(html+=code);return html}var txt=r.__textSTATIC[code]||"";if(r.__text&&r.__text[code]);else if(r.__textsNotFound=r.__textsNotFound||{},!r.__textsNotFound[code]&&(r.__textsNotFound[code]=code,r.isDevEnv())){var payload={code:code,categoryCode:$U.url.hashName()||"home",categoryRootCode:"DIAGS",content:txt};db.stackCtrl("reportNotFound","Text","reportNotFound",payload)}return buildBlock()}}]),srv.service("tpl",function($rootScope,$compile,$templateCache){var _this=this;this.compile=function(n,s){var raw=$templateCache.get(n+".html");return _this.compileRaw(raw,s)},this.compileRaw=function(raw,s){var el=$compile(angular.element(raw))(s);return el},expose("tpl",this)}),srv.service("$mongoosePaginate",["server",function(db){function handler(modelName){var self=this;self.id=Date.now(),self.working=!1,self.ctrl=function(data,model,opt){function autoResolve(res){opt.callback?opt.callback(res.result):model.update(res.result,null)}var promise=MyPromise(function(resolve,err,emit){if(!model.pagination)return err("model.pagination required."),void console.warn("$mongoosePaginate model.pagination required.");if(!self.working){self.working=!0,self.workingTS=Date.now(),function(ts){setTimeout(function(){self.workingTS==ts&&1==self.working&&(self.working=!1)},1e4)}(self.workingTS);var action=opt&&opt.action||"paginate";db.ctrl(modelName,action,Object.assign({__limit:model.pagination.itemsPerPage,__lean:!0,__page:model.pagination.currentPage},data)).then(function(r){if(self.working=!1,!r.ok)return void(self.working=!1);var numberOfPages=r.result.pages;model.pagination&&model.pagination.update({itemsLength:r.result.docs.length,numPages:numberOfPages,total:r.result.total}),r.result=r.result.docs,opt&&opt.autoResolve?(autoResolve(r),resolve(r)):resolve(r)})}});return promise}}return{get:function(modelName){return new handler(modelName)}}}]),srv.service("localdb",["$http",function(http){return function(settings){return MyPromise(function(resolve){resolve({localdb:!0})})}}]),srv.directive("fileModel",["$parse","$rootScope",function($parse,$rootScope){return{restrict:"A",scope:{model:"=fileModel",overwrite:"=fileModelOverwrite",field:"@field"},link:function(scope,element,attrs){var model=$parse(attrs.fileModel),modelSetter=model.assign;$U.expose("fileModel",scope),element.bind("change",function(){scope.$apply(function(){try{scope.model=scope.model||{},"undefined"!=typeof scope.overwrite&&(scope.overwrite=void 0==scope.overwrite?!1:scope.overwrite,scope.overwrite="boolean"!=typeof scope.overwrite?!1:scope.overwrite),scope.overwrite?scope.model=element[0].files[0]:scope.model[scope.field||"file"]=element[0].files[0],attrs.fileModelChange&&scope.$parent.$eval(attrs.fileModelChange)}catch(e){modelSetter(element[0].files[0])}})})}}}]),srv.service("fileUpload",["$http",function($http){this.single=function(opt,success,err){var fd=new FormData;Object.keys(opt.data).forEach(function(key){fd.append(key,opt.data[key])}),fd.append("file",opt.file),$http.post(opt.url,fd,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(success).error(err)}}]),srv.service("server",["$http","localdb","$rootScope","fileUpload",function(_http,localdb,r,fileUpload){function getLocalData(){return MyPromise(function(resolve,error){localData?resolve(localData):$.getJSON("./data.json",function(data){localData=data,resolve(localData)}).fail(function(jqxhr,textStatus,error){var err=textStatus+", "+error;console.log("Request Failed: "+err)})})}function handleError(_log,err){_log(err)}function get(relativeUrl,data,callback){var _log=logger(relativeUrl,data);_http({method:"GET",data:data,url:_URL+"/"+relativeUrl}).then(function(res){_log(res),callback&&callback(res)},function(err){return handleError(_log,err)})}function _post(relativeUrl,data,callback,error){data=data||{};var _log=logger(relativeUrl,data);globalState.async&&(data=Object.assign(data,{___serviceOptions:{logAsAsync:!0}}),delete globalState.async),data.___serviceOptions&&1==data.___serviceOptions.logAsAsync&&_log.registerAsync(),$U.once("server-up",function(){_http({method:"POST",data:data,url:_URL+"/"+relativeUrl}).then(function(res){return _log(res),res.data&&0==res.data.ok&&console.warn("SERVER:REQUEST:WARNING = ",res.data.err||"Unkown error detected",relativeUrl),callback(res)},function(err){handleError(_log,err),error(err)})})}function ctrl(ctrl,action,data){return MyPromise(function(resolve,error){_post("ctrl/"+ctrl+"/"+action,data,function(res){return resolve(res.data)},error)})}function stackCtrl(id,arg1,arg2,arg3){window.___stackScope=window.___stackScope||{stacks:{}};var s=window.___stackScope;s.stacks[id]=s.stacks[id]||{flag:!1,promises:[],watcher:$U.on(id+"-stack-pop",function(){var stack=s.stacks[id];if(stack.promises.length>0){stack.flag=!0;var d=stack.promises.shift();ctrl(d.arg1,d.arg2,d.arg3).then(function(res){stack.flag=!1,console.log("stackCtrlPromise-watcher-resolve "+id+". left:"+stack.promises.length),$U.emit(id+"-stack-pop")})}})},s.stacks[id].promises.push({arg1:arg1,arg2:arg2,arg3:arg3}),0==s.stacks[id].flag&&setTimeout(function(){0==s.stacks[id].flag&&$U.emit(id+"-stack-pop")},50)}var _URL="http://localhost:5000";$.ajax("/serverURL").then(function(r){_URL=r.URL,$U.emitPreserve("server-up"),console.info("server:url(env serverURL):"+_URL)}),$.ajax("/serverRawURL").then(function(r){window.__raw_origin=r.URL});var globalState={},localData=null,spinner=function(){return function(v){r.showSpinner=v,r.dom()}}(),logger=function(){var _controlledErrorsStrings=[],_controlledErrors={},_errors={},_logs={},fn=new function(){var self=this;return self.id=newId(20),function(url,req){var item={url:url,req:req};_logs[self.id]=item,setTimeout(function(){void 0!==_logs[self.id]&&(item.err="Logger: request timeout.",delete _logs[self.id])},3e4),r.$emit("logger.working");var rta=function(res){if(!_.isUndefined(_logs[self.id])){if(res.data||res.result){var data=res.data||res;data.ok!==!0&&(item.err=data.err||data,item.message=data.message||null,_.includes(_controlledErrorsStrings,item.err)?_controlledErrors[self.id]=item:item.err&&item.err.type&&_.includes(_controlledErrorsStrings,item.err.type)?(item.message=item.err.message,_controlledErrors[self.id]=item):_errors[self.id]=item)}else item.err="Server down, try later.",_.includes(_controlledErrorsStrings,item.err)?_controlledErrors[self.id]=item:_errors[self.id]=item;_.isUndefined(_logs[self.id])||delete _logs[self.id],0===Object.keys(_logs).length&&r.$emit("logger.clear")}};return rta.registerAsync=function(){delete _logs[self.id],r.$emit("logger.clear")},rta}};return fn.addControlledErrors=function(arr){_controlledErrorsStrings=_.union(arr,_controlledErrorsStrings)},fn.clearErrors=function(){return _errors={}},fn.hasErrors=function(){return Object.keys(_errors).length>0},fn.hasPending=function(){return Object.keys(_logs).length>0},fn.pending=function(){var msg="Pending<br>";return _.each(_logs,function(v,k){console.info(v.url),""!==msg&&(msg+="<br>"),msg+=v.url+": "+JSON.stringify(v.req)}),msg},fn.errors=function(){var msg="Errors<br>";return _.each(_errors,function(v,k){console.info(v),""!==msg&&(msg+="<br>");try{msg+=v.url+": "+JSON.stringify(v.err)}catch(e){msg+=v.url+": Unparseable error. See the console."}}),msg},r.state={working:function(){return fn.hasPending()},data:_logs},r.logger=fn,fn}();r.$on("logger.working",function(){spinner(!0)}),r.$on("logger.clear",function(){spinner(!1)}),r.get=get;var ws={URL:function(){return _URL},getAvailableRanges:function(order,opt){return diagsGetAvailableRanges(order,ctrl,opt)},localData:getLocalData,http:function(ctrl,action,data){return _http.post(_URL+"/ctrl/"+ctrl+"/"+action,data)},form:function(relativeURL,data){if(!data.file)throw Error("form: file arg required");return MyPromise(function(r,err){var file=data.file;delete data.file;var _log=logger(relativeURL,data);fileUpload.single({url:_URL+"/"+relativeURL,file:file,data:data},function(res){_log(res),r(res)},function(res){_log(res),err(res)})})},setAsync:function(){return globalState.async=!0,ws},stackCtrl:stackCtrl,ctrl:ctrl,$get:function(url,config){return MyPromise(function(resolve,error){var _log=logger(url,{});_http.get(url,config).then(function(res){_log({ok:!0,result:res}),resolve(res)},function(err){_log({ok:!1,err:err}),error(err)})})},$post:function(url,data,config){return MyPromise(function(resolve,error){var _log=logger(url,data);_http.post(url,data,config).then(function(res){_log({ok:!0,result:res}),resolve(res)},function(err){_log({ok:!1,err:err}),error(err)})})},post:function(url,data){return MyPromise(function(resolve,error){_post(url,data,function(res){resolve(res)},error)})}};return r.ws=ws,ws}]),function(){var app=angular.module("srv.crud",[]);app.service("crud",function($rootScope,server){function notify(m,t){r.notify(m,{type:t,duration:5e3,clickDismissable:!0})}function handleError(_err){notify("error, try later.","warning")}function fireEvent(evts,p,path){evts&&(evts.forEach(function(evt){evt(p)}),console.log("crud-fire "+path+" triggers ",evts.length,"events"))}function createActions(s,opt,params){function fire(path,p){var evts=$U.val(opt,path);fireEvent(evts,p,path)}s.deleteSilent=function(){db.ctrl(opt.name,"remove",{_id:s.item._id}).then(function(data){data.ok?s.back():handleError(data)}).error(handleError)},s["delete"]=function(){opt.modals&&opt.modals.confirm?s[opt.modals.confirm]($U.val(opt,"modals.delete.description")||"Delete item?",function(){s.deleteSilent()}):window.confirm($U.val(opt,"modals.delete.description")||"Delete item?")&&s.deleteSilent()},s.validate=function(){$U.ifThenMessage($U.val(opt,"validate.options",{args:[opt.scope]})||[],function(m){"string"!=typeof m[0]?notify(m[0](),"warning"):notify(m[0],"warning")},s.save)},s.save=function(){db.ctrl(opt.name,"save",s.item).then(function(data){data.ok?(fire("events.after.save"),$U.has($U.val(opt,"save.after.goBack"),[void 0,!0])&&s.back()):handleError(data)}).error(handleError)},s.back=function(){return r.params&&r.params.prevRoute?r.route(r.params.prevRoute):void r.route($U.val(opt,"routes.back")||"dashboard")},s.cancel=function(){s.back()},s.load=function(id){r.params&&r.params.item&&r.params.item._diag&&(s.item=r.params.item,delete r.params.item),db.ctrl(opt.name,"get",Object.assign({_id:id||params.id||s.item._id},$U.val(opt,"defaults.http.request")||{})).then(function(data){s.requesting=!1,data.ok&&null!==data.result?s.item=data.result:handleError(data)}).error(handleError)},s.init=function(){params&&params.id&&"-1"!==params.id.toString()?s.load():s.reset()},s.reset=function(){s.item=$U.val(opt,"defaults.data")||{}}}var r=$rootScope,db=server;return{create:function(opt){return opt.name?opt.scope?opt.routeParams?(createActions(opt.scope,opt,opt.routeParams),opt.scope):notify("crud.create require opt.routeParams","warning"):notify("crud.create require opt.scope","warning"):notify("crud.create require opt.name","warning")}}})}(),function(){var app=angular.module("srv.diagPrice",[]);app.service("diagPrice",function($rootScope,server){function diagsPrice(_order,diagsArr){var _diags={};debug("diags",_diags);var diag=null,rta=0;return Object.keys(_order.diags).forEach(function(diagName){_order.diags[diagName]&&(diag=diagsArr.filter(function(d){return d.name==diagName})[0],_diags[diagName]=diag.price,rta+=diag.price)}),rta}function getExtraDatePrice(price,date,scope){debug("extraDatePrice",0),debug("extraDatePriceType","");var porcentages=scope.settings.pricePercentageIncrease;return isTodaySaturday(date)?(debug("extraDatePrice",price*porcentages.todaySaturday/100),debug("extraDatePriceType","todaySaturday"),debug("extraDatePricePorc",porcentages.todaySaturday),price*porcentages.todaySaturday/100):isTodaySunday(date)?(debug("extraDatePrice",price*porcentages.todayMondayToFriday/100),debug("extraDatePriceType","todayMondayToFriday"),debug("extraDatePricePorc",porcentages.todayMondayToFriday),price*porcentages.todayMondayToFriday/100):isToday(date)?(debug("extraDatePrice",price*porcentages.todayMondayToFriday/100),debug("extraDatePriceType","todayMondayToFriday"),price*porcentages.todayMondayToFriday/100):isTomorrowSaturday(date)?(debug("extraDatePrice",price*porcentages.tomorrowSaturday/100),debug("extraDatePriceType","tomorrowSaturday"),debug("extraDatePricePorc",porcentages.tomorrowSaturday),price*porcentages.tomorrowSaturday/100):isTomorrowSunday(date)?(debug("extraDatePrice",price*porcentages.tomorrowSunday/100),debug("extraDatePriceType","tomorrowSunday"),debug("extraDatePricePorc",porcentages.tomorrowSunday),price*porcentages.tomorrowSunday/100):isTomorrow(date)?(debug("extraDatePrice",price*porcentages.tomorrowMondayToFriday/100),debug("extraDatePriceType","tomorrowMondayToFriday"),debug("extraDatePricePorc",porcentages.tomorrowMondayToFriday),price*porcentages.tomorrowMondayToFriday/100):isSaturday(date)?(debug("extraDatePrice",price*porcentages.saturday/100),debug("extraDatePriceType","saturday"),debug("extraDatePricePorc",porcentages.saturday),price*porcentages.saturday/100):isSunday(date)?(debug("extraDatePrice",price*porcentages.sunday/100),debug("extraDatePriceType","sunday"),debug("extraDatePricePorc",porcentages.sunday),price*porcentages.sunday/100):(debug("extraDatePrice",price*porcentages.mondayToFriday/100),debug("extraDatePriceType","mondayToFriday"),debug("extraDatePricePorc",porcentages.mondayToFriday),price*porcentages.mondayToFriday/100)}function warn(str){return console.warn("getPriceQuote: "+str),0}function debug(prop,val){void 0==prop&&(r.__priceQuote={}),r.__priceQuote[prop]=val}var r=$rootScope,isSaturday=function(d){return 6===moment(d).day()},isSunday=function(d){return 0===moment(d).day()},isTomorrowSaturday=function(d){return 6===moment().add(1,"day").day()&&moment(d).isSame(moment().add(1,"day"),"day")},isTomorrowSunday=function(d){return 0===moment().add(1,"day").day()&&moment(d).isSame(moment().add(1,"day"),"day")},isTomorrow=function(d){return moment(d).isSame(moment().add(1,"day"),"day")},isTodaySaturday=function(d){return 6===moment().day()&&moment().isSame(moment(d),"day")},isTodaySunday=function(d){return 0===moment().day()&&moment().isSame(moment(d),"day")},isToday=function(d){return moment().isSame(moment(d),"day")};return r.__priceQuote={},{setPrices:function(scope,_order){var diagCommissionRate=_order._diag.commission;if(void 0==diagCommissionRate)return console.warn("setPrices _order._diag.commission required");var vatRate=scope.settings.pricePercentageIncrease.VATRate||20,priceHT=_order.price/(vatRate/100+1);_order.vatPrice=_order.price-priceHT,_order.priceHT=priceHT,_order.diagRemunerationHT=_order.priceHT*diagCommissionRate/100,debug("diagRemunerationHT",_order.diagRemunerationHT),debug("diagCommissionRate",diagCommissionRate),debug("revenueRate",100-diagCommissionRate),_order.revenueHT=_order.priceHT-_order.diagRemunerationHT,debug("revenueHT",_order.revenueHT),_order.vatRate=vatRate},getPriceQuote:function(scope,date){debug(void 0);var _order=scope.item;if(scope._order&&scope._order._id&&(_order=scope._order),_order=_.cloneDeep(_order),_order.info||(_order.info=_order),debug("_order",_order),!_order)return warn("_order required.");if(date=date||_order.start,!date)return warn("date (or _order.start) required.");var basePrice=scope.basePrice;if(!basePrice)return warn("basePrice required.");debug("basePrice",basePrice);var squareMeters=_order.info.squareMeters;if(!squareMeters)return warn("squareMeters required.");var squareMetersPrice=scope.squareMetersPrice;if(!squareMetersPrice)return warn("squareMetersPrice required.");var squareMetersPorcentage=squareMetersPrice[squareMeters];if(!squareMetersPorcentage)return warn("squareMetersPorcentage required.");if(!scope.diags)return warn("diags required.");var selectedDiagsTotalPrice=diagsPrice(_order,scope.diags);debug("selectedDiagsTotalPrice",selectedDiagsTotalPrice);var subTotal=basePrice+selectedDiagsTotalPrice;debug("subTotal",subTotal);var extraBuildingSizePrice=subTotal*squareMetersPorcentage/100;debug("extraBuildingSizePrice",extraBuildingSizePrice),debug("extraBuildingSizePorc",squareMetersPorcentage);var extraDatePrice=getExtraDatePrice(subTotal,date,scope);debug("extraDatePrice",extraDatePrice),_order._client&&void 0!=_order._client.discount&&!isNaN(_order._client.discount)||(_order._client=_order._client||{},_order._client.discount=0,warn("_order._client.discount 0 .. 100 required (warning)"));var discountClientPorc=_order._client.discount,discountClientPrice=subTotal*_order._client.discount/100;debug("discountClientPrice",discountClientPrice),debug("discountClientPorc",discountClientPorc);var rta=subTotal+extraBuildingSizePrice+extraDatePrice-discountClientPrice,rtaRounded=10*parseInt(parseInt(rta)/10,10);debug("total",rta),debug("totalRoundedValue",Math.abs(rta-rtaRounded)),debug("totalRoundedHT",rtaRounded);var vatPrice=scope.settings.pricePercentageIncrease.VATRate||20;return debug("vatRate",vatPrice),vatPrice=rtaRounded*vatPrice/100,debug("vatPrice",vatPrice),rtaRounded+=vatPrice,debug("totalRoundedTTC",rtaRounded),rtaRounded}}})}(),function(){var app=angular.module("srv.diagSlots",[]);app.service("diagSlots",function($rootScope,server,diagPrice){var r=$rootScope,db=server;return function(scope,item){function requestSlots(date){return $U.MyPromise(function(resolve,error,evt){if(isFinite(new Date(date))){var time=$D.OrderTotalTime(item.diags,scope.diags),order={day:date,time:time};db.getAvailableRanges(order,_settings).then(function(data){var cbHell=$U.cbHell(data.length,function(){resolve(data)});data.forEach(function(r){r.id=window.btoa(JSON.stringify(r)),r.price=diagPrice.getPriceQuote(scope,date),db.ctrl("User","get",{_id:r._diag}).then(function(d){d.ok&&d.result&&(r.name=d.result.firstName+", "+d.result.lastName.substring(0,1),d.result.diagPriority&&(r.name+=" ("+d.result.diagPriority+")"),cbHell.next())})}),0==data.length&&cbHell.call()})}})}var _settings={};return function(){function asyncRequest(_date,cbHell,dataPosition){var _newDate=new Date(_date);requestSlots(_newDate).then(function(d){var d=_.orderBy(d,function(item){return item.start._d});if(d.length>4){try{db.ctrl("Log","create",{message:"booking-warning: date slot request retrieve "+d.length+" slots.",data:d})}catch(e){}for(;d.length>4;)d.pop()}_data[dataPosition]=new DaySlot(_newDate,d),cbHell.next()})}var DaySlot=function(_date,_slots){var o={date:moment(_date),slots:_slots,label:function(){return o.isToday()?"Aujourd’hui":r.momentFormat(o.date,"dddd DD MMMM")},isToday:function(){return o.date.isSame(moment(),"day")}};return o},_data=[],_nextTimes=0,cursor=moment(),o={};return o.setDiag=function(_diag){_settings._diag=_diag},o.get=function(){return _data},o.init=function(d,opt){cursor=moment(d),opt=opt||{},_settings.department=opt.department,o.request()},o.backIsDisabled=function(){return cursor.isSame(moment(),"days")},o.nextIsDisabled=function(){return!1},o.next=function(){return _nextTimes>15?(_nextTimes=0,o.init()):(_nextTimes++,cursor=cursor.add(4,"days"),void o.request())},o.back=function(){cursor.isSame(moment(),"days")||(cursor=cursor.subtract(4,"days"),cursor.isBefore(moment(),"days")?cursor=moment():_nextTimes--,o.request())},o.request=function(){var _localCursor=moment(cursor),cbHell=$U.cbHell(4,function(){o.get()[0].date.isSame(moment(),"day")&&0==o.get()[0].slots.length&&o.init(moment().add(1,"days").toDate())});asyncRequest(_localCursor._d,cbHell,0),_localCursor=_localCursor.add(1,"days"),asyncRequest(_localCursor._d,cbHell,1),_localCursor=_localCursor.add(1,"days"),asyncRequest(_localCursor._d,cbHell,2),_localCursor=_localCursor.add(1,"days"),asyncRequest(_localCursor._d,cbHell,3)},o}()}})}(),function(global){function diagsGetAvailableRanges(order,ctrl,opt){function diagsPriority(cb){var payload={userType:"diag",__rules:{disabled:{$ne:!0}},__select:"priority"};opt._diag&&(payload._id=opt._diag._id||opt._diag),opt.department&&(payload.__rules.departments={$eq:opt.department.toString()},console.info("debug filtering diags who cover department ",opt.department)),ctrl("User","getAll",payload).then(function(data){cb(data.result.map(function(v){return{_id:v._id,priority:v.priority}}))})}function timeRangesDiagSayHeCantWorktype(cb){ctrl("TimeRange","getAll",{type:"work-exception",__select:"_user start end repeat"}).then(function(data){cb(data.result.map(function(v){return v}))})}function timeRangesDiagIsWorking(order,cb){ctrl("Order","getAll",{__select:"start end _diag",__rules:{status:{$ne:"complete"}}}).then(function(data){data.result=data.result.filter(function(v){return moment(v.start).isSame(moment(order.day),"day")}),cb(data.result.map(function(v){return{_user:v._diag,start:v.start,end:v.end}}))})}function _data(cb){timeRangesDiagIsWorking(order,function(working){timeRangesDiagSayHeCantWorktype(function(exceptions){diagsPriority(function(diags){cb(working,exceptions,diags)})})})}function calc(order,working,exceptions,diags){return diagsCalculateAvailableSlots(order,working,exceptions,diags)}if(opt=opt||{},!isFinite(new Date(order.day)))throw Error("getAvailableRanges Invalid order day");return $U.MyPromise(function(resolve,error){_data(function(working,exceptions,diags){resolve(calc(order,working,exceptions,diags))})})}function diagsCalculateAvailableSlots(order,working,exceptions,diags){var slots={morning:[],afternoon:[]},diags=_.orderBy(diags,function(v){return v.priority});return diags.forEach(function(diag){if(isExceptionCollidingWholeDay(diag,order,exceptions))return void(DEBUG&&console.log(diag._id+" exception colliding whole day"));var _exceptions=orderDiagExceptions(order,diag,exceptions),_collisions=_.union(filterOrders(working,diag),_exceptions);if(_collisions=_.union(_collisions,slots.morning),_collisions=_.union(_collisions,slots.afternoon),slots.morning.length<2)if(freeMorning(order,_collisions))slots=allocateFixedMorning(slots,order,diag);else{var sumo=allocateMorning(diag,order,_collisions,slots);sumo&&slots.morning.length<2&&(_collisions.push(slots.morning[slots.morning.length-1]),allocateMorning(diag,order,_collisions,slots))}if(slots.afternoon.length<2)if(freeAfternoon(order,_collisions))slots=allocateFixedAfternoon(slots,order,diag);else{var sumo=allocateAfternoon(diag,order,_collisions,slots);sumo&&slots.afternoon.length<2&&(_collisions.push(slots.afternoon[slots.afternoon.length-1]),allocateAfternoon(diag,order,_collisions,slots))}}),_.union(slots.morning,slots.afternoon)}function allocateFixedMorning(_slots,order,diag){if(isToday(order))if(moment().isBefore(moment().hour(11).minutes(30)))if(moment().isBefore(moment().hour(8).minutes(0)))_slots.morning.push(slot(9,0,order,diag),slot(10,0,order,diag)),DEBUG&&console.log("allocate-fixed-morning-today-at-9h00-and-10h00-current-time-before-08h00: ");else{var fixed=moment().add(1,"hour");if(fixed.isBefore(moment().hour(11).minutes(30))){var minutes=10*parseInt(parseInt(fixed.minutes())/10,10);_slots.morning.push(slot(fixed.hours(),minutes,order,diag)),DEBUG&&console.log("allocate-fixed-morning-today-at: ",fixed),fixed=fixed.add(1,"hour"),fixed.isBefore(moment().hour(11).minutes(30))?(_slots.morning.push(slot(fixed.hours(),minutes,order,diag)),DEBUG&&console.log("allocate-fixed-morning-today-at: ",fixed)):DEBUG&&console.log("allocate-fixed-morning-today-skip: fixed beyond limit (11h30)",fixed)}else DEBUG&&console.log("allocate-fixed-morning-today-skip: fixed beyond limit (11h30)",fixed)}else DEBUG&&console.log("allocate-fixed-morning-skip-current-time-after-11h30: ",fixed);else _slots.morning.push(slot(9,0,order,diag),slot(10,0,order,diag));return _slots}function allocateFixedAfternoon(_slots,order,diag){if(isToday(order))if(moment().isAfter(moment().hour(13).minutes(0))){var fixed=moment().add(1,"hour"),limit=moment().hours(19).minutes(0).subtract(order.time.hours,"hours").subtract(order.time.minutes,"minutes");if(fixed.isBefore(limit)){var minutes=10*parseInt(parseInt(fixed.minutes())/10,10);_slots.afternoon.push(slot(fixed.hours(),minutes,order,diag)),DEBUG&&console.log("allocate-fixed-afternoon-today-at: ",fixed),fixed=fixed.add(1,"hour"),fixed.isBefore(limit)?(_slots.afternoon.push(slot(fixed.hours(),minutes,order,diag)),DEBUG&&console.log("allocate-fixed-afternoon-today-at: ",fixed)):DEBUG&&console.log("allocate-fixed-afternoon-today-skip: fixed beyond limit",limit,fixed)}else DEBUG&&console.log("allocate-fixed-afternoon-today-skip: fixed beyond limit",limit,fixed)}else _slots.afternoon.push(slot(14,0,order,diag),slot(15,0,order,diag)),DEBUG&&console.log("allocate-fixed-afternoon-today-at-14-and-15-current-time-before-13h00: ",fixed);else _slots.afternoon.push(slot(14,0,order,diag),slot(15,0,order,diag));return _slots}function isToday(order){return moment(order.day).isSame(moment(),"day")}function filterOrders(orders,diag){return orders.filter(function(v){
return v._user==diag._id})}function allocateMorning(diag,order,collisions,arr){var startMinH=8,startMinM=0;if(isToday(order)){if(moment().isAfter(moment().hour(11).minutes(30)))return!1;startMinH=moment().add(1,"hour").hours(),startMinM=moment().minutes()}return allocate(startMinH,startMinM,11,30,diag,order,collisions,arr,"morning")}function allocateAfternoon(diag,order,collisions,arr){var startMinH=13,startMinM=0,startMax=moment(order.day).hours(19).minutes(0).subtract(order.time.hours,"hour").subtract(order.time.minutes,"minutes");if(isToday(order)){if(moment().isAfter(moment().hour(startMax.hours()).minutes(startMax.minutes())))return!1;startMinH=moment().add(1,"hour").hours(),startMinM=moment().minutes()}return allocate(startMinH,startMinM,startMax.hours(),startMax.minutes(),diag,order,collisions,arr,"afternoon")}function normalizeStart(start){start=moment(start);var h=start.hours(),m=start.minutes();return m>0&&30>m&&(m=30),m>30&&(m=0,h++),start.hours(h).minutes(m)}function allocate(startMinH,startMinM,startMaxH,startMaxM,diag,order,collisions,arr,propName){var startMin=moment(order.day).hour(startMinH).minutes(startMinM),startMax=moment(order.day).hour(startMaxH).minutes(startMaxM),cut=!1,start=moment(startMin),_cols=[],c=0;do{if(_cols=rangeCollisions4(start,order,collisions),0==_cols.length){if(_cols=rangeCollisions5(orderEnd(start,order),1,30,collisions),0==_cols.length){var _s=slot(start.hours(),start.minutes(),order,diag);return arr[propName].push(_s),!0}start=moment(_cols[_cols.length-1].end).add(1,"hours").add(30,"minutes"),start=normalizeStart(start)}else start=moment(_cols[_cols.length-1].end).add(1,"hours").add(30,"minutes"),start=normalizeStart(start);c++,c>20&&(cut=!0)}while(moment(start).isBefore(moment(startMax))||cut);return!1}function freeMorning(order,collisions){var lastAssignableMorningDate=moment(order.day).hours(11).minutes(30);return 0==collisions.filter(function(v){return moment(v.start).isBefore(lastAssignableMorningDate)}).length}function freeAfternoon(order,collisions){var minAssignableAfternoonDate=moment(order.day).hours(13).minutes(0);return 0==collisions.filter(function(v){return moment(v.start).isAfter(minAssignableAfternoonDate)}).length}function slot(h,m,order,diag){var start=moment(order.day).hour(h).minutes(m);return{_diag:diag._id,start:start,end:moment(start).add(order.time.hours,"hours").add(order.time.minutes,"minutes")}}function orderEnd(start,order){return moment(start).add(order.time.hours,"hours").add(order.time.minutes,"minutes")}function rangeCollisions5(date,hp,mp,collisions){return rangeCollisions2(date,moment(date).hours(),moment(date).minutes(),hp,mp,collisions)}function rangeCollisions4(start,order,collisions){return rangeCollisions(start,orderEnd(start,order),collisions)}function rangeCollisions2(date,h,m,hp,mp,collisions){var start=moment(date).hour(h).minutes(m),end=moment(start).add(hp,"hours").add(mp,"minutes");return rangeCollisions(start,end,collisions)}function rangeCollisions(start,end,collisions){var get=function(cb){return collisions.filter(function(v){return cb(v)})||[]},rta=get(function(r){return moment(r.start).isSameOrAfter(start)&&moment(r.start).isSameOrBefore(end)});return _.union(rta,get(function(r){return moment(r.end).isSameOrAfter(start)&&moment(r.end).isSameOrBefore(end)})),rta}function orderDiagExceptions(order,diag,exceptions){var repeatWeek,sameDOW,collide,sameDay=!1,repeatDay=!1;return exceptions.filter(function(range){return range._user!==diag._id?!1:(collide=!0,sameDay=moment(range.start).isSame(order.day,"day"),repeatDay="day"==range.repeat,repeatWeek="week"==range.repeat,sameDOW=moment(order.day).day()==moment(range.start).day(),collide=collide&&(sameDay||repeatDay||repeatWeek&&sameDOW))})}function isExceptionCollidingWholeDay(diag,order,exceptions){return exceptions.some(function(ex){var o=moment(order.day);return ex._user!=diag._id?!1:moment(ex.start).isBefore(o.hour(8).minutes(0))&&moment(ex.end).isAfter(o.hour(19).minutes(0))})}global.diagsCalculateAvailableSlots=diagsCalculateAvailableSlots,global.diagsGetAvailableRanges=diagsGetAvailableRanges;var DEBUG=!1}("undefined"!=typeof exports&&exports||window);var app=angular.module("app.directives",[]);app.directive("compileHtml",["$compile",function($compile){return{restrict:"A",link:function(scope,element,attrs){scope.$watch(function(){return scope.$eval(attrs.compileHtml)},function(value){element.html(value),$compile(element.contents())(scope)}),console.log("compile-html running")}}}]),app.directive("bindHtmlCompile",["$compile",function(compile){return{restrict:"A",link:function(s,el,attrs){s.$watch(function(){return s.$eval(attrs.bindHtmlCompile)},function(e){el.html(e&&e.toString());var f=s;attrs.bindHtmlScope&&(f=s.$eval(attrs.bindHtmlScope));var compiled=compile(el.contents())(f);el.html("").append(compiled);var first=el.find(":first-child"),tag=first&&first.get(0)&&first.get(0).tagName.toUpperCase()||"NONE";if("SPAN"==tag){var other=$(el).find("*").not(":first");first.append(other),el.html(first.html())}var text="";el.children().each(function(){"SPAN"==$(this).get(0).tagName&&(text+=$(this).text())}),text.length>0&&el.text(text)})}}}]),app.directive("tableFilter",function($rootScope,$timeout,$compile,$templateRequest,$sce,tpl){return{restrict:"AE",replace:!0,scope:{model:"=model"},template:"<out></out>",link:function(s,elem,attrs){function assignPayloadRules(data){var rule,val,_data,rules=s.model.filter.payloadRules;if(!rules)return data;for(var x in rules)rule=rules[x],void 0!=rule&&(val=s.model.filter.fields[x],void 0!=val&&(data.__rules=data.__rules||{},_data=rule(data,val),_data?data=_data:console.warn("app filter payload rules undefined output for ",x)));return data}function assignRuleByType(payload,type,handler){var fieldValue=null;for(var fieldName in s.model.filter.fields)fieldValue=s.model.filter.fields[fieldName],void 0!=fieldValue&&void 0!==s.model.filter.rules[fieldName]&&s.model.filter.rules[fieldName].toLowerCase()==type.toLowerCase()&&(payload.__rules=payload.__rules||{},payload=handler(payload,fieldName,fieldValue));return payload}function storeSet(){s.model.filter.store&&$U.store.set("filter_"+s.model.filter.store+"_"+r.session()._id,s.model.filter.payload)}function storeGet(){s.model.filter.store&&(s.model.filter.payload=$U.store.get("filter_"+s.model.filter.store+"_"+r.session()._id))}function regexpFields(){var fields={};for(var x in s.model.filter.fields)"_"!=x.charAt(0)&&s.model.filter.rules[x]&&"contains"==s.model.filter.rules[x]&&(fields[x]=s.model.filter.fields[x]);return fields}function collectionPointersFields(){var fields={};for(var x in s.model.filter.fields)"_"==x.charAt(0)&&s.model.filter.fields[x]&&(fields[x]=s.model.filter.fields[x]);return fields}var r=$rootScope;if(!s.model||s.model.filter){var filter=s.model.filter.template||"<h5>tableFilter requires filter.template</h5>";r.dom(function(){var el=tpl.compile(filter,s);elem.replaceWith(el),el.find("input").on("keyup",function(evt){"13"==evt.keyCode.toString()&&s.model.filter.filter()})}),s.model.filter.filter=function(){s.model.filter.payload={__regexp:regexpFields()},s.model.filter.payload=assignRuleByType(s.model.filter.payload,"awesome-in",function(data,name,val){val=val.replaceAll(" ",""),","==val.charAt(val.length-1)&&(val=val.substring(0,val.length-1));var arr=val.split(",");return data.__rules=data.__rules||{},data.__rules[name]={$in:arr},data}),s.model.filter.payload=assignRuleByType(s.model.filter.payload,"in",function(data,name,val){return data.__rules[name]={$in:[val]},data}),s.model.filter.payload=assignRuleByType(s.model.filter.payload,"month-range",function(data,name,val){var date=moment().month(parseInt(val));return data.__rules[name]={$gte:date.startOf("month").toDate().toString(),$lt:date.endOf("month").toDate().toString()},data}),s.model.filter.payload=assignPayloadRules(s.model.filter.payload),s.model.filter.payload=Object.assign(s.model.filter.payload,collectionPointersFields()),storeSet(),s.model.filter&&s.model.filter.update&&s.model.filter.update()},s.model.filter.clear=function(){s.model.filter.payload={};for(var x in s.model.filter.fields)s.model.filter.fields[x]="";storeSet(),s.model.filter.fields={},s.model.filter.update()},s.model.filter.firstTime=function(){storeGet(),s.model.filter.update()},s.model.filter.fields={};var filtered=[];s.$watch("model.filter.fields",function(fields){if(s.model.itemsOriginalRef&&0!=s.model.itemsOriginalRef.length){filtered=s.model.itemsOriginalRef;var filterVal,rule="contains",val=null;for(var x in fields)filterVal=fields[x]||"",s.model.filter.rules[x]&&(rule=s.model.filter.rules[x]||rule,"contains"==rule&&(filtered=filtered.filter(function(v){return v[x]&&-1!==v[x].toLowerCase().indexOf(filterVal.toLowerCase())})),"match"==rule&&(filtered=filtered.filter(function(v){return val="_"==x.charAt(0)?v[x]&&v[x]._id:v[x],val&&val.toLowerCase()==filterVal.toLowerCase()})),"matchCaseSensiive"==rule&&(filtered=filtered.filter(function(v){return val="_"==x.charAt(0)?v[x]&&v[x]._id:v[x],val&&val==filterVal})));s.model.items=filtered,r.dom()}},!0)}}}}),app.directive("ctrlDtp",function($rootScope){return{restrict:"AE",scope:{opt:"=options"},replace:!0,templateUrl:"./views/directives/directive.ctrl.datetimepicker.html",link:function(s,el,attrs){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}var opt=s.opt;if($U.expose(opt.name||"dtp",s),!opt.modelPath)throw Error("ctrlDtp require opt.modelPath");if(!opt.scope)throw Error("ctrlDtp require opt.scope");if(!opt.cls)throw Error("ctrlDtp require opt.cls (function)");if(!opt.disabled)throw Error("ctrlDtp require opt.disabled (function)");s=Object.assign(s,{scope:opt.scope,opened:!1,disabled:function(){return opt.disabled()},cls:function(){return opt.cls()},model:opt.initDate||new Date}),opt.scope.$watch(function(){opt.digest&&opt.digest(opt)}),opt.scope.$watch(opt.modelPath,function(v){void 0!==v&&v!==s.model&&(s.model=v)}),s.$watch("model",function(v){setVal(opt.scope,opt.modelPath,v)})}}}),app.directive("ctrlSelect",function($rootScope){return{restrict:"AE",scope:{opt:"=options"},replace:!0,templateUrl:"./views/directives/directive.ctrl.select.html",link:function(s,el,attrs){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}s.choiceLabel=function(choice){return choice.label?"string"!=typeof choice.label?choice.label():choice.label:choice},s.choiceDisabled=function(choice){return choice.disabled?choice.disabled():!1};var r=$rootScope,opt=s.opt;if(!opt.modelPath)throw Error("ctrlSelect require opt.modelPath");if(!opt.scope)throw Error("ctrlSelect require opt.scope");if(!opt.items)throw Error("ctrlSelect require opt.items");if(!opt.cls)throw Error("ctrlSelect require opt.cls (function)");if(!opt.disabled)throw Error("ctrlSelect require opt.disabled (function)");s=Object.assign(s,{scope:opt.scope,label:opt.label||"(Select Item)",disabled:function(){return opt.disabled()},cls:function(){return opt.cls()},click:function(x){setVal(opt.scope,opt.modelPath,x.val||x)}}),opt.filterWatch?s.scope.$watch(opt.filterWatch,function(){opt.filter&&(s.opt.items=_.filter(s.opt.items,function(v){return opt.filter(v)}))},!0):s.scope.$watch(function(){opt.filter&&(s.opt.items=_.filter(s.opt.items,function(v){return opt.filter(v)}))}),opt.scope.$watch(opt.modelPath,function(v,oldV){var arr=s.opt.items.filter(function(item){return(item.val||item)==v});if(arr.length>1)throw Error("ctrlSelect items val need to be unique.");1==arr.length?(arr[0].label?"string"!=typeof arr[0].label?s.label=arr[0].label():s.label=arr[0].label:s.label=arr[0],opt.change&&opt.change(arr[0],opt,function(){v!==oldV&&setVal(opt.scope,opt.modelPath,oldV)}),r.dom()):(opt.label&&(s.label=opt.label||"(Select Item)"),console.warn("ctrlSelect model has an invalid value. Values expected: "+JSON.stringify(s.opt.items.map(function(item){return item.val||item}))))}),opt.init&&opt.init(opt)}}}),app.directive("includeReplace",function(){return{require:"ngInclude",restrict:"A",link:function(scope,el,attrs){el.replaceWith(el.children())}}}),app.directive("activeRoute",function($rootScope){return{restrict:"A",link:function(scope,el,attrs){function apply(){$rootScope.routeIs(attrs.activeRoute)?el.addClass("active"):el.removeClass("active")}$rootScope.dom(apply),$rootScope.$watch("__route",function(__route){$rootScope.dom(apply)})}}}),app.directive("focusOn",function(){return function(scope,elem,attr){scope.$on("focusOn",function(e,name){name===attr.focusOn&&elem[0].focus()})}}),app.directive("collapseNav",function($timeout,$rootScope){return{restrict:"AE",replace:!1,link:function(s,elem,attr){var r=$rootScope;r.dom(function(){elem.find("li").on("click",function(){r.dom(function(){var w=$(window).width();768>w&&elem.collapse("hide")})})})}}}),app.factory("focus",function($rootScope,$timeout){return function(name){$timeout(function(){$rootScope.$broadcast("focusOn",name)})}}),app.directive("crudModal",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open",close:"=close"},template:"<output></output>",link:function(s,elem,attrs){var r=$rootScope,fire=function(n,p,ctx){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){ctx?cb.call(ctx,p):cb(p)}))};s.open=function(opt){if(s.evts=opt.evts,!opt.templateUrl)throw Error("crudModal needs templateUrl");$uibModal.open({animation:!0,templateUrl:opt.templateUrl,controller:function($scope,$uibModalInstance){var s=$scope;s.fire=function(n,p){return fire(n,p,s)},Object.assign(s,opt),s.save=s.validate=function(){s.validate&&s.validate.when&&s.validate.fail?$U.ifThenMessage(s.validate.when(s),s.validate.fail(s),function(){s.close()}):s.close()},s.close=function(){$uibModalInstance.close(),opt.callback(s.item)},s.closeSilent=function(){$uibModalInstance.close()},s.redirect=function(url){r.params={item:s.item},r.route(url),s.closeSilent()},s.cancel=function(){$uibModalInstance.dismiss("cancel")},fire("init",null,s)}})}}}}),app.directive("address",function($rootScope,$timeout){return{scope:{model:"=model",field:"@field",change:"=change",number:"@number",street:"@street",city:"@city",department:"@department",region:"@region",country:"@country",postCode:"@postCode"},restrict:"AE",link:function(scope,elem,attrs){if(!scope.model)throw Error("directive address require a valid model.");$timeout(function(){function onResult(event,result){scope.model[scope.field]=result.formatted_address,scope.change&&scope.change(result.formatted_address);var number,street,city,department,region,country,postCode,data=result.address_components.map(function(v){return v.long_name});4==data.length&&(number="",street=data[0],city=data[1],department=data[1],region="",country=data[2],postCode=data[3]),5==data.length&&(number="",street=data[0],city=data[0],department=data[1],region=data[2],country=data[3],postCode=data[4]),6===data.length&&(number="",street=data[0],city=data[1],department=data[2],region=data[3],country=data[4],postCode=data[5]),7===data.length&&(number=data[0],street=data[1],city=data[2],department=data[3],region=data[4],country=data[5],postCode=data[6]),scope.number&&setVal(scope.model,scope.number,number),scope.street&&setVal(scope.model,scope.street,street),scope.city&&setVal(scope.model,scope.city,city),scope.department&&setVal(scope.model,scope.department,department),scope.region&&setVal(scope.model,scope.region,region),scope.country&&$U.fetchCountry(result.formatted_address).then(function(d){setVal(scope.model,scope.country,d.name)}),scope.postCode&&setVal(scope.model,scope.postCode,postCode),$U.expose("address",Object.assign(result,scope)),$rootScope.dom()}function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}function read(){$timeout(function(){""!==scope.model[scope.field]&&elem.geocomplete("find",scope.model[scope.field]),scope.$apply()})}try{elem.geocomplete({country:"FR"}).bind("geocode:result",onResult)}catch(e){var msg="Google library issue, address autocomplete feature is temporaly disabled.";return console.warn(msg)}read(),scope.$watch("model."+scope.field,read),scope.$apply()})}}}),app.directive("debug",function($rootScope,$timeout,server,$compile){return{scope:{show:"=show"},restrict:"AE",replace:!0,template:'<div><i ng-show="show" ng-click="click()" class="link fa fa-bug fa-lg fixed left-1 bottom-1 always-on-top"><input disabled type="checkbox" ng-click="stop()" ng-model="check"></i><span data-output></span></div>',link:function(s,elem,attrs){var r=$rootScope;s.check=!0,s.opt={onClose:function(){r.logger.clearErrors()}},s.stop=function(){return window.event.stopPropagation()},s.click=function(){var log=r.logger.pending();log&&s.create(log,"info");var err=r.logger.errors();err&&s.create(err,"danger")},s.$watch("check",function(v){v?(s.checking&&clearInterval(s.checking),s.checking=setInterval(function(){r.logger.hasErrors()&&r.dom(function(){0===elem.find("[data-output] .alert-danger").length&&(s.create(r.logger.errors(),"danger"),r.logger.clearErrors())})},1e3),window.onerror=function(err){s.create(err,"danger")}):(s.checking&&clearInterval(s.checking),window.onerror=function(err){})}),s.create=function(msg,type){return console.warn("[DEBUG]["+("danger"===type?"ERROR":"WARNING")+"] "+msg)},setTimeout(function(){-1!==server.URL().indexOf("localhost")&&(s.show=!0,r.dom())},5e3)}}}),app.directive("spinner",function($rootScope,$timeout){return{scope:{show:"=show"},restrict:"AE",replace:!0,templateUrl:"./views/directives/directive.spinner.html",link:function(scope,elem,attrs){}}}),app.directive("checkBox",function($rootScope,$timeout){return{scope:{val:"=val",arr:"=push"},restrict:"AE",replace:!0,template:"<input type='checkbox'/>",link:function(scope,elem,attrs){$timeout(function(){scope.$apply(function(){elem.value=scope.val,elem.on("change",function(){var checked=elem.get(0).checked;checked?(scope.arr=scope.arr||[],scope.arr.push(scope.val)):_.remove(scope.arr,function(e){return e===scope.val})})})})}}}),app.directive("notify",function($rootScope,$timeout){return{scope:{message:"@message",type:"@type",cls:"@cls",scroll:"=scroll",opt:"=opt",evts:"=evts",settings:"=settings"},restrict:"AE",replace:!0,templateUrl:"./views/common/popups/popup-notify.html",link:function(scope,elem,attrs){var r=$rootScope,s=scope;if(s.settings&&"string"==typeof s.settings){var fixedJSON=s.settings.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g,'"$2": ');s.settings=JSON.parse(fixedJSON)}var fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};$timeout(function(){scope.$apply(function(){elem.find(".alert").addClass(scope.type||"alert-danger"),scope.cls&&elem.find(".alert").addClass(scope.cls)})}),scope.clickDismiss=function(){s.settings&&s.settings.clickDismissable===!1&&s.opt&&!s.opt.clickDismissable||scope.dismiss()},scope.dismiss=function(){s.dismissed||(s.dismissed=!0,elem.find(".alert").alert("close"),elem.remove(),fireEvent("close"),scope.opt&&scope.opt.onClose&&scope.opt.onClose())},scope.$watch("message",function(v){elem.find("[data-message]").html(v)}),s.opt&&s.opt.duration?r.dom(s.dismiss,s.opt.duration):(_.includes(["alert-info","alert-success"],s.type)&&r.dom(scope.dismiss,2e3),_.includes(["alert-danger","alert-warning"],s.type)&&r.dom(scope.dismiss,1e4)),1==s.settings.scroll&&r.dom($U.scrollToTop)}}}),app.directive("myAlert",function($rootScope,$timeout){return{scope:{message:"@message",type:"@type",cls:"@cls",scroll:"=scroll",opt:"=opt",evts:"=evts"},restrict:"AE",replace:!0,templateUrl:"./views/directives/directive.alert.html",link:function(scope,elem,attrs){var s=scope,r=$rootScope,fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};$timeout(function(){scope.$apply(function(){elem.addClass(scope.type||"alert-danger"),scope.cls&&elem.addClass(scope.cls)})}),scope.dismiss=function(){elem.alert("close"),fireEvent("close"),scope.opt&&scope.opt.onClose&&scope.opt.onClose()},scope.$watch("message",function(v){elem.find("[data-message]").html(v),v&&scope.scroll&&r.dom(function(){$("html, body").animate({scrollTop:elem.offset().top},500)})})}}}),app.directive("myAlerts",function($rootScope,$timeout,$compile){return{restrict:"AE",replace:!0,scope:{add:"=add",directive:"@directive",stacked:"=stacked",settings:"@settings"},template:"<output></output>",link:function(s,elem,attrs){function onClose(){if(s.stacked){if(s.el=null,0===s._stacked.length)return;var p=s._stacked[0];s._stacked=s._stacked.slice(1),s.add(p.message,p.type,p.timeout,p.scroll,p.opt)}}var r=$rootScope;s.decodeMessage=function(msg){return"string"==typeof msg?msg:JSON.stringify(msg)},s._stacked=[],s.evts={close:[onClose]};var fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};s.add=function(message,type,timeout,scroll,opt){var msg=s.decodeMessage(message);type&&"string"!=typeof type&&(opt=type,type=opt.type||void 0),timeout&&"object"===("undefined"==typeof timeout?"undefined":_typeof(timeout))&&(opt=timeout,timeout=void 0),opt&&opt.scroll===!0&&(scroll=!0),s.el&&s.el.alert("close");var directive=s.directive||"my-alert";s.opt=opt;var el=$compile("<"+directive+" settings='settings' evts='evts' opt='opt' scroll='"+scroll+"' message='"+msg+"' type='alert-"+(type||"danger")+"'/>")(s);s.el=el,elem.html("").append(el),timeout&&"my-alert"===directive&&r.dom(function(){elem.html(""),fireEvent("close")},timeout)},"notify"==s.directive&&(r.notify=s.add,r.message=s.add),window.ss=s}}}),app.directive("modalCustom",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){if(!attrs.templateUrl)throw Error("modalCustom attr templateUrl required.");s.open=function(opt,confirmCallback){opt=opt||{};var message="";message="string"==typeof opt?opt:opt.message||"";$uibModal.open({animation:!0,templateUrl:opt.templateUrl||attrs.templateUrl,controller:function($scope,$uibModalInstance){$scope.data=opt.data,$scope.message=message,$scope.messageEl=opt.messageEl||null,$scope.yes=function(){$uibModalInstance.close(),confirmCallback&&confirmCallback()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$U.expose("modalCustom",$scope)}})}}}}),app.directive("modalConfirm",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){s.open=function(opt,okCallback){opt=opt||{};var message="";message="string"==typeof opt?opt:opt.message||"";var rta={};$uibModal.open({backdrop:opt.backdrop||!0,animation:!0,templateUrl:opt.templateUrl||"views/directives/directive.modal.sure.html",controller:function($scope,$uibModalInstance){$scope.data=opt.data,$scope.message=message,$scope.yes=function(){$uibModalInstance.close(),okCallback&&okCallback()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.close=function(good){$uibModalInstance.dismiss("cancel"),good&&okCallback&&okCallback()},rta.scope=$scope,rta.close=function(){$uibModalInstance.dismiss("cancel")},r._modal=$scope}});return rta};var r=$rootScope;r.modalConfirm=r.modalConfirm||{},r.modalConfirm[attrs.open]=s.open,r.modalConfirm.first=s.open}}}),app.directive("dynamicTable",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!0,scope:{model:"=model"},templateUrl:"views/common/partials/dynamic-table.html",link:function(s,elem,attrs){function objUpdate(obj1,obj2,preserveFields){var rta=obj1;return Object.keys(obj2).forEach(function(k){for(var x in preserveFields)if(preserveFields[x]==k&&"undefined"!=typeof obj1[k])return;rta[k]=obj2[k]}),rta}var r=$rootScope;$rootScope.$watch("hasMouse",function(v){s.hasMouse=v});attrs.name;if(!s.model)return void console.error("directive.table: no model present");s.click=function(item,index){s.model.click&&s.model.click(item,index)},s.buttons=s.model.buttons||null,s.columns=s.model.columns||[],s.model.items=s.model.items||[],s.paginationTotalItems=1;var paginationDefaults={currentPage:1,maxSize:5,itemsPerPage:10,total:1,changed:function(){s.model.paginate&&s.model.paginate(function(items){s.model.items=items,r.dom()})},update:function(p){s.model.pagination.total=p.total}};s.model.pagination=s.model.pagination&&objUpdate(s.model.pagination,paginationDefaults,["itemsPerPage"])||paginationDefaults,s.model.update=function(items,data){s.model.items=items,s.model.itemsOriginalRef=items,s.data||(s.data=data)},s.model.columnFilter=function(item){return void 0==item.disabled||1==!item.disabled},s.model.init&&s.model.init(),s.model.itemsOriginalRef=s.model.items,$U.expose("table",s)}}}),app.directive("appendChild",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!1,scope:{child:"=child"},link:function(s,elem,attrs){s.child&&elem.html("").append(s.child)}}}),app.directive("htmlContent",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!1,scope:{html:"&html"},link:function(s,elem,attrs){s.html&&$rootScope.dom(function(){elem.html(s.html)})}}}),app.directive("timeRange",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){s.open=function(opt){$uibModal.open({animation:!0,templateUrl:"views/directives/directive.modal.timeRange.html",controller:function($scope,$uibModalInstance){var s=$scope;s.title=opt.title,s.title||(s.title="Time Range",opt.action&&"edit"===opt.action?s.title+=" - Edition":s.title="New "+s.title),s._opt=opt,window.edit=s,s.days=function(){var o={label:"Day",selected:"",items:[],val:null,select:function(val){o.items.forEach(function(v){v.val.toString()==val.toString()&&o.click(v)})},click:function(v){o.selected=v.label||v,o.val=v.val,s.start.val&&(s.start.val=moment(s.start.val),s.start.val.day("-1"===o.val.toString()?1:o.val)),s.end.val&&(s.end.val=moment(s.end.val),s.end.val.day("-1"===o.val.toString()?1:o.val))}},m=moment();o.items.push({label:"(Choice a day)",val:""},{label:"Every day",val:"-1"});for(var x=1;7>=x;x++)m.day(x),o.items.push({label:m.format("dddd"),val:x});return o.selected=o.items[0].label,o}();var timePickerData=function(){return function(m){return{hstep:1,mstep:10,repeat:"",minDate:moment().date(1),val:m||moment().hour(9).minutes(0)}}}();if(s.start=timePickerData(opt.start),s.end=timePickerData(opt.end),s.repeat="none",s.daySelection=function(){return"none"!==s.repeat},s.datepicker={val:void 0,minDate:moment().add(1,"day"),maxDate:moment().add(2,"month"),initDate:new Date},s.$watch("repeat",function(v){"day"===v&&s.days.select(-1)}),s.validate=function(){if(!s.description,"week"==s.repeat&&"-1"===s.days.val.toString())return s.message("Choice a day","warning",2e3),!1;if("none"===s.repeat&&void 0==s.datepicker.val)return void s.message("Choice a day in the calendar","warning",2e3);if(!s.start.val)return void s.message("Choice a valid start time.");if(!s.end.val)return void s.message("Choice a valid end time.");if(moment(s.start.val).isAfter(moment(s.end.val)))return void s.message("Start time need  to be before end time.");try{var _d=moment(s.start.val);_d=moment(s.end.val),"none"===s.repeat&&(s.start.val=moment(s.datepicker.val).hour(moment(s.start.val).hour()).minutes(moment(s.start.val).minutes()).toDate(),s.end.val=moment(s.datepicker.val).hour(moment(s.end.val).hour()).minutes(moment(s.end.val).minutes()).toDate())}catch(e){return s.message("Invalid time","warning",2e3),!1}return!0},s.save=function(){if(s.validate()){$uibModalInstance.close();var rta={description:s.description||"",start:s.start.val,end:s.end.val,type:opt.type,repeat:s.repeat};"edit"==opt.action&&(rta._user=opt.item._user,rta._id=opt.item._id),opt.callback(rta)}},s.cancel=function(){$uibModalInstance.dismiss("cancel")},!opt.action)throw Error("directive timeRange open require arg.action");if("new"==opt.action,"edit"===opt.action){var start=moment(opt.item.start);s.repeat=opt.item.repeat,s.description=opt.item.description,s.start.val=opt.item.start,s.end.val=opt.item.end,opt.type=opt.item.type,s.days.val=start.day(),s.days.select(s.days.val),"day"==s.repeat&&(s.days.val=-1),"none"==s.repeat&&(s.datepicker.val=opt.item.start)}}})}}}}),app.directive("removeHidden",function($rootScope,$timeout,$compile){return{restrict:"A",link:function(scope,el,attrs){$rootScope.dom(function(){el.removeClass("hidden")},2e3)}}}),function(){var app=angular.module("diags_ctrl_settings",[]);app.controller("diags_ctrl_settings",["server","$scope","$rootScope",function(db,s,r){function validNumber(input){var rta=!input;return rta?!1:(rta=isNaN(input),rta?!1:!!$U.numberBetween(input,0,500))}return s.deleteAll=function(t){r.openConfirm({message:"You want to delete all the objects of type "+t+" ?",data:{title:"Delete Confirmation"}},function(){db.ctrl(t,"removeWhen",{}).then(function(res){res.ok&&r.okModal("All the objects of type "+t+" were deleted from the database.")})})},$U.expose("s",s),r.toggleNavbar(!0),r.secureSection(s),r.userIs(["diag","client"])?r.handleSecurityRouteViolation():($U.expose("s",s),s.months=function(){return moment.monthsShort().map(function(m,k){return k+1+" - "+m})},s.menuItems={Texts:"texts",Notifications:"notifications",Logs:"logs",Tools:"tools","Price Modifiers":"price-modifiers",Documentation:"documentation",Database:"settings-database","Extract Data":"settings-exportation","Invoice Template":"settings-invoice"},s.priceModifiers={"Today Monday to Friday (+%)":"todayMondayToFriday","Today Saturday (+%)":"todaySaturday","Today Sunday (+%)":"todaySunday","Tomorrow Monday to Friday (+%)":"tomorrowMondayToFriday","Tomorrow Saturday (+%)":"tomorrowSaturday","Tomorrow Sunday (+%)":"tomorrowSunday","Monday to Friday (+%)":"mondayToFriday","Saturday (+%)":"saturday","Sunday (+%)":"sunday"},s.item={pricePercentageIncrease:{todayMondayToFriday:30,todaySaturday:50,todaySunday:130,tomorrowMondayToFriday:10,tomorrowSaturday:40,tomorrowSunday:110,mondayToFriday:0,saturday:30,sunday:100,VATRate:20}},s.validate=function(){var rules=[];for(var x in s.item.pricePercentageIncrease)rules.push([validNumber(s.item.pricePercentageIncrease[x]),"==",!1,x+" valid value in  0 .. 500"]);$U.ifThenMessage(rules,r.warningMessage,s.save)},s.save=function(){db.ctrl("Settings","save",s.item).then(function(d){d.ok&&r.infoMessage("Changes saved")})},s.read=function(){db.ctrl("Settings","getAll",{}).then(function(r){r.ok&&r.result.length>0?s.item=r.result[0]:s.save()})},s.read(),s.input={file:null},s["import"]={texts:function(){if(!s.input.file)return r.warningMessage("Select a file");var reader=new FileReader;reader.onload=function(theFile){return function(e){try{var arr=JSON.parse(window.decodeURIComponent(e.target.result));arr.map(function(o){return delete o._id,o}),console.info(arr),r.openConfirm({message:"Upload "+arr.length+" items? Data will be replaced."},function(){db.ctrl("Text","importAll",{items:arr}).then(function(res){res.ok&&r.okModal({message:"Data uploaded ok."})})})}catch(ex){r.warningMessage("Import issue, try later."),console.warn(ex)}}}(s.input.file),reader.readAsText(s.input.file)}},s.reports={input:{month:moment().month(),diagSeparator:", ",fileName:"report.csv"},texts:{all:function(){db.ctrl("Category","getAll",{__select:"code description _parent"}).then(function(rr){
var cats=rr.result;cats.map(function(item){if(item._parent){var _p=_.cloneDeep(cats.filter(function(c){return c._id==item._parent})[0]);delete _p._id,item._parent=_p}}),db.ctrl("Text","getAll",{__select:"_category code description content"}).then(function(res){res.ok&&res.result&&(res.result.map(function(item){delete item._id,delete item._v,item._category=cats.filter(function(c){return c._id==item._category})[0]}),res.result.map(function(item){delete item._category._id,delete item._category._v}),s.reports.input.fileName="text_"+res.result.length+"_items_"+r.momentDateTime(Date.now()).toString().replaceAll(" ","_")+".json",s.download(res.result,!0))})})}},orders:{monthReportFilename:"report_orders_month_.csv",monthReport:function(){var date=moment().month(parseInt(s.reports.input.month));s.reports.orders.monthReportFilename="report_orders_month_"+date.format("MMMM")+".csv",db.ctrl("Order","getAll",{__select:"_id status _diag address start price priceHT revenueHT diagRemunerationHT diags deliveredAt",__populate:{_diag:"firstName lastName"},__rules:{status:{$in:["completed","delivered"]},deliveredAt:{$gte:date.startOf("month").toDate().toString(),$lt:date.endOf("month").toDate().toString()}}}).then(function(res){if(res.ok){console.info(res.result);var rta=[];res.result.forEach(function(d){rta.push({orderID:d._id,start_date:r.momentDateTime(d.start),delivered_date:r.momentDateTime(d.deliveredAt),status:d.status,diag_fullname:d._diag.firstName+" "+d._diag.lastName,address:d.address,diags_list:_.map(_.pickBy(d.diags,function(a){return 1==a}),function(v,k){return k}).join(s.reports.input.diagSeparator),priceTTC:d.price,priceHT:d.priceHT,revenueHT:d.revenueHT,diagRemunerationHT:d.diagRemunerationHT})}),s.download(rta)}}),console.log("monthReport! gte ",r.momentDateTime(date.startOf("month").toDate()),"lt",r.momentDateTime(date.endOf("month").toDate()))}}},void(s.download=function(data,isJSON){return isJSON=isJSON||!1,0==data.length?r.okModal("No results"):void r.openConfirm({message:data.length+" items found, extract?",data:{title:isJSON?"Confirmation":"Extract Confirmation for "+moment().month(parseInt(s.reports.input.month)).format("MMMM")}},function(){isJSON?$U.downloadContent(window.encodeURIComponent(JSON.stringify(data)),s.reports.input.fileName):$U.downloadContent($U.toCSV({data:data}),s.reports.orders.monthReportFilename)})}))}]),app.controller("ctrl-settings-invoice",["server","$scope","$rootScope","$routeParams","focus",function(db,s,r,params){function check(){"undefined"!=typeof window.tinymce?r.dom(init):setTimeout(check,100)}function initTinyMCE(){if("undefined"!=typeof window.tinyMCE)for(var length=window.tinyMCE.editors.length,i=length;i>0;i--)window.tinyMCE.editors[i-1].remove();tinymce.init({selector:"#editor",theme:"modern",height:300,plugins:["advlist autolink link image lists charmap print preview hr anchor pagebreak spellchecker","searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking","save table contextmenu directionality emoticons template paste textcolor"],content_css:"css/diags.design.css",toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media fullpage | forecolor backcolor emoticons"})}function init(){initTinyMCE(),r.dom(s.read,0)}$U.expose("s",s),s.item={code:"",description:"",content:"",updatedByHuman:!0},check(),s.variables={"{{LOGO}}":"Diagnostical Logo","{{ORDER_DESCRIPTION}}":"Ex: Pack Vent: ...","{{ADDRESS}}":"Diag Address","{{CLIENT_FULLNAME}}":"Particular Client / Agency / Other first & last name","{{CLIENT_FIRSTNAME}}":"Particular Client / Agency / Other first name","{{CLIENT_LASTNAME}}":"Particular Client / Agency / Other last name","{{CLIENT_EMAIL}}":"Particular Client / Agency / Other email","{{CLIENT_ADDRESS}}":"Particular Client / Agency / Other address","{{LANDLORDFULLNAME}}":"Landlord Fullname (Agency / Other only)","{{LANDLORDEMAIL}}":"Landlord Email (Agency / Other only)","{{LANDLORDPHONE}}":"Landlord Phone (Agency / Other only)","{{LANDLORDADDRESS}}":"Landlord Address (Agency / Other only)","{{CREATEDAT}}":"Order creation date Ex: 16/06/2016 10h29","{{START}}":"Order diag start date Ex: 16/06/2016 10h29","{{END}}":"Order diag start date Ex: 16/06/2016 10h29","{{PRICE}}":"Order TTC Price","{{PRICEHT}}":"Order HT Price","{{VATRATE}}":"Order VAT Rate Applied","{{VATPRICE}}":"Order VAT Price Applied","{{REVENUEHT}}":"Diagnostical Revenue HT Price","{{DIAGREMUNERATIONHT}}":"Diag Remuneration HT"},db.ctrl("Order","get",{__populate:{_client:"email firstName lastName landlordFullName landlordEmail address"}}).then(function(res){res.ok&&(s.randomOrder=res.result)}),s.preview=function(){if(!s.randomOrder)return r.warningMessage("At least one Order saved in DB is required.");s.item.content=window.encodeURIComponent(tinymce.activeEditor.getContent());var html=window.encodeURIComponent($D.OrderReplaceHTML(window.decodeURIComponent(s.item.content),s.randomOrder,r));r.ws.ctrl("Pdf","view",{html:html}).then(function(res){if(res.ok){s.save();var win=window.open(res.result,"_blank");win.focus()}else r.warningMessage("Server Issue, try later.")})},s.read=function(){db.ctrl("Category","createUpdate",{code:"DIAGS_SETTINGS",__match:["code"]}).then(function(_res){if(_res&&_res.ok&&_res.result){var _category=_res.result._id;db.ctrl("Text","get",{_category:_category,code:"INVOICE"}).then(function(res){res.ok?res.result?(s.item=res.result,tinymce.activeEditor.setContent(window.decodeURIComponent(s.item.content))):db.ctrl("Text","createUpdate",{_category:_category,code:"INVOICE",description:"diags-invoice-template",content:window.encodeURIComponent("&nbsp;"),__match:["code"]}).then(function(res){res.ok&&res.result&&(s.item=res.result,tinymce.activeEditor.setContent(window.decodeURIComponent(s.item.content)))}):r.warningMessage("Server issue while reading item. Try later.")})}})},s.save=function(){return s.item.code?s.item.description?s.item._category?(s.item.updatedByHuman=!0,s.item.content=window.encodeURIComponent(tinymce.activeEditor.getContent()),void db.ctrl("Text","save",s.item).then(function(){r.infoMessage("Changes saved",5e3)})):r.warningMessage("Page Section required"):r.warningMessage("Description required"):r.warningMessage("Code required")}}])}(),function(){var app=angular.module("diags_ctrl_contact_form",[]);app.controller("diags_ctrl_contact_form",["server","$timeout","$scope","$rootScope","$uibModal",function(db,$timeout,s,r,$uibModal){s._email={},s.send=function(){db.ctrl("Notification","ADMIN_NEW_CONTACT_FORM_MESSAGE",s._email).then(function(d){d.ok?r.infoMessage("Message envoyé"):r.infoMessage("Problème de serveur , réessayer plus tard")})},s.validate=function(){$U.ifThenMessage([[!s._email.fullname,"==",!0,"Prénom Nom requis"],[!s._email.email,"==",!0,"Email requis"],[!s._email.phone,"==",!0,"Phone requis"],[!s._email.message,"==",!0,"Message requis"]],function(m){s.warningMsg(m[0],1e4)},s.send)}}])}(),function(){var app=angular.module("diags_ctrl_tools",[]);app.controller("diags_ctrl_tools",["server","$timeout","$scope","$rootScope","$uibModal",function(db,$timeout,s,r,$uibModal){$U.expose("s",s),s.dtpMin=moment().toDate().toString(),s.datetimepicker={start:moment().add(1,"month")},s.name="Tools"}])}(),angular.module("app.run-calendar",["mwl.calendar"]).config(function(calendarConfig){calendarConfig.dateFormatter="moment",calendarConfig.displayEventEndTimes=!0,calendarConfig.showTimesOnWeekView=!0}),function(){var app=angular.module("app.admin",[]);app.controller("adminDashboard",["server","$scope","$rootScope",function(db,s,r){r.toggleNavbar(!0),r.secureSection(s)}]),app.directive("adminBalance",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/diags/backoffice/partials/admin-balance.html",link:function(s,elem,attrs){var r=$rootScope,ws=server;attrs.name;r.logger.addControlledErrors(["StripeConnectionError"]),ws.ctrl("Payment","balance").then(function(data){if(!data.ok)return r.notify(data.err&&data.err.message||"Server error when connecting with Stripe.");var b={},out=data.result;b.available=_.sumBy(out.available,function(o){return o.amount})/100,b.pending=_.sumBy(out.pending,function(o){return o.amount})/100,b.livemode=out.livemode,s.b=b}),ws.ctrl("Stats","general").then(function(data){s.g=data.result})}}}),app.directive("adminTurnover",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server,$mongoosePaginate){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){function payload(){var data={__populate:{_order:"_id info"}};return data=Object.assign(data,s.model.filter.payload||{})}function update(items,cb){dbPaginate.ctrl(payload(),s.model,{autoResolve:!0,callback:cb})}function sync(){db.ctrl("Payment","syncTransactions",{_user:r.session()._id}).then(function(res){console.info("syncTransactions",res),s.model.filter.update()})}var r=$rootScope,db=server,dbPaginate=(attrs.name,$mongoosePaginate.get("StripeTransaction"));r.setCurrentCtrl(s),s.title="Stripe  transactions",s.model={init:function(){return s.model.filter.firstTime()},filter:{template:"adminBalanceFilter",update:update,rules:{created:"month-range"}},pagination:{itemsPerPage:10},paginate:function(cb){update(null,cb)},months:function(){return moment.monthsShort().map(function(m,k){return k+1+" - "+m})},click:function(item,index){var data={};return db.localData().then(function(d){Object.assign(data,d)}),item._order?void r.route("orders/edit/"+item._order._id):r.infoMessage("There is not an Order associated",4e3)},buttons:[{label:"Rafraîchir",type:function(){return"btn diags-btn azure-radiance spacing-h-1"},click:function(){return update()}},{label:"Sync avec Stripe",type:function(){return"btn diags-btn azure-radiance spacing-h-1"},click:function(){return sync()}}],columns:[{label:"Description",name:"description"},{label:"Quantité (EUR)",labelCls:function(){return{"text-right":!0}},name:"amount",align:"right"},{label:"Stripe Fee (EUR)",labelCls:function(){return{"text-right":!0}},name:"stripeFee",align:"right"},{label:"Création",name:"created",format:function(v,item){return r.momentDateTime(item.created)}}],items:[]},update()}}}),app.directive("adminsList",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){},controller:function($scope,$element,$attrs,$transclude){function update(){db.ctrl("User","getAll",{userType:"admin"}).then(function(res){return s.model.update(res.result)})}var r=$rootScope,db=server,s=$scope;s.title="",r.routeParams({item:{userType:"admin"},prevRoute:"administrators"}),s.model={click:function(item,index){r.routeParams({item:item}),r.route("administrators/edit/"+item._id)},buttons:[{label:"Rafraîchir",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return update()}},{label:"Créer admin",type:function(){return"btn diags-btn bg-azure-radiance"},click:function(){return r.route("administrators/edit/-1")}}],columns:[{label:"Email",name:"email"},{label:"Téléphones",name:"fixedTel",format:function(v,item){return v="",item.fixedTel&&(v="TF: "+item.fixedTel),item.cellPhone&&(v?v+=" M: "+item.cellPhone:v="M: "+item.cellPhone),v}}],items:[]},update()}}})}(),function(){function updateCategorySelectData(s,db,cb){s.categories=[],db.ctrl("Category","get",{code:"DIAGS"}).then(function(r){r&&r.ok&&r.result&&db.ctrl("Category","getAll",{_parent:r.result._id}).then(function(r){r&&r.ok&&r.result&&(s.categories=r.result,cb&&cb())})})}app.directive("ckEditor",["$compile",function(compile){return{restrict:"A",link:function(s,el,attrs){function init(){"undefined"!=typeof window.CKEDITOR?CKEDITOR.replace(attrs.name):setTimeout(init,1e3)}init()}}}]),app.controller("ctrl-text-edit",["server","$scope","$rootScope","$routeParams","focus",function(db,s,r,params){function check(){"undefined"!=typeof window.tinymce?r.dom(init):setTimeout(check,100)}function setData(decodedData){if(isCKEditor()){if(!CKEDITOR)return setTimeout(function(){return setData(decodedData)},500);CKEDITOR.instances.editor.setData(decodedData)}else tinymce.activeEditor.setContent(decodedData)}function initTinyMCE(){if("undefined"!=typeof window.tinyMCE)for(var length=window.tinyMCE.editors.length,i=length;i>0;i--)window.tinyMCE.editors[i-1].remove();tinymce.init({selector:"#editor",theme:"modern",height:300,plugins:["advlist autolink link image lists charmap print preview hr anchor pagebreak spellchecker","searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking","save table contextmenu directionality emoticons template paste textcolor"],content_css:"css/diags.design.css",toolbar:"insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media fullpage | forecolor backcolor emoticons"})}function init(){isCKEditor()||initTinyMCE(),params&&params.id&&"-1"!==params.id.toString()?(s.item._id=params.id,r.dom(s.read,0)):r.params.code&&db.ctrl("Text","get",{code:r.params.code}).then(function(res){res.ok&&res.result&&(s.item._id=res.result._id,r.dom(s.read,0))})}$U.expose("s",s),s.item={code:"",description:"",content:"",updatedByHuman:!0};var isCKEditor=function(){return r.params.code||r.params.ckeditor};s.isCKEditor=isCKEditor,updateCategorySelectData(s,db),isCKEditor()?init():check(),s.read=function(){db.ctrl("Text","get",{_id:s.item._id}).then(function(res){res.ok?(s.item=res.result,setData(window.decodeURIComponent(s.item.content))):r.warningMessage("Server issue while reading item. Try later.")})},s.save=function(){return s.item.code?s.item.description?s.item._category?(s.item.updatedByHuman=!0,isCKEditor()?s.item.content=window.encodeURIComponent(CKEDITOR.instances.editor.getData()):s.item.content=window.encodeURIComponent(tinymce.activeEditor.getContent()),void db.ctrl("Text","save",s.item).then(function(){r.route("texts"),r.params.code&&r.routeParams({_text:s.item})})):r.warningMessage("Page Section required"):r.warningMessage("Description required"):r.warningMessage("Code required")},s["delete"]=function(){s.confirm("Delete "+s.item.code+" ?",function(){db.ctrl("Text","remove",{_d:s.item._id})})}}]),app.directive("textsList",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server,$mongoosePaginate){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){},controller:function($scope,$element,$attrs,$transclude){function update(items,cb){var data={__populate:{_category:"code"},__sort:"-createdAt"};data=Object.assign(data,s.model.filter.payload),dbPaginate.ctrl(data,s.model).then(function(res){cb?cb(res.result):s.model.update(res.result,null)})}var r=$rootScope,db=server,s=$scope,dbPaginate=$mongoosePaginate.get("Text");$U.expose("s",s),r.routeParams({prevRoute:"texts"}),s.model={init:function(){updateCategorySelectData(s.model,db,function(){s.model.filter.firstTime()})},filter:{store:"TEXTS_LIST",template:"textsFilter",update:update,rules:{code:"contains",_category:"match"}},pagination:{itemsPerPage:10},paginate:function(cb){update(null,cb)},click:function(item,index){r.routeParams({item:item}),r.route("texts/edit/"+item._id)},buttons:[{label:"Rafraîchir",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return s.model.filter.filter()}},{label:"Clear Filters",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return s.model.filter.clear&&s.model.filter.clear()}},{label:"Créer",type:function(){return"btn diags-btn bg-azure-radiance margin-right-1"},click:function(){return r.route("texts/edit/-1")}}],columns:[{label:"Page Section",name:"_category",format:function(v,item){return item._category&&item._category.code||""}},{label:"Code",name:"code"},{label:"Description",name:"description"},{label:"UpdatedAt",name:"updatedAt",format:function(v,item){return r.momentFormat(item.updatedAt,"DD-MM-YY HH:mm")}},{label:"Edit",disabled:!0,name:"updatedAt",format:function(v,item){return'<i class="fa fa-pencil-square-o link" ng-click="model.editItem(item)" aria-hidden="true"></i>'}}],editItem:function(item){window.open(window.location.origin+"/admin#/texts/edit/"+item._id,"_blank")},items:[],records:{label:"Records",show:!0}}}}})}();var srv=angular.module("app.routes",[]);srv.config(["$routeProvider",function($routeProvider,$rootScope){$routeProvider.when("/mentions-legales",{templateUrl:"views/diags/legal-mentions.html"}).when("/conditions-generales-utilisation",{templateUrl:"views/diags/general-conditions.html"}).when("/ernt",{templateUrl:"views/diags/ernmt.html"}).when("/faq",{templateUrl:"views/diags/faq.html"}).when("/contactez-nous",{templateUrl:"views/diags/contact-us.html"}).when("/login",{templateUrl:"views/diags/login.html"}).when("/diag-inscription",{templateUrl:"views/diags/diag-inscription.html"}).when("/",{templateUrl:"views/diags/backoffice/dashboard.html"}).when("/dashboard",{templateUrl:"views/diags/backoffice/dashboard.html"}).when("/global-calendar",{templateUrl:"views/diags/backoffice/global-calendar.html"}).when("/settings",{templateUrl:"views/diags/backoffice/settings/diags-settings.html"}).when("/settings-invoice",{templateUrl:"views/diags/backoffice/settings/diags-settings-invoice.html"}).when("/settings-database",{templateUrl:"views/diags/backoffice/settings/diags-settings-database.html"}).when("/settings-database-text",{templateUrl:"views/diags/backoffice/settings/diags-settings-database-text.html"}).when("/settings-exportation",{templateUrl:"views/diags/backoffice/settings/diags-settings-exportation.html"}).when("/settings-exportation-orders",{templateUrl:"views/diags/backoffice/settings/diags-settings-exportation-orders.html"}).when("/settings-exportation-texts",{templateUrl:"views/diags/backoffice/settings/diags-settings-exportation-texts.html"}).when("/notifications",{templateUrl:"views/diags/backoffice/notification/notification-list.html"}).when("/notifications/edit/:id",{templateUrl:"views/diags/backoffice/notification/notification-edit.html"}).when("/logs",{templateUrl:"views/diags/backoffice/log/log-list.html"}).when("/logs/edit/:id",{templateUrl:"views/diags/backoffice/log/log-edit.html"}).when("/administrators",{templateUrl:"views/diags/backoffice/admin/admins.html"}).when("/administrators/edit/:id",{templateUrl:"views/diags/backoffice/admin/admin.edit.html"}).when("/exceptions",{templateUrl:"views/diags/backoffice/exception/exception.list.html"}).when("/exceptions/edit/:id",{templateUrl:"views/diags/backoffice/exception/exception.edit.html"}).when("/texts",{templateUrl:"views/diags/backoffice/text/text-list.html"}).when("/texts/edit/:id",{templateUrl:"views/diags/backoffice/text/text-edit.html"}).when("/clients",{templateUrl:"views/diags/backoffice/client/clients.html"}).when("/clients/edit/:id",{templateUrl:"views/diags/backoffice/client/client.edit.html"}).when("/price-modifiers",{templateUrl:"views/diags/backoffice/price-modifiers.html"}).when("/documentation",{templateUrl:"views/diags/backoffice/diags-docs.html"}).when("/tools",{templateUrl:"views/diags/backoffice/tools.html"}).when("/tools/termites-check",{templateUrl:"views/diags/backoffice/tools.termites-check.html"}).when("/tools/datetime-picker-testing",{templateUrl:"views/diags/backoffice/tools/tools.datetimepicker-test.html"}).when("/diag/balance",{templateUrl:"views/diags/backoffice/diag/diag-balance.html"}).when("/diags",{templateUrl:"views/diags/backoffice/diag/diags.html"}).when("/diags/edit/:id",{templateUrl:"views/diags/backoffice/diag/diag.edit.html"}).when("/orders",{templateUrl:"views/diags/backoffice/order/orders.html"}).when("/orders/edit/:id",{templateUrl:"views/diags/backoffice/order/order.edit.html"}).when("/orders/view/:id",{templateUrl:"views/diags/backoffice/order/order.view.html"}).otherwise({redirectTo:"/"})}]),function(){var app=angular.module("app.tools",[]);app.controller("termitesChecker",["server","$scope","$rootScope",function(db,s,r){s.item=[],s.check=function(){return s.item.address?void s.departmentHasTermites():r.notify("Address required","warning")},s.departmentHasTermites=function(){if(s.item.department){var code=s.item.postCode.substring(0,2),has=_.includes(s.termitesDepartments.map(function(v){return v.toString()}),code);s.item.hasTermites=has?"Yes":"No",s.item.message=code}else s.item.message="department expected."},s.termites=function(){return s.termitesDepartments?s.termitesDepartments.join(", "):""},db.localData().then(function(data){Object.assign(s,data)})}])}();var app=angular.module("app.calendar",[]);app.directive("globalCalendar",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.diag.calendar.html",link:function(s,elem,attrs){function update(){ws.ctrl("Order","getAll",{__rules:{status:{$ne:["created"]}},__select:"_client _diag email start end status",__populate:{_client:"email firstName lastName",_diag:"email firstName lastName"}}).then(function(res){if(console.log(res),res.ok){var evts=[];res.result.forEach(function(v){v.diag=v._diag.firstName+", "+v._diag.lastName.toUpperCase().substring(0,1),evts.push({item:v,title:"Order (Status: "+v.status+", Diag: "+v.diag+")",type:"info",startsAt:moment(v.start).toDate(),endsAt:moment(v.end).toDate(),editable:!1,deletable:!1,draggable:!1,resizable:!1,incrementsBadgeTotal:!0,cssClass:"a-css-class-name"}),s.events=evts}),r.cache("global.calendar.events",s.events)}})}var r=$rootScope,ws=server,m=moment();m.year(),m.month();window.s=s,s.calendarView="year",s.views={label:"View Type",selected:s.calendarView,click:function(x){s.calendarView=x.label.toLowerCase(),s.views.selected=s.calendarView,r.dom()},items:[{label:"Day"},{label:"Week"},{label:"Month"},{label:"Year"}]},s.calendarDate=new Date,s.events=r.cache("global.calendar.events")||[],s.eventClicked=function(calendarEvent){r.params={item:calendarEvent.item,prevRoute:"global-calendar"},r.route("orders/edit/"+calendarEvent.item._id)},update()}}}),function(){var vars={TITLE:"",TPL_CRUD:"views/directives/directive.fast-crud.html",TPL_CRUD_EDIT:"views/diags/backoffice/notification/notification.edit.html"},app=angular.module("app.notifications",[]);app.controller("notificationEdit",["$rootScope","$scope","server","crud","$routeParams",function(r,s,db,crud,params){r.setCurrentCtrl(s),s.send=function(){var item=s.item;s.confirm("Confirm sending to "+item.to+"?",function(){db.ctrl("Email","send",{_user:item._user,_notification:item._id,html:item.contents,to:item.to,subject:item.subject}).then(function(d){console.info(d),r.infoMessage("Copy send to "+item.to),s.init()})})},crud.create({name:"Notification",routeParams:params,scope:s,defaults:{data:{message:"Write your message"}},save:{after:{goBack:!0}},routes:{back:"notifications"},modals:{confirm:"confirm","delete":{description:function(){return"Delete item "+s.item.type+" "+r.momentDateTime(s.item.created)}}},events:{after:{save:[function(){}]}},validate:{options:function(s){return[[s.item.message,"==",!1,"Message required"]]}}}).init()}]),app.directive("sectionNotifications",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server,$mongoosePaginate){return{restrict:"AE",replace:!0,scope:{},templateUrl:vars.TPL_CRUD,link:function(s,elem,attrs){function update(items,cb){if(items)return void s.model.update(items);var data={__populate:{_user:"email",_config:""},__sort:"-createdAt"};data=Object.assign(data,s.model.filter.payload),dbPaginate.ctrl(data,s.model).then(function(res){cb?cb(res.result):s.model.update(res.result,null)}).on("cache",function(res){s.model.update(res.result,null)})}var r=$rootScope,db=server,dbPaginate=$mongoosePaginate.get("Notification");s.title=vars.TITLE,r.logger.addControlledErrors(["SENDING_DISABLED_TYPE"]),$U.expose("s",s);s.model={init:function(){s.model.filter.firstTime()},filter:{store:"NOTIFICATIONS_LIST",template:"notificationFilter",update:update,rules:{to:"contains",_user:"match"}},pagination:{itemsPerPage:5},paginate:function(cb){update(null,cb)},getUsers:function(val){return db.http("User","getAll",{__regexp:{email:val}}).then(function(res){return res.data.result})},remove:function(item,index){var rule={_id:item._id};item._config.notifications=_.pull(item._config.notifications,item._id),db.ctrl("UserNotifications","update",item._config).then(function(d){d.ok&&db.ctrl("Notification","remove",rule).then(function(d){update()})})},buttonsTpl:vars.TPL_CRUD_BUTTONS,tfoot:vars.TPL_CRUD_TFOOT,click:function(item,index){s.item=item,r.routeParams({item:item}),r.route("notifications/edit/"+item._id)},buttons:[{label:"Rafraîchir",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return s.model.filter.filter()}},{label:"Clear Filters",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return s.model.filter.clear&&s.model.filter.clear()}}],columns:[{label:"User",name:"to",format:function(x,item){return item._user&&item._user.email||""}},{label:"To",name:"to"},{label:"Subject",name:"subject"},{label:"Sended",name:"sended",format:function(v){return v?"Yes":"No"}},{label:"Created",name:"createdAt",format:function(v){return r.momentFormat(v,"DD-MM-YY HH:mm")}}],records:{label:"Records",show:!0}}}}})}();var app=angular.module("app.login",[]);app.controller("adminLogin",["server","$scope","$rootScope",function(db,s,r){r.__hideNavMenu=!0,r.navShow=!0,s.show=!1,$U.once("route-exit:login",function(url){r.__hideNavMenu=!1}),s.login=function(){var session=r.session();session.email&&session.expire<(new Date).getTime(),db.ctrl("User","login",r._login).then(function(res){res.ok&&null!=res.result?(r.session(res.result),r.route("dashboard")):(s.loginFailedTimes++,r.warningMessage("Incorrect login"))}).error(function(res){s.sendingRequest=!1,r.errorMessage("Server down, try later.")})},s.resetPassword=function(){return r._login.email?void db.ctrl("User","passwordReset",{email:r._login.email}).then(function(res){res.ok&&(r.message("Un nouveau mot de passe a été envoyé par e-mail","info",void 0,void 0,{duration:1e4}),s.loginFailedTimes=0,r.dom())}):r.warningMessage("Email required")};var params={email:$U.getParameterByName("email"),password:$U.getParameterByName("k")?window.atob($U.getParameterByName("k")):""};params.email&&(r._login.email=params.email),params.password&&(r._login.password=params.password),params.email&&params.password&&(console.log("adminLogin: lets try to sign-in from queryparameters"),s.login()),r.logged()?(db.ctrl("User","get",{_id:r.session()._id}).then(function(err,data){!err&&data.ok&&data.result&&r.session(data.result)}),r.route("dashboard")):s.show=!0}]),app.controller("adminLoginExternal",["server","$scope","$rootScope",function(db,s,r){s.login=function(){var session=r.session();session.email&&session.expire<(new Date).getTime(),db.ctrl("User","login",r._login).then(function(res){res.ok&&null!=res.result?(r.session(res.result),s.redirect()):r.warningMessage("Login incorrect")}).error(function(res){s.sendingRequest=!1,r.errorMessage("Server down, try later.")})},s.redirect=function(){var path="admin#/login?email="+r._login.email+"&k="+window.btoa(r._login.password||"dummy");r.routeRelative(path)},s.resetPassword=function(){return r._login.email?void db.ctrl("User","passwordReset",{email:r._login.email}).then(function(res){res.ok&&(r.message("Un nouveau mot de passe a été envoyé par e-mail","info",void 0,void 0,{duration:1e4}),r.dom())}):r.warningMessage("Email est requis")},s.userType=s.userType||"client",r.dom(function(){r.logged()&&r.session().userType==s.userType&&(r._login.email=r.session().email,r._login.password=r.session().password,s.redirect())},500),$U.expose("s",s)}]);var app=angular.module("app.user",[]);app.controller("adminUsers",["server","$scope","$rootScope",function(db,s,r){function read(){s.message("Loading . . .","info"),db.ctrl("User","getAll",{}).then(function(r){s.items=r.result,s.message("Loaded","success",1e3)})}return r.toggleNavbar(!0),r.secureSection(s),s.selectedItems=[],s.items=[],r.userIs(["diag","client"])?r.handleSecurityRouteViolation():(s.click=function(item,optionalRouteForEdition){r.route((optionalRouteForEdition||"users/edit/")+item._id)},s.create=function(optionalRouteForEdition){r.route(optionalRouteForEdition||"users/edit/-1")},s["delete"]=function(item){s.confirm("Remove "+s.selectedItems.length+" item/s?",function(){console.log("adminUsers:removeAll:in-progress"),s.message("deleting . . .","info"),s.requesting=!0,db.ctrl("User","removeAll",{ids:s.selectedItems}).then(function(res){s.requesting=!1,s.message("deleted","info"),read(),console.info("adminUsers:removeAll:success",r.data)}).error(function(err){s.requesting=!1,s.message("error, try later.","danger"),console.warn("adminUsers:removeAll:error",err)})})},s.select=function(){window.event&&window.event.stopPropagation()},void r.dom(read,0))}]),app.controller("adminUsersEdit",["server","$scope","$rootScope","$routeParams","tpl",function(db,s,r,params,tpl){function reset(){s.item=_.clone(s.original)}function read(){return r.userIs(["diag","client"])&&params.id!==r.session()._id?r.handleSecurityRouteViolation():(s.requesting=!0,void db.ctrl("User","get",{_id:params.id}).then(function(res){s.item=res.result,res.ok?s.types.click(s.item.userType):s.message("not found, maybe it was deleted!","warning",5e3)}))}function userHasRelatedOrders(cb){var time=function(d){return moment(d).format("HH:mm")},descr=function(_order){return _order.address+" ("+time(_order.start)+" - "+time(_order.end)+")"};return $U.MyPromise(function(resolve,error,emit){if("admin"===s.item.userType)return emit("no");var rules={__select:"start end address"};"client"===s.item.userType&&(rules._client=s.item._id),"diag"===s.item.userType&&(rules._diag=s.item._id),db.ctrl("Order","getAll",rules).then(function(data){if(data.ok&&data.result&&data.result.length>0){var relatedOrders=[];data.result.forEach(function(_order){relatedOrders.push(descr(_order))}),emit("yes",null,{relatedOrders:relatedOrders})}else emit("no")})})}if(r.toggleNavbar(!0),r.secureSection(s),r.dom(),$U.expose("s",s),s.item={email:"",password:""},r.params&&r.params.item&&(s.item=Object.assign(r.params.item),delete r.params.item),s.original=_.clone(s.item),s.types={selected:"(Choice a user type)",items:[{label:"Admin"},{label:"Diag"},{label:"Client"}],click:function(choice){if("string"!=typeof choice)s.item.userType=choice.label.toString().toLowerCase(),s.types.selected=choice.label;else for(var x in s.types.items)s.types.items[x].label.toString().toLowerCase()==choice.toString().toLowerCase()&&(s.types.selected=s.types.items[x].label,s.item.userType=s.types.items[x].label.toString().toLowerCase())}},params&&params.id&&"-1"!==params.id.toString())r.dom(read,1e3);else{if(r.userIs(["diag","client"]))return r.handleSecurityRouteViolation();reset()}s.back=function(){if(r.userIs(["diag","client"]))r.route("dashboard");else{if(r.params&&r.params.prevRoute){var _r=r.params.prevRoute;return delete r.params.prevRoute,r.route(_r)}console.warn("r.params.prevRoute required"),r.route("dashboard")}},s.notifyClientNewAccount=function(){db.ctrl("Notification","CLIENT_NEW_ACCOUNT",s.item).then(function(res){console.info("RTA",res.result)})},s.cancel=function(){s.back()},s.isCurrent=function(){return r.session()._id==s.item._id},s.isAdmin=function(){return"admin"==s.item.userType},s.isClient=function(){return"client"==s.item.userType},s.validate=function(){$U.ifThenMessage([[!s.item.userType,"==",!0,"User type est nécessaire"],[!s.item.firstName,"==",!0,"Prénom est nécessaire"],[!s.item.email,"==",!0,"Email est nécessaire"],[!s.item.password,"==",!0,"Password est nécessaire"],["admin"!==s.item.userType&&!s.item.clientType,"==",!0,"clientType est nécessaire"],[s.isClient()&&void 0==s.item.discount,"==",!0,"Discount est nécessaire"],[s.isClient()&&isNaN(s.item.discount),"==",!0,"Discount allowed values are 0..100"],[s.isClient()&&(s.item.discount<0||s.item.discount>100),"==",!0,"Discount allowed values are 0..100"]],function(m){
s.message(m[0],"warning",0,!0)},s.save)},s.save=function(){function _save(){db.ctrl("User","save",s.item).then(function(res){res.ok?(res.result&&res.result._id==r.session()._id&&r.session(res.result),s.message("saved","success"),s.back()):s.message("error, try later","danger")}).error(function(_err){s.message("error, try later.","danger")})}db.ctrl("User","getAll",{email:s.item.email,userType:s.item.userType,clientType:s.item.clientType}).then(function(data){data.result;if(data.result.length>0){var _item=data.result[0];s.item._id&&s.item._id==_item._id?_save():s.message("Email address in use.")}else _save()})},s["delete"]=function(){function _proceedDelete(){s.confirm("Delete User "+s.item.email+" ?",function(){db.ctrl("User","remove",{_id:s.item._id}).then(function(res){s.message("deleted","info"),reset(),s.back()}).error(function(_err){s.requesting=!1,s.message("error, try later.","danger")})})}userHasRelatedOrders().on("yes",function(_err,r){s.relatedOrders=r.relatedOrders||["data.relatedOrders required"],s.okModal({messageEl:tpl.compile("user.delete.associated-orders",s)},function(){delete s.relatedOrders})}).on("no",function(){_proceedDelete()})}}]),function(){var app=angular.module("app.log",[]);app.controller("logEdit",["$rootScope","$scope","server","crud","$routeParams",function(r,s,db,crud,params){r.setCurrentCtrl(s),crud.create({name:"Log",routeParams:params,scope:s,defaults:{data:{message:"Write your message"}},save:{after:{goBack:!0}},routes:{back:"logs"},modals:{confirm:"confirm","delete":{description:function(){return"Delete item "+s.item.type+" "+r.momentDateTime(s.item.created)}}},events:{after:{save:[function(){}]}},validate:{options:function(s){return[[s.item.message,"==",!1,"Message required"]]}}}).init()}]),app.directive("logList",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server,$mongoosePaginate){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){},controller:function($scope,$element,$attrs,$transclude){function update(cb){dbPaginate.ctrl({},s.model).then(function(res){return cb?cb(res.result):void s.model.update(res.result)})}var r=$rootScope,db=server,s=$scope,dbPaginate=$mongoosePaginate.get("Log");r.secureSection(s);var isClientOrDiag=r.userIs(["client","diag"]);return isClientOrDiag?r.handleSecurityRouteViolation():(s.title="Logs",r.routeParams({item:{userType:"admin"},prevRoute:"logs"}),void(s.model={init:function(){return update()},filter:{template:"logFilter",rules:{type:"contains"}},paginate:function(cb){update(cb)},click:function(item,index){r.routeParams({item:item}),r.route("logs/edit/"+item._id)},buttons:[{label:"Refresh",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return update()}},{label:"New Log",show:!1,type:function(){return"btn diags-btn bg-azure-radiance margin-right-1"},click:function(){return r.route("logs/edit/-1")}},{label:"Delete all",type:function(){return"btn diags-btn bg-blaze-orange"},click:function(){s.confirm("Sure?",function(){db.ctrl("Log","removeAll",{}).then(function(d){d.ok?(r.infoMessage("All records were deleted"),update(null)):r.warningMessage("Delete all fail, try later.")})})}}],columns:[{label:"Type",name:"type"},{label:"Message",name:"message",format:function(v,item){return item.message&&item.message.substring(0,100)+" . . ."||"Empty"}},{label:"Created",format:function(v,item){return r.momentFormat(item.createdAt,"DD-MM-YY HH[h]mm")}}],items:[],records:{label:"Records",show:!0}}))}}})}(),function(){var app=angular.module("app.diag",[]);app.directive("diagsList",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){},controller:function($scope,$element,$attrs,$transclude){function update(){db.ctrl("User","getAll",{userType:"diag"}).then(function(res){res.result=_.orderBy(res.result,["priority"],["asc"]),s.model.update(res.result)})}var r=$rootScope,db=server,s=$scope;s.title="",r.routeParams({prevRoute:"diags"}),s.model={click:function(item,index){r.routeParams({item:item}),r.route("diags/edit/"+item._id)},buttons:[{label:"Rafraîchir",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return update()}},{label:"Créer un nouveau",type:function(){return"btn diags-btn bg-azure-radiance"},click:function(){return r.route("diags/edit/-1")}}],columns:[{label:"Priorité",name:"priority"},{label:"Description",name:"firstName",format:function(x,o){return o.firstName+(o.lastName?", "+o.lastName:"")}},{label:"Email",name:"email"},{label:"Téléphones",name:"fixedTel",format:function(v,item){return v="",item.fixedTel&&(v="TF: "+item.fixedTel),item.cellPhone&&(v?v+=" M: "+item.cellPhone:v="M: "+item.cellPhone),v}},{label:"Reversement",name:"commission"},{label:"Activated",name:"commission",format:function(v,item){return!item.disabled}}],items:[]},update()}}}),app.directive("diagExceptionList",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server,$mongoosePaginate,$routeParams){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){function update(items,cb){if(items)return void s.model.update(items);var rules={__populate:{_user:"email"}};return r.userIs("diag")&&(rules._user=r.session()._id),params&&params.id&&(rules._user=params.id),rules._user&&"-1"!=rules._user.toString()?void dbPaginate.ctrl(rules,s.model).then(function(res){res.ok&&(cb?cb(res.result):s.model.update(res.result,null))}):console.warn("time-range: insufficients rules.")}var r=$rootScope,dbPaginate=$mongoosePaginate.get("TimeRange"),params=$routeParams,db=server;attrs.name;r.secureSection(s),r.userIs("client")&&r.handleSecurityRouteViolation();var userId=function(){return r.userIs("diag")?r.session()._id:params.id?params.id:null},prevRoute=function(){return r.userIs("diag")?"dashboard":params.id?"diags/edit/"+params.id:"exceptions"},columns=[];r.userIs("admin")&&null==(params&&params.id||null)&&columns.push({label:"Diag",name:"_user",format:function(v,item){return item._user.email}}),columns.push({label:"Description",name:"description"},{label:"de",name:"start",format:function(v,item){return"none"!==item.repeat?r.momentTime(item.start):r.momentDateTimeWords2(item.start)}},{label:"à",name:"end",format:function(v,item){return"none"!==item.repeat?r.momentTime(item.end):r.momentDateTimeWords2(item.end)}},{label:"Règle",name:"repeat",format:function(v,item){return"none"==item.repeat?"Indisponibilité spécifique":"day"==item.repeat?"Indisponibilité tous les jours":"week"==item.repeat?"Indisponibilité toutes les semaines":"Error"}}),s.model={title:"Indisponibilités",paginate:function(cb){return update(null,cb)},init:function(){return update()},remove:function(item,index){var msg="Delete Indisponibilité  "+item.description+" / De "+r.momentDateTime(item.start)+" À "+r.momentDateTime(item.end);s.confirm(msg,function(){db.ctrl("TimeRange","remove",{_id:item._id}).then(function(){update()})})},click:function(item,index){r.routeParams({item:item,prevRoute:prevRoute()}),r.route("exceptions/edit/"+item._id)},buttons:[{label:"Rafraichir",type:function(){return"btn diags-btn bg-azure-radiance margin-right-quarter margin-bottom-quarter"},click:function(){return update()}},{label:"Ajouter une indisponibilité",type:function(){return"btn diags-btn bg-azure-radiance margin-bottom-quarter"},click:function(){r.routeParams({item:{_user:userId()},prevRoute:prevRoute()}),r.route("exceptions/edit/-1")}}],columns:columns}}}}),app.controller("diagExceptionEdit",["server","$scope","$rootScope","$routeParams","focus",function(db,s,r,params,focus){var _s$item;s.item=(_s$item={start:null,end:null,repeat:"none",description:""},_defineProperty(_s$item,"start",new Date),_defineProperty(_s$item,"end",new Date),_s$item);var isEdit="-1"!==params.id.toString();$U.expose("edit",s),s.days=function(){var o={label:"Day",selected:"",items:[],val:-1,select:function(val){o.items.forEach(function(v){v.val.toString()==val.toString()&&o.click(v)})},click:function(v){o.selected=v.label||v,o.val=v.val,s.item.start&&(s.item.start=moment(s.item.start).day("-1"===o.val.toString()?1:o.val)._d),s.item.end&&(s.item.end=moment(s.item.end).day("-1"===o.val.toString()?1:o.val)._d)}},m=moment();o.items.push({label:"(Choice a day)",val:""},{label:"Every day",val:"-1"});for(var x=1;7>=x;x++)m.day(x),o.items.push({label:m.format("dddd"),val:x});return s.$watch("repeat",function(v){"day"===v&&s.days.select(-1)}),o.selected=o.items[0].label,o}(),s.timeRange={hstep:1,mstep:10,minDate:moment().date(1)},s.datepicker={minDate:moment().toDate().toString(),maxDate:moment().add(60,"day").toDate().toString(),initDate:new Date},s.getDiags=function(val){return db.http("User","getAll",{userType:"diag",__rules:{disabled:{$ne:!0}},__regexp:{email:val}}).then(function(res){return res.data.result})},s.onLoad=function(isNew){return isNew?(s.item.start=moment().hour(9).minutes(0)._d,void(r.params&&r.params.item&&(s.item=Object.assign(s.item,r.params.item),"string"==typeof s.params.item._user&&db.ctrl("User","get",{_id:r.params.item._user,__select:"email"}).then(function(d){d.ok&&(s.item._user=d.result)}),delete r.params.item))):void("week"==s.repeat&&s.days.select(moment(s.item.start).day()))},isEdit?r.params&&r.params.item?(s.item=r.params.item,r.params.item=null,s.onLoad()):db.ctrl("TimeRange","get",{_id:params.id,__populate:{_user:"email"}}).then(function(d){d.ok?(s.item=d.result,s.onLoad()):r.notify({message:"Loading error, try later",type:"warning"})}):s.onLoad(!0),s.save=function(){db.ctrl("TimeRange","createUpdate",s.item).then(function(result){r.route(r.params&&r.params.prevRoute||"dashboard")})},s.cancel=function(){return r.route(r.params&&r.params.prevRoute||"dashboard")},s["delete"]=function(){var msg="Delete "+s.item.description+" "+s.item.startFormat+" - "+s.item.endFormat+" ("+s.item.dayFormat+")";s.confirm(msg,function(){db.ctrl("TimeRange","remove",{_id:s.item._id}).then(function(){s.cancel()})})},s.rangeCollideWithOrder=function(yes,no){db.ctrl("Order","getAll",{__select:"start end",_diag:s.item._user}).then(function(d){if(d.ok){var yesFlag=!1;if(d.result.forEach(function(v){return $D.rangeCollide(v.start,v.end,s.item.start,s.item.end)?(yesFlag=!0,yes(v)):void 0}),yesFlag)return;return no()}return console.warn("rangeCollide order fetch error"),no()}).error(function(){console.warn("rangeCollide order fetch error")})},s.validate=function(){return s.item?s.item._user?void s.rangeCollideWithOrder(function(order){return r.warningMessage("An order exists for this date.")},function(){$U.ifThenMessage([[!s.item._user,"==",!0,"Diag required"],["week"==s.item.repeat&&"-1"===s.days.val.toString(),"==",!0,"Choice a day"],[_.isNull(s.item.start)||_.isUndefined(s.item.start),"==",!0,"Start date required"],[_.isNull(s.item.end)||_.isUndefined(s.item.end),"==",!0,"Start date required"],[moment(s.item.start||null).isValid(),"==",!1,"Start date invalid"],[moment(s.item.end||null).isValid(),"==",!1,"End date invalid"],["none"!=s.item.repeat&&moment(s.item.end).isValid()&&moment(s.item.start).isValid()&&!moment(s.item.end).isSame(moment(s.item.start),"day"),"==",!0,"Start / End dates need to be in the same day."],[moment(s.item.end).isValid()&&moment(s.item.end).isBefore(moment(s.item.start),"hour"),"==",!0,"End date cannot be lower than Start date"]],function(m){"string"!=typeof m[0]?r.notify(m[0](),"warning"):r.notify(m[0],"warning")},s.save)}):console.warn("item._user missing."):console.warn("item missing.")}}])}(),function(){app.controller("diagInscription",["server","$scope","$rootScope","$routeParams",function(db,s,r,params){function save(){function _save(){db.ctrl("User","save",s.item).then(function(res){s.requesting=!1;var _r=res;_r.ok?(r.infoMessage("Your account has been created. Check for email validation."),r.route("login",0)):r.warningMessage("Error, try later","warning")})}db.custom("user","find",{email:s.item.email,userType:"diag",disabled:!0}).then(function(res){if(res.data.result.length>0){var _item=res.data.result[0];s.item._id&&s.item._id==_item._id?_save():s.message("Email address in use.")}else _save()})}r.__hideNavMenu=!0,r.toggleNavbar(!0),$U.once("route-exit:diag-inscription",function(url){r.__hideNavMenu=!1}),s.item={email:"",password:"",address:"",userType:"diag",priority:void 0,commission:0},s.validate=function(){$U.ifThenMessage([[!s.item.email,"==",!0,"email est nécessaire"],[!s.item.password,"==",!0,"password est nécessaire"],[!s.item.address,"==",!0,"address est nécessaire"],[!s.item.cellPhone,"==",!0,"phone est nécessaire"]],function(m){r.warningMessage(m[0])},save)},$U.expose("s",s)}])}(app);var app=angular.module("app.diag.complete",[]);app.directive("diagOrders",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server,$mongoosePaginate){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){function update(items,cb){if(items)return s.model.update(items);var data={__populate:{_client:"email userType",_diag:"email userType"}};r.userIs(["diag"])&&(data._diag=r.session()._id),r.userIs(["client"])&&(data._client=r.session()._id),data.__sort={start:1},data.__rules={start:{$gt:moment().toDate()},status:{$nin:["completed","delivered","created"]}},dbPaginate.ctrl(data,s.model).then(function(res){cb?cb(res.result):s.model.update(res.result,null)})}var r=$rootScope,ws=server,dbPaginate=$mongoosePaginate.get("Order");attrs.name;s.title="Rendez-vous à venir",s.model={init:function(){update()},pagination:{itemsPerPage:10},paginate:function(cb){update(null,cb)},click:function(item,index){var data={};ws.localData().then(function(d){Object.assign(data,d)}),r.params={item:item,prevRoute:"dashboard"},r.route("orders/edit/"+item._id)},buttons:[{label:"Rafraichir",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return update()}}],columns:TABLE_COLUMNS(r),items:[]},update()}}}),app.directive("diagOrdersSucceded",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server,$mongoosePaginate){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){function update(items,cb){if(items)return s.model.update(items);var data={__populate:{_client:"email userType",_diag:"email userType"}};r.userIs(["diag"])&&(data._diag=r.session()._id),r.userIs(["client"])&&(data._client=r.session()._id),data.__sort={start:-1},data.__rules={end:{$lt:moment().toDate()},status:{$in:["completed","prepaid","delivered"]}},dbPaginate.ctrl(data,s.model).then(function(res){cb?cb(res.result):s.model.update(res.result,null)})}var r=$rootScope,ws=server,dbPaginate=$mongoosePaginate.get("Order");attrs.name;s.title="Rendez-vous effectués",s.model={init:function(){update()},pagination:{itemsPerPage:10},paginate:function(cb){update(null,cb)},click:function(item,index){var data={};ws.localData().then(function(d){Object.assign(data,d)}),r.params={item:item,prevRoute:"dashboard"},r.route("orders/edit/"+item._id)},buttons:[{label:"Rafraichir",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return update()}}],columns:TABLE_COLUMNS(r),items:[]},update()}}}),app.directive("diagCalendar",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.diag.calendar.html",link:function(s,elem,attrs){function update(){var conditions={__populate:{_client:"email userType",_diag:"email userType"}};r.userIs(["diag"])&&(conditions._diag=r.session()._id),r.userIs(["client"])&&(conditions._client=r.session()._id),conditions.__rules={status:{$ne:"created"}},ws.ctrl("Order","getAll",conditions).then(function(res){if(console.info(res),res.ok){var evts=[];res.result.forEach(function(v){evts.push({item:v,title:"Order ",type:"info",startsAt:new Date(v.start),endsAt:new Date(v.end),editable:!1,deletable:!1,draggable:!1,resizable:!1,incrementsBadgeTotal:!0,cssClass:"a-css-class-name"}),s.events=evts})}})}var r=$rootScope,ws=server,m=moment();m.year(),m.month();window.s=s,s.open=function(){},s.calendarView="year",s.views={label:"View Type",selected:s.calendarView,click:function(x){s.calendarView=x.label.toLowerCase(),s.views.selected=s.calendarView,r.dom()},items:[{label:"Day"},{label:"Week"},{label:"Month"},{label:"Year"}]},s.calendarDate=new Date,s.events=[],s.eventClicked=function(calendarEvent){r.params={item:calendarEvent.item,prevRoute:"dashboard"},r.route("orders/edit/"+calendarEvent.item._id)},s.eventEdited=function(evt){},update()}}}),app.controller("diagDashboard",["server","$scope","$rootScope",function(db,s,r){console.info("app.admin.diag:diagDashboard")}]),app.controller("ctrl-diag-edit",["server","$scope","$rootScope","$routeParams",function(db,s,r,params){function handleErrors(_err){r.errorMessage("Error, try later.")}function reset(){s.item=_.cloneDeep(s.original)}function read(){var id=params.id;s.item._id&&(id=s.item._id),db.ctrl("User","get",{_id:id,userType:"diag"}).then(function(res){s.original=_.clone(res.result),s.item=res.result,s.diplomesUpdate(),res.ok||r.infoMessage("Registry not found, maybe it was deleted.","warning",5e3)})}s.pdf={file:null};var isAdmin=r.userIs(["admin"]),isClient=r.userIs(["client"]),notCurrentDiag=r.userIs(["diag"])&&r.session()._id!==params.id,logged=r.logged();if(s.inscriptionLabel={val:"Suivant",update:function(){r.dom(function(){s.item._id?s.inscriptionLabel.val="Suivant":s.inscriptionLabel.val="Suivant"})}},logged){if(r.toggleNavbar(!0),r.secureSection(s),isClient||notCurrentDiag)return r.handleSecurityRouteViolation()}else r.__hideNavMenu=!0,$U.once("route-exit:diag-inscription",function(url){r.__hideNavMenu=!1}),r.toggleNavbar(!0);$U.expose("s",s),r.dom(),s.item={email:"",password:"",address:"",userType:"diag",priority:100,commission:0,disabled:!0},isAdmin&&(s.item.disabled=!1),s.original=_.cloneDeep(s.item),s.department=null,s.removeDeparment=function(nro){s.item.departments=s.item.departments||[],s.item.departments.splice(s.item.departments.indexOf(nro),1)},s.addDepartment=function(){return s.department?(s.item.departments=s.item.departments||[],_.includes($D.availableFranceDepartementsNumbers(),s.department.toString())?_.includes(s.item.departments,s.department)?r.warningMessage("Le département est déjà sélectionné"):void s.item.departments.push(s.department):r.warningMessage("Le département est pas valide")):r.warningMessage("Indiquez le département")},s.$watch("item.disabled",function(v){v&&s.item._id&&db.ctrl("Order","count",{_diag:s.item._id}).then(function(d){d.ok&&d.result>0&&(s.item.disabled=!1,r.warningMessage("Diag can only be disabled when there are not orders assigned.",5e3))})}),s.$watch("item.priority",function(v){}),s.validatePriority=function(v,okCb){if(!_.isUndefined(v)&&!_.isNull(v)&&isFinite(v)&&!isNaN(v)){if(v===s.original.priority)return okCb();db.ctrl("User","get",{userType:"diag",priority:v,__select:"email"}).then(function(data){null!==data.result?(s.item.priority=s.original.priority,r.warningMessage("Priority "+v+" is alredy assigned to "+data.result.email,5e3)):okCb()})}},s.$watch("item.address",function(v){}),s.addressChange=function(v){return s.item.address=v},params&&params.id&&"-1"!==params.id.toString()?r.dom(read,1e3):reset(),s.cancel=function(){r.route("diags")},s.validate=function(){$U.ifThenMessage([[s.item.email,"==","","email est nécessaire"],[s.item.password,"==","","Password est nécessaire"],[void 0==s.item.commission,"==",!0,"Commission est nécessaire"],[isNaN(s.item.commission),"==",!0,"Commission allowed values are 0..100"],[s.item.commission<0||s.item.commission>100,"==",!0,"Commission allowed values are 0..100"],[!s.item.priority,"==",!0,"Priority required"],[isNaN(s.item.priority),"==",!0,"Priority allowed values are 0..100"],[s.item.priority<0||s.item.priority>100,"==",!0,"Priority allowed values are 0..100"],[s.item.departments&&0==s.item.departments.length,"==",!0,"Un Département en charge est requis"],[s.item.notifications&&1==s.item.notifications.DIAG_DIAG_ACCOUNT_CREATED&&s.item._id&&(!s.item.diplomes||s.item.diplomes&&0==s.item.diplomes.length),"==",!0,"A Diplome est nécessaire"]],function(m){r.warningMessage(m[0],5e3)},function(){s.validatePriority(s.item.priority,function(){s.save()})})},s.diplomesExpirationDateChange=function(_id){s.item.diplomesInfo[_id]&&(s.item.diplomesInfo[_id].expirationDateNotificationSended=!1,s.item.diplomesInfo[_id].expirationDateNotificationEnabled=!1)},s.diplomesExpirationDateNotificationEnabled=function(_id){return r.userIs("admin")&&s.item.diplomesInfo&&s.item.diplomesInfo[_id]?(void 0==s.item.diplomesInfo[_id].expirationDateNotificationEnabled&&(s.item.diplomesInfo[_id].expirationDateNotificationEnabled=!1),s.item.diplomesInfo[_id].expirationDateNotificationEnabled):!1},s.diplomesEnableExpirationDateNotification=function(_id){s.item.diplomesInfo||console.error("diplomesInfo expected."),s.item.diplomesInfo[_id].expirationDateNotificationEnabled=!0,s.item.diplomesInfo[_id].expirationDateNotificationSended=!1,db.ctrl("User","update",{_id:s.item._id,diplomesInfo:s.item.diplomesInfo}).then(function(d){r.notify("Expiration Date Notification Enabled","info")})},s.diplomesUpdate=function(){if(s.item&&s.item.diplomes&&s.item.diplomes.length>0){s.diplomesData={};var infoToDelete=[];Object.keys(s.item.diplomesInfo||{}).forEach(function(_id){_.includes(s.item.diplomes,_id)||infoToDelete.push(_id)}),infoToDelete.forEach(function(k){delete s.item.diplomesInfo[k]}),db.ctrl("User","update",{_id:s.item._id,diplomesInfo:s.item.diplomesInfo}),s.item.diplomes.forEach(function(_id,k){db.ctrl("File","find",{_id:_id}).then(function(data){var file=data.result;data.ok&&file?(s.item.diplomesInfo=s.item.diplomesInfo||{},s.item.diplomesInfo[_id]||(s.item.diplomesInfo[_id]={expirationDateNotificationEnabled:!1,expirationDateNotificationSended:!1,filename:file.filename},db.ctrl("User","update",{_id:s.item._id,diplomesInfo:s.item.diplomesInfo}),console.info("diplome-info-created",_id)),file=Object.assign(file,s.item.diplomesInfo&&s.item.diplomesInfo[file._id]||{}),s.diplomesData[file._id]=s.diplomesDataCreate(file)):(console.info("diplome-fetch-fail: deleting-reference",_id),s.item.diplomes=_.pull(s.item.diplomes,_id),s.item.diplomesInfo=_.pull(s.item.diplomesInfo,_id),s.diplomesData[_id]&&delete s.diplomesData[_id],0===Object.keys(s.diplomesData).length&&s.diplomesNew(),db.ctrl("User","update",{_id:s.item._id,diplomes:s.item.diplomes}))})})}else s.item.diplomes=s.item.diplomes||[],s.diplomesNew()},s.diplomesFile={},s.diplomesFileChange=function(id){console.info(id),setTimeout(function(){s.diplomesSave(id)},1e3)},s.diplomesData={},s.diplomesDelete=function(_id){if(s.diplomesExists(_id)){var name=s.diplomesData[_id]&&s.diplomesData[_id].info.filename||"File";s.confirm("Delete "+name+" ?",function(){db.ctrl("File","remove",{_id:_id}).then(function(d){d.ok&&(delete s.diplomes[_id],delete s.diplomesInfo[_id],delete s.diplomesData[_id],0===Object.keys(s.diplomesData).length&&s.diplomesNew(),s.diplomesUpdate())})})}},s.diplomesExists=function(_id){return s.item&&s.item.diplomes&&_.includes(s.item.diplomes,_id)},s.diplomesDownload=function(_id){window.open(db.URL()+"/File/get/"+_id,"_newtab")},s.diplomesNew=function(){s.item&&s.item.diplomes.length!==Object.keys(s.diplomesData).length||(s.diplomesData[(new Date).getTime()]=s.diplomesDataCreate())},s.diplomesLabel=function(_id){var d=s.diplomesData[_id];return s.diplomesExists(_id)?"Pdf "+(d.info&&"("+d.info.filename+")"||"unkown"):(d=s.diplomesFile[_id],d&&d.name?"Sélectionné: "+d.name.toLowerCase()+" ":"Sélectionnez le fichier")},s.diplomesDataCreate=function(info){var o={obtentionMaxDate:new Date,obtentionDateOpen:!1,obtentionDateClick:function(){return o.obtentionDateOpen=!o.obtentionDateOpen},expirationMinDate:new Date,expirationDateOpen:!1,expirationDateClick:function(){return o.expirationDateOpen=!o.expirationDateOpen},dateOptions:{formatYear:"yy",startingDay:1},info:info||{filename:"Sélectionnez le fichier"}};return o.info.obtentionDate=isFinite(new Date(o.info.obtentionDate))&&new Date(o.info.obtentionDate)||new Date,o.info.expirationDate=isFinite(new Date(o.info.expirationDate))&&new Date(o.info.expirationDate)||new Date,o},s.diplomeInfoApply=function(){s.item.diplomesInfo=s.item.diplomesInfo||{},Object.keys(s.diplomesData).forEach(function(id){if(s.diplomesExists(id)){var data=s.diplomesData[id];s.item.diplomesInfo[id]={obtentionDate:data.info.obtentionDate,expirationDate:data.info.expirationDate,expirationDateNotificationEnabled:!1,expirationDateNotificationSended:!1,filename:data.info.filename}}})},s.diplomesSave=function(_id){function _deleteCurr(){db.ctrl("File","remove",{_id:curr})}function _uploadNew(){r.infoMessage("Patientez, le chargement de vos certifications est en cours",99999),db.form("File/save/",{name:s.diplomesFile[_id].name,file:s.diplomesFile[_id]}).then(function(data){if(data.ok){var newId=data.result._id;s.item.diplomes.push(newId),s.item.diplomesInfo=s.item.diplomesInfo||{},s.item.diplomesInfo[newId]=s.diplomesData[_id].info,s.diplomesExists(curr)&&(s.item.diplomes=_.pull(s.item.diplomes,curr),s.item.diplomesInfo=_.pull(s.item.diplomesInfo,curr)),db.ctrl("User","update",{_id:s.item._id,diplomes:s.item.diplomes}).then(function(data){data.ok?(s.diplomesExists(curr)&&_deleteCurr(),r.infoMessage("Vos certifications ont été chargées avec succès.",5e3)):r.warningMessage("Upload échoué, essayez plus tard.",99999),read(s.item._id)})}else r.warningMessage("Upload échoué, essayez plus tard.",99999)})}var file=s.diplomesFile[_id];if(!file)return r.warningMessage("Un fichier requis",5e3);if("application/pdf"!==file.type)return r.warningMessage("Format pdf nécessaire",5e3);if(file.size/1e3>1624)return r.warningMessage("Limite 1.5mb pour le fichier pdf",5e3);if(s.diplomesFile[_id]){var curr=_id;_uploadNew()}},s.needToBeNotifiedAboutActivation=function(_user){var rta="diag"===_user.userType&&_user.disabled===!1&&(void 0==_user.notifications||void 0===_user.notifications.DIAGS_DIAG_ACCOUNT_ACTIVATED||0==_user.notifications.DIAGS_DIAG_ACCOUNT_ACTIVATED);return console.info("needToBeNotifiedAboutActivation",rta),rta},s.notifyAboutActivation=function(_user){s.item=_user||s.item,db.ctrl("Notification","DIAG_DIAG_ACCOUNT_CREATED",{_user:s.item}).then(function(res){res.ok?(s.item.notifications=s.item.notifications||{},s.item.notifications.DIAGS_DIAG_ACCOUNT_ACTIVATED=!0,db.ctrl("User","save",s.item),console.info("notifyAboutActivation:success",res.message)):console.info("notifyAboutActivation:failed",res.err)})},s.adminsNeedToBeNotifiedAboutDiagAccountCreation=function(_user){var rta="diag"===_user.userType&&1==_user.disabled&&(!_user.notifications||void 0==_user.notifications.DIAGS_DIAG_ACCOUNT_CREATED||0==_user.notifications.DIAGS_DIAG_ACCOUNT_CREATED);return console.info("adminsNeedToBeNotifiedAboutDiagAccountCreation",rta),rta},s.notifyAdminsAboutDiagAccountCreation=function(_diag){db.ctrl("User","getAll",{userType:"admin",__select:"email"}).then(function(res){if(console.info("notifyAdminsAboutDiagAccountCreation:admins:",res.result.length),res.ok){var cbHell=$U.cbHell(res.result.length,function(){Object.assign(s.item,_diag),s.item.notifications=s.item.notifications||{},s.item.notifications.DIAGS_DIAG_ACCOUNT_CREATED=1,db.ctrl("User","save",s.item),console.info("notifyAdminsAboutDiagAccountCreation:success")});res.result.forEach(function(_admin){db.ctrl("Notification","ADMIN_DIAG_ACCOUNT_CREATED",{_user:_diag,_admin:{email:_admin.email}}).then(function(rta){cbHell.next()})})}})},s.save=function(){function _save(){s.diplomeInfoApply(),db.ctrl("User","save",s.item).then(function(res){var _r=res;if(_r.ok){if(s.item._id=res.result._id,s.adminsNeedToBeNotifiedAboutDiagAccountCreation(s.item)?s.notifyAdminsAboutDiagAccountCreation(s.item):s.needToBeNotifiedAboutActivation(s.item)&&s.notifyAboutActivation(s.item),!logged)return s.item&&s.item.diplomes&&s.item.diplomes.length>0?(r.route("login"),r.infoMessage("Votre compte Diagnostiqueur est en cours de création. Un agent Diagnostical vous contactera prochainement pour finaliser votre inscription.",1e4)):(s.item=res.result,s.inscriptionLabel.update(),r.dom(),r.infoMessage("T&eacute;l&eacute;verser un diplome s&apos;il vous pla&Icirc;t",1e4));r.route("diags",0)}else r.warningMessage("Error, try later","warning")}).error(handleErrors)}var payload={email:s.item.email,userType:"diag"};db.ctrl("User","find",payload).then(function(res){if(res.result.length>0){var _item=res.result[0];s.item._id&&s.item._id==_item._id?_save():s.warningMessage("Email address in use.")}else _save()}).error(handleErrors)},s["delete"]=function(){s.confirm("Delete Diag "+s.item.email+" ?",function(){db.ctrl("User","remove",{_id:s.item._id}).then(function(res){r.infoMessage("Deleted"),reset(),r.route("diags",0)}).error(function(err){r.errorMessage("Error, try later.")})})},s.update=read}]),function(){var app=angular.module("app.diag.balance",[]);app.directive("diagBalance",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server,$mongoosePaginate){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){function payload(){var data={_user:r.session()._id,__populate:{_order:"_id info diagRemunerationHT"}};return data=Object.assign(data,s.model.filter.payload||{})}function update(items,cb){db.ctrl("Payment","syncTransactions",{_user:r.session()._id,_diag:r.session()._id}).then(function(res){dbPaginate.ctrl(payload(),s.model,{autoResolve:!0,callback:cb}).then(function(r){r.result&&(s.model.total=0,r.result.forEach(function(i){return s.model.total+=i._order.diagRemunerationHT}))})})}var r=$rootScope,db=server,dbPaginate=(attrs.name,$mongoosePaginate.get("StripeTransaction"));s.title="Portefeuille",r.setCurrentCtrl(s),s.model={total:0,init:function(){return s.model.filter.firstTime()},filter:{template:"diagBalanceFilter",update:update,rules:{created:"month-range"},payloadRules:{year:function(data,val){var date=moment().year(parseInt(val));return null==s.model.filter.fields.created&&(data.__rules.created={$gte:date.startOf("year").toDate().toString(),$lt:date.endOf("year").toDate().toString()}),data}},yearChange:function(){s.model.filter.fields.created=null,s.model.filter.filter()}},pagination:{itemsPerPage:10},paginate:function(cb){update(null,cb)},months:function(){return moment.monthsShort().map(function(m,k){return k+1+" - "+m})},years:function(){for(var c={},x=2010;2020>x;x++)c[x.toString()]=x;return c},tfoot:"views/diags/backoffice/partials/diag-balance-footer.html",click:function(item,index){return item._order?void r.route("orders/edit/"+item._order._id):r.infoMessage("Il n'y a pas un ordre associé",4e3)},buttons:[{label:"Rafraîchir",type:function(){return"btn diags-btn azure-radiance spacing-h-1"},click:function(){return update()}}],columns:[{label:"Description",name:"description"},{label:"Revenue (EUR)",labelCls:function(){return{"text-right":!0}},name:"stripeFee",format:function(v,item){return item._order.diagRemunerationHT},align:"right"},{label:"Création",name:"created",format:function(v,item){return r.momentDateTime(item.created)}}],items:[]},update()}}})}(),function(){var app=angular.module("app.client",[]);app.directive("clientOrders",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server,$mongoosePaginate){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){function update(items,cb){var data={__select:"address status start end createdAt",__populate:{_client:"email userType",_diag:"email userType firstName lastName"},__sort:{
createdAt:-1}};r.userIs(["diag"])&&(data._diag=r.session()._id),r.userIs(["client"])&&(data._client=r.session()._id),dbPaginate.ctrl(data,s.model).then(function(res){cb?cb(res.result):s.model.update(res.result,null)})}var r=$rootScope,dbPaginate=$mongoosePaginate.get("Order"),ws=server;attrs.name;s.title="Vos commandes",s.model={pagination:{itemsPerPage:5},paginate:function(cb){update(null,cb)},click:function(item,index){var data={};ws.localData().then(function(d){Object.assign(data,d)}),r.params={item:item,prevRoute:"dashboard"},r.route("orders/edit/"+item._id)},hideTooltip:!0,buttons:[{label:"Refresh",show:!1,type:function(){return"btn diags-btn bg-madison spacing-h-1"},click:function(){return update()}}],columns:[{label:"Debug",name:"start",format:function(v,item){return r.momentDateTimeWords2(item.start)}},{label:"Address",name:"address"},{label:"Statut",name:"status"}],items:[]},update()}}}),app.directive("clientsList",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server,$mongoosePaginate){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){},controller:function($scope,$element,$attrs,$transclude){function update(cb){dbPaginate.ctrl({userType:"client"},s.model).then(function(res){cb?cb(res.result):s.model.update(res.result)})}var r=$rootScope,s=$scope,dbPaginate=$mongoosePaginate.get("User");s.title="",r.routeParams({prevRoute:"clients"}),s.model={init:function(){return update()},filter:{template:"clientFilter",rules:{email:"contains",clientType:"contains"}},paginate:function(cb){update(cb)},click:function(item,index){r.routeParams({item:item}),r.route("clients/edit/"+item._id)},buttons:[{label:"Refresh",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return update()}},{label:"New Client",type:function(){return"btn diags-btn bg-azure-radiance"},click:function(){return r.route("clients/edit/-1")}}],columns:[{label:"Type",name:"clientType"},{label:"Description",name:"firstName",format:function(x,o){return o.firstName+(o.lastName?", "+o.lastName:"")}},{label:"Email",name:"email"},{label:"Tel",name:"fixedTel",format:function(v,item){return item.fixedTel||item.cellPhone||""}},{label:"Siret",name:"siret"}],items:[]}}}})}(),function(){var app=angular.module("app.order",[]);app.controller("adminOrders",["server","$scope","$rootScope","focus",function(db,s,r,focus){function read(){db.custom("order","getAll",{__populate:{_client:"email",_diag:"email commission ",__select:"address start end status created"}}).then(function(r){r.data.result=_.orderBy(r.data.result,["created"],["desc"]),s.items=r.data.result,r.successMessage("Loaded",1e3)})}return window.s=s,s.focus=focus,r.toggleNavbar(!0),r.secureSection(s),s.selectedItems=[],s.items=[],r.userIs(["diag","client"])?r.handleSecurityRouteViolation():(s.click=function(item){r.routeParams({prevRoute:"orders"}),r.route("orders/edit/"+item._id)},s.create=function(){r.route("orders/edit/-1")},s.select=function(){window.event&&window.event.stopPropagation()},s.syncStripe=function(){db.ctrl("Order","syncStripe"),setTimeout(read,5e3),setTimeout(read,2e4)},s.refresh=read,void r.dom(read,0))}]),app.controller("adminOrdersEdit",["server","$scope","$rootScope","$routeParams","focus","diagPrice","diagSlots",function(db,s,r,params,focus,diagPrice,diagSlots){function init(){r.toggleNavbar(!0),-1!==window.location.href.indexOf("orders/view")?(s.afterRead.push(function(){s.isPaid()||s.pay()}),r.params&&r.params.prevRoute||(r.toggleNavbar(!0),r.__hideNavMenu=!0,$U.once("route-exit:"+$U.url.hashName(),function(url){r.__hideNavMenu=!1}))):r.secureSection(s),r.dom(),setHelpers(),setDefaults(),setBindings(),setActions(),$U.whenProperties(s,["diags"],[setDefaultsDiags]),params&&params.id&&"-1"!==params.id.toString()?r.dom(read,0):reset()}function autoPay(){-1!==window.location.href.indexOf("orders/view")&&s.pay&&"1"===$U.getParameterByName("pay")&&s.item&&!_.includes(["prepaid","completed"],s.item.status)&&s.pay()}function diagNameConvertion(key){return $D.diagNameConvertion(key)}function setHelpers(){s.diagNameConvertion=diagNameConvertion,s.diagSlots=diagSlots(s,s.item),s.__rdvInit=!1,s.rdvConditions=function(){if(s.item._id)return!1;if(!s.item.info)return!1;var rta=void 0!==s.item.info.squareMeters&&void 0!==s.item._client;return rta&&!s.__rdvInit&&(s.__rdvInit=!0,s.diagSlots.init()),rta},s.viewPDF=function(){$D.getInvoiceHTMLContent(db,s.item,r,function(html){html=window.encodeURIComponent($D.OrderReplaceHTML(window.decodeURIComponent(html),s.item,r)),r.ws.ctrl("Pdf","view",{html:html}).then(function(res){if(res.ok){var win=window.open(res.result,"_blank");win.focus()}else res.warningMessage("Server Issue, try later.")})})},s.delegate=function(){s.item.notifications=s.item.notifications||{},s.item.notifications.LANDLORD_ORDER_PAYMENT_DELEGATED?r.openConfirm({message:"Already sended, send again?"},function(){s.item.notifications.LANDLORD_ORDER_PAYMENT_DELEGATED=!1,db.ctrl("Order","update",{_id:s.item._id,notifications:s.item.notifications}).then(function(res){s.sendPaymentLink()})}):s.sendPaymentLink()},s.dateSlotSelected=function(rng){return s.item.start&&s.item.start==rng.start},s.drawRange=function(rng){var rta=moment(rng.start).format("HH[h]mm");return rta+=" - "+rng.price+" €"},s.unwrapRange=function(range){var data=range;s.item.start=data.start,s.item.end=data.end,s.applyTotalPrice()},s.infoItemShow=function(item){return"boolean"==typeof item},s.canWriteAgency=function(){return s.item._id?r.userIs(["admin"])||r.session()._id==s.item._client._id&&_.includes(["agency","other"],s.item._client.clientType):r.userIs("admin")},s.canWriteDiag=function(){return s.item._id?r.userIs(["admin"])||r.sesison()._id==s.item._diag._id:!1},s.diagPrice=function(){return s.item.price?isNaN(s.item.price)?0:.3*(s.item.price-.12*s.item.price):0},s.isPaid=function(){return _.includes(["prepaid","completed"],s.item.status)},s.isDiag=function(){return s.item._id?r.userIs("diag")&&r.session()._id==s.item._diag._id:!1},s.isOwner=function(){return s.item&&s.item._client?"landlord"===s.item._client.clientType:!1},s.successMsg=function(msg){r.message(msg,{type:"success",duration:1e4})},s.infoMsg=function(msg){r.message(msg,{duration:5e3,type:"info"})},s.currentClientType=function(){return s.item&&s.item._client&&"("+s.item._client.clientType+")"||""},s.totalTime=function(){return $D.OrderTotalTime(s.item.diags,s.diags)};var _totalTimeFormatedDate=moment();s.totalTimeFormated=function(){if(!s.item.diags||!s.diags)return"";var t=$D.OrderTotalTime(s.item.diags,s.diags),m=_totalTimeFormatedDate.hours(t.hours).minutes(t.minutes).format("HH:mm");return m},s.orderDescription=function(){var d=$D.createOrderDescription(s.item);return s.item.info.description=d,d},s.applyTotalPrice=function(){s.item.price=diagPrice.getPriceQuote(s),s.item._diag?diagPrice.setPrices(s,s.item):console.warn("set-prices-skip _diag undefined "),r.dom()},s.applyTotalTime=function(){var t=$D.OrderTotalTime(s.item.diags,s.diags);s.item&&s.item.start&&(s.item.end=moment(s.item.start).add(t.hours,"hours").add(t.minutes,"minutes")._d,r.dom())},s.type=r.session().userType,s.is=function(arr){return _.includes(arr,s.type)},s.focus=focus,window.s=s}function setDefaults(){window.Object.assign(s.item,{email:"",password:"",status:"created",start:moment().add(1,"day").hour(9).minutes(0).toDate(),end:moment().add(1,"day").hour(10).minutes(30).toDate(),fastDiagComm:0,price:0,diags:{},info:{sell:!1,house:!1,squareMeters:void 0,constructionPermissionDate:void 0}}),s.original=_.clone(s.item)}function setDefaultsDiags(){s.item.diags=s.item.diags||{},s.diags.forEach(function(val,key){s.item.diags[val.name]=!!val.mandatory})}function setBindings(){function dtAfter(d1,d2,unit){return moment(d1).isAfter(moment(d2),unit)}db.ctrl("Settings","getAll",{}).then(function(d){d.ok&&d.result.length>0&&(s.settings=d.result[0])}),s.$watch("item.start",function(v){s.item.date=v}),s.$watch("item._diag",function(v){s.diagSlots&&s.diagSlots.setDiag(s.item._diag)}),db.localData().then(function(data){Object.assign(s,data),s.diags.forEach(function(diag){diag.show=!0})}),s.CLIENT_TYPES=["agency","enterprise","landlord","other"],s.CLIENT_TYPES_COMPANY=["agency","enterprise","other"],s.isOrderClientLandLord=function(){return s.item&&s.item._client&&s.item._client.clientType?!_.includes(s.CLIENT_TYPES_COMPANY,s.item._client.clientType):!0},s.isOrderClientAgency=function(){return!s.isOrderClientLandLord()},s.__keysWhereItems={},s.__keysWhereGetItems=function(){return s.item._client&&s.item._client.clientType?s.isOrderClientLandLord()?{"Ou ?":function(){return""},"Diag Address":function(){return s.item.address},"Client Address":function(){return s.item._client.address},Other:function(){return"other"}}:{"Ou ?":function(){return""},"Diag Address":function(){return s.item.address},"Agency Address":function(){return s.item._client.address},"Landlord Address":function(){return s.item.landLordAddress},Other:function(){return"other"}}:{"Ou ?":function(){return""}}},s.$watch("item",function(val){s.__keysWhereItems=s.__keysWhereGetItems()},!0),s.__keysWhereSelectFirstItem=function(){return s.__keysWhereItems&&Object.keys(s.__keysWhereItems)[0]||"Loading"},s.__keysWhereSelectLabel=function(){return s.__keysWhereSelectLabelVal||s.__keysWhereSelectFirstItem()},s.__keysWhereSelect=function(key,val){s.item.keysWhere=val&&val()||void 0},s.$watch("item.keysWhere",function(val){if(!s.item._id){if(void 0==val)return r.dom(function(){s.item.keysAddress="non disponible"}),r.dom(function(){s.item.keysAddress=void 0},2e3),s.__keysWhereSelectLabelVal="Ou ?";Object.keys(s.__keysWhereItems).forEach(function(k){s.__keysWhereItems[k]()==val&&(s.__keysWhereSelectLabelVal=k)}),s.item.keysAddress="other"==val?"":val}}),s.__keysTimeFromItems={},s.__keysTimeFromGetItems=function(){var vals={};if(!s.item)return vals;for(var m=moment(s.item.start).hours(8);m.isBefore(moment(s.item.start));)vals[r.momentTime(m)]=new Date(m.toString()),m=m.add(5,"minutes");return vals[r.momentTime(s.item.start)]=new Date(moment(s.item.start).toString()),vals},s.__keysTimeFromSelectFirstItem=function(){return s.__keysTimeFromItems&&Object.keys(s.__keysTimeFromItems)[0]||"Loading"},s.__keysTimeFromSelectLabel="choisir",s.__keysTimeFromSelect=function(key,val){s.item.keysTimeFrom=val,dtAfter(s.item.keysTimeFrom,s.item.keysTimeTo)&&(s.item.keysTimeTo=void 0)},s.$watch("item.keysTimeFrom",function(val){if(val){if(s.item._id)return s.__keysTimeFromSelectLabel=r.momentTime(s.item.keysTimeFrom);s.__keysTimeFromSelectLabel="choisir",_.each(s.__keysTimeFromItems,function(v,k){v==val&&(s.__keysTimeFromSelectLabel=k)})}else s.__keysTimeFromSelectLabel="choisir"}),s.$watch("item.start",function(val){s.__keysTimeFromItems=s.__keysTimeFromGetItems()}),s.__keysTimeToItems={},s.__keysTimeToGetItems=function(){var vals={};if(!s.item)return vals;var m=moment(s.item.start).hours(8).minutes(0);for(moment(s.item.keysTimeFrom).isAfter(m)&&moment(s.item.keysTimeFrom).isBefore(moment(s.item.start))&&(m=m.hours(moment(s.item.keysTimeFrom).hours()),m=m.minutes(moment(s.item.keysTimeFrom).minutes()));m.isBefore(moment(s.item.start));)vals[r.momentTime(m)]=new Date(m.toString()),m=m.add(5,"minutes");return vals[r.momentTime(s.item.start)]=new Date(moment(s.item.start).toString()),vals},s.__keysTimeToSelectFirstItem=function(){return s.__keysTimeToItems&&Object.keys(s.__keysTimeToItems)[0]||"Loading"},s.__keysTimeToSelectLabel="choisir",s.__keysTimeToSelect=function(key,val){s.item.keysTimeTo=val},s.$watch("item.keysTimeTo",function(val){if(val){if(s.item._id)return s.__keysTimeToSelectLabel=r.momentTime(s.item.keysTimeTo);s.__keysTimeToSelectLabel="choisir",_.each(s.__keysTimeToItems,function(v,k){v==val&&(s.__keysTimeToSelectLabel=k)})}else s.__keysTimeToSelectLabel="choisir"}),s.$watch("item.keysTimeFrom",function(val){s.__keysTimeToItems=s.__keysTimeToGetItems()}),s.$watch("item.start",function(val){s.__keysTimeToItems=s.__keysTimeToGetItems()}),s.datepicker={minDate:moment().toDate(),maxDate:moment().add(60,"day").toDate(),initDate:new Date},s.noResults="No results found",s.LoadingClients="Loading Clients",s.getClients=function(val){return db.http("User","getAll",{userType:"client",__regexp:{email:val}}).then(function(res){return res.data.result})},s.getDiags=function(val){return db.http("User","getAll",{userType:"diag",__rules:{disabled:{$ne:!0}},__regexp:{email:val}}).then(function(res){return res.data.result})},s.start=$D.createDateTimePickerData(),s.end=$D.createDateTimePickerData(),s.status=$D.createSelect({scope:s,model:"item.status",label:"(Select an status)",items:["Ordered","Prepaid","Delivered","Completed"],change:function(selected){s.item.status=selected.toString().toLowerCase(),r.dom()}})}function setActions(){function emailOfPersonWhoPaid(){var session=r.session();return session&&session._id==s.item._client._id?s.item._client.email:s.item.landLordEmail||s.item._client.email||""}s.sendPaymentLink=function(cb){function _sendPaymentLink(){s.confirm({message:"You want to send a payment link to "+s.item.landLordEmail+" ?",templateUrl:"views/directives/modal.yes-not-now.html"},function(){s.infoMsg("Sending email."),$D.getInvoiceHTMLContent(db,s.item,r,function(html){db.ctrl("Notification","LANDLORD_ORDER_PAYMENT_DELEGATED",{_user:s.item._client,_order:s.item,attachmentPDFHTML:html}).then(function(data){"created"==s.item.status&&(s.item.status="ordered",db.ctrl("Order","update",s.item)),s.infoMsg("Email sended."),cb&&cb()})})})}$U.ifThenMessage([[!s.item.landLordEmail,"==",!0,"Landlord Email required."],[!s.item.landLordFullName,"==",!0,"Landlord Name required."]],function(m){"string"!=typeof m[0]?r.warningMessage(m[0]()):r.warningMessage(m[0])},_sendPaymentLink)},s.pay=function(){var order=s.item;$D.openStripeModalPayOrder(order,function(token){order.stripeToken=token.id,db.ctrl("Order","pay",order).then(function(data){data.ok?(s.item.status="delivered"===s.item?"completed":"prepaid",s.successMsg("Commande payée"),r.dom(read,5e3)):(s.successMsg("There was a server error, try later.","warning"),console.info("PAY-FAIL",data.err))})},{config:r.config,email:emailOfPersonWhoPaid()})},s.back=function(){if(s.is(["diag","client"]))r.route("dashboard");else{if(r.params&&r.params.prevRoute)return r.route(r.params.prevRoute);r.route("orders")}},s.cancel=function(){s.back()},s.mm=function(d){return moment(d).minutes()},s.mmOK=function(d){return _.includes([0,30],s.mm(d))},s.validate=function(){$U.ifThenMessage([[_typeof(s.item._client),"!=","object","Client required"],[_typeof(s.item._diag),"!=","object","Diag Man required"],[_.isUndefined(s.item.address)||_.isNull(s.item.address)||""===s.item.address,"==",!0,"Address required"],[!s.item.start,"==",!0,"start date est requis"],[!s.item.end,"==",!0,"end date est requis"],[moment(s.item.start||null).isValid(),"==",!1,"start date invalide"],[moment(s.item.end||null).isValid(),"==",!1,"end date invalide"],[s.isOrderClientAgency()&&!s.item.landLordEmail,"==",!0,"E-mail du propriétaire requis"],[s.isOrderClientAgency()&&!s.item.landLordFullName,"==",!0,"Nom du propriétaire requis"],[!s.item.keysAddress,"==",!0,"Clés Adresse requise"],[!s.item.keysTimeFrom,"==",!0,'Clés Temps "De" requis'],[!s.item.keysTimeTo,"==",!0,'Clés Temps "To" requis'],[moment(s.item.end).isValid()&&moment(s.item.start).isValid()&&!moment(s.item.end).isSame(moment(s.item.start),"day"),"==",!0,"Start / End dates need to be in the same day."],[moment(s.item.end).isValid()&&moment(s.item.end).isBefore(moment(s.item.start),"hour"),"==",!0,"End date cannot be lower than Start date"],[isNaN(s.item.fastDiagComm),"==",!0,"Comission need to be a number"],[isNaN(s.item.price),"==",!0,"Price need to be a number"],[s.item.status,"==","","Status required"]],function(m){"string"!=typeof m[0]?r.warningMessage(m[0]()):r.warningMessage(m[0])},s.save)},s.save=function(){db.ctrl("Order","save",s.item).then(function(res){res.ok?s.item.notifications&&1==s.item.notifications.LANDLORD_ORDER_PAYMENT_DELEGATED?(r.infoMessage("Changes saved"),s.back()):(s.item._id=res.result._id,s.isOrderClientLandLord()?s.back():s.sendPaymentLink(function(){s.back()}),r.infoMessage("Changes saved")):handleError(res)}).error(handleError)},s.downloadFile=function(){return s.item.pdfId?void window.open(db.URL()+"/File/get/"+s.item.pdfId,"_newtab"):r.warningMessage("File required",5e3)},s.deletePDF=function(){return s.pdfFileInfo?void s.confirm("Delete "+s.pdfFileInfo.filename+" ?",function(){db.ctrl("File","remove",{_id:s.pdfFileInfo._id}).then(function(d){d.ok&&(s.item.pdfId=null,db.ctrl("Order","update",{_id:s.item._id,pdfId:s.item.pdfId}),r.dom())})}):console.warn("s.pdfFileInfo expected.")},s["delete"]=function(){if(!_.includes(["ordered","created"],s.item.status))return void s.okModal({message:"You can't delete an Order with the follow status: delivered, prepaid or completed.",data:{title:"Delete Info"}});var time=function(d){return moment(d).format("HH:mm")},descr=s.item.address+" ("+time(s.item.start)+" - "+time(s.item.end)+")";s.confirm("Delete Order "+descr+" ?",function(){db.ctrl("Order","remove",{_id:s.item._id}).then(function(data){data.ok?s.back():handleError(data)}).error(handleError)})}}function handleError(er){s.warningMessage("Problème technique. S&#39il vous plaît réessayer plus tard")}function reset(){s.item=_.clone(s.original)}function read(id){r.params&&r.params.item&&r.params.item._diag&&(s.item=r.params.item,delete r.params.item),db.ctrl("Order","get",{_id:id||params.id||s.item._id,__populate:{_client:"email clientType address discount firstName lastName",_diag:"email address commission firstName lastName"}}).then(function(data){data.ok&&null!==data.result?(data.result=Object.assign(data.result,{start:new Date(data.result.start),end:new Date(data.result.end)}),s.item=data.result,s.afterRead&&s.afterRead.forEach&&s.afterRead.forEach(function(cb){return cb()}),autoPay(),s.pdfCheck()):handleError(data)}).error(handleError)}r.setCurrentCtrl(s),s.pdf={file:null},s.pdfDownload=function(code){window.open(db.URL()+"/File/get/"+s.item.files[code]._id,"_newtab")},s.pdfExists=function(code){return s.item&&s.item.files&&void 0!==s.item.files[code]},s.pdfDelete=function(code){if(s.pdfExists(code)){var name=s.item.files[code]&&s.item.files[code].filename||"File";s.confirm("Delete "+name+" ?",function(){db.ctrl("File","remove",{_id:s.item.files[code]._id}).then(function(d){d.ok&&(delete s.item.files[code],s.pdfCheck())})})}},s.pdfChange=function(diagCode){return s.item&&s.item.end&&moment(s.item.end).isAfter(moment())?(s.pdf={},r.dom(),r.infoMessage("Ajouter après "+moment(s.item.end).format("dddd DD [de] MMMM YY"),5e3)):void r.dom(function(){s.pdfSave(diagCode)},1e3)},s.pdfAllPdfUploaded=function(){for(var x in s.item.diags)if(1==s.item.diags[x]&&!(s.item.files&&s.item.files[x]&&s.item.files[x]._id))return!1;return!0},s.pdfSaveSuccess=function(){"prepaid"==s.item.status&&s.pdfAllPdfUploaded()&&(console.warn("every pdf was uploaded. Turning order to completed."),s.item.status="completed")},s.pdfSave=function(code){function _deletePrev(prevID){prevID&&(db.ctrl("File","remove",{_id:prevID}),console.log("pdf delete prev",prevID))}function _uploadNew(){r.infoMessage("Patientez, le chargement est en cours",99999),db.form("File/save/",{name:s.pdf[code].name,file:s.pdf[code]}).then(function(data){data.ok?(s.item.files[code]=data.result,s.pdfSaveSuccess(),db.ctrl("Order","update",{_id:s.item._id,files:s.item.files,status:s.item.status}).then(function(data){_deletePrev(prevID),read(s.item._id),r.infoMessage("File upload success.",5e3)})):r.warningMessage("Upload fail, try later.",9999)})}if(!code)return console.warn("pdfSave code required");if(!s.pdf[code])return r.warningMessage("Un fichier requis",5e3);if("application/pdf"!==s.pdf[code].type)return r.warningMessage("Format pdf nécessaire",5e3);if(s.pdf[code].size/1e3>1624)return r.warningMessage("Limite 1.5mb pour le fichier pdf",5e3);s.item.files=s.item.files||{};var prevID=s.item.files[code]&&s.item.files[code]._id;_uploadNew()},s.pdfCheck=function(){if(s.item&&(!s.item||s.item.files)&&(!s.item||!s.item.files||0!=Object.keys(s.item.files).length)){var cbHell=$U.cbHell(Object.keys(s.item.files).length,function(){db.ctrl("Order","update",{_id:s.item._id,files:s.item.files}),console.log("pdf check complete")}),file=null;for(var code in s.item.files)file=s.item.files[code],file?file._id?db.ctrl("File","find",{_id:file._id}).then(function(res){var r=res.ok&&res.result;r||delete s.item.files[code],cbHell.next()}):(console.warn("checking file, _id expected. Code its ",code),delete s.item.files[code],cbHell.next()):cbHell.next()}},s.pdfReset={},s.item={},s.afterRead=[],init()}]),app.directive("ordersList",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server,$mongoosePaginate){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){},controller:function($scope,$element,$attrs,$transclude){function update(items,cb){function _apply(){data=Object.assign(data,s.model.filter.payload||{}),dbPaginate.ctrl(data,s.model).then(function(res){cb?cb(res.result):s.model.update(res.result,null)})}var data={__select:"_client _diag address start end price status created createdAt",__populate:{_client:"email",_diag:"email"},__sort:"-createdAt"};r.dom(_apply)}var r=$rootScope,db=server,s=$scope,dbPaginate=$mongoosePaginate.get("Order");$U.expose("s",s),s.title="",r.routeParams({prevRoute:"orders"}),s.syncStripe=function(){db.ctrl("Order","syncStripe"),setTimeout(update,1e4)},s.model={init:function(){return s.model.filter.firstTime()},months:function(){return moment.monthsShort().map(function(m,k){return k+1+" - "+m})},filter:{template:"ordersFilter",update:update,rules:{status:"awesome-in",createdAt:"month-range",start:"month-range",deliveredAt:"month-range"}},pagination:{itemsPerPage:10},paginate:function(cb){update(null,cb)},click:function(item,index){r.routeParams({item:item}),r.route("orders/edit/"+item._id)},buttons:[{label:"Rafraîchir",type:function(){return"btn diags-btn bg-azure-radiance margin-left-0 margin-right-1"},click:function(){return update()}},{label:"Créer",type:function(){return"btn diags-btn bg-azure-radiance margin-right-1"},click:function(){return r.route("orders/edit/-1")}},{label:"Sync payments",show:!1,type:function(){return"btn diags-btn bg-azure-radiance margin-right-1"},click:function(){return s.syncStripe()}}],columns:[{label:"Diag",name:"_diag",format:function(v,item){return item._diag.email}},{label:"Client",name:"_client",format:function(v,item){return item._client.email}},{label:"Adresse",name:"address"},{label:"When",name:"start",format:function(v,item){return r.momentFormat(item.start,"DD-MM-YY")}},{label:"Hour",name:"start",format:function(v,item){return r.momentTime(item.start)+" - "+r.momentTime(item.end)}},{label:"Price",name:"price"},{label:"Statut",name:"status"},{label:"Created",name:"createdAt",format:function(v,item){return r.momentFormat(item.createdAt,"DD-MM-YY HH:mm")}}],items:[],records:{label:"Records",show:!0}}}}})}();var app=angular.module("app.client.payments",[]);app.directive("clientPayments",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){function update(){var data={__populate:{_client:"email userType",_diag:"email userType"}};r.userIs(["diag"])&&(data._diag=r.session()._id),r.userIs(["client"])&&(data._client=r.session()._id),ws.ctrl("Order","getAll",data).then(function(res){res.ok&&(res.result.forEach(function(v){v.date=moment(v.start).format("DD-MM-YY"),v.start=moment(v.start).format("HH:mm"),v.end=moment(v.end).format("HH:mm"),v.description=v.address+"<br>"+v.date+"<br>"+v.start+" - "+v.end,v.status="Not yett"}),s.model.update(res.result))})}function pay(order){var handler=StripeCheckout.configure({key:"pk_test_MDkxtBLcBpHwMCgkqX2dJHjO",image:"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",token:function(_token2){order.stripeToken=_token2.id,ws.ctrl("Order","pay",order).then(function(data){data.ok?console.info("PAY-OK",data.result):console.info("PAY-FAIL",data.err)})}});handler.open({name:r.config.companyName||"[r.config.companyName]",description:"Order payment",email:order._client.email,currency:"eur",amount:100*order.price,zipCode:!1,allowRememberMe:!1})}var r=$rootScope,ws=server;attrs.name;s.title="My Payments",s.model={click:function(item,index){var data={};ws.localData().then(function(d){Object.assign(data,d)}),s.open({title:"Order Payment",data:data,evts:{init:[]},item:item,templateUrl:"views/partials/partial.modal.order.payment.html",callback:function(item){pay(item)}})},buttons:[{label:"Refresh",type:function(){return"btn btn-primary spacing-h-1"},click:function(){return update()}}],columns:[{label:"Description",name:"description"},{label:"You pay",name:"status"}],items:[]},update()}}});