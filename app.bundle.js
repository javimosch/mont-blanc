"use strict";function openStripeModalPayOrder(order,cb,opt){opt=opt||{};var handler=StripeCheckout.configure({key:"pk_test_MDkxtBLcBpHwMCgkqX2dJHjO",image:"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",token:function(_token){cb(_token)}});handler.open({name:r.config.companyName||"[r.config.companyName]",description:"Order payment",email:opt.email||order._client.email,currency:"eur",amount:100*order.price,zipCode:!1,allowRememberMe:!1})}function normalizeOrderStartTime(t,forwardOnly,backwardOnly){return t.minutes<30&&(forwardOnly?t.minutes=30:t.minutes=0),30==t.minutes&&(t.minutes=30),t.minutes>30&&(backwardOnly?t.minutes=30:(t.minutes=0,t.hours++)),t}function normalizeOrderTime(t,eachTreintaOnly){return t.minutes>0&&t.minutes<15&&(t.minutes=15,eachTreintaOnly&&(t.minutes=0)),t.minutes>15&&t.minutes<30&&(t.minutes=30),t.minutes>30&&t.minutes<45&&(t.minutes=45,eachTreintaOnly&&(t.minutes=30)),t.minutes>45&&t.minutes<59&&(t.hours+=1,t.minutes=0),t}function OrderTotalTime(selectedDiags,diags){var total=0;if(!selectedDiags)return 0;Object.keys(selectedDiags).forEach(function(mkey){selectedDiags[mkey]&&diags.forEach(function(dval,dkey){return dval.name==mkey?(dval.time=dval.price/4,total+=dval.time||0,!1):void 0})}),total=10*parseInt(parseInt(total)/10,10)+10;var hours=Math.floor(total/60),minutes=total%60,t={hours:hours,minutes:minutes};return t}function expose(path,val){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||{},obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}setVal(window,path,val)}function createDateTimePickerData(){var o={isOpen:!1,openCalendar:function(e){e.preventDefault(),e.stopPropagation(),o.isOpen=!0}};return o}function createSelect(opt){var o={label:opt.label,click:function(x){o.label=x.label||x,setPropByGivenPath(opt.scope,opt.model,x),opt.change(x)},items:opt.items};return opt.scope.$watch(opt.model,function(v){void 0!==v?o.label=v.label||v.substring(0,1).toUpperCase()+v.slice(1):o.label=opt.label}),o}function setPropByGivenPath(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj&&(obj[split[lastIndex]]=val)}function ifThenMessage(comparisons,messagesCallback,noMessagesCallback){var messages=[];comparisons.forEach(function(comparison){var v1=comparison[0];if("function"==typeof v1)v1()&&messages.push(comparison[1]);else{var operator=comparison[1],v2=comparison[2],m=comparison[3],cb=comparison[4]||void 0;"=="==operator&&v1==v2&&messages.push(m),"!="==operator&&v1!=v2&&messages.push(m),">"==operator&&v1>v2&&messages.push(m),"<"==operator&&v2>v1&&messages.push(m),">="==operator&&v1>=v2&&messages.push(m),"<="==operator&&v2>=v1&&messages.push(m)}messages.filter(function(_m){return _m==m}).length>0&&cb&&cb()}),messages.length>0?messagesCallback(messages):noMessagesCallback()}function getParameterByName(name,url){url||(url=window.location.href),name=name.replace(/[\[\]]/g,"\\$&");var regex=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)"),results=regex.exec(url);return results?results[2]?decodeURIComponent(results[2].replace(/\+/g," ")):"":null}function MyPromise(cb){var _scope={cb:null,errorCb:null,errorRes:null,res:null},resolve=function(res){_scope.cb&&_scope.cb(res),_scope.res=res||{}},error=function(errorRes){_scope.errorCb&&_scope.errorCb(errorRes),_scope.errorRes=errorRes||{}};cb(resolve,error);var rta={then:function(cb){return _scope.res?_scope.res=cb(_scope.res):_scope.cb=cb,rta},error:function(errorCb){return _scope.errorRes?errorCb(_scope.errorRes):_scope.errorCb=errorCb,rta},arr:function(){return _scope.res=_scope.res||[],_scope.res}};return rta}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol?"symbol":typeof obj},subTotal=function(model,diags,basePrice,opt){opt=opt||{},opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo.basePrice=opt.s.priceInfo.basePrice);var total=0;model.diags=model.diags||{},Object.keys(model.diags).forEach(function(mkey){return model.diags[mkey]?void diags.forEach(function(dval,dkey){return dval.show&&dval.name==mkey?(opt.s&&(opt.s.priceInfo[mkey]=dval.price),total+=dval.price||0,!1):void 0}):void(opt.s&&opt.s.priceInfo[mkey]&&delete opt.s.priceInfo[mkey])});var rta=basePrice+total;return 0===total?(opt.s&&(opt.s.priceInfo.basePrice=0),rta=0):opt.s&&(opt.s.priceInfo.basePrice=basePrice),rta},sizePrice=function(model,diags,squareMetersPrice,basePrice,opt){var rta=0,isHouse=model.info?model.info.house:model.house,squareMeters=model.info?model.info.squareMeters:model.squareMeters;if(isHouse&&squareMeters){var porcent=squareMetersPrice[squareMeters];if((_.isUndefined(porcent)||_.isNull(porcent))&&(console.warn("sizePrice: squareMeters missing in model."),porcent=0),0===parseInt(porcent))rta=0;else{var sub=subTotal(model,diags,basePrice,opt);rta=sub*parseInt(porcent),rta/=100}}return opt&&opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo.sizePrice=rta),rta},totalPrice=function(showRounded,model,diags,squareMetersPrice,basePrice,opt){var tot=subTotal(model,diags,basePrice,opt)+sizePrice(model,diags,squareMetersPrice,basePrice,opt),realTot=10*parseInt(parseInt(tot)/10,10);return opt=opt||{},opt.s&&(opt.s.priceInfo=opt.s.priceInfo||{},opt.s.priceInfo["Round-to-near-10"]=-1*(tot-realTot)),opt.overwriteModel===!1||(model.price=realTot),showRounded?realTot:tot},$hasMouse=function(change){$("html").on("mousemove",function(e){change(!0),$("html").off("mousemove")}),change(!1)};$(function(){$.hrefAnchor=function(){var url=window.location.href,idx=url.indexOf("#"),hash=-1!=idx?url.substring(idx+1):"";return hash.replace("/","")},$.scrollToAnchor=function(){var elem=$("#"+$.hrefAnchor());$("html, body").animate({scrollTop:elem.offset().top},500)},$.onGlobalError=function(cb){$("html").on("error",function(){console.log("ERROR.DETECTED")})},$.downloadPNG=function(elem,name){html2canvas(elem,{onrendered:function(canvas){var imgData=canvas.toDataURL("image/jpeg",1),pdf=new jsPDF;pdf.addImage(imgData,"JPEG",25,20),pdf.save("download.pdf")}})}});var whenProperties=function(o,props,cbArray){var i=setInterval(function(){var rta=!0;props.forEach(function(v){_.isUndefined(o[v])&&(rta=!1)}),rta&&(clearInterval(i),cbArray.forEach(function(cb){cb()}))},200)};!function(exports){var BASE64URICHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split("");exports.newId=function(len,radix){var chars=BASE64URICHARS,newId=[],i=0;for(radix=radix||chars.length,len=len||22,i=0;len>i;i++)newId[i]=chars[0|Math.random()*radix];return newId.join("")}}("undefined"==typeof exports?window:exports);var downloadFile=function(filename,encodedData,mimeType){var link=document.createElement("a");mimeType=mimeType||"text/plain",link.setAttribute("download",filename),link.setAttribute("href","data:"+mimeType+";charset=utf-8,"+encodedData),link.click()},downloadJSON=function(filename,data){downloadFile(filename,JSON.stringify(data,null,"	"),"text/json")},ToStringParameters=function(obj){var rta="";for(var x in obj)""!=rta&&(rta+="&"),rta+=x+"="+decodeURIComponent(JSON.stringify(obj[x]));return rta},getHashParams=function(){for(var e,hashParams={},a=/\+/g,r=/([^&;=]+)=?([^&;]*)/g,d=function(s){return decodeURIComponent(s.replace(a," "))},q=window.location.hash.substring(1);e=r.exec(q);)hashParams[d(e[1])]=d(e[2]);return hashParams};"undefined"!=typeof exports?(exports.MyPromise=MyPromise,exports.getHashParams=getHashParams,exports.getParameterByName=getParameterByName,exports.ifThenMessage=ifThenMessage):(window.MyPromise=MyPromise,window.getHashParams=getHashParams,window.getParameterByName=getParameterByName,window.ifThenMessage=ifThenMessage);var srv=angular.module("app.common.service",[]);srv.service("localdb",["$http",function(http){return function(settings){return MyPromise(function(resolve){resolve({localdb:!0})})}}]),srv.directive("fileModel",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attrs){var model=$parse(attrs.fileModel),modelSetter=model.assign;element.bind("change",function(){scope.$apply(function(){modelSetter(scope,element[0].files[0])})})}}}]),srv.service("fileUpload",["$http",function($http){this.single=function(opt,success,err){var fd=new FormData;Object.keys(opt.data).forEach(function(key){fd.append(key,opt.data[key])}),fd.append("file",opt.file),$http.post(opt.url,fd,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(success).error(err)}}]),srv.service("server",["$http","localdb","$rootScope","fileUpload",function(_http,localdb,r,fileUpload){function getLocalData(){return MyPromise(function(resolve,error){localData?resolve(localData):$.getJSON("./data.json",function(data){localData=data,resolve(localData)}).fail(function(jqxhr,textStatus,error){var err=textStatus+", "+error;console.log("Request Failed: "+err)})})}function handleError(_log,err){_log(err)}function get(relativeUrl,data,callback){var _log=logger(relativeUrl,data);_http({method:"GET",data:data,url:_URL+"/"+relativeUrl}).then(function(res){_log(res),callback&&callback(res)},function(err){return handleError(_log,err)})}function _post(relativeUrl,data,callback,error){var _log=logger(relativeUrl,data);_http({method:"POST",data:data,url:_URL+"/"+relativeUrl}).then(function(res){return _log(res),res.data&&0==res.data.ok&&console.warn("SERVER:REQUEST:WARNING = ",res.data.err||"Unkown error detected"),callback(res)},function(err){handleError(_log,err),error(err)})}function login(data){return console.log("SEVICE LOGIN",data),MyPromise(function(resolve,error){_post("login",data,function(res){resolve(res)},error)})}function save(table,data){return MyPromise(function(resolve,error){_post("save/"+table,data,function(res){resolve(res)},error)})}function getSingle(table,data){return MyPromise(function(resolve,error){_post("get/"+table,data,function(res){resolve(res)},error)})}function getAll(table,data){return MyPromise(function(resolve,error){get("getAll/"+table,data,function(res){resolve(res)},error)})}function custom(controller,action,data,method){return MyPromise("get"===method?function(resolve,error){get(controller+"/"+action,data,function(res){resolve(res)},error)}:function(resolve,error){_post(controller+"/"+action,data,function(res){resolve(res)},error)})}function diagsPriority(cb){ctrl("User","getAll",{userType:"diag",__rules:{disabled:{$ne:!0}},__select:"diagPriority"}).then(function(data){cb(data.result.map(function(v){return{_id:v._id,priority:v.diagPriority}}))})}function timeRangesDiagSayHeCantWorktype(cb){ctrl("TimeRange","getAll",{type:"work-exception",__select:"_user start end repeat"}).then(function(data){cb(data.result.map(function(v){return v}))})}function timeRangesDiagIsWorking(order,cb){ctrl("Order","getAll",{__select:"diagStart diagEnd _diag",__rules:{status:{$ne:"complete"}}}).then(function(data){data.result=data.result.filter(function(v){return moment(v.diagStart).isSame(moment(order.day),"day")}),cb(data.result.map(function(v){return{_user:v._diag,start:v.diagStart,end:v.diagEnd}}))})}function getAvailableRanges(order){function _data(cb){timeRangesDiagIsWorking(order,function(working){timeRangesDiagSayHeCantWorktype(function(exceptions){diagsPriority(function(diags){cb(working,exceptions,diags)})})})}function calc(order,working,exceptions,diags){return diagsCalculateAvailableSlots(order,working,exceptions,diags);var diags}if(!isFinite(new Date(order.day)))throw Error("getAvailableRanges Invalid order day");return MyPromise(function(resolve,error){_data(function(working,exceptions,diags){resolve(calc(order,working,exceptions,diags))})})}function ctrl(ctrl,action,data){return MyPromise(function(resolve,error){_post("ctrl/"+ctrl+"/"+action,data,function(res){return resolve(res.data)},error)})}var _URL="http://localhost:5000";$.ajax("/serverURL").then(function(r){_URL=r.URL,console.info("server:url:"+_URL)});var localData=null,spinner=function(){return function(v){r.showSpinner=v,r.dom()}}(),logger=function(){var _controlledErrorsStrings=[],_controlledErrors={},_errors={},_logs={},fn=new function(){var self=this;return self.id=newId(20),function(url,req){var item={url:url,req:req};return _logs[self.id]=item,setTimeout(function(){void 0!==_logs[self.id]&&(item.err="Logger: request timeout.",delete _logs[self.id])},3e4),r.$emit("logger.working"),function(res){if(res.data||res.result){var data=res.data||res;data.ok!==!0&&(item.err=data.err||data,item.message=data.message||null,_.includes(_controlledErrorsStrings,item.err)?_controlledErrors[self.id]=item:_errors[self.id]=item)}else item.err="Server down, try later.",_.includes(_controlledErrorsStrings,item.err)?_controlledErrors[self.id]=item:_errors[self.id]=item;_.isUndefined(_logs[self.id])||delete _logs[self.id],0===Object.keys(_logs).length&&r.$emit("logger.clear")}}};return fn.addControlledErrors=function(arr){_controlledErrorsStrings=_.union(arr,_controlledErrorsStrings)},fn.clearErrors=function(){return _errors={}},fn.hasErrors=function(){return Object.keys(_errors).length>0},fn.hasPending=function(){return Object.keys(_logs).length>0},fn.pending=function(){var msg="Pending<br>";return _.each(_logs,function(v,k){console.info(v.url),""!==msg&&(msg+="<br>"),msg+=v.url+": "+JSON.stringify(v.req)}),msg},fn.errors=function(){var msg="Errors<br>";return _.each(_errors,function(v,k){console.info(v),""!==msg&&(msg+="<br>");try{msg+=v.url+": "+JSON.stringify(v.err)}catch(e){msg+=v.url+": Unparseable error. See the console."}}),msg},r.state={working:function(){return fn.hasPending()},data:_logs},r.logger=fn,fn}();r.$on("logger.working",function(){spinner(!0)}),r.$on("logger.clear",function(){spinner(!1)}),r.get=get;var ws=([{price:60,diagStart:(new Date).getTime()-18e5,diagEnd:(new Date).getTime()+18e5,_diag:1},{price:55,diagStart:(new Date).getTime()-72e5,diagEnd:(new Date).getTime()-36e5,_diag:1}],{URL:function(){return _URL},getAvailableRanges:getAvailableRanges,login:login,save:save,get:getSingle,getAll:getAll,localData:getLocalData,custom:custom,http:function(ctrl,action,data){return _http.post(_URL+"/ctrl/"+ctrl+"/"+action,data)},form:function(relativeURL,data){if(!data.file)throw Error("form: file arg required");return MyPromise(function(r,err){var file=data.file;delete data.file;var _log=logger(relativeURL,data);fileUpload.single({url:_URL+"/"+relativeURL,file:file,data:data},function(res){_log(res),r(res)},function(res){_log(res),err(res)})})},ctrl:ctrl,$get:function(url,config){return MyPromise(function(resolve,error){var _log=logger(url,data);_http.get(url,config).then(function(res){_log({ok:!0,result:res}),resolve(res)},function(err){_log({ok:!1,err:err}),error(err)})})},$post:function(url,data,config){return MyPromise(function(resolve,error){var _log=logger(url,data);_http.post(url,data,config).then(function(res){_log({ok:!0,result:res}),resolve(res)},function(err){_log({ok:!1,err:err}),error(err)})})},post:function(url,data){return MyPromise(function(resolve,error){_post(url,data,function(res){resolve(res)},error)})}});return r.ws=ws,ws}]);var app=angular.module("app.common.root",[]);app.run(["server","$timeout","$rootScope",function(db,$timeout,r){window.r=r,r.getHashParams=getHashParams,r.debug=!0,r.config={},db.localData().then(function(data){return Object.assign(r.config,data.config||{})}),r.__cache={},r.cache=function(n,o){return o?r.__cache[n]=o:(!_.isUndefined(r.__cache[n])&&!_.isNull(r.__cache[n]),r.__cache[n]||null)},r.momentFormat=function(d,f){return moment(d).format(f)},r.dom=function(cb,timeout){$timeout(function(){cb&&cb(),r.$apply()},timeout||0)},r.toggleBody=function(val){r.dom(function(){var el=document.body;el.className=el.className.replace("hidden","").trim(),val||(el.className=(el.className+" hidden").trim())})},r.db=function(){var lib=new localStorageDB("inspectors",localStorage),db={setUnique:function(tableName,data){lib.insertOrUpdate(tableName,{ID:1},data),lib.commit()},getUnique:function(tableName){return lib.queryAll(tableName)[0]},getAll:function(tableName){return lib.queryAll(tableName)}};return db.createSession=function(force){force&&lib.tableExists("session")&&lib.dropTable("session"),lib.createTable("session",["_id","email","expire","userType","password","rememberPass","clientType"]),db.setUnique("session",{_id:null,email:null,expire:null,password:null,userType:null,clientType:null,rememberPass:!0})},lib.tableExists("session")||db.createSession(),db}(),r.session=function(data){return data&&(r.db.setUnique("session",data),r._session=data),Object.assign(r.db.getUnique("session"),r._session||{})},r.logged=function(){var ss=r.session();return null!==ss.email&&null!==ss.password},r.viewAsClient=function(){r._session=r._session||{},r._session.userType="client",r.dom()},r.viewAsDiag=function(){r._session=r._session||{},r._session.userType="diag",r.dom()},r.viewAsAdmin=function(){r._session=r._session||{},r._session.userType="admin",r.dom()},r._login={email:"",password:""};var session=r.session();_.each(session,function(val,key){r._login[key]=val}),session.password&&(r._login.password=session.password),session.rememberPass||(r._login.password=null),r.logout=function(){r.session({email:null,password:null}),r.route("login")},r.route=function(url,delay){setTimeout(function(){var path=window.location.origin+window.location.pathname;path+="#/"+url,window.location.href=path},delay||0)},r.userIs=function(arr){var type=r.session().userType;return _.includes(arr,type)},r.routeParams=function(obj){r.params=Object.assign(r.params||{},obj)},r.hasMouse=!1,$hasMouse(function(v){r.hasMouse=v,r.dom()})}]);var app=angular.module("app.common.directives",[]);app.directive("ctrlDtp",function($rootScope){return{restrict:"AE",scope:{opt:"=options"},replace:!0,templateUrl:"./views/directives/directive.ctrl.datetimepicker.html",link:function(s,el,attrs){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}var opt=s.opt;if(expose&&expose(opt.name||"dtp",s),!opt.modelPath)throw Error("ctrlDtp require opt.modelPath");if(!opt.scope)throw Error("ctrlDtp require opt.scope");if(!opt.cls)throw Error("ctrlDtp require opt.cls (function)");if(!opt.disabled)throw Error("ctrlDtp require opt.disabled (function)");s=Object.assign(s,{scope:opt.scope,opened:!1,disabled:function(){return opt.disabled()},cls:function(){return opt.cls()},model:opt.initDate||new Date}),opt.scope.$watch(function(){opt.digest&&opt.digest(opt)}),opt.scope.$watch(opt.modelPath,function(v){void 0!==v&&v!==s.model&&(s.model=v)}),s.$watch("model",function(v){setVal(opt.scope,opt.modelPath,v)})}}}),app.directive("ctrlSelect",function($rootScope){return{restrict:"AE",scope:{opt:"=options"},replace:!0,templateUrl:"./views/directives/directive.ctrl.select.html",link:function(s,el,attrs){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}var r=$rootScope,opt=s.opt;if(!opt.modelPath)throw Error("ctrlSelect require opt.modelPath");if(!opt.scope)throw Error("ctrlSelect require opt.scope");if(!opt.items)throw Error("ctrlSelect require opt.items");if(!opt.cls)throw Error("ctrlSelect require opt.cls (function)");if(!opt.disabled)throw Error("ctrlSelect require opt.disabled (function)");s=Object.assign(s,{scope:opt.scope,label:opt.label||"(Select Item)",disabled:function(){return opt.disabled()},cls:function(){return opt.cls()},click:function(x){setVal(opt.scope,opt.modelPath,x.val||x)}}),opt.filterWatch?s.scope.$watch(opt.filterWatch,function(){opt.filter&&(s.opt.items=_.filter(s.opt.items,function(v){return opt.filter(v)}))},!0):s.scope.$watch(function(){opt.filter&&(s.opt.items=_.filter(s.opt.items,function(v){return opt.filter(v)}))}),opt.scope.$watch(opt.modelPath,function(v,oldV){var arr=s.opt.items.filter(function(item){return(item.val||item)==v});if(arr.length>1)throw Error("ctrlSelect items val need to be unique.");1==arr.length?(s.label=arr[0].label||arr[0],opt.change&&opt.change(arr[0],opt,function(){v!==oldV&&setVal(opt.scope,opt.modelPath,oldV)}),r.dom()):(opt.label&&(s.label=opt.label||"(Select Item)"),console.warn("ctrlSelect model has an invalid value. Values expected: "+JSON.stringify(s.opt.items.map(function(item){return item.val||item}))))}),opt.init&&opt.init(opt)}}}),app.directive("includeReplace",function(){return{require:"ngInclude",restrict:"A",link:function(scope,el,attrs){el.replaceWith(el.children())}}}),app.directive("focusOn",function(){return function(scope,elem,attr){scope.$on("focusOn",function(e,name){name===attr.focusOn&&elem[0].focus()})}}),app.directive("collapseNav",function($timeout,$rootScope){return{restrict:"AE",replace:!1,link:function(s,elem,attr){var r=$rootScope;r.dom(function(){elem.find("li").on("click",function(){r.dom(function(){var w=$(window).width();768>w&&elem.collapse("hide")})})})}}}),app.factory("focus",function($rootScope,$timeout){return function(name){$timeout(function(){$rootScope.$broadcast("focusOn",name)})}}),app.directive("crudModal",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open",close:"=close"},template:"<output></output>",link:function(s,elem,attrs){var fire=function(n,p,ctx){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){ctx?cb.call(ctx,p):cb(p)}))};s.open=function(opt){if(s.evts=opt.evts,!opt.templateUrl)throw Error("crudModal needs templateUrl");$uibModal.open({animation:!0,templateUrl:opt.templateUrl,controller:function($scope,$uibModalInstance){var s=$scope;s.fire=function(n,p){return fire(n,p,s)},Object.assign(s,opt),s.save=s.validate=function(){s.validate&&s.validate.when&&s.validate.fail?ifThenMessage(s.validate.when(s),s.validate.fail(s),function(){s.close()}):s.close()},s.close=function(){$uibModalInstance.close(),opt.callback(s.item)},s.closeSilent=function(){$uibModalInstance.close()},s.redirect=function(url){r.params={item:s.item},r.route(url),s.closeSilent()},s.cancel=function(){$uibModalInstance.dismiss("cancel")},fire("init",null,s)}})}}}}),app.directive("address",function($rootScope,$timeout){return{scope:{model:"=model",field:"@field",change:"=change",number:"@number",street:"@street",city:"@city",department:"@department",region:"@region",country:"@country",postCode:"@postCode"},restrict:"AE",link:function(scope,elem,attrs){if(!scope.model)throw Error("directive address require a valid model.");$timeout(function(){function setVal(obj,propertyPath,val){var split=propertyPath.split("."),lastIndex=split.length-1;return split.forEach(function(chunk,index){var isLast=lastIndex==index;return isLast?!1:(obj=obj[chunk]||null,obj?void 0:!1)}),obj?(val&&(obj[split[lastIndex]]=val),obj[split[lastIndex]]):void 0}function read(){$timeout(function(){""!==scope.model[scope.field]&&elem.geocomplete("find",scope.model[scope.field]),scope.$apply()})}elem.geocomplete().bind("geocode:result",function(event,result){scope.model[scope.field]=result.formatted_address,scope.change&&scope.change(result.formatted_address);var number,street,city,department,region,country,postCode,data=result.address_components.map(function(v){return v.long_name});4==data.length&&(number="",street=data[0],city=data[1],department=data[1],region="",country=data[2],postCode=data[3]),5==data.length&&(number="",street=data[0],city=data[0],department=data[1],region=data[2],country=data[3],postCode=data[4]),6===data.length&&(number="",street=data[0],city=data[1],department=data[2],region=data[3],country=data[4],postCode=data[5]),7===data.length&&(number=data[0],street=data[1],city=data[2],department=data[3],region=data[4],country=data[5],postCode=data[6]),scope.number&&setVal(scope.model,scope.number,number),scope.street&&setVal(scope.model,scope.street,street),scope.city&&setVal(scope.model,scope.city,city),scope.department&&setVal(scope.model,scope.department,department),scope.region&&setVal(scope.model,scope.region,region),scope.country&&setVal(scope.model,scope.country,country),scope.postCode&&setVal(scope.model,scope.postCode,postCode),expose("address",Object.assign(result,scope)),r.dom()}),read(),scope.$watch("model."+scope.field,read),scope.$apply()})}}}),app.directive("debug",function($rootScope,$timeout,server,$compile){return{scope:{show:"=show"},restrict:"AE",replace:!0,template:'<div><i ng-show="show" ng-click="click()" class="link fa fa-bug fa-lg fixed left-1 bottom-1 always-on-top"><input type="checkbox" ng-click="stop()" ng-model="check"></i><span data-output></span></div>',link:function(s,elem,attrs){var r=$rootScope;s.check=!0,s.opt={onClose:function(){r.logger.clearErrors()}},s.stop=function(){return window.event.stopPropagation()},s.click=function(){var log=r.logger.pending();log&&s.create(log,"info");var err=r.logger.errors();err&&s.create(err,"danger")},s.$watch("check",function(v){v?(s.checking&&clearInterval(s.checking),s.checking=setInterval(function(){r.logger.hasErrors()&&r.dom(function(){0===elem.find("[data-output] .alert-danger").length&&s.create(r.logger.errors(),"danger")})},1e3),window.onerror=function(err){s.create(err,"danger")}):(s.checking&&clearInterval(s.checking),window.onerror=function(err){})}),s.create=function(msg,type){s.msgs=s.msgs||{};var cls="always-on-top fixed overlay limit-h-200 fullwidth "+("danger"===type?"bottom-1":"top-1"),el=$compile("<my-alert opt='opt' message='"+msg+"' type='alert-"+(type||"danger")+"' cls='"+cls+"' />")(s);void 0!==s.msgs[type]&&s.msgs[type].alert("close"),s.msgs[type]=el,r.dom(function(){elem.find("[data-output]").append(el)})},setTimeout(function(){-1!==server.URL().indexOf("localhost")&&(s.show=!0,r.dom())},5e3)}}}),app.directive("spinner",function($rootScope,$timeout){return{scope:{show:"=show"},restrict:"AE",replace:!0,templateUrl:"./views/directives/directive.spinner.html",link:function(scope,elem,attrs){}}}),app.directive("checkBox",function($rootScope,$timeout){return{scope:{val:"=val",arr:"=push"},restrict:"AE",replace:!0,template:"<input type='checkbox'/>",link:function(scope,elem,attrs){$timeout(function(){scope.$apply(function(){elem.value=scope.val,elem.on("change",function(){var checked=elem.get(0).checked;checked?(scope.arr=scope.arr||[],scope.arr.push(scope.val)):_.remove(scope.arr,function(e){return e===scope.val})})})})}}}),app.directive("notify",function($rootScope,$timeout){return{scope:{message:"@message",type:"@type",cls:"@cls",scroll:"=scroll",opt:"=opt",evts:"=evts",settings:"=settings"},restrict:"AE",replace:!0,templateUrl:"./views/directives/directive.alert.notify.html",link:function(scope,elem,attrs){var r=$rootScope,s=scope;if(s.settings&&"string"==typeof s.settings){var fixedJSON=s.settings.replace(/(['"])?([a-zA-Z0-9_]+)(['"])?:/g,'"$2": ');s.settings=JSON.parse(fixedJSON)}var fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};$timeout(function(){scope.$apply(function(){elem.find(".alert").addClass(scope.type||"alert-danger"),scope.cls&&elem.find(".alert").addClass(scope.cls)})}),scope.clickDismiss=function(){s.settings&&s.settings.clickDismissable===!1&&s.opt&&!s.opt.clickDismissable||scope.dismiss()},scope.dismiss=function(){s.dismissed||(s.dismissed=!0,elem.find(".alert").alert("close"),elem.remove(),fireEvent("close"),scope.opt&&scope.opt.onClose&&scope.opt.onClose())},scope.$watch("message",function(v){elem.find("[data-message]").html(v)}),s.opt&&s.opt.duration?r.dom(s.dismiss,s.opt.duration):(_.includes(["alert-info","alert-success"],s.type)&&r.dom(scope.dismiss,2e3),_.includes(["alert-danger","alert-warning"],s.type)&&r.dom(scope.dismiss,1e4))}}}),app.directive("myAlert",function($rootScope,$timeout){return{scope:{message:"@message",type:"@type",cls:"@cls",scroll:"=scroll",opt:"=opt",evts:"=evts"},restrict:"AE",replace:!0,templateUrl:"./views/directives/directive.alert.html",link:function(scope,elem,attrs){var s=scope,fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};$timeout(function(){scope.$apply(function(){elem.addClass(scope.type||"alert-danger"),scope.cls&&elem.addClass(scope.cls)})}),scope.dismiss=function(){elem.alert("close"),fireEvent("close"),scope.opt&&scope.opt.onClose&&scope.opt.onClose()},scope.$watch("message",function(v){elem.find("[data-message]").html(v),v&&scope.scroll&&r.dom(function(){$("html, body").animate({scrollTop:elem.offset().top},500)})})}}}),app.directive("myAlerts",function($rootScope,$timeout,$compile){return{restrict:"AE",replace:!0,scope:{add:"=add",directive:"@directive",stacked:"@stacked",settings:"@settings"},template:"<output></output>",link:function(s,elem,attrs){function onClose(){if(s.stacked){if(s.el=null,0===s._stacked.length)return;var p=s._stacked[0];s._stacked=s._stacked.slice(1),s.add(p.message,p.type,p.timeout,p.scroll,p.opt)}}s.stacked="true"===s.stacked,s.decodeMessage=function(msg){return"string"==typeof msg?msg:JSON.stringify(msg)},s._stacked=[],s.evts={close:[onClose]};var fireEvent=function(n){s.evts&&(s.evts[n]=s.evts[n]||[],s.evts[n].forEach(function(cb){cb()}))};s.add=function(message,type,timeout,scroll,opt){var msg=s.decodeMessage(message);if(type&&"string"!=typeof type&&(opt=type,type=opt.type||void 0),timeout&&"object"===("undefined"==typeof timeout?"undefined":_typeof(timeout))&&(opt=timeout,timeout=void 0),opt&&opt.scroll===!0&&(scroll=!0),s.stacked){if(s.el)return s._stacked.push({message:message,type:type,timeout:timeout,scroll:scroll,opt:opt})}else s.el&&s.el.alert("close");var directive=s.directive||"my-alert";s.opt=opt;var el=$compile("<"+directive+" settings='settings' evts='evts' opt='opt' scroll='"+scroll+"' message='"+msg+"' type='alert-"+(type||"danger")+"'/>")(s);s.el=el,elem.html("").append(el),timeout&&"my-alert"===directive&&r.dom(function(){elem.html(""),fireEvent("close")},timeout)},window.ss=s}}}),app.directive("modalConfirm",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"},template:"<output></output>",link:function(s,elem,attrs){s.open=function(opt,okCallback){opt=opt||{};var message="";message="string"==typeof opt?opt:opt.message||"";$uibModal.open({animation:!0,templateUrl:opt.templateUrl||"views/directives/directive.modal.sure.html",controller:function($scope,$uibModalInstance){$scope.data=opt.data,$scope.message=message,$scope.yes=function(){$uibModalInstance.close(),okCallback&&okCallback()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}})}}}}),app.directive("dynamicTable",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!0,scope:{model:"=model"},templateUrl:"views/partials/partials.table.html",link:function(s,elem,attrs){var r=$rootScope;$rootScope.$watch("hasMouse",function(v){s.hasMouse=v});attrs.name;return s.model?(s.click=function(item,index){s.model.click&&s.model.click(item,index)},s.buttons=s.model.buttons||null,s.columns=s.model.columns||[],s.items=s.model.items||[],void(s.model.update=function(items,data){s.items=items,s.data=data,r.dom()})):void console.error("directive.table: no model present")}}}),app.directive("htmlContent",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce){return{restrict:"AE",replace:!1,scope:{html:"=html"},link:function(s,elem,attrs){r.dom(function(){elem.html(s.html)})}}}),app.directive("timeRange",function($rootScope,$timeout,$compile,$uibModal){return{restrict:"AE",replace:!0,scope:{open:"=open"
},template:"<output></output>",link:function(s,elem,attrs){s.open=function(opt){$uibModal.open({animation:!0,templateUrl:"views/directives/directive.modal.timeRange.html",controller:function($scope,$uibModalInstance){var s=$scope;s.title=opt.title,s.title||(s.title="Time Range",opt.action&&"edit"===opt.action?s.title+=" - Edition":s.title="New "+s.title),s._opt=opt,window.edit=s,s.days=function(){var o={label:"Day",selected:"",items:[],val:null,select:function(val){o.items.forEach(function(v){v.val.toString()==val.toString()&&o.click(v)})},click:function(v){o.selected=v.label||v,o.val=v.val,s.start.val&&(s.start.val=moment(s.start.val),s.start.val.day("-1"===o.val.toString()?1:o.val)),s.end.val&&(s.end.val=moment(s.end.val),s.end.val.day("-1"===o.val.toString()?1:o.val))}},m=moment();o.items.push({label:"(Choice a day)",val:""},{label:"Every day",val:"-1"});for(var x=1;7>=x;x++)m.day(x),o.items.push({label:m.format("dddd"),val:x});return o.selected=o.items[0].label,o}();var timePickerData=function(){return function(m){return{hstep:1,mstep:10,repeat:"",minDate:moment().date(1),val:m||moment().hour(9).minutes(0)}}}();if(s.start=timePickerData(opt.start),s.end=timePickerData(opt.end),s.repeat="none",s.daySelection=function(){return"none"!==s.repeat},s.datepicker={val:void 0,minDate:moment().add(1,"day"),maxDate:moment().add(2,"month"),initDate:new Date},s.$watch("repeat",function(v){"day"===v&&s.days.select(-1)}),s.validate=function(){if(!s.description,!s.days.val)return s.message("Choice a day","warning",2e3),!1;if("day"!==s.repeat&&"-1"===s.days.val.toString())return s.message("Choice a day","warning",2e3),!1;if("none"===s.repeat&&void 0==s.datepicker.val)return void s.message("Choice a day in the calendar","warning",2e3);try{var _d=moment(s.start.val);_d=moment(s.end.val),"none"===s.repeat&&(s.start.val=moment(s.datepicker.val).hour(moment(s.start.val).hour()).minutes(moment(s.start.val).minutes()).toDate(),s.end.val=moment(s.datepicker.val).hour(moment(s.end.val).hour()).minutes(moment(s.end.val).minutes()).toDate())}catch(e){return s.message("Invalid time","warning",2e3),!1}return!0},s.save=function(){if(s.validate()){$uibModalInstance.close();var rta={description:s.description||"",start:s.start.val,end:s.end.val,type:opt.type,repeat:s.repeat};"edit"==opt.action&&(rta._user=opt.item._user,rta._id=opt.item._id),opt.callback(rta)}},s.cancel=function(){$uibModalInstance.dismiss("cancel")},!opt.action)throw Error("directive timeRange open require arg.action");if("new"==opt.action,"edit"===opt.action){var start=moment(opt.item.start);s.repeat=opt.item.repeat,s.description=opt.item.description,s.start.val=opt.item.start,s.end.val=opt.item.end,opt.type=opt.item.type,s.days.val=start.day(),s.days.select(s.days.val),"day"==s.repeat&&(s.days.val=-1)}}})}}}});var app=angular.module("app",["app.admin.routes","app.admin.login","app.admin.user","app.admin.diag","app.admin.diag.balance","app.admin.order","app.admin.client","app.admin.calendar","app.notifications","app.admin.client.payments","app.common.directives","app.common.service","app.common.root","ngRoute","mwl.calendar","ui.bootstrap","ui.bootstrap.datetimepicker"]);app.run(["server","$timeout","$rootScope",function(db,$timeout,r){r.navShow=!0,r.toggleNavbar=function(val){r.navShow=val,r.dom()},r.secureSection=function(_s){_s.show=!1,r.logged()?_s.show=!0:(console.warn("secureSection:redirecting to login"),r.route("login"))},r.handleSecurityRouteViolation=function(){r.route("dashboard"),console.warn("SECURITY: YOU-DONT-BELONG-HERE")},$("html").keydown(function(event){if("27"==event.keyCode&&r.params&&r.params.prevRoute&&r.__currentCtrlScope&&r.__currentCtrlScope.back){if(r.state.working())return void r.message("Loading...",{type:"warning",duration:2e3});var fn=r.__currentCtrlScope.back;r.__currentCtrlScope=null,fn()}}),r.setCurrentCtrl=function(_s){r.__currentCtrlScope=_s}}]),app.config(function(calendarConfig){calendarConfig.dateFormatter="moment",calendarConfig.displayEventEndTimes=!0,calendarConfig.showTimesOnWeekView=!0}),app.controller("adminDashboard",["server","$scope","$rootScope",function(db,s,r){r.toggleNavbar(!0),r.secureSection(s)}]),app.directive("adminBalance",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/partials/partial.admin.balance.html",link:function(s,elem,attrs){var ws=server;attrs.name;ws.ctrl("Payment","balance").then(function(data){var b={},out=data.result;b.available=_.sumBy(out.available,function(o){return o.amount})/100,b.pending=_.sumBy(out.pending,function(o){return o.amount})/100,b.livemode=out.livemode,s.b=b}),ws.ctrl("Stats","general").then(function(data){s.g=data.result})}}}),app.directive("adminTurnover",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){function update(){var data={__populate:{_client:"email userType",_diag:"email userType"}};r.userIs(["diag"])&&(data._diag=r.session()._id),r.userIs(["client"])&&(data._client=r.session()._id),ws.ctrl("Payment","balanceTransactions",data).then(function(res){res.ok&&(res.result.data.forEach(function(v){v.amount=v.amount/100,v.created=moment(v.created).format("DD/MM/YY HH:MM"),v._order={_id:"!@#!@#!@",description:"Zararara"}}),s.model.update(res.result.data))})}var r=$rootScope,ws=server;attrs.name;s.title="Balance details",s.model={click:function(item,index){function _open(){s.open({title:"Balance Transaction",data:data,evts:{init:[]},item:item,templateUrl:"views/partials/partial.modal.balance.details.html",callback:function(item){}})}var data={};ws.localData().then(function(d){Object.assign(data,d)}),ws.ctrl("Payment","associatedOrder",{source:item.source}).then(function(data){item=Object.assign(data.result),_open()})},buttons:[{label:"Refresh",type:function(){return"btn btn-primary spacing-h-1"},click:function(){return update()}}],columns:[{label:"Description",name:"description"},{label:"Amount (eur)",name:"amount",align:"right"},{label:"Created",name:"created"}],items:[]},update()}}});var srv=angular.module("app.admin.routes",[]);app.config(["$routeProvider",function($routeProvider){$routeProvider.when("/",{templateUrl:"views/view.admin.login.html"}).when("/dashboard",{templateUrl:"views/view.admin.dashboard.html"}).when("/global-calendar",{templateUrl:"views/view.admin.calendar.html"}).when("/notifications",{templateUrl:"views/view.notifications.html"}).when("/administrators",{templateUrl:"views/view.admin-list.html"}).when("/administrators/edit/:id",{templateUrl:"views/view.admin-edit.html"}).when("/clients",{templateUrl:"views/view.admin.clients.html"}).when("/clients/edit/:id",{templateUrl:"views/view.admin.clients.edit.html"}).when("/users",{templateUrl:"views/view.admin.users.html"}).when("/users/edit/:id",{templateUrl:"views/view.admin.users.edit.html"}).when("/diag/balance",{templateUrl:"views/view.admin.diag.balance.html"}).when("/diags",{templateUrl:"views/view.admin.diags.html"}).when("/diags/edit/:id",{templateUrl:"views/view.admin.diags.edit.html"}).when("/orders",{templateUrl:"views/view.admin.orders.html"}).when("/orders/edit/:id",{templateUrl:"views/view.admin.orders.edit.html"}).when("/orders/view/:id",{templateUrl:"views/view.admin.orders.view.html"}).otherwise({redirectTo:"/"})}]);var app=angular.module("app.admin.calendar",[]);app.directive("globalCalendar",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.diag.calendar.html",link:function(s,elem,attrs){function update(){ws.ctrl("Order","getAll",{__populate:["_client","email"]}).then(function(res){if(res.ok){var evts=[];res.result.forEach(function(v){v.start=moment(v.diagStart).format("HH:mm"),v.end=moment(v.diagEnd).format("HH:mm"),evts.push({item:v,title:"Order ",type:"info",startsAt:new Date(v.diagStart),endsAt:new Date(v.diagEnd),editable:!1,deletable:!1,draggable:!1,resizable:!1,incrementsBadgeTotal:!0,cssClass:"a-css-class-name"}),s.events=evts}),r.cache("global.calendar.events",s.events)}})}var r=$rootScope,ws=server,m=moment();m.year(),m.month();window.s=s,s.calendarView="year",s.views={label:"View Type",selected:s.calendarView,click:function(x){s.calendarView=x.label.toLowerCase(),s.views.selected=s.calendarView,r.dom()},items:[{label:"Day"},{label:"Week"},{label:"Month"},{label:"Year"}]},s.calendarDate=new Date,s.events=r.cache("global.calendar.events")||[],s.eventClicked=function(calendarEvent){r.params={item:calendarEvent.item,prevRoute:"global-calendar"},r.route("orders/edit/"+calendarEvent.item._id)},update()}}}),function(){var vars={TITLE:"Notifications",TPL_CRUD:"views/directives/directive.fast-crud.html",TPL_CRUD_EDIT:"views/partials/notification.edit.html"},app=angular.module("app.notifications",[]);app.directive("sectionNotifications",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:vars.TPL_CRUD,link:function(s,elem,attrs){function update(){var data={__populate:{_config:""}};ws.ctrl("Notification","getAll",data).then(function(res){res.ok&&(console.info("notifications",res.result),s.model.update(res.result,s.balance))})}var r=$rootScope,ws=server;attrs.name;s.title=vars.TITLE,window.balance=s,r.logger.addControlledErrors(["SENDING_DISABLED_TYPE"]),s.model={remove:function(item,index){var rule={_id:item._id};item._config.notifications=_.pull(item._config.notifications,item._id),ws.ctrl("UserNotifications","update",item._config).then(function(d){d.ok&&ws.ctrl("Notification","remove",rule).then(function(d){update(!0)})})},periodSelected:"year",periods:createSelect({label:"(Select a period)",model:"model.periodSelected",scope:s,change:function(x){console.info(x),update(!0)},items:["month","year"]}),buttonsTpl:vars.TPL_CRUD_BUTTONS,tfoot:vars.TPL_CRUD_TFOOT,click:function(item,index){function _open(){s.open({title:"Notification Details",data:data,evts:{init:[]},item:item,templateUrl:vars.TPL_CRUD_EDIT,callback:function(item){}})}var data={send:function(){s.confirm("Confirm sending to "+item.to+"?",function(){ws.ctrl("Email","send",{_user:item._user,_notification:item._id,html:item.contents,to:item.to,subject:item.subject}).then(function(d){console.info(d),update()})})}};_open()},buttons:[{label:"Refresh",type:function(){return"btn btn-primary spacing-h-1"},click:function(){return update(!0)}},{label:"Recalc",show:!1,type:function(){return"btn btn-primary spacing-h-1"},click:function(){return update(!0)}}],columns:[{label:"To",name:"to"},{label:"Subject",name:"subject"},{label:"Sended",name:"sended",format:function(v){return v?"Yes":"No"}},{label:"Created",name:"created",format:function(v){return r.momentFormat(v,"DD-MM-YY HH:mm")}}],items:[]},update()}}})}();var app=angular.module("app.admin.login",["app.common.service"]);app.controller("adminLogin",["server","$scope","$rootScope",function(db,s,r){function _asyncUpdateSession(){db.ctrl("User","get",{_id:session()._id}).then(function(err,data){!err&&data.ok&&data.result&&r.session(data.result)})}console.info("app.admin.login:adminLogin"),r.navShow=!1,s.show=!1,s.loginFailedTimes=0,s.create=function(){function _create(){db.custom("user","save",{email:r._login.email,password:r._login.password,userType:"admin"}).then(function(res){s.sendingRequest=!1,r.session(res.data.result),console.log("adminLogin:admin:creation:success",res.data),r.route("dashboard")}).error(function(err){s.sendingRequest=!1,console.log("adminLogin:admin:creation:fail",err)})}s.sendingRequest=!0,db.custom("user","find",{email:r._login.email}).then(function(res){res.data.result.length>0?(r.session(res.data.result[0]),console.log("login:user:found:"+res.data.result[0].email),r.route("dashboard")):_create()})},s.login=function(){if(-1!==r._login.email.indexOf("admin"))return s.create();var session=r.session();session.email&&session.expire<(new Date).getTime()&&r.db.createSession(!0),s.sendingRequest=!0,db.custom("user","login",r._login).then(function(res){s.sendingRequest=!1,res.data.ok&&null!=res.data.result?(r.session(res.data.result),r.route("dashboard")):(s.loginFailedTimes++,s.addAlert("Incorrect login","warning"))}).error(function(res){s.sendingRequest=!1,s.addAlert(res)})},s.resetPassword=function(){db.ctrl("User","passwordReset",{email:r._login.email}).then(function(res){res.ok&&(r.message("A new password has been send to "+r._login.email,"info",void 0,void 0,{duration:1e4}),s.loginFailedTimes=0,r.dom())})};var params={email:getParameterByName("email"),password:getParameterByName("k")?atob(getParameterByName("k")):""};params.email&&(r._login.email=params.email),params.password&&(r._login.password=params.password),params.email&&params.password&&(console.log("adminLogin: lets try to sign-in from queryparameters"),s.login());var session=r.session();session.email&&session.expire>(new Date).getTime()?(r.session(r._login),console.log("adminLogin: session found at initial check"),_asyncUpdateSession(),r.route("dashboard")):s.show=!0}]);var app=angular.module("app.admin.user",["app.common.service"]);app.controller("adminUsers",["server","$scope","$rootScope",function(db,s,r){function read(){s.message("Loading . . .","info"),db.custom("user","getAll",{}).then(function(r){s.items=r.data.result,s.message("Loaded","success",1e3)})}return r.toggleNavbar(!0),r.secureSection(s),s.selectedItems=[],s.items=[],r.userIs(["diag","client"])?r.handleSecurityRouteViolation():(s.click=function(item,optionalRouteForEdition){r.route((optionalRouteForEdition||"users/edit/")+item._id)},s.create=function(){r.route("users/edit/-1")},s["delete"]=function(item){s.confirm("Remove "+s.selectedItems.length+" item/s?",function(){console.log("adminUsers:removeAll:in-progress"),s.message("deleting . . .","info"),s.requesting=!0,db.custom("user","removeAll",{ids:s.selectedItems}).then(function(res){s.requesting=!1,s.message("deleted","info"),read(),console.info("adminUsers:removeAll:success",r.data)}).error(function(err){s.requesting=!1,s.message("error, try later.","danger"),console.warn("adminUsers:removeAll:error",err)})})},s.select=function(){window.event&&window.event.stopPropagation()},void r.dom(read,0))}]),app.controller("adminUsersEdit",["server","$scope","$rootScope","$routeParams",function(db,s,r,params){function reset(){s.item=_.clone(s.original)}function read(){return r.userIs(["diag","client"])&&params.id!==r.session()._id?r.handleSecurityRouteViolation():(s.message("Loading . . .","info"),s.requesting=!0,void db.custom("user","get",{_id:params.id}).then(function(res){s.requesting=!1,s.item=res.data.result,res.data.ok?(s.types.click(s.item.userType),s.message("Loaded","success",2e3)):s.message("not found, maybe it was deleted!","warning",5e3)}))}if(r.toggleNavbar(!0),r.secureSection(s),r.dom(),expose("s",s),s.item={email:"",password:""},s.original=_.clone(s.item),s.types={selected:"(Choice a user type)",items:[{label:"Admin"},{label:"Diag"},{label:"Client"}],click:function(choice){if("string"!=typeof choice)s.item.userType=choice.label.toString().toLowerCase(),s.types.selected=choice.label;else for(var x in s.types.items)s.types.items[x].label.toString().toLowerCase()==choice.toString().toLowerCase()&&(s.types.selected=s.types.items[x].label,s.item.userType=s.types.items[x].label.toString().toLowerCase())}},params&&params.id&&"-1"!==params.id.toString())r.dom(read,1e3);else{if(r.userIs(["diag","client"]))return r.handleSecurityRouteViolation();reset()}s.back=function(){if(r.userIs(["diag","client"]))r.route("dashboard");else{if(r.params&&r.params.prevRoute)return r.route(r.params.prevRoute);r.route("users")}},s.cancel=function(){s.back()},s.validate=function(){ifThenMessage([[s.item.userType,"==",void 0,"User type required"],[s.item.email,"==","","Email cannot be empty"],[s.item.password,"==","","Password cannot be empty"]],function(m){s.message(m[0],"warning",0,!0)},s.save)},s.save=function(){function _save(){s.requesting=!0,db.custom("user","save",s.item).then(function(res){s.requesting=!1;var _r=res.data;_r.ok?(_r.result&&_r.result._id==r.session()._id&&r.session(_r.result),s.message("saved","success"),s.back()):s.message("error, try later","danger")}).error(function(err){s.requesting=!1,s.message("error, try later.","danger")})}s.message("saving . . .","info"),s.requesting=!0,db.ctrl("User","getAll",{email:s.item.email,userType:s.item.userType,clientType:s.item.clientType}).then(function(data){data.result;if(s.requesting=!1,data.result.length>0){var _item=data.result[0];s.item._id&&s.item._id==_item._id?_save():s.message("Email address in use.")}else _save()})},s["delete"]=function(){s.confirm("Delete User "+s.item.email+" ?",function(){console.log("adminUsersEdit:remove:in-progress"),s.message("deleting . . .","info"),s.requesting=!0,db.custom("user","remove",{_id:s.item._id}).then(function(res){s.requesting=!1,s.message("deleted","info"),reset(),s.back(),console.info("adminUsersEdit:remove:success",r.data)}).error(function(err){s.requesting=!1,s.message("error, try later.","danger"),console.warn("adminUsersEdit:remove:error",err)})})}}]);var app=angular.module("app.admin.diag",["app.common.service"]);app.directive("timeRangeExceptions",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.section.exceptions.html",link:function(s,elem,attrs){function update(){ws.ctrl("TimeRange","getAll",{_user:r.session()._id}).then(function(res){res.ok&&(res.result.forEach(function(v){v.dayFormat=moment(v.start).format("dddd"),v.startFormat=moment(v.start).format("HH:mm"),v.endFormat=moment(v.end).format("HH:mm")}),s.model.update(res.result))})}var r=$rootScope,ws=server;attrs.name;s.model={remove:function(item,index){var msg="Delete "+item.description+" "+item.startFormat+" - "+item.endFormat+" ("+item.dayFormat+")";s.confirm(msg,function(){ws.ctrl("TimeRange","remove",{_id:item._id}).then(function(){update()})})},click:function(item,index){s.open({title:"Edit Exception",action:"edit",item:item,type:"work-exception",callback:function(timeRange){ws.ctrl("TimeRange","createUpdate",timeRange).then(function(result){update()})}})},buttons:[{label:"Refresh",type:function(){return"btn btn-primary spacing-h-1"},click:function(){return update()}},{label:"New",type:function(){return"btn btn-default spacing-h-1"},click:function(){s.open({title:"New Exception",action:"new",type:"work-exception",callback:function(timeRange){timeRange._user=r.session()._id,ws.ctrl("TimeRange","create",timeRange).then(function(result){update()})}})}}],columns:[{label:"Description",name:"description"},{label:"Day",name:"dayFormat"},{label:"Start",name:"startFormat"},,{label:"End",name:"endFormat"},{label:"Repeat rule",name:"repeat"}],items:[{description:"working #1",day:moment().date(1).format("dddd"),start:moment().date(1).format("HH:mm"),end:moment().date(2).format("HH:mm"),repeat:"day"}]},update(),console.log("directive.exceptions.linked")}}}),app.directive("diagOrders",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){function update(){var data={__populate:{_client:"email userType",_diag:"email userType"}};r.userIs(["diag"])&&(data._diag=r.session()._id),r.userIs(["client"])&&(data._client=r.session()._id),ws.ctrl("Order","getAll",data).then(function(res){res.ok&&(res.result.forEach(function(v){v.date=moment(v.diagStart).format("dddd, DD MMMM"),v.start=moment(v.diagStart).format("HH:mm"),v.end=moment(v.diagEnd).format("HH:mm")}),s.model.update(res.result))})}var r=$rootScope,ws=server;attrs.name;s.title="Your Orders",s.model={click:function(item,index){var data={};ws.localData().then(function(d){Object.assign(data,d)}),r.params={item:item,prevRoute:"dashboard"},r.route("orders/edit/"+item._id)},buttons:[{label:"Refresh",type:function(){return"btn btn-primary spacing-h-1"},click:function(){return update()}}],columns:[{label:"Address",name:"address"},{label:"Status",name:"status"},{label:"Start",name:"start"},{label:"End",name:"end"}],items:[]},update()}}}),app.directive("diagCalendar",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.diag.calendar.html",link:function(s,elem,attrs){function update(){var conditions={__populate:{_client:"email userType",_diag:"email userType"}};r.userIs(["diag"])&&(conditions._diag=r.session()._id),r.userIs(["client"])&&(conditions._client=r.session()._id),ws.ctrl("Order","getAll",conditions).then(function(res){if(res.ok){var evts=[];res.result.forEach(function(v){v.start=moment(v.diagStart).format("HH:mm"),v.end=moment(v.diagEnd).format("HH:mm"),evts.push({item:v,title:"Order ",type:"info",startsAt:new Date(v.diagStart),endsAt:new Date(v.diagEnd),editable:!1,deletable:!1,draggable:!1,resizable:!1,incrementsBadgeTotal:!0,cssClass:"a-css-class-name"}),s.events=evts})}})}var r=$rootScope,ws=server,m=moment(),y=m.year(),mo=m.month();window.s=s,s.open=function(){},s.calendarView="year",s.views={label:"View Type",selected:s.calendarView,click:function(x){s.calendarView=x.label.toLowerCase(),s.views.selected=s.calendarView,r.dom()},items:[{label:"Day"},{label:"Week"},{label:"Month"},{label:"Year"}]},s.calendarDate=new Date,s.events=[{title:"Order #2384",type:"info",startsAt:new Date(y,mo,15,1),endsAt:new Date(y,mo,15,15),editable:!1,deletable:!1,draggable:!0,resizable:!0,incrementsBadgeTotal:!0,recursOn:"year",cssClass:"a-css-class-name"}],s.eventClicked=function(calendarEvent){r.params={item:calendarEvent.item,prevRoute:"dashboard"},r.route("orders/edit/"+calendarEvent.item._id)},s.eventEdited=function(evt){},update()}}}),app.controller("diagDashboard",["server","$scope","$rootScope",function(db,s,r){console.info("app.admin.diag:diagDashboard")}]),app.controller("adminDiags",["server","$scope","$rootScope",function(db,s,r){function read(){s.message("loading . . .","info"),db.custom("user","getAll",{userType:"diag"}).then(function(r){console.info("adminDiags:read:success",r.data),s.items=r.data.result,s.message("loaded!","success",1e3)})}console.info("app.admin.diag:adminDiags"),r.toggleNavbar(!0),r.secureSection(s);var isClientOrDiag=r.userIs(["client","diag"]);return isClientOrDiag?r.handleSecurityRouteViolation():(s.selectedItems=[],s.items=[],s.click=function(item){r.route("diags/edit/"+item._id)},s.create=function(){r.route("diags/edit/-1")},s["delete"]=function(item){s.confirm("Remove "+s.selectedItems.length+" item/s?",function(){console.log("adminDiags:removeAll:in-progress"),s.message("deleting . . .","info"),s.requesting=!0,db.custom("user","removeAll",{ids:s.selectedItems}).then(function(res){s.requesting=!1,s.message("deleted","info"),read(),console.info("adminDiags:removeAll:success",r.data)}).error(function(err){s.requesting=!1,s.message("error, try later.","danger"),console.warn("adminDiags:removeAll:error",err)})})},s.select=function(){window.event&&window.event.stopPropagation()},void r.dom(read,0))}]),app.controller("adminDiagsEdit",["server","$scope","$rootScope","$routeParams",function(db,s,r,params){function handleErrors(err){s.requesting=!1,s.message("error, try later.","danger")}function reset(){s.item=_.clone(s.original)}function read(){s.message("loading . . .","info"),s.requesting=!0,db.custom("user","get",{_id:params.id}).then(function(res){s.requesting=!1,s.original=_.clone(res.data.result),s.item=res.data.result,s.diplomesUpdate(),res.data.ok?s.message("loaded","success",2e3):s.message("not found, maybe it was deleted!","warning",5e3)})}r.toggleNavbar(!0),r.secureSection(s);var isClient=r.userIs(["client"]),notCurrentDiag=r.userIs(["diag"])&&r.sesson()._id!==params.id;return isClient||notCurrentDiag?r.handleSecurityRouteViolation():(expose("s",s),r.dom(),s.item={email:"",password:"",address:"",userType:"diag",diagPriority:void 0},s.original=_.clone(s.item),window.edit=s,s.$watch("item.disabled",function(v){v&&s.item._id&&db.ctrl("Order","count",{_diag:s.item._id}).then(function(d){d.ok&&d.result>0&&(s.item.disabled=!1,r.message("Diag can only be disabled when there are not orders assigned.",{type:"warning",duration:5e3}))})}),s.$watch("item.diagPriority",function(v){if(!_.isUndefined(v)&&!_.isNull(v)&&isFinite(v)){if(v===s.original.diagPriority)return;db.ctrl("User","get",{userType:"diag",diagPriority:v,__select:"email"}).then(function(data){null!==data.result&&(s.item.diagPriority=s.original.diagPriority,r.message("Priority "+v+" is alredy assigned to "+data.result.email,"warning",5e3,!0))})}}),s.$watch("item.address",function(v){}),s.addressChange=function(v){return s.item.address=v},params&&params.id&&"-1"!==params.id.toString()?(console.info("adminDiagsEdit:params",params),r.dom(read,1e3)):(console.info("adminDiagsEdit:reset"),reset()),s.cancel=function(){r.route("diags")},s.validate=function(){ifThenMessage([[s.item.email,"==","","Email cannot be empty"],[s.item.password,"==","","Password cannot be empty"]],function(m){s.message(m[0],"warning",0,!0)},s.save)},s.diplomesExpirationDateNotificationEnabled=function(_id){return s.item.diplomesInfo?(void 0==s.item.diplomesInfo[_id].expirationDateNotificationEnabled&&(s.item.diplomesInfo[_id].expirationDateNotificationEnabled=!1),s.item.diplomesInfo[_id].expirationDateNotificationEnabled):!1},s.diplomesEnableExpirationDateNotification=function(_id){s.item.diplomesInfo||console.error("diplomesInfo expected."),s.item.diplomesInfo[_id].expirationDateNotificationEnabled=!0,db.ctrl("Order","update",{_id:s.item._id}).then(function(d){r.notify("Expiration Date Notification Enabled","info")})},s.diplomesUpdate=function(){if(s.item&&s.item.diplomes&&s.item.diplomes.length>0){s.diplomesData={};var infoToDelete=[];Object.keys(s.item.diplomesInfo||{}).forEach(function(_id){_.includes(s.item.diplomes,_id)||infoToDelete.push(_id)}),infoToDelete.forEach(function(k){delete s.item.diplomesInfo[k]}),db.ctrl("User","update",{_id:s.item._id,diplomesInfo:s.item.diplomesInfo}),s.item.diplomes.forEach(function(_id,k){db.ctrl("File","find",{_id:_id}).then(function(data){var file=data.result;data.ok&&file?(s.item.diplomesInfo||(s.item.diplomesInfo={},s.item.diplomesInfo[_id]={expirationDateNotificationEnabled:!1,expirationDateNotificationSended:!1,filename:file.filename},db.ctrl("User","update",{_id:s.item._id,diplomesInfo:s.item.diplomesInfo})),file=Object.assign(file,s.item.diplomesInfo&&s.item.diplomesInfo[file._id]||{}),s.diplomesData[file._id]=s.diplomesDataCreate(file)):(s.item.diplomes=_.pull(s.item.diplomes,_id),s.item.diplomesInfo=_.pull(s.item.diplomesInfo,_id),s.diplomesData[_id]&&delete s.diplomesData[_id],0===Object.keys(s.diplomesData).length&&s.diplomesNew(),db.ctrl("User","update",{_id:s.item._id,diplomes:s.item.diplomes}))})})}else s.item.diplomes=s.item.diplomes||[],s.diplomesNew()},s.diplomesFile={},s.diplomesData={},s.diplomesDelete=function(_id){if(s.diplomesExists(_id)){var name=s.diplomesData[_id]&&s.diplomesData[_id].info.filename||"File";s.confirm("Delete "+name+" ?",function(){db.ctrl("File","remove",{_id:_id}).then(function(d){d.ok&&(s.item.diplomes=_.pull(s.item.diplomes,_id),s.item.diplomesInfo=_.pull(s.item.diplomesInfo,_id),s.diplomesData[_id]&&delete s.diplomesData[_id],0===Object.keys(s.diplomesData).length&&s.diplomesNew(),s.diplomesUpdate())})})}},s.diplomesExists=function(_id){return s.item&&s.item.diplomes&&_.includes(s.item.diplomes,_id)},s.diplomesDownload=function(_id){window.open(db.URL()+"/File/get/"+_id,"_newtab")},s.diplomesNew=function(){s.item&&s.item.diplomes.length!==Object.keys(s.diplomesData).length||(s.diplomesData[(new Date).getTime()]=s.diplomesDataCreate())},s.diplomesLabel=function(_id){var d=s.diplomesData[_id];return s.diplomesExists(_id)?"Pdf "+(d.info&&"("+d.info.filename+")"||"unkown"):(d=s.diplomesFile[_id],d&&d.name?"Selected: "+d.name.toLowerCase()+" (click upload button)":"select a file and click the upload button")},s.diplomesDataCreate=function(info){var o={obtentionMaxDate:new Date,obtentionDateOpen:!1,obtentionDateClick:function(){return o.obtentionDateOpen=!o.obtentionDateOpen},expirationMinDate:new Date,expirationDateOpen:!1,expirationDateClick:function(){return o.expirationDateOpen=!o.expirationDateOpen},dateOptions:{formatYear:"yy",startingDay:1},info:info||{filename:"select a file and click the upload button"}};return o.info.obtentionDate=isFinite(new Date(o.info.obtentionDate))&&new Date(o.info.obtentionDate)||new Date,o.info.expirationDate=isFinite(new Date(o.info.expirationDate))&&new Date(o.info.expirationDate)||new Date,o},s.diplomesSave=function(_id){function _deleteCurr(){db.ctrl("File","remove",{_id:curr})}function _uploadNew(){if(s.diplomesFile[_id]){var _str=s.diplomesFile[_id].name.toString().toLowerCase();if("pdf"!==_str.substring(_str.length-3))return void s.message("PDF Format required",{type:"warning",duration:99999,scroll:!0})}s.message("Uploading (Do not touch anything)",{type:"info",duration:99999,scroll:!0}),db.form("File/save/",{name:s.diplomesFile[_id].name,file:s.diplomesFile[_id]}).then(function(data){if(data.ok){var newId=data.result._id;s.item.diplomes.push(newId),s.item.diplomesInfo=s.item.diplomesInfo||{},s.item.diplomesInfo[newId]=s.diplomesData[_id].info,s.diplomesExists(curr)&&(s.item.diplomes=_.pull(s.item.diplomes,curr),s.item.diplomesInfo=_.pull(s.item.diplomesInfo,curr)),db.ctrl("User","update",{_id:s.item._id,diplomes:s.item.diplomes}).then(function(data){data.ok?(s.diplomesExists(curr)&&_deleteCurr(),s.message("File upload success.",{type:"info",duration:5e3,scroll:!0})):s.message("Upload fail, try later.",{type:"warning",duration:99999,scroll:!0}),read(s.item._id)})}else s.message("Upload fail, try later.",{type:"warning",duration:99999,scroll:!0})})}if(s.diplomesFile[_id]){var curr=_id;_uploadNew()}},s.save=function(){function _save(){s.requesting=!0,s.item.diplomesInfo=s.item.diplomesInfo||{},Object.keys(s.diplomesData).forEach(function(id){if(s.diplomesExists(id)){var data=s.diplomesData[id];s.item.diplomesInfo[id]={obtentionDate:data.info.obtentionDate,expirationDate:data.info.expirationDate,expirationDateNotificationEnabled:!1,expirationDateNotificationSended:!1,filename:data.info.filename}}}),db.ctrl("User","save",s.item).then(function(res){s.requesting=!1;var _r=res;_r.ok?(console.info("adminDiagsEdit:save:success"),s.message("saved","success"),r.route("diags",0)):(console.warn("adminDiagsEdit:save:fail",_r.err),s.message("error, try later","danger"))}).error(handleErrors)}s.message("saving . . .","info"),s.requesting=!0,db.custom("user","find",{email:s.item.email,userType:"diag"}).then(function(res){if(s.requesting=!1,res.data.result.length>0){var _item=res.data.result[0];s.item._id&&s.item._id==_item._id?_save():s.message("Email address in use.")}else _save()}).error(handleErrors)},s["delete"]=function(){s.confirm("Delete Diag "+s.item.email+" ?",function(){s.message("deleting . . .","info"),s.requesting=!0,db.custom("user","remove",{_id:s.item._id}).then(function(res){s.requesting=!1,s.message("deleted","info"),reset(),r.route("diags",0),console.info("adminDiagsEdit:remove:success",r.data)}).error(function(err){s.requesting=!1,s.message("error, try later.","danger"),console.warn("adminDiagsEdit:remove:error",err)})})},void(s.update=read))}]),function(){var app=angular.module("app.admin.diag.balance",[]);app.directive("diagBalance",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){function update(recalc){var data={_id:r.session()._id};recalc&&(data._calculate=!0),data.period=s.model.periodSelected||"year",ws.ctrl("User","balance",data).then(function(res){res.ok&&(console.info("balance",res.result),
s.balance=res.result,s.model.update(res.result.items,s.balance))})}var r=$rootScope,ws=server;attrs.name;s.title="Balance details",window.balance=s,s.model={periodSelected:"year",periods:createSelect({label:"(Select a period)",model:"model.periodSelected",scope:s,change:function(x){console.info(x),update(!0)},items:["month","year"]}),buttonsTpl:"views/partials/partial.diag.balance.buttons.html",tfoot:"views/partials/partial.diag.balance.footer.html",click:function(item,index){function _open(){s.open({title:"Balance Transaction",data:data,evts:{init:[]},item:item,templateUrl:"views/partials/partial.modal.balance.details.html",callback:function(item){}})}var data={};ws.localData().then(function(d){Object.assign(data,d)}),ws.ctrl("Payment","associatedOrder",{source:item.source}).then(function(data){item=Object.assign(data.result),_open()})},buttons:[{label:"Refresh",type:function(){return"btn btn-primary spacing-h-1"},click:function(){return update(!0)}},{label:"Recalc",show:!1,type:function(){return"btn btn-primary spacing-h-1"},click:function(){return update(!0)}}],columns:[{label:"Description",name:"description"},{label:"Amount (eur)",name:"amount",align:"right"}],items:[]},update()}}})}();var app=angular.module("app.admin.client",[]);app.directive("clientOrders",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){function update(){var data={__populate:{_client:"email userType",_diag:"email userType firstName lastName"}};r.userIs(["diag"])&&(data._diag=r.session()._id),r.userIs(["client"])&&(data._client=r.session()._id),ws.ctrl("Order","getAll",data).then(function(res){res.ok&&(res.result.forEach(function(v){v.date=moment(v.diagStart).format("dddd, DD MMMM"),v.start=moment(v.diagStart).format("HH:mm"),v.end=moment(v.diagEnd).format("HH:mm")}),s.model.update(res.result))})}var r=$rootScope,ws=server;attrs.name;s.title="Your Orders",s.model={click:function(item,index){var data={};ws.localData().then(function(d){Object.assign(data,d)}),r.params={item:item,prevRoute:"dashboard"},r.route("orders/edit/"+item._id)},buttons:[{label:"Refresh",type:function(){return"btn btn-primary spacing-h-1"},click:function(){return update()}}],columns:[{label:"Address",name:"address"},{label:"Status",name:"status"},{label:"Start",name:"start"},{label:"End",name:"end"}],items:[]},update()}}});var app=angular.module("app.admin.order",["app.common.service"]);app.controller("adminOrders",["server","$scope","$rootScope","focus",function(db,s,r,focus){function read(){s.message("Loading . . .","info"),db.custom("order","getAll",{__populate:{_client:"email",_diag:"email"}}).then(function(r){s.items=r.data.result,s.message("Loaded","success",1e3)})}return window.s=s,s.focus=focus,r.toggleNavbar(!0),r.secureSection(s),s.selectedItems=[],s.items=[],r.userIs(["diag","client"])?r.handleSecurityRouteViolation():(s.click=function(item){r.routeParams({prevRoute:"orders"}),r.route("orders/edit/"+item._id)},s.create=function(){r.route("orders/edit/-1")},s.select=function(){window.event&&window.event.stopPropagation()},s.syncStripe=function(){db.ctrl("Order","syncStripe"),setTimeout(read,5e3),setTimeout(read,2e4)},s.refresh=read,void r.dom(read,0))}]),app.controller("adminOrdersEdit",["server","$scope","$rootScope","$routeParams","focus",function(db,s,r,params,focus){function init(){r.toggleNavbar(!0),-1!==window.location.href.indexOf("orders/view")?r.toggleNavbar(!1):r.secureSection(s),r.dom(),setHelpers(),setDefaults(),setBindings(),setActions(),whenProperties(s,["diags"],[setDefaultsDiags]),params&&params.id&&"-1"!==params.id.toString()?r.dom(read,0):reset()}function autoPay(){-1!==window.location.href.indexOf("orders/view")&&s.pay&&"1"===getParameterByName("pay")&&s.item&&!_.includes(["prepaid","completed"],s.item.status)&&s.pay()}function setHelpers(){s.successMsg=function(msg){r.message(msg,{type:"success",duration:1e4})},s.infoMsg=function(msg){r.message(msg,{duration:5e3,type:"info"})},s.currentClientType=function(){return s.item&&s.item._client&&"("+s.item._client.clientType+")"||""},s.subTotal=function(){return subTotal(s.item,s.diags,s.basePrice)},s.sizePrice=function(){return sizePrice(s.item,s.diags,s.squareMetersPrice,s.basePrice)},s.totalPrice=function(showRounded){return totalPrice(showRounded,s.item,s.diags,s.squareMetersPrice,s.basePrice,{overwriteModel:!1,s:s})},s.totalTime=function(){return OrderTotalTime(s.item.diags,s.diags)},s.totalTimeFormated=function(){var t=OrderTotalTime(s.item.diags,s.diags),m=moment().hours(t.hours).minutes(t.minutes).format("HH:mm");return m},s.applyTotalPrice=function(){s.item.price=s.totalPrice(!0)},s.applyTotalTime=function(){var t=OrderTotalTime(s.item.diags,s.diags);s.item&&s.item.diagStart&&(s.item.diagEnd=moment(s.item.diagStart).add(t.hours,"hours").add(t.minutes,"minutes")._d,r.dom())},s.message=r.message,s.type=r.session().userType,s.is=function(arr){return _.includes(arr,s.type)},s.focus=focus,window.s=s}function setDefaults(){s.item={email:"",password:"",status:"ordered",diagStart:moment().add(1,"day").hour(9).minutes(0).toDate(),diagEnd:moment().add(1,"day").hour(10).minutes(30).toDate(),fastDiagComm:0,price:0,diags:{}},s.original=_.clone(s.item)}function setDefaultsDiags(){s.diags.forEach(function(val,key){s.item.diags[val.name]=val.mandatory?!0:!1})}function setBindings(){db.localData().then(function(data){Object.assign(s,data),s.diags.forEach(function(diag){diag.show=!0})}),s.keysWhereTime={invalidKeysTimeMessage:function(){var startTime=function(){return moment(s.item.diagStart).format("HH:mm")};return"Keys time should be between 8:00 and "+startTime()},invalidKeysTime:function(){var before=function(d1,h){return moment(d1).isBefore(moment(d1).hours(8))},after=function(d1){return moment(d1).isAfter(moment(s.item.diagStart))},v=s.item.keysTime;return s.item&&s.item.diagStart&&(before(v)||after(v))?!0:!1},init:function(self){},emit:function(n){var self=this,arr=self.evts[n]||[];arr.forEach(function(evt){return evt(self)})},evts:{onItem:[function(self){s.keysWhereTime.updateItems(self)}]},mstep:15,hstep:1,address:"",scope:s,val:void 0,disabled:function(){return r.state.working()},cls:function(){return{btn:!0,"btn-primary":!0}},filter:function(v){return s.item&&s.item._client&&s.item._client.clientType&&"agency"!==s.item._client.clientType&&"agency"==v.val?!1:!0},label:"(Select where)",modelPath:"item.keysWhere",items:[],updateItems:function(self){var o=[{label:"Order Address",val:1,get:function(){return s.item&&s.item.address}}];s.item._client&&"agency"==s.item._client.clientType&&o.push({label:"Agency address",val:3,get:function(){return s.item._client.address||""}},{label:"Landlord address",val:4,get:function(){return s.item.landLordAddress||""}}),s.item._client&&"landlord"==s.item._client.clientType&&o.push({label:"Client address",val:3,get:function(){return s.item._client.address||""}}),self.items=o},change:function(v,self,setOldValue){if(v){var address=v.get();return address?s.item.keysAddress&&s.item.keysAddress==address?void(s.item.keysTime||(s.item.keysTime=moment(s.item.diagStart).hours(8).minutes(0)._d)):void(s.item.keysAddress=address):(r.notify("Address not found",{type:"warning",duration:5e3,clickDismissable:!0}),self.val=void 0,void setOldValue())}}},s.datepicker={minDate:moment().toDate(),maxDate:moment().add(60,"day").toDate(),initDate:new Date},s.noResults="No results found",s.LoadingClients="Loading Clients",s.getClients=function(val){return db.http("User","getAll",{userType:"client",__regexp:{email:val}}).then(function(res){return res.data.result})},s.getDiags=function(val){return db.http("User","getAll",{userType:"diag",__rules:{disabled:{$ne:!0}},__regexp:{email:val}}).then(function(res){return res.data.result})},s.start=createDateTimePickerData(),s.end=createDateTimePickerData(),s.status=createSelect({scope:s,model:"item.status",label:"(Select an status)",items:["Ordered","Prepaid","Delivered","Completed"],change:function(selected){s.item.status=selected.toString().toLowerCase(),r.dom()}})}function setActions(){s.sendPaymentLink=function(){function _sendPaymentLink(){s.confirm("You want to send a payment link to "+s.item.landLordEmail+" ?",function(){s.infoMsg("Sending email."),db.ctrl("Email","orderPaymentLink",s.item).then(function(data){s.infoMsg("Email sended.")})})}ifThenMessage([[!s.item.landLordEmail,"==",!0,"Landlord Email required."],[!s.item.landLordFullName,"==",!0,"Landlord Name required."]],function(m){"string"!=typeof m[0]?s.message(m[0](),"warning",0,!0):s.message(m[0],"warning",0,!0)},_sendPaymentLink)},s.pay=function(){var order=s.item;openStripeModalPayOrder(order,function(token){order.stripeToken=token.id,db.ctrl("Order","pay",order).then(function(data){data.ok?(console.info("PAY-OK",data.result),s.successMsg("The order was paid successfully"),r.dom(read,5e3)):(s.successMsg("There was a server error, try later.","warning"),console.info("PAY-FAIL",data.err))})})},s.back=function(){if(s.is(["diag","client"]))r.route("dashboard");else{if(r.params&&r.params.prevRoute)return r.route(r.params.prevRoute);r.route("orders")}},s.cancel=function(){s.back()},s.mm=function(d){return moment(d).minutes()},s.mmOK=function(d){return _.includes([0,30],s.mm(d))},s.validate=function(){ifThenMessage([[_typeof(s.item._client),"!=","object","Client required"],[_.isUndefined(s.item.address)||_.isNull(s.item.address)||""===s.item.address,"==",!0,"Address required"],[_.isNull(s.item.diagStart)||_.isUndefined(s.item.diagStart),"==",!0,"Start date required"],[_.isNull(s.item.diagEnd)||_.isUndefined(s.item.diagEnd),"==",!0,"Start date required"],[moment(s.item.diagStart||null).isValid(),"==",!1,"Start date invalid"],[moment(s.item.diagEnd||null).isValid(),"==",!1,"End date invalid"],[s.mmOK(s.item.diagStart),"==",!1,"Start date minutes need to be 0 or 30."],[s.mmOK(s.item.diagEnd),"==",!1,"End date minutes need to be 0 or 30."],[moment(s.item.diagEnd).isValid()&&moment(s.item.diagStart).isValid()&&!moment(s.item.diagEnd).isSame(moment(s.item.diagStart),"day"),"==",!0,"Start / End dates need to be in the same day."],[moment(s.item.diagEnd).isValid()&&moment(s.item.diagEnd).isBefore(moment(s.item.diagStart),"hour"),"==",!0,"End date cannot be lower than Start date"],[s.keysWhereTime.invalidKeysTime(),"==",!0,s.keysWhereTime.invalidKeysTimeMessage],[isNaN(s.item.fastDiagComm),"==",!0,"Comission need to be a number"],[isNaN(s.item.price),"==",!0,"Price need to be a number"],[s.item.status,"==","","Status required"]],function(m){"string"!=typeof m[0]?s.message(m[0](),"warning",0,!0):s.message(m[0],"warning",0,!0)},s.save)},s.save=function(){s.message("saving . . .","info"),s.requesting=!0,db.ctrl("Order","save",s.item).then(function(data){s.requesting=!1,data.ok?(s.message("saved","success"),s.back()):handleError(data)}).error(handleError)},s.downloadFile=function(){return s.item.pdfId?void window.open(db.URL()+"/File/get/"+s.item.pdfId,"_newtab"):s.message("File required","warning",{duration:5e3,scroll:!0})},s.saveFile=function(){function _deletePrev(){pdfId_prev&&db.ctrl("File","remove",{_id:pdfId_prev})}function _uploadNew(){s.message("Uploading (Do not touch anything)",{type:"info",duration:99999,scroll:!0}),db.form("File/save/",{name:s.pdfFile.name,file:s.pdfFile}).then(function(data){data.ok?(s.item.pdfId=data.result._id,db.ctrl("Order","update",{_id:s.item._id,pdfId:data.result._id,status:"prepaid"===s.item.status?"completed":"delivered"}).then(function(data){_deletePrev(),read(s.item._id),s.message("File upload success.",{type:"info",duration:5e3,scroll:!0})})):s.message("Upload fail, try later.",{type:"warning",duration:99999,scroll:!0})})}if(!s.pdfFile)return saveFile,s.message("File required","warning",{duration:5e3,scroll:!0});var pdfId_prev=s.item.pdfId;_uploadNew()},s["delete"]=function(){var time=function(d){return moment(d).format("HH:mm")},descr=s.item.address+" ("+time(s.item.diagStart)+" - "+time(s.item.diagEnd)+")";s.confirm("Delete Order "+descr+" ?",function(){s.message("deleting . . .","info"),s.requesting=!0,db.ctrl("Order","remove",{_id:s.item._id}).then(function(data){s.requesting=!1,data.ok?(s.message("deleted","info"),s.back()):handleError(data)}).error(handleError)})}}function handleError(err){s.requesting=!1,s.message("error, try later.","danger",0,!0)}function reset(){s.item=_.clone(s.original)}function _readFile(){s.item.pdfId&&db.ctrl("File","find",{_id:s.item.pdfId}).then(function(data){data.ok&&(s.pdfFileInfo=data.result.length>0&&data.result[0]||null)})}function onItem(item){s.keysWhereTime.emit("onItem")}function read(id){r.params&&r.params.item&&r.params.item._diag&&(s.item=r.params.item,delete r.params.item),s.requesting=!0,db.ctrl("Order","get",{_id:id||params.id||s.item._id,__populate:{_client:"email clientType address",_diag:"email address"}}).then(function(data){s.requesting=!1,data.ok&&null!==data.result?(data.result=Object.assign(data.result,{diagStart:new Date(data.result.diagStart),diagEnd:new Date(data.result.diagEnd)}),s.item=data.result,onItem(s.item),autoPay(),_readFile(),s.message("Loaded","success",2e3)):handleError(data)}).error(handleError)}r.setCurrentCtrl(s),init()}]);var app=angular.module("app.admin.client.payments",["app.common.service"]);app.directive("clientPayments",function($rootScope,$timeout,$compile,$uibModal,$templateRequest,$sce,server){return{restrict:"AE",replace:!0,scope:{},templateUrl:"views/directives/directive.fast-crud.html",link:function(s,elem,attrs){function update(){var data={__populate:{_client:"email userType",_diag:"email userType"}};r.userIs(["diag"])&&(data._diag=r.session()._id),r.userIs(["client"])&&(data._client=r.session()._id),ws.ctrl("Order","getAll",data).then(function(res){res.ok&&(res.result.forEach(function(v){v.date=moment(v.diagStart).format("DD-MM-YY"),v.start=moment(v.diagStart).format("HH:mm"),v.end=moment(v.diagEnd).format("HH:mm"),v.description=v.address+"<br>"+v.date+"<br>"+v.start+" - "+v.end,v.status="Not yett"}),s.model.update(res.result))})}function pay(order){var handler=StripeCheckout.configure({key:"pk_test_MDkxtBLcBpHwMCgkqX2dJHjO",image:"https://stripe.com/img/documentation/checkout/marketplace.png",locale:"auto",token:function(_token2){order.stripeToken=_token2.id,ws.ctrl("Order","pay",order).then(function(data){data.ok?console.info("PAY-OK",data.result):console.info("PAY-FAIL",data.err)})}});handler.open({name:r.config.companyName||"[r.config.companyName]",description:"Order payment",email:order._client.email,currency:"eur",amount:100*order.price,zipCode:!1,allowRememberMe:!1})}var r=$rootScope,ws=server;attrs.name;s.title="My Payments",s.model={click:function(item,index){var data={};ws.localData().then(function(d){Object.assign(data,d)}),s.open({title:"Order Payment",data:data,evts:{init:[]},item:item,templateUrl:"views/partials/partial.modal.order.payment.html",callback:function(item){pay(item)}})},buttons:[{label:"Refresh",type:function(){return"btn btn-primary spacing-h-1"},click:function(){return update()}}],columns:[{label:"Description",name:"description"},{label:"You pay",name:"status"}],items:[]},update()}}});